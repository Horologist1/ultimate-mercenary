<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lanzador de Dados - Ultimate Mercenary</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles_additional.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        .dice-container {
            background-color: var(--medium-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .dice-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .dice-header h2 {
            font-family: var(--header-font);
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-color);
        }

        .dice-panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .dice-panel {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
        }

        .dice-panel h3 {
            font-family: var(--header-font);
            color: var(--secondary-color);
            margin-bottom: 15px;
            text-align: center;
        }

        .dice-controls {
            margin-bottom: 20px;
        }

        .dice-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .dice-label {
            width: 120px;
            color: var(--primary-color);
        }

        .dice-input {
            background-color: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--primary-color);
            color: var(--light-text);
            padding: 8px;
            border-radius: 5px;
            width: 60px;
            text-align: center;
        }

        .dice-input.dice-skill {
            width: 80px;
        }

        .dice-button {
            background-color: var(--darker-bg);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: var(--header-font);
            transition: all 0.3s ease;
        }

        .dice-button:hover {
            background-color: var(--primary-color);
            color: var(--darker-bg);
            box-shadow: 0 0 10px var(--primary-color);
        }

        .dice-button.roll-button {
            background-color: var(--darker-bg);
            color: var(--secondary-color);
            border: 1px solid var(--secondary-color);
            padding: 10px 20px;
            font-size: 1.1rem;
            margin-top: 10px;
            width: 100%;
        }

        .dice-button.roll-button:hover {
            background-color: var(--secondary-color);
            color: var(--darker-bg);
            box-shadow: 0 0 10px var(--secondary-color);
        }

        .dice-select {
            background-color: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--primary-color);
            color: var(--light-text);
            padding: 8px;
            border-radius: 5px;
            flex-grow: 1;
        }

        .dice-results {
            background-color: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--primary-color);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            min-height: 150px;
            overflow-y: auto;
            max-height: 300px;
        }

        .dice-results h4 {
            color: var(--secondary-color);
            margin-bottom: 10px;
            text-align: center;
            font-family: var(--header-font);
        }

        .dice-result {
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(0, 242, 255, 0.2);
            padding-bottom: 10px;
        }

        .dice-result-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .dice-result-type {
            font-weight: bold;
            color: var(--primary-color);
        }

        .dice-result-time {
            font-size: 0.8rem;
            color: rgba(224, 224, 255, 0.6);
        }

        .dice-roll {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .dice-roll-value {
            font-family: var(--header-font);
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .dice-roll-details {
            font-size: 0.9rem;
            color: rgba(224, 224, 255, 0.8);
        }

        .dice-success {
            color: #0f0;
            font-weight: bold;
        }

        .dice-critical {
            color: #ff0;
            font-weight: bold;
            text-shadow: 0 0 5px #ff0;
        }

        .dice-failure {
            color: #f00;
        }

        .dice-botch {
            color: #f00;
            font-weight: bold;
            text-shadow: 0 0 5px #f00;
        }

        .dice-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .dice-checkbox input {
            width: 18px;
            height: 18px;
            appearance: none;
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--primary-color);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }

        .dice-checkbox input:checked {
            background-color: var(--primary-color);
        }

        .dice-checkbox input:checked::before {
            content: '✓';
            position: absolute;
            color: black;
            font-size: 12px;
            top: 0;
            left: 4px;
        }

        .dice-history-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .dice-description {
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .dice-description h4 {
            color: var(--primary-color);
            margin-bottom: 5px;
            font-family: var(--header-font);
            text-align: left;
        }

        .dice-description p {
            margin-bottom: 5px;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .dice-panels {
                grid-template-columns: 1fr;
            }
        }

        /* Dice animation */
        @keyframes diceRoll {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            20% { transform: rotateX(180deg) rotateY(90deg); }
            40% { transform: rotateX(90deg) rotateY(270deg); }
            60% { transform: rotateX(360deg) rotateY(180deg); }
            80% { transform: rotateX(180deg) rotateY(360deg); }
            100% { transform: rotateX(0deg) rotateY(0deg); }
        }

        .rolling {
            animation: diceRoll 1s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <img src="images/oce_logo.png" alt="OmniCorp Entertainment Logo" class="logo">
                <div class="title-container">
                    <h1>ULTIMATE MERCENARY</h1>
                    <h2>Lanzador de Dados</h2>
                </div>
            </div>
            <div class="return-button-container">
                <a href="index.html" class="return-button"><i class="fas fa-arrow-left"></i> Volver al Inicio</a>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html"><i class="fas fa-home"></i> Inicio</a></li>
                    <li><a href="character-sheet.html"><i class="fas fa-user"></i> Hoja de Personaje</a></li>
                    <li><a href="encounter-generator.html"><i class="fas fa-gamepad"></i> Generador de Encuentros</a></li>
                </ul>
            </nav>
        </header>

        <main>
            <div class="dice-container">
                <div class="dice-header">
                    <h2>Sistema de Tiradas Eclipse Phase</h2>
                </div>
                
                <div class="dice-panels">
                    <div class="dice-panel">
                        <h3>Tirada de Habilidad</h3>
                        <div class="dice-controls">
                            <div class="dice-row">
                                <div class="dice-label">Habilidad:</div>
                                <input type="number" class="dice-input dice-skill" id="skill-value" min="0" max="100" value="50">
                                <select class="dice-select" id="skill-name">
                                    <option value="Armas de Fuego">Armas de Fuego</option>
                                    <option value="Combate CaC">Combate CaC</option>
                                    <option value="Atletismo">Atletismo</option>
                                    <option value="Sigilo">Sigilo</option>
                                    <option value="Percepción">Percepción</option>
                                    <option value="Interfaz">Interfaz</option>
                                    <option value="Hardware">Hardware</option>
                                    <option value="Persuasión">Persuasión</option>
                                    <option value="Supervivencia">Supervivencia</option>
                                    <option value="Intimidación">Intimidación</option>
                                    <option value="Otra">Otra...</option>
                                </select>
                            </div>
                            <div class="dice-row" id="custom-skill-row" style="display: none;">
                                <div class="dice-label">Nombre:</div>
                                <input type="text" class="dice-select" id="custom-skill-name" placeholder="Nombre de la habilidad...">
                            </div>
                            <div class="dice-row">
                                <div class="dice-label">Modificadores:</div>
                                <input type="number" class="dice-input" id="skill-modifier" value="0">
                                <button class="dice-button" id="add-modifier">Añadir</button>
                            </div>
                            <div id="modifiers-list" style="margin-bottom: 15px;">
                                <!-- Modifiers will be added here -->
                            </div>
                            <div class="dice-checkbox">
                                <input type="checkbox" id="superior-equip">
                                <label for="superior-equip">Equipo Superior (+10)</label>
                            </div>
                            <div class="dice-checkbox">
                                <input type="checkbox" id="extra-time">
                                <label for="extra-time">Tiempo Extra (+10)</label>
                            </div>
                            <div class="dice-checkbox">
                                <input type="checkbox" id="cooperative">
                                <label for="cooperative">Trabajo Cooperativo (+10)</label>
                            </div>
                            <button class="dice-button roll-button" id="skill-roll">Lanzar Dados</button>
                        </div>
                        <div class="dice-description">
                            <h4>Tiradas de Habilidad</h4>
                            <p>Tirada d100: debes obtener un resultado menor o igual que tu valor de habilidad.</p>
                            <p><strong>Éxito Crítico:</strong> 1/10 del valor de habilidad o menos (mín. 01-05).</p>
                            <p><strong>Éxito:</strong> Menor o igual que habilidad.</p>
                            <p><strong>Fallo:</strong> Mayor que habilidad.</p>
                            <p><strong>Fallo Crítico:</strong> 96-00.</p>
                        </div>
                    </div>
                    
                    <div class="dice-panel">
                        <h3>Tirada de Daño</h3>
                        <div class="dice-controls">
                            <div class="dice-row">
                                <div class="dice-label">Tipo:</div>
                                <select class="dice-select" id="damage-type">
                                    <option value="custom">Personalizado</option>
                                    <option value="1d10">1d10 (Cuchillo Básico)</option>
                                    <option value="1d10+2">1d10+2 (Cuchillo de Combate)</option>
                                    <option value="1d10+1">1d10+1 (Porra)</option>
                                    <option value="2d10">2d10 (Pistola Ligera)</option>
                                    <option value="2d10+2">2d10+2 (Pistola Pesada)</option>
                                    <option value="2d10">2d10 (Subfusil)</option>
                                    <option value="3d10">3d10 (Escopeta)</option>
                                    <option value="2d10+4">2d10+4 (Rifle de Asalto)</option>
                                </select>
                            </div>
                            <div class="dice-row" id="custom-damage-row">
                                <div class="dice-label">Dados:</div>
                                <input type="number" class="dice-input" id="damage-dice" min="1" max="10" value="2">
                                <span style="margin: 0 5px;">d10</span>
                                <span style="margin: 0 5px;">+</span>
                                <input type="number" class="dice-input" id="damage-bonus" value="0">
                            </div>
                            <div class="dice-row">
                                <div class="dice-label">AP:</div>
                                <input type="number" class="dice-input" id="damage-ap" value="0">
                            </div>
                            <div class="dice-checkbox">
                                <input type="checkbox" id="called-shot">
                                <label for="called-shot">Disparo Localizado</label>
                            </div>
                            <div class="dice-checkbox">
                                <input type="checkbox" id="critical-hit">
                                <label for="critical-hit">Éxito Crítico (DV +5)</label>
                            </div>
                            <button class="dice-button roll-button" id="damage-roll">Calcular Daño</button>
                        </div>
                        <div class="dice-results">
                            <h4>Historial de Tiradas</h4>
                            <div id="dice-history"></div>
                            <div class="dice-history-controls">
                                <button class="dice-button" id="clear-history">Limpiar Historial</button>
                                <button class="dice-button" id="save-history">Guardar Historial</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="dice-container">
                <div class="dice-header">
                    <h2>Herramientas Adicionales</h2>
                </div>
                
                <div class="dice-panels">
                    <div class="dice-panel">
                        <h3>Enfrentamientos Rápidos</h3>
                        <div class="dice-controls">
                            <div class="dice-row">
                                <div class="dice-label">Habilidad PJ:</div>
                                <input type="number" class="dice-input dice-skill" id="opposed-pc-skill" min="0" max="100" value="50">
                            </div>
                            <div class="dice-row">
                                <div class="dice-label">Habilidad PNJ:</div>
                                <input type="number" class="dice-input dice-skill" id="opposed-npc-skill" min="0" max="100" value="40">
                            </div>
                            <button class="dice-button roll-button" id="opposed-roll">Resolver Enfrentamiento</button>
                        </div>
                        <div class="dice-description">
                            <h4>Enfrentamientos</h4>
                            <p>Ambos participantes hacen tiradas de habilidad. Los resultados se comparan como sigue:</p>
                            <p>1. Si uno tiene éxito y el otro falla, el que tiene éxito gana.</p>
                            <p>2. Si ambos tienen éxito o ambos fallan, gana quien tenga el mejor grado de éxito/fallo (mayor diferencia entre el resultado y el valor objetivo).</p>
                            <p>3. Si hay empate en el grado de éxito/fallo, gana quien tenga mayor valor de habilidad base.</p>
                        </div>
                    </div>
                    
                    <div class="dice-panel">
                        <h3>Generador de Encuentros</h3>
                        <div class="dice-controls">
                            <div class="dice-row">
                                <div class="dice-label">Tipo:</div>
                                <select class="dice-select" id="encounter-type">
                                    <option value="guard">Guardias de OCE</option>
                                    <option value="competitor">Competidores</option>
                                    <option value="creature">Criaturas Mutadas</option>
                                    <option value="hazard">Peligros Ambientales</option>
                                    <option value="reward">Recompensas/Hallazgos</option>
                                </select>
                            </div>
                            <div class="dice-row">
                                <div class="dice-label">Dificultad:</div>
                                <select class="dice-select" id="encounter-difficulty">
                                    <option value="easy">Fácil</option>
                                    <option value="medium" selected>Media</option>
                                    <option value="hard">Difícil</option>
                                </select>
                            </div>
                            <button class="dice-button roll-button" id="generate-encounter">Generar Encuentro</button>
                        </div>
                        <div class="dice-results">
                            <h4>Encuentro Generado</h4>
                            <div id="encounter-result"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>Ultimate Mercenary: La Forja del Acero Callejero &copy; 2025</p>
            <p>Basado en Eclipse Phase Segunda Edición</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Skill name change handler
            document.getElementById('skill-name').addEventListener('change', function() {
                const customSkillRow = document.getElementById('custom-skill-row');
                if (this.value === 'Otra') {
                    customSkillRow.style.display = 'flex';
                } else {
                    customSkillRow.style.display = 'none';
                }
            });
            
            // Damage type change handler
            document.getElementById('damage-type').addEventListener('change', function() {
                const customDamageRow = document.getElementById('custom-damage-row');
                const damageTypeValue = this.value;
                
                if (damageTypeValue === 'custom') {
                    customDamageRow.style.display = 'flex';
                } else {
                    customDamageRow.style.display = 'none';
                    
                    // Parse the damage string to set dice and bonus values
                    const damagePattern = /(\d+)d10(?:\+(\d+))?/;
                    const match = damageTypeValue.match(damagePattern);
                    
                    if (match) {
                        const diceCount = parseInt(match[1]);
                        const bonus = match[2] ? parseInt(match[2]) : 0;
                        
                        document.getElementById('damage-dice').value = diceCount;
                        document.getElementById('damage-bonus').value = bonus;
                    }
                }
            });
            
            // Skill roll button
            document.getElementById('skill-roll').addEventListener('click', function() {
                const skillValue = parseInt(document.getElementById('skill-value').value);
                let skillName = document.getElementById('skill-name').value;
                
                if (skillName === 'Otra') {
                    skillName = document.getElementById('custom-skill-name').value || 'Habilidad Personalizada';
                }
                
                // Calculate modifiers
                let totalModifier = 0;
                
                // Check checkbox modifiers
                if (document.getElementById('superior-equip').checked) totalModifier += 10;
                if (document.getElementById('extra-time').checked) totalModifier += 10;
                if (document.getElementById('cooperative').checked) totalModifier += 10;
                
                // Get any additional modifiers from the list
                document.querySelectorAll('.modifier-item').forEach(item => {
                    totalModifier += parseInt(item.getAttribute('data-value'));
                });
                
                const finalSkill = Math.max(1, Math.min(99, skillValue + totalModifier));
                
                // Roll the dice
                const roll = Math.floor(Math.random() * 100) + 1;
                
                // Determine the result
                let result, resultClass;
                const critThreshold = Math.max(5, Math.floor(finalSkill / 10));
                
                if (roll <= critThreshold) {
                    result = 'ÉXITO CRÍTICO';
                    resultClass = 'dice-critical';
                } else if (roll <= finalSkill) {
                    result = 'ÉXITO';
                    resultClass = 'dice-success';
                } else if (roll >= 96) {
                    result = 'FALLO CRÍTICO';
                    resultClass = 'dice-botch';
                } else {
                    result = 'FALLO';
                    resultClass = 'dice-failure';
                }
                
                // Calculate margin of success/failure
                const margin = Math.abs(finalSkill - roll);
                
                // Add to history
                addToHistory({
                    type: 'Habilidad',
                    name: skillName,
                    roll: roll,
                    target: finalSkill,
                    original: skillValue,
                    modifier: totalModifier,
                    result: result,
                    resultClass: resultClass,
                    margin: margin
                });
            });
            
            // Damage roll button
            document.getElementById('damage-roll').addEventListener('click', function() {
                const diceCount = parseInt(document.getElementById('damage-dice').value);
                const bonus = parseInt(document.getElementById('damage-bonus').value);
                const ap = parseInt(document.getElementById('damage-ap').value);
                
                // Get damage type text for display
                let damageTypeText;
                if (document.getElementById('damage-type').value === 'custom') {
                    damageTypeText = `${diceCount}d10${bonus >= 0 ? '+' + bonus : bonus}`;
                } else {
                    damageTypeText = document.getElementById('damage-type').options[
                        document.getElementById('damage-type').selectedIndex
                    ].text;
                }
                
                // Apply modifiers
                let damageModifier = 0;
                let notes = [];
                
                if (document.getElementById('called-shot').checked) {
                    notes.push('Disparo Localizado');
                }
                
                if (document.getElementById('critical-hit').checked) {
                    damageModifier += 5;
                    notes.push('Éxito Crítico (+5 DV)');
                }
                
                // Roll the dice
                let rolls = [];
                let total = 0;
                
                for (let i = 0; i < diceCount; i++) {
                    const roll = Math.floor(Math.random() * 10) + 1;
                    rolls.push(roll);
                    total += roll;
                }
                
                total += bonus + damageModifier;
                
                // Add to history
                addToHistory({
                    type: 'Daño',
                    damageType: damageTypeText,
                    rolls: rolls,
                    bonus: bonus,
                    damageModifier: damageModifier,
                    ap: ap,
                    total: total,
                    notes: notes
                });
            });
            
            // Opposed roll button
            document.getElementById('opposed-roll').addEventListener('click', function() {
                const pcSkill = parseInt(document.getElementById('opposed-pc-skill').value);
                const npcSkill = parseInt(document.getElementById('opposed-npc-skill').value);
                
                // Roll for PC
                const pcRoll = Math.floor(Math.random() * 100) + 1;
                const pcSuccess = pcRoll <= pcSkill;
                const pcMargin = Math.abs(pcSkill - pcRoll);
                
                // Roll for NPC
                const npcRoll = Math.floor(Math.random() * 100) + 1;
                const npcSuccess = npcRoll <= npcSkill;
                const npcMargin = Math.abs(npcSkill - npcRoll);
                
                // Determine winner
                let winner, winReason;
                
                if (pcSuccess && !npcSuccess) {
                    winner = 'PJ';
                    winReason = 'PJ éxito, PNJ fallo';
                } else if (!pcSuccess && npcSuccess) {
                    winner = 'PNJ';
                    winReason = 'PNJ éxito, PJ fallo';
                } else if (pcSuccess && npcSuccess) {
                    // Both succeed, check margin
                    if (pcMargin > npcMargin) {
                        winner = 'PJ';
                        winReason = 'Ambos éxito, PJ mejor margen';
                    } else if (npcMargin > pcMargin) {
                        winner = 'PNJ';
                        winReason = 'Ambos éxito, PNJ mejor margen';
                    } else {
                        // Tied margin, check base skill
                        if (pcSkill > npcSkill) {
                            winner = 'PJ';
                            winReason = 'Empate en margen, PJ mayor habilidad';
                        } else if (npcSkill > pcSkill) {
                            winner = 'PNJ';
                            winReason = 'Empate en margen, PNJ mayor habilidad';
                        } else {
                            winner = 'Empate';
                            winReason = 'Empate absoluto';
                        }
                    }
                } else {
                    // Both fail, check margin
                    if (pcMargin < npcMargin) {
                        winner = 'PJ';
                        winReason = 'Ambos fallo, PJ mejor margen';
                    } else if (npcMargin < pcMargin) {
                        winner = 'PNJ';
                        winReason = 'Ambos fallo, PNJ mejor margen';
                    } else {
                        // Tied margin, check base skill
                        if (pcSkill > npcSkill) {
                            winner = 'PJ';
                            winReason = 'Empate en margen, PJ mayor habilidad';
                        } else if (npcSkill > pcSkill) {
                            winner = 'PNJ';
                            winReason = 'Empate en margen, PNJ mayor habilidad';
                        } else {
                            winner = 'Empate';
                            winReason = 'Empate absoluto';
                        }
                    }
                }
                
                // Add to history
                addToHistory({
                    type: 'Enfrentamiento',
                    pc: {
                        skill: pcSkill,
                        roll: pcRoll,
                        success: pcSuccess,
                        margin: pcMargin
                    },
                    npc: {
                        skill: npcSkill,
                        roll: npcRoll,
                        success: npcSuccess,
                        margin: npcMargin
                    },
                    winner: winner,
                    winReason: winReason
                });
            });
            
            // Generate encounter button
            document.getElementById('generate-encounter').addEventListener('click', function() {
                const type = document.getElementById('encounter-type').value;
                const difficulty = document.getElementById('encounter-difficulty').value;
                
                const encounterText = generateEncounter(type, difficulty);
                
                const encounterResult = document.getElementById('encounter-result');
                encounterResult.innerHTML = `
                    <div class="dice-result">
                        <div class="dice-result-header">
                            <span class="dice-result-type">Encuentro Generado</span>
                            <span class="dice-result-time">${new Date().toLocaleTimeString()}</span>
                        </div>
                        <div style="margin-top: 10px;">${encounterText}</div>
                    </div>
                `;
            });
            
            // Add modifier button
            document.getElementById('add-modifier').addEventListener('click', function() {
                const modifierValue = parseInt(document.getElementById('skill-modifier').value);
                if (isNaN(modifierValue) || modifierValue === 0) return;
                
                const modifiersList = document.getElementById('modifiers-list');
                const modifierItem = document.createElement('div');
                modifierItem.className = 'dice-row modifier-item';
                modifierItem.setAttribute('data-value', modifierValue);
                
                modifierItem.innerHTML = `
                    <div class="dice-label">${modifierValue >= 0 ? '+' : ''}${modifierValue}:</div>
                    <input type="text" class="dice-select" placeholder="Razón del modificador...">
                    <button class="dice-button remove-modifier">✕</button>
                `;
                
                modifiersList.appendChild(modifierItem);
                
                // Reset the modifier input
                document.getElementById('skill-modifier').value = 0;
                
                // Add event listener to remove button
                modifierItem.querySelector('.remove-modifier').addEventListener('click', function() {
                    modifiersList.removeChild(modifierItem);
                });
            });
            
            // Clear history button
            document.getElementById('clear-history').addEventListener('click', function() {
                if (confirm('¿Estás seguro de que quieres limpiar el historial de tiradas?')) {
                    document.getElementById('dice-history').innerHTML = '';
                }
            });
            
            // Save history button
            document.getElementById('save-history').addEventListener('click', function() {
                const history = document.getElementById('dice-history').innerHTML;
                if (!history.trim()) {
                    alert('No hay historial para guardar.');
                    return;
                }
                
                const date = new Date().toISOString().slice(0, 10);
                const blob = new Blob([`<html><head><title>Historial de Tiradas</title>
                    <style>
                        body { font-family: Arial, sans-serif; background-color: #111; color: #eee; }
                        .dice-result { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
                        .dice-result-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
                        .dice-result-type { font-weight: bold; color: #0cf; }
                        .dice-result-time { font-size: 0.8rem; color: #999; }
                        .dice-success { color: #0f0; font-weight: bold; }
                        .dice-critical { color: #ff0; font-weight: bold; }
                        .dice-failure { color: #f00; }
                        .dice-botch { color: #f00; font-weight: bold; }
                    </style>
                </head><body>
                    <h1>Historial de Tiradas - Ultimate Mercenary</h1>
                    <h2>Fecha: ${date}</h2>
                    <div id="dice-history">${history}</div>
                </body></html>`], { type: 'text/html' });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tiradas_ultimate_mercenary_${date}.html`;
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            });
            
            // Function to add result to history
            function addToHistory(data) {
                const historyContainer = document.getElementById('dice-history');
                const resultElement = document.createElement('div');
                resultElement.className = 'dice-result';
                
                const now = new Date().toLocaleTimeString();
                
                // Create the result based on the type
                if (data.type === 'Habilidad') {
                    resultElement.innerHTML = `
                        <div class="dice-result-header">
                            <span class="dice-result-type">${data.name}</span>
                            <span class="dice-result-time">${now}</span>
                        </div>
                        <div class="dice-roll">
                            <span class="dice-roll-value ${data.resultClass}">${data.roll}</span>
                            <span class="dice-roll-details">
                                vs ${data.target} (${data.original}${data.modifier >= 0 ? '+' : ''}${data.modifier !== 0 ? data.modifier : ''})
                            </span>
                        </div>
                        <div><strong class="${data.resultClass}">${data.result}</strong> (Margen: ${data.margin})</div>
                    `;
                } else if (data.type === 'Daño') {
                    const rollsDisplay = data.rolls.join(', ');
                    const notesDisplay = data.notes.length > 0 ? `<div><em>${data.notes.join(', ')}</em></div>` : '';
                    
                    resultElement.innerHTML = `
                        <div class="dice-result-header">
                            <span class="dice-result-type">Daño: ${data.damageType}</span>
                            <span class="dice-result-time">${now}</span>
                        </div>
                        <div class="dice-roll">
                            <span class="dice-roll-value">${data.total}</span>
                            <span class="dice-roll-details">
                                [${rollsDisplay}] + ${data.bonus}${data.damageModifier ? ' + ' + data.damageModifier : ''}
                            </span>
                        </div>
                        <div>AP: ${data.ap}</div>
                        ${notesDisplay}
                    `;
                } else if (data.type === 'Enfrentamiento') {
                    const pcResultClass = data.pc.success ? 'dice-success' : 'dice-failure';
                    const npcResultClass = data.npc.success ? 'dice-success' : 'dice-failure';
                    const winnerClass = data.winner === 'PJ' ? 'dice-success' : (data.winner === 'PNJ' ? 'dice-failure' : '');
                    
                    resultElement.innerHTML = `
                        <div class="dice-result-header">
                            <span class="dice-result-type">Enfrentamiento</span>
                            <span class="dice-result-time">${now}</span>
                        </div>
                        <div>
                            PJ: <span class="${pcResultClass}">${data.pc.roll}</span> vs ${data.pc.skill} 
                            (${data.pc.success ? 'Éxito' : 'Fallo'}, Margen: ${data.pc.margin})
                        </div>
                        <div>
                            PNJ: <span class="${npcResultClass}">${data.npc.roll}</span> vs ${data.npc.skill} 
                            (${data.npc.success ? 'Éxito' : 'Fallo'}, Margen: ${data.npc.margin})
                        </div>
                        <div>
                            <strong class="${winnerClass}">Ganador: ${data.winner}</strong>
                            <div><em>${data.winReason}</em></div>
                        </div>
                    `;
                }
                
                // Add the result to the history
                historyContainer.insertBefore(resultElement, historyContainer.firstChild);
                
                // Apply animation
                resultElement.classList.add('rolling');
                setTimeout(() => {
                    resultElement.classList.remove('rolling');
                }, 1000);
            }
            
            // Function to generate random encounters
            function generateEncounter(type, difficulty) {
                // Define difficulty modifiers
                const diffMod = {
                    easy: -1,
                    medium: 0,
                    hard: 1
                };
                
                const mod = diffMod[difficulty];
                
                // Generate based on type
                switch (type) {
                    case 'guard':
                        return generateGuardEncounter(mod);
                    case 'competitor':
                        return generateCompetitorEncounter(mod);
                    case 'creature':
                        return generateCreatureEncounter(mod);
                    case 'hazard':
                        return generateHazardEncounter(mod);
                    case 'reward':
                        return generateRewardEncounter(mod);
                    default:
                        return 'Error: Tipo de encuentro desconocido.';
                }
            }
            
            function generateGuardEncounter(mod) {
                // Number of guards
                const guardCount = Math.max(1, Math.floor(Math.random() * 3) + 1 + mod);
                
                // Guard types
                const guardTypes = [
                    'Dron Araña de Vigilancia "Scuttler"',
                    'Guardia de Seguridad Warden Mk.II',
                    'Soldado Pacificador'
                ];
                
                // Select guard type based on difficulty
                let guardIndex = Math.floor(Math.random() * 3);
                guardIndex = Math.min(2, Math.max(0, guardIndex + mod));
                
                const guardType = guardTypes[guardIndex];
                
                // Generate patrol behavior
                const behaviors = [
                    'patrullando un área fija',
                    'en búsqueda activa',
                    'en un puesto de control',
                    'haciendo una ronda de inspección',
                    'escoltando un paquete de suministros'
                ];
                
                const behavior = behaviors[Math.floor(Math.random() * behaviors.length)];
                
                // Generate special condition
                const conditions = [
                    '',
                    'Tienen detectores de movimiento mejorados.',
                    'Están en alerta por una fuga reciente.',
                    'Uno tiene un implante ocular avanzado.',
                    'Están intercambiando información por radio cada 2 minutos.',
                    'Tienen un dron de vigilancia adicional.'
                ];
                
                const condition = conditions[Math.min(5, Math.max(0, Math.floor(Math.random() * 6) + mod))];
                
                return `
                    <p><strong>${guardCount} ${guardType}</strong> ${guardCount > 1 ? 'están' : 'está'} ${behavior}.</p>
                    ${condition ? `<p>${condition}</p>` : ''}
                    <p><em>Recompensa por eliminación/evasión: ${(guardIndex + 1) * 50 * guardCount} PM</em></p>
                `;
            }
            
            function generateCompetitorEncounter(mod) {
                // Number of competitors
                const competitorCount = Math.max(1, Math.floor(Math.random() * 3) + 1 + mod);
                
                // Competitor types
                const competitorTypes = [
                    'Concursantes Novatos',
                    'Concursantes Intermedios',
                    'Concursantes Veteranos'
                ];
                
                // Select competitor type based on difficulty
                let competitorIndex = Math.floor(Math.random() * 3);
                competitorIndex = Math.min(2, Math.max(0, competitorIndex + mod));
                
                const competitorType = competitorTypes[competitorIndex];
                
                // Generate attitude
                const attitudes = [
                    'están dispuestos a colaborar temporalmente',
                    'parecen neutrales pero cautelosos',
                    'actúan de forma agresiva y territorial',
                    'están acechando en emboscada',
                    'tienen problemas internos y están discutiendo'
                ];
                
                const attitude = attitudes[Math.floor(Math.random() * attitudes.length)];
                
                // Generate special equipment
                const equipment = [
                    '',
                    'Uno tiene una pistola pesada.',
                    'Tienen un mapa parcial de la zona.',
                    'Poseen un kit médico avanzado.',
                    'Uno tiene un implante de camuflaje óptico básico.',
                    'Tienen una granada (fragmentación o aturdidora).'
                ];
                
                const gear = equipment[Math.min(5, Math.max(0, Math.floor(Math.random() * 6) + mod))];
                
                return `
                    <p><strong>${competitorCount} ${competitorType}</strong> ${attitude}.</p>
                    ${gear ? `<p>${gear}</p>` : ''}
                    <p><em>Recompensa por eliminación: ${(competitorIndex + 1) * 30 * competitorCount} PM</em></p>
                    <p><em>Recompensa por alianza exitosa: ${(competitorIndex + 1) * 20} PM</em></p>
                `;
            }
            
            function generateCreatureEncounter(mod) {
                // Creature types by difficulty
                const creatureTypes = [
                    ['1d6 Cosechadores Reptantes', '1 Agro-Drone Defectuoso', '1d3 Cosechadores + 1 Agro-Drone'],
                    ['1d3+2 Cosechadores Reptantes', '1d3 Agro-Drones Defectuosos', '1 Terror-Maíz (Alfa)'],
                    ['2d6 Cosechadores Reptantes', '1d4+1 Agro-Drones', '1 Terror-Maíz + 1d6 Cosechadores']
                ];
                
                // Select creature encounter based on difficulty
                const difficultyRow = Math.min(2, Math.max(0, 1 + mod));
                const creatureOptions = creatureTypes[difficultyRow];
                const creature = creatureOptions[Math.floor(Math.random() * creatureOptions.length)];
                
                // Generate behavior
                const behaviors = [
                    'buscando comida/presas',
                    'defendiendo su territorio',
                    'atacando a otro grupo de concursantes',
                    'herido y acorralado',
                    'en estado de frenesí'
                ];
                
                const behavior = behaviors[Math.floor(Math.random() * behaviors.length)];
                
                // Generate special condition
                const conditions = [
                    '',
                    'El área está cubierta por una densa niebla tóxica.',
                    'Las criaturas están infectadas con un parásito que causa daño si atacan cuerpo a cuerpo.',
                    'Un dispositivo cercano atrae/repele a las criaturas con ondas sonoras.',
                    'Hay muestras biológicas valiosas que pueden extraerse de las criaturas.',
                    'Las criaturas tienen una mutación imprevista que les otorga una nueva capacidad.'
                ];
                
                const condition = conditions[Math.min(5, Math.max(0, Math.floor(Math.random() * 6) + mod))];
                
                return `
                    <p><strong>${creature}</strong> ${behavior}.</p>
                    ${condition ? `<p>${condition}</p>` : ''}
                    <p><em>Recompensa por eliminación: ${150 + (difficultyRow * 100)} PM</em></p>
                    <p><em>Muestra biológica (si se recolecta): +50 PM</em></p>
                `;
            }
            
            function generateHazardEncounter(mod) {
                // Hazard types by difficulty
                const hazardTypes = [
                    ['Zona de gas irritante', 'Suelo inestable', 'Filtración eléctrica menor'],
                    ['Campo de radiación residual', 'Trampa con cuchillas', 'Torreta automática pasiva'],
                    ['Zona minada', 'Prensa hidráulica activa', 'Nube de nanobots corrosivos']
                ];
                
                // Select hazard based on difficulty
                const difficultyRow = Math.min(2, Math.max(0, 1 + mod));
                const hazardOptions = hazardTypes[difficultyRow];
                const hazard = hazardOptions[Math.floor(Math.random() * hazardOptions.length)];
                
                // Generate detection difficulty
                const detections = [
                    'evidente a simple vista',
                    'perceptible con una tirada básica de Percepción (TN 20)',
                    'difícil de detectar (Percepción TN 30)',
                    'solo detectable con equipo especializado o Percepción TN 40',
                    'casi imposible de detectar sin preparación específica (Percepción TN 50+)'
                ];
                
                const detectionIndex = Math.min(4, Math.max(0, Math.floor(Math.random() * 3) + mod));
                const detection = detections[detectionIndex];
                
                // Generate bypass method
                const bypasses = [
                    'Puede evitarse fácilmente rodeándola.',
                    'Requiere una tirada de Atletismo TN 20 para sortearla.',
                    'Se puede desactivar con una tirada de Hardware TN 30.',
                    'Necesita un equipo específico (Herramientas/Hackeo) para neutralizarla.',
                    'Prácticamente inevitable - hay que resistir sus efectos o encontrar otra ruta.'
                ];
                
                const bypassIndex = Math.min(4, Math.max(0, Math.floor(Math.random() * 3) + mod));
                const bypass = bypasses[bypassIndex];
                
                // Generate effect
                const effects = [
                    'Causa 1d10 de daño al fallar.',
                    'Causa 2d10 de daño al fallar.',
                    'Causa 3d10 de daño y un efecto de estado (herida, veneno, etc.).',
                    'Daño masivo (4d10+) con posibilidad de herida grave.',
                    'Potencialmente letal (daño masivo y efectos críticos).'
                ];
                
                const effectIndex = Math.min(4, Math.max(0, Math.floor(Math.random() * 3) + mod));
                const effect = effects[effectIndex];
                
                return `
                    <p><strong>${hazard}</strong></p>
                    <p>Detección: ${detection}</p>
                    <p>Solución: ${bypass}</p>
                    <p>Efecto: ${effect}</p>
                    <p><em>Recompensa por superación: ${50 + (difficultyRow * 50)} PM</em></p>
                `;
            }
            
            function generateRewardEncounter(mod) {
                // Reward types by difficulty (rarer but better with higher difficulty)
                const rewardTypes = [
                    ['Kit médico básico', 'Munición estándar', 'Datapad con información parcial'],
                    ['Kit médico avanzado', 'Arma de calidad media', 'Implante básico dañado'],
                    ['Arma de alta calidad', 'Implante cibernético funcional', 'Tokens de Datos OCE']
                ];
                
                // Select reward based on difficulty
                const difficultyRow = Math.min(2, Math.max(0, 1 + mod));
                const rewardOptions = rewardTypes[difficultyRow];
                const reward = rewardOptions[Math.floor(Math.random() * rewardOptions.length)];
                
                // Generate location
                const locations = [
                    'abandonado en un rincón',
                    'en un contenedor semi-oculto',
                    'en el cadáver de un concursante eliminado',
                    'en una caja de seguridad con cerradura',
                    'guardado en un compartimento blindado con trampa'
                ];
                
                const locationIndex = Math.min(4, Math.max(0, Math.floor(Math.random() * 3) + mod));
                const location = locations[locationIndex];
                
                // Generate condition
                const conditions = [
                    'En perfecto estado',
                    'Ligeramente dañado pero funcional',
                    'Requiere reparación menor (Hardware TN 20)',
                    'Severamente dañado (Hardware TN 30)',
                    'Modificado de forma peculiar (efectos secundarios)'
                ];
                
                const condition = conditions[Math.floor(Math.random() * conditions.length)];
                
                // Generate complication
                const complications = [
                    '',
                    'Un rastreador está acoplado al objeto.',
                    'Hay otros concursantes buscándolo activamente.',
                    'Un dron de seguridad protege la zona.',
                    'El objeto está programado para activar una alarma si se mueve.',
                    'Es una trampa diseñada para parecer un objeto valioso.'
                ];
                
                const complicationIndex = Math.min(5, Math.max(0, Math.floor(Math.random() * 4) + mod));
                const complication = complications[complicationIndex];
                
                return `
                    <p><strong>${reward}</strong> ${location}.</p>
                    <p>Estado: ${condition}</p>
                    ${complication ? `<p>Complicación: ${complication}</p>` : ''}
                    <p><em>Valor: ${100 + (difficultyRow * 100)} PM</em></p>
                `;
            }
        });
    </script>
</body>
</html>