<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Mercenary 1.6 - Panel de Control</title>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <!-- Initialize Firebase -->
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBVc1a4E4_y-YJZV5ZqFQzTr1T8Txe8TmQ",
            authDomain: "ultimatemercenary-1e212.firebaseapp.com",
            projectId: "ultimatemercenary-1e212",
            storageBucket: "ultimatemercenary-1e212.firebasestorage.app",
            messagingSenderId: "683730871364",
            appId: "1:683730871364:web:350aaf7a296ad34db28811",
            databaseURL: "https://ultimatemercenary-1e212-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // Get database reference
        window.database = firebase.database();

        // Referencias
        window.conocidosRef = window.database.ref('conocidosSeleccionados');
        window.conocimientosRef = window.database.ref('conocimientosSeleccionados');
        window.mensajesRef = window.database.ref('mensajes-directos');
        window.currentTestRef = window.database.ref('currentTest');
        window.timeOfDayRef = window.database.ref('timeOfDay');
        window.messageFiltersRef = window.database.ref('messageFilters');
        window.nombresRef = window.database.ref('nombresConcursantes');
        window.audienceRef = window.database.ref('audience');
        window.ratingRef = window.database.ref('rating');
        window.pmRef = window.database.ref('playerPM');
        window.chatRef = window.database.ref('mensajes-publico-expanded');
    </script>

    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
        }

        .main-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .background-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            opacity: 0.3;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 12px 24px;
            background-color: #ff4757;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            z-index: 9999;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-button:hover {
            background-color: #ff6b81;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        .back-button i {
            font-size: 16px;
        }

        .control-panel {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.9);
            border-radius: 8px;
            border: 1px solid #444;
            max-height: 80vh;
            overflow-y: auto;
            margin: 20px;
        }

        .control-panel::-webkit-scrollbar {
            width: 8px;
        }

        .control-panel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .control-panel::-webkit-scrollbar-thumb {
            background: #00ccff;
            border-radius: 4px;
        }

        .control-panel::-webkit-scrollbar-thumb:hover {
            background: #00a3cc;
        }

        .top-bar {
            background-color: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            height: 60px;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .title-container h1 {
            font-size: 24px;
            margin: 0;
            color: #00ccff;
        }

        .title-container h2 {
            font-size: 18px;
            margin: 0;
            color: #ff4757;
        }

        .test-selector {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .test-selector label {
            color: #00ccff;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
        }

        .test-selector select {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid #444;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .test-selector select:hover {
            border-color: #00ccff;
        }

        .test-selector select:focus {
            outline: none;
            border-color: #00ccff;
            box-shadow: 0 0 10px rgba(0, 204, 255, 0.5);
        }

        .current-objective {
            background-color: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            border-bottom: 1px solid #444;
        }

        .current-objective h3 {
            color: #ff4757;
            margin: 0 0 10px 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
        }

        .current-objective p {
            color: #fff;
            margin: 0;
            font-size: 14px;
            line-height: 1.4;
        }

        .main-area {
            flex: 1;
            display: grid;
            grid-template-columns: 2fr 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 120px);
            margin-top: 60px;
        }

        .control-section {
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            border: 1px solid #444;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 30px;
            overflow-y: auto;
            min-height: 400px;
        }

        /* La sección de audiencia ocupa dos filas y la primera columna */
        .control-section.audience {
            grid-row: 1 / span 2;
            grid-column: 1 / 2;
            min-height: 700px;
        }
        /* Las otras secciones ocupan la segunda columna */
        .control-section:not(.audience) {
            grid-column: 2 / 3;
        }

        .control-section h3 {
            color: #00ccff;
            margin: 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
        }

        .control-group {
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            border: 1px solid #444;
            padding: 15px;
            margin-bottom: 15px;
        }

        .control-group h4 {
            color: #ff4757;
            margin: 0 0 10px 0;
            font-size: 14px;
        }

        .control-input {
            width: 100%;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid #444;
            border-radius: 4px;
            color: white;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .control-button {
            background-color: #ff4757;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            transition: all 0.3s ease;
            width: 100%;
        }

        .control-button:hover {
            background-color: #ff6b81;
            transform: translateY(-2px);
        }

        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 0, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 1000;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(
                circle at center,
                transparent 0%,
                rgba(0, 0, 0, 0.3) 100%
            );
            pointer-events: none;
            z-index: 999;
        }

        /* Estilos para la sección de DMs */
        .control-section textarea {
            width: 100%;
            min-height: 100px;
            margin: 10px 0;
            padding: 10px;
            background-color: rgba(30, 30, 30, 0.8);
            border: 1px solid #444;
            border-radius: 4px;
            color: white;
            font-family: 'Roboto', sans-serif;
            resize: vertical;
        }

        .control-section select {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background-color: rgba(30, 30, 30, 0.8);
            border: 1px solid #444;
            border-radius: 4px;
            color: white;
            font-family: 'Roboto', sans-serif;
        }

        .pm-controls {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 10px;
            margin-bottom: 10px;
        }

        .pm-controls input {
            margin-bottom: 0;
        }

        .pm-controls button {
            width: 50px;
        }

        .user-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.8);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px;
        }

        .user-list h4 {
            color: #00ccff;
            margin: 0 0 10px 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            text-align: center;
        }

        .user-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            padding: 8px;
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 12px;
            align-items: center;
        }

        .user-name {
            color: #00ccff;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-pm, .user-audience, .user-rating {
            color: #ff4757;
            text-align: right;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            min-width: 60px;
        }

        .user-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            padding: 0 8px 5px 8px;
            color: #00ccff;
            font-size: 11px;
            text-transform: uppercase;
            border-bottom: 1px solid #444;
            margin-bottom: 5px;
            align-items: center;
        }

        .user-header div {
            text-align: right;
        }

        .user-header div:first-child {
            text-align: left;
        }

        /* Estilos para el chat en el panel de control */
        .chat-container {
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 300px;
            margin-bottom: 20px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            height: 200px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            border: 1px solid #444;
            transition: all 0.3s ease;
        }

        .chat-message:hover {
            transform: translateX(5px);
            background-color: rgba(40, 40, 40, 0.8);
        }

        .chat-message .username {
            color: #00ccff;
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-message .content {
            color: #fff;
            word-wrap: break-word;
        }

        /* Estilos para los filtros de mensajes */
        .filter-checkbox {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            border: 1px solid #444;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .filter-checkbox:hover {
            background-color: rgba(0, 204, 255, 0.1);
            border-color: #00ccff;
        }

        .filter-checkbox input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            position: absolute;
            top: 8px;
            right: 8px;
            height: 16px;
            width: 16px;
            background-color: #333;
            border: 2px solid #666;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .filter-checkbox input:checked ~ .checkmark {
            background-color: #00ccff;
            border-color: #00ccff;
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .filter-checkbox input:checked ~ .checkmark:after {
            display: block;
        }

        .filter-checkbox .checkmark:after {
            left: 4px;
            top: 1px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .filter-label {
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            font-size: 11px;
            color: #00ccff;
            margin-top: 20px;
            margin-bottom: 4px;
            text-align: center;
        }

        .filter-desc {
            font-size: 9px;
            color: #888;
            text-align: center;
            font-style: italic;
        }

        .filter-checkbox input:checked ~ .filter-label {
            color: #00ff88;
        }

        .filter-checkbox input:checked ~ .filter-desc {
            color: #00ff88;
        }

        /* Add styles for the ranking table */
        .ranking-table-admin {
            width: 100%;
            margin-top: 20px;
        }

        .ranking-table-admin table {
            width: 100%;
            border-collapse: collapse;
        }

        .ranking-table-admin th,
        .ranking-table-admin td {
            padding: 12px;
            text-align: center;
            border: 1px solid #444;
            color: white;
        }

        .ranking-table-admin th {
            background-color: rgba(0, 204, 255, 0.2);
            color: #00ccff;
            font-family: 'Orbitron', sans-serif;
        }

        .ranking-table-admin tr:nth-child(even) {
            background-color: rgba(30, 30, 30, 0.8);
        }

        .ranking-table-admin input {
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid #444;
            color: white;
            padding: 5px;
            width: 100px;
            text-align: center;
        }

        .ranking-table-admin button {
            background-color: #00ccff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }

        .ranking-table-admin button:hover {
            background-color: #00a3cc;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Botón de volver -->
        <button class="back-button" onclick="window.location.href='index.html'">
            <i class="fas fa-arrow-left"></i> VOLVER
        </button>
        
        <!-- Panel de control -->
        <div class="control-panel">
            <!-- Barra superior -->
            <div class="top-bar">
                <div class="logo-container">
                    <img src="images/oce_logo.png" alt="OmniCorp Entertainment Logo" class="logo">
                    <div class="title-container">
                        <h1>ULTIMATE MERCENARY</h1>
                        <h2>Panel de Control</h2>
                    </div>
                    <div class="test-selector" style="margin-left: 30px;">
                        <label for="current-test">Prueba Actual:</label>
                        <select id="current-test" onchange="updateCurrentTest(this.value)">
                            <option value="prueba0">Prueba 0: La Caída</option>
                            <option value="prueba1">Prueba 1: Carrera de Obstáculos</option>
                            <option value="prueba2">Prueba 2: La Cosecha</option>
                            <option value="prueba3">Prueba 3: La Entrega</option>
                        </select>
                    </div>
                    <div class="test-selector" style="margin-left: 20px;">
                        <label for="time-of-day">Momento:</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="time-of-day" onchange="updateTimeOfDay(this.value)">
                            <option value="dia">Día</option>
                            <option value="noche">Noche</option>
                        </select>
                            <button class="control-button" onclick="applyTimeOfDay()" style="padding: 4px 12px; font-size: 12px;">APLICAR</button>
                            <button class="control-button" onclick="resetFirebaseTimeOfDay()" style="padding: 4px 12px; font-size: 11px; background-color: #ff6b4a;">RESET</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="current-objective">
                <h3>Objetivo Actual:</h3>
                <p id="objective-text">Selecciona una prueba para ver su objetivo.</p>
            </div>
            
            <!-- Área principal -->
            <div class="main-area">
                <!-- Sección de Control de Audiencia -->
                <div class="control-section audience">
                    <h3>CONTROL DE AUDIENCIA</h3>
                    
                    <div class="control-group">
                        <h4>ESPECTADORES</h4>
                        <input type="number" class="control-input" id="spectators-input" placeholder="Número de espectadores">
                        <button class="control-button" onclick="updateSpectators()">ACTUALIZAR</button>
                    </div>
                    
                    <div class="control-group">
                        <h4>RATING</h4>
                        <input type="number" class="control-input" id="rating-input" placeholder="Rating (0.0 - 10.0)" step="0.1" min="0" max="10">
                        <button class="control-button" onclick="updateRating()">ACTUALIZAR</button>
                    </div>

                    <div class="control-group">
                        <h4>GESTIÓN DE PUNTOS DE MÉRITO (PM)</h4>
                        <div class="pm-controls">
                            <input type="number" class="control-input" id="pm-add-input" placeholder="Cantidad a sumar/restar">
                            <button class="control-button" onclick="addPM()">+</button>
                            <button class="control-button" onclick="subtractPM()">-</button>
                        </div>
                        <input type="number" class="control-input" id="pm-direct-input" placeholder="Establecer PM total">
                        <button class="control-button" onclick="updateDirectPM()">ESTABLECER PM</button>
                        
                        <h4 style="margin-top: 15px; color: #00ccff;">USUARIOS Y ESTADÍSTICAS</h4>
                        <div class="user-list">
                            <h4>USUARIOS Y ESTADÍSTICAS</h4>
                            <div class="user-header">
                                <div>Usuario</div>
                                <div>PM</div>
                                <div>Audiencia</div>
                                <div>Rating</div>
                            </div>
                            <div id="user-list-content">
                                <!-- Los usuarios se añadirán dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sección de Control de Mensajes -->
                <div class="control-section">
                    <h3>CONTROL DE MENSAJES</h3>
                    
                    <!-- Filtros de Categorías de Mensajes -->
                    <div class="control-group" style="background-color: rgba(0, 20, 40, 0.8); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #00ccff; margin-bottom: 15px; font-family: 'Orbitron', sans-serif;">
                            <i class="fas fa-filter"></i> FILTROS DE MENSAJES CONTEXTUALES
                        </h4>
                        <div class="filter-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <label class="filter-checkbox">
                                <input type="checkbox" id="filter-fan" checked onchange="toggleMessageFilter('fan', this.checked)">
                                <span class="checkmark"></span>
                                <span class="filter-label">FAN</span>
                                <span class="filter-desc">Admiración y apoyo</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" id="filter-picante" checked onchange="toggleMessageFilter('picante', this.checked)">
                                <span class="checkmark"></span>
                                <span class="filter-label">PICANTE</span>
                                <span class="filter-desc">Contenido sensual</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" id="filter-humillante" checked onchange="toggleMessageFilter('humillante', this.checked)">
                                <span class="checkmark"></span>
                                <span class="filter-label">HUMILLANTE</span>
                                <span class="filter-desc">Retos degradantes</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" id="filter-relleno" checked onchange="toggleMessageFilter('relleno', this.checked)">
                                <span class="checkmark"></span>
                                <span class="filter-label">RELLENO</span>
                                <span class="filter-desc">Comentarios generales</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" id="filter-queja" checked onchange="toggleMessageFilter('queja', this.checked)">
                                <span class="checkmark"></span>
                                <span class="filter-label">QUEJA</span>
                                <span class="filter-desc">Críticas y descontento</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" id="filter-divertido" checked onchange="toggleMessageFilter('divertido', this.checked)">
                                <span class="checkmark"></span>
                                <span class="filter-label">DIVERTIDO</span>
                                <span class="filter-desc">Humor y entretenimiento</span>
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" id="filter-insulto" checked onchange="toggleMessageFilter('insulto', this.checked)">
                                <span class="checkmark"></span>
                                <span class="filter-label">INSULTO</span>
                                <span class="filter-desc">Ofensas directas</span>
                            </label>
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="control-button" onclick="enableAllFilters()">ACTIVAR TODOS</button>
                            <button class="control-button" onclick="disableAllFilters()">DESACTIVAR TODOS</button>
                            <button class="control-button" onclick="resetFiltersToDefault()">RESTABLECER</button>
                        </div>
                    </div>
                    
                    <!-- Añadir el widget de chat -->
                    <div class="chat-container" style="margin-bottom: 20px;">
                        <div class="chat-messages" id="chat-messages">
                            <!-- Los mensajes se añadirán dinámicamente -->
                        </div>
                    </div>

                    <div class="control-group">
                        <h4>ENVIAR MENSAJE</h4>
                        <input type="text" class="control-input" id="public-username-input" placeholder="Usuario" style="margin-bottom: 8px;">
                        <input type="text" class="control-input" id="message-input" placeholder="Escribe un mensaje...">
                        <button class="control-button" onclick="sendMessage()">ENVIAR</button>
                    </div>

                    <div class="control-group">
                        <h4>ENVIAR OFERTA DE PM</h4>
                        <input type="text" class="control-input" id="pm-username-input" placeholder="Usuario" style="margin-bottom: 8px;">
                        <input type="number" class="control-input" id="pm-input" placeholder="Cantidad de PM">
                        <input type="text" class="control-input" id="pm-message-input" placeholder="Mensaje con la oferta...">
                        <button class="control-button" onclick="sendPMMessage()">ENVIAR OFERTA</button>
                    </div>

                    <!-- Sección de Mensajes Directos -->
                    <div class="control-group">
                        <h4>MENSAJES DIRECTOS</h4>
                        <input type="text" id="dm-custom-sender" class="control-input" placeholder="Nombre del remitente (escribir libremente)" style="margin-bottom: 8px;">
                        <textarea id="dm-content" class="control-input" placeholder="Contenido del mensaje" rows="4"></textarea>
                        <button class="control-button" onclick="sendDirectMessage()">ENVIAR MENSAJE A BANDEJA</button>
                    </div>
                </div>

                <!-- Sección de Conocidos y Conocimientos -->
                <div class="control-section">
                    <h3>CONOCIDOS</h3>
                    <div id="conocidos-list" class="control-group"></div>
                    <h3>CONOCIMIENTOS</h3>
                    <p style="color: #aaa; font-size: 12px; margin-bottom: 10px;">Selecciona los personajes específicos que conoce el jugador:</p>
                    <div id="conocimientos-list" class="control-group"></div>
                </div>

                <!-- Add new ranking section -->
                <div class="control-section ranking">
                    <h3>Gestión del Ranking</h3>
                    <div class="control-group">
                        <h4>Top 10 Participantes</h4>
                        <div class="ranking-table-admin">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Posición</th>
                                        <th>Número</th>
                                        <th>PM</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="rankingTableBody">
                                    <!-- Content will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="scanline"></div>
        <div class="overlay"></div>
    </div>

    <script src="js/stats-manager.js"></script>
    <script>
        // Sistema de almacenamiento persistente
        const persistentStorage = {
            data: {
                playerPM: 0,
                audience: 0,
                rating: 0
            },

            init() {
                // Obtener valores actuales
                const currentPM = localStorage.getItem('playerPM') || '0';
                const currentAudience = localStorage.getItem('spectators') || '0';
                const currentRating = localStorage.getItem('rating') || '0.0';

                // Actualizar datos
                this.data.playerPM = parseInt(currentPM);
                this.data.audience = parseInt(currentAudience);
                this.data.rating = parseFloat(currentRating);

                // Sincronizar con statsManager si existe y tiene las funciones necesarias
                if (window.statsManager && typeof statsManager.updateUI === 'function') {
                    if (typeof statsManager.updateSpectators === 'function') {
                        statsManager.updateSpectators(this.data.audience);
                    }
                    if (typeof statsManager.updateRating === 'function') {
                        statsManager.updateRating(this.data.rating);
                    }
                    statsManager.updateUI();
                }
            },

            updatePM(amount) {
                this.data.playerPM = amount;
                localStorage.setItem('playerPM', amount.toString());
                if (window.statsManager && typeof statsManager.updateUI === 'function') {
                    statsManager.updateUI();
                }
            },

            updateAudience(value) {
                const newValue = parseInt(value) || 0;
                this.data.audience = newValue;
                localStorage.setItem('spectators', newValue.toString());
                if (window.statsManager && typeof statsManager.updateSpectators === 'function') {
                    statsManager.updateSpectators(newValue);
                    if (typeof statsManager.updateUI === 'function') {
                        statsManager.updateUI();
                    }
                }
            },

            updateRating(value) {
                const newValue = parseFloat(value) || 0;
                this.data.rating = newValue;
                localStorage.setItem('rating', newValue.toString());
                if (window.statsManager && typeof statsManager.updateRating === 'function') {
                    statsManager.updateRating(newValue);
                    if (typeof statsManager.updateUI === 'function') {
                        statsManager.updateUI();
                    }
                }
            }
        };

        // Función para actualizar la lista de usuarios
        function updateUserList() {
            const userListContent = document.getElementById('user-list-content');
            if (!userListContent) return;

            // Obtener valores actuales
            const currentPM = localStorage.getItem('playerPM') || '0';
            const currentAudience = localStorage.getItem('spectators') || '0';
            const currentRating = localStorage.getItem('rating') || '0.0';

            // Crear elemento para el usuario auri
            userListContent.innerHTML = `
                <div class="user-item">
                    <div class="user-name">auri</div>
                    <div class="user-pm">${currentPM}</div>
                    <div class="user-audience">${currentAudience}</div>
                    <div class="user-rating">${parseFloat(currentRating).toFixed(1)}</div>
                </div>
            `;
        }

        // Objetivos de cada prueba
        const testObjectives = {
            'prueba0': 'Supervivencia inicial en el hangar subterráneo. Los concursantes deben adaptarse al entorno, familiarizarse con el equipo básico y demostrar su capacidad para sobrevivir en condiciones adversas.',
            'prueba1': 'Completar la carrera de obstáculos industrial. Los concursantes deben superar una serie de desafíos físicos y mentales, demostrando su agilidad, resistencia y capacidad de adaptación.',
            'prueba2': 'Recolectar plantas y materiales valiosos del Jardín Vertical. Los concursantes deben identificar, recolectar y preservar especímenes raros y peligrosos, demostrando su conocimiento y precisión.',
            'prueba3': 'Realizar entregas de paquetes en el distrito industrial. Los concursantes deben transportar cargamentos valiosos a través de zonas peligrosas, demostrando su sigilo y eficiencia.'
        };

        // Datos de personajes y facciones
        const personajes = [
            { nombre: 'Vainilla', img: 'images/vainilla.png', desc: 'La Idol Ambiciosa. Ex-estrella del pop y manipuladora de audiencias.' },
            { nombre: 'Auri', img: 'images/kira_initial.png', desc: 'Protagonista principal, adaptable y endeudada con los Dragones de Jade.' },
            { nombre: 'Boris "Goliath" Volkov', img: 'images/goliath.png', desc: 'El Tanque Ruso, ex-Spetsnaz, brutal y directo.' },
            { nombre: 'Silas "Glitch" Vance', img: 'images/silas_glitch.png', desc: 'Netrunner nervioso, ex-ingeniero de seguridad.' },
            { nombre: 'Raven (Mizuki Tanaka)', img: 'images/raven.png', desc: 'La Asesina Silenciosa, maestra del sigilo.' },
            { nombre: 'Chispa (Anya Sharma)', img: 'images/chispa_new.png', desc: 'La Mecánica Optimista, experta en cromo.' },
            { nombre: 'Marcus "Old Man" Thorne', img: 'images/old_man.png', desc: 'El Veterano Cínico, ex-corporativo.' },
            { nombre: 'Jinx', img: 'images/jinx_alt.png', desc: 'La Psicópata Impredecible, disfruta del caos.' },
            { nombre: 'Lin Mayfair', img: 'images/lin_mayfair_new.png', desc: 'La "Inocente" Endeudada, historia trágica.' },
            { nombre: 'Subject Omega', img: 'images/subject_omega.png', desc: 'El Misterioso, posible experimento de OCE.' },
            { nombre: 'Ekaterina "Echo" Petrov', img: 'images/cyber_sniper.png', desc: 'La Francotiradora Fantasma, precisión sobrehumana.' },
            { nombre: 'Dr. Felix "Compound" Reyes', img: 'images/cyber_chemist.png', desc: 'El Químico Clandestino, genio de drogas de combate.' },
            { nombre: 'Los Gemelos (Jin & Jun)', img: 'images/cyber_twins.png', desc: 'Los Sincronizados, mentes enlazadas.' },
            { nombre: 'Sofía "Viper" Nakamura', img: 'images/viper_blade.png', desc: 'La Samurái Callejera, busca venganza.' },
            { nombre: 'Alex "Phantom" Mercer', img: 'images/hacker_phantom.png', desc: 'El Fantasma de la Red, hacker legendario.' },
            { nombre: 'Marcus "Titan" Graves', img: 'images/titan_warrior.png', desc: 'El Soldado Aumentado, ex-super-soldado.' },
            { nombre: 'Faith "Oracle" Lee', img: 'images/faith_oracle.png', desc: 'La Tecno-Sacerdotisa, ex-profeta de la Singularidad.' },
            { nombre: 'Darius "Thunder Fist" Jackson', img: 'images/thunder_fist.png', desc: 'El Campeón de las Peleas Clandestinas.' },
            { nombre: 'Aria "Maven" Chen', img: 'images/maven_corporate.png', desc: 'La Ejecutiva Despiadada, ex-vicepresidenta de Nakamura-Daichi.' },
            { nombre: 'Alex "Phantom" Mercer', img: 'images/hacker_phantom.png', desc: 'El Fantasma de la Red, hacker legendario.' },
            { nombre: 'Sofía "Viper" Nakamura', img: 'images/viper_blade.png', desc: 'La Samurái Callejera, busca venganza.' }
        ];
        const facciones = [
            { nombre: 'OmniCorp Entertainment (OCE)', img: 'images/oce_logo.png', desc: 'Conglomerado mediático global, operaciones negras y tecnología militar.' },
            { nombre: 'Colectivo Nexus-9', img: 'images/nexus9_logo.png', desc: 'Tecno-anarquistas, democratizan la tecnología de modificación corporal.' },
            { nombre: 'Chrome Dynasty', img: 'images/chrome_dynasty_logo.png', desc: 'Organización criminal de élite, obsesionados con el cromo.' },
            { nombre: 'Zaibatsu Nakamura-Daichi Corp', img: 'images/nakamura_daichi_logo.png', desc: 'Conglomerado de biotecnología, integración tecno-orgánica.' },
            { nombre: 'Huérfanos Digitales', img: 'images/huerfanos_digitales_emblema.png', desc: 'Tribu urbana, víctimas de la "muerte digital".' }
        ];

        // Personajes individuales de las facciones para selección granular
        const personajesFacciones = [
            // OmniCorp Entertainment (OCE)
            {
                nombre: 'Kaiser "El Emperador" Von Stroheim',
                faccion: 'OmniCorp Entertainment (OCE)',
                rol: 'Anfitrión y Productor Ejecutivo',
                img: 'images/kaiser_new.png',
                desc: 'Imponente figura que viste trajes de seda negra con reflejos carmesí. Su brazo biónico "Ares Predator VII" de cromo negro pulido con detalles dorados intimidaría incluso al más valiente. Sus ópticas "Zeiss Ikon X" revelan pupilas rojas que parecen analizar cada debilidad. Su cabello plateado peinado hacia atrás completa su imagen de autoridad absoluta.',
                dialogo: '¡Bienvenidos, rebaño de desesperados, a la arena donde las ovejas se convierten en lobos o en pienso! ¡Cien almas buscando redención, o al menos, una muerte con más estilo que la que les esperaba fuera! Soy Kaiser, su pastor en este valle de sombras y neón. Sus deudas, sus crímenes, sus errores... olvídense de ellos. Aquí, solo importa una cosa: ¡SOBREVIVIR! ¡ENTRETENER! ¡ASCENDER! Ultimate Mercenary ha comenzado. ¡Que la purga... digo, la competencia, dé inicio!'
            },
            {
                nombre: 'Mr. Kenji Tanaka',
                faccion: 'OmniCorp Entertainment (OCE)',
                rol: 'Jefe de Adquisiciones de Talento',
                img: 'images/guard_ocemk2.png',
                desc: 'Trajeado impecablemente, Mr. Tanaka es la cara "amable" de OCE. Con una sonrisa falsa pero convincente y mirada fríamente calculadora, es él quien cierra los tratos sucios que llevan a los concursantes hasta el programa. Función: Maneja la "contratación" de concursantes y otros activos de OCE, asegurándose de que todo tenga el aspecto de legalidad necesario para la transmisión pública.',
                dialogo: 'Le aseguro que todas nuestras operaciones son... completamente legales. ¿Los participantes? Todos son voluntarios, por supuesto. Han firmado contratos extensivos. El que algunos lo hicieran con una pistola figurativa en la cabeza es, como comprenderá, irrelevante para nuestros abogados.'
            },
            {
                nombre: 'Dra. Naomi "Nano" McClaray',
                faccion: 'OmniCorp Entertainment (OCE)',
                rol: 'Médica Jefe de OCE',
                img: 'images/doctora_nano_thumb.png',
                desc: 'Ex-investigadora principal en BioTech Corp, especializada en nanomedicina avanzada. Ahora supervisa todos los procedimientos médicos en Ultimate Mercenary, incluyendo implantes y "reparaciones" de concursantes valiosos. Sus brazos cibernéticos están especializados en procedimientos de precisión que han salvado —y transformado— a docenas de concursantes.',
                dialogo: 'Mis dispositivos son lo único que mantiene vivos a la mitad de ustedes. Curiosamente, también son lo que podría matarlos con solo un comando remoto. ¿Fascinante balance, no crees?'
            },
            {
                nombre: 'Director Ikari',
                faccion: 'OmniCorp Entertainment (OCE)',
                rol: 'Agente del Gobierno Sombra',
                img: 'images/director_ikari.png',
                desc: 'Oficial de alto rango en el Ministerio de Seguridad Interna de Neo-Kyoto. Su presencia en las gradas VIP de Ultimate Mercenary es discreta pero constante. El gobierno oficialmente condena el show mientras secretamente lo utiliza para probar implantes experimentales y reclutar especialistas en combate.',
                dialogo: 'Puedo hacer que tu historial criminal desaparezca... o que tú desaparezcas. Ambas opciones son igualmente sencillas para mí. La diferencia está en lo útil que me resultes.'
            },

            // Colectivo Nexus-9
            {
                nombre: 'Dra. Ada "Quantum" Mercurio',
                faccion: 'Colectivo Nexus-9',
                rol: 'Científica Visionaria y Fundadora',
                img: 'images/nexus9_ada_quantum.png',
                desc: 'Antigua jefa de investigación en neurotecnología avanzada para NeuroCorp, Ada descubrió que la empresa planeaba hacer que la tecnología de transferencia de conciencia fuera deliberadamente adictiva. Robó prototipos y datos críticos antes de desaparecer. Con implantes neurales experimentales autoinstalados, puede procesar información a velocidades sobrehumanas y conectarse directamente con sistemas informáticos. Su rostro está parcialmente cubierto por una máscara respiratoria personalizada.',
                dialogo: 'La muerte ya no es inevitable, solo es costosa. Cambiaremos eso, aunque tengamos que desmantelar todo el sistema corporativo para lograrlo.'
            },
            {
                nombre: 'Xiong "Mesh" Lee',
                faccion: 'Colectivo Nexus-9',
                rol: 'Especialista en Infiltración y Recuperación',
                img: 'images/nexus9_mesh_lee.png',
                desc: 'Ex-agente de seguridad corporativa con amplia experiencia militar. Después de perder a su familia en un "accidente" corporativo, fue reconstruido por el Colectivo con tecnología experimental. Su cuerpo está poblado por nanomáquinas que pueden reconfigurar parcialmente su apariencia. Se especializa en operaciones de infiltración y recuperación, entrando en instalaciones corporativas para extraer tecnología o datos. Su lealtad al Colectivo es absoluta.',
                dialogo: 'Mi cuerpo es un prototipo. Mi mente es un arma. Si me matas, aprenderán de mi cadáver y construirán algo mejor.'
            },

            // Chrome Dynasty
            {
                nombre: 'Madame Jade "Emperatriz de Cromo"',
                faccion: 'Chrome Dynasty',
                rol: 'Líder Suprema de la Chrome Dynasty',
                img: 'images/chrome_dynasty_emperatriz.png',
                desc: 'Una figura casi mítica, la Emperatriz rara vez se muestra públicamente sin un elaborado velo digital que oculta sus facciones. Su verdadera edad es desconocida, con rumores que sugieren que ha transferido su conciencia a múltiples cuerpos a lo largo de décadas. Su cuerpo actual es una obra maestra de ingeniería biomecánica, con implantes cromados que realzan su presencia intimidante. Como líder, controla un vasto imperio criminal con eficiencia implacable.',
                dialogo: 'La carne es débil. La sangre es transitoria. Solo el cromo perdura. En este nuevo mundo, aquellos con la mejor tecnología no son simplemente ricos - son dioses.'
            },
            {
                nombre: 'Jin "Silverhand" Wong',
                faccion: 'Chrome Dynasty',
                rol: 'Enforcer Principal y Cirujano de Combate',
                img: 'images/chrome_dynasty_silverhand.png',
                desc: 'Antiguo cirujano militar deshonradamente despedido por experimentación no autorizada, Jin encontró un hogar en la Chrome Dynasty. Sus brazos completamente cibernéticos contienen un arsenal de herramientas quirúrgicas que utiliza tanto para instalar implantes de élite como para "recuperarlos" de enemigos caídos. Su reputación es legendaria en los bajos fondos de Neo-Kyoto, donde se dice que puede remover todos los implantes de un objetivo mientras lo mantiene consciente, como forma de castigo ejemplar.',
                dialogo: 'Puedo reconstruirte o desmantelarte con la misma precisión. La elección es tuya, pero te sugiero que elijas sabiamente.'
            },

            // Nakamura-Daichi Corp
            {
                nombre: 'Hideo Nakamura',
                faccion: 'Zaibatsu Nakamura-Daichi Corp',
                rol: 'CEO y Patriarca de Nakamura-Daichi Corp',
                img: 'images/nakamura_daichi_ceo.png',
                desc: 'A sus 78 años, Hideo representa la vieja guardia corporativa con adaptaciones modernas. Su cuerpo está sutilmente mejorado con los mejores productos de su compañía, haciéndolo parecer un saludable hombre de 50 años. A diferencia de muchos ejecutivos, Hideo mantiene sus mejoras discretas y casi invisibles. Conocido por su inteligencia estratégica y paciencia implacable, Hideo planifica a décadas vista, posicionando a Nakamura-Daichi para eventualmente dominar el mercado global de biotecnología.',
                dialogo: 'Las corporaciones que exhiben su poder son las primeras en caer. El verdadero poder, como la mejor tecnología, funciona de manera invisible.'
            },
            {
                nombre: 'Dra. Yuki Nakamura',
                faccion: 'Zaibatsu Nakamura-Daichi Corp',
                rol: 'Directora de Investigación y Desarrollo',
                img: 'images/nakamura_daichi_yuki.png',
                desc: 'Genio científico con doctorados en bioingeniería y cibernética neural, Yuki representa el futuro de la corporación. A diferencia de su padre, es más agresiva en sus tácticas y menos paciente con obstáculos. Ha dirigido personalmente varios proyectos revolucionarios, incluyendo el "Programa Fénix" - un intento de transferencia de conciencia. Aunque públicamente mantiene la imagen corporativa de elegancia y discreción, Yuki ha autorizado operaciones clandestinas para sabotear a competidores y adquirir tecnología por medios cuestionables.',
                dialogo: 'Mi padre construyó esta empresa con paciencia. Yo la convertiré en un imperio con determinación. La diferencia entre nosotros es que él está dispuesto a esperar que el mundo cambie. Yo estoy decidida a cambiarlo yo misma.'
            },

            // Huérfanos Digitales
            {
                nombre: 'Zero "Void" Tanaka',
                faccion: 'Huérfanos Digitales',
                rol: 'Líder y Rostro del Movimiento',
                img: 'images/huerfanos_zero_void.png',
                desc: 'Zero perdió a ambos padres en el "Gran Fallo de Arasaka" cuando tenía 15 años. Sus padres habían transferido sus conciencias a la infraestructura corporativa días antes de que un ataque cibernético masivo corrompiera irreversiblemente miles de almacenamientos de conciencia. Ahora en sus veintitantos, Zero se ha convertido en el rostro de los Huérfanos Digitales. Su máscara, un panel LCD que alterna entre estática y fragmentos reconstruidos de los rostros de sus padres, se ha convertido en un símbolo del movimiento.',
                dialogo: 'No están muertos. No están vivos. Están atrapados en el limbo corporativo mientras nosotros quedamos aquí, con cuentas que pagar y corazones rotos. No somos anti-tecnología - somos pro-humanidad.'
            },
            {
                nombre: 'Iris "Glitch" Sato',
                faccion: 'Huérfanos Digitales',
                rol: 'Especialista en Recuperación de Conciencias',
                img: 'images/huerfanos_iris_glitch.png',
                desc: 'Ex-ingeniera de calibración de resleeving para Arasaka, Iris abandonó su lucrativa carrera después de descubrir que la empresa estaba ocultando deliberadamente la tasa de fallos en las transferencias de conciencia. Ahora se especializa en la delicada tarea de intentar recuperar fragmentos de conciencias dañadas.',
                dialogo: 'A veces, lo único que puedes salvar de alguien es un eco digital. Pero a veces, un eco es suficiente para recordar que existieron.'
            }
        ];

        // Utilidades para localStorage
        function getConocidosSeleccionados() {
            const val = localStorage.getItem('conocidosSeleccionados');
            return val ? JSON.parse(val) : [];
        }
        function getConocimientosSeleccionados() {
            const val = localStorage.getItem('conocimientosSeleccionados');
            return val ? JSON.parse(val) : [];
        }
        function setConocidosSeleccionados(arr) {
            localStorage.setItem('conocidosSeleccionados', JSON.stringify(arr));
        }
        function setConocimientosSeleccionados(arr) {
            localStorage.setItem('conocimientosSeleccionados', JSON.stringify(arr));
        }

        // Renderizar checkboxes
        function renderCheckboxList(list, containerId, cookieKey) {
            const container = document.getElementById(containerId);
            const selected = cookieKey === 'conocidosSeleccionados' ? getConocidosSeleccionados() : getConocimientosSeleccionados();
            
            if (cookieKey === 'conocimientosSeleccionados') {
                // Para conocimientos, mostrar personajes agrupados por facción
                const personajesPorFaccion = {};
                personajesFacciones.forEach(personaje => {
                    if (!personajesPorFaccion[personaje.faccion]) {
                        personajesPorFaccion[personaje.faccion] = [];
                    }
                    personajesPorFaccion[personaje.faccion].push(personaje);
                });
                
                container.innerHTML = Object.entries(personajesPorFaccion).map(([faccion, personajes]) => {
                    const faccionInfo = facciones.find(f => f.nombre === faccion);
                    return `
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <img src="${faccionInfo.img}" alt="${faccion}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;border:1px solid #444;">
                                <div>
                                    <h4 style="color: #ff4757; margin: 0; font-family: 'Orbitron', sans-serif;">${faccion}</h4>
                                    <p style="color: #aaa; margin: 5px 0 0 0; font-size: 12px;">${faccionInfo.desc}</p>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px;">
                                ${personajes.map(personaje => {
                                    const isSelected = selected.includes(personaje.nombre);
                                    return `
                                        <label style="display:flex;align-items:center;padding:8px;background:rgba(0,0,0,0.5);border:1px solid #555;border-radius:6px;cursor:pointer;gap:10px;transition:all 0.3s ease;">
                                            <input type="checkbox" value="${personaje.nombre.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" ${isSelected ? 'checked' : ''}
                                                data-nombre="${encodeURIComponent(personaje.nombre)}" data-cookiekey="${cookieKey}">
                                            <img src="${personaje.img}" alt="${personaje.nombre}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;border:1px solid #444;">
                                            <div style="flex:1;min-width:0;">
                                                <div style="font-weight:bold;color:#00ccff;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${personaje.nombre}</div>
                                                <div style="color:#ff4757;font-size:10px;margin:2px 0;">${personaje.rol}</div>
                                                <div style="color:#aaa;font-size:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${personaje.desc}</div>
                                            </div>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                // Para conocidos, mantener el comportamiento original
                container.innerHTML = list.map((item, idx) => {
                    const isSelected = selected.includes(item.nombre);
                    return '<label style="display:flex;align-items:center;margin-bottom:8px;cursor:pointer;gap:10px;">' +
                        '<input type="checkbox" value="' + item.nombre.replace(/"/g, '&quot;').replace(/'/g, '&#39;') + '" ' + (isSelected ? 'checked' : '') +
                        ' data-nombre="' + encodeURIComponent(item.nombre) + '" data-cookiekey="' + cookieKey + '">' +
                        '<img src="' + item.img + '" alt="' + item.nombre.replace(/"/g, '&quot;').replace(/'/g, '&#39;') + '" style="width:40px;height:40px;object-fit:cover;border-radius:6px;border:1px solid #444;">' +
                        '<span style="font-weight:bold;color:#00ccff;">' + item.nombre + '</span>' +
                        '<span style="font-size:12px;color:#aaa;margin-left:8px;">' + item.desc + '</span>' +
                        '</label>';
                }).join('');
            }
            
            // Agregar listeners después de renderizar
            const checkboxes = container.querySelectorAll('input[type="checkbox"][data-nombre][data-cookiekey]');
            checkboxes.forEach(cb => {
                cb.addEventListener('change', function() {
                    const nombre = decodeURIComponent(this.getAttribute('data-nombre'));
                    const key = this.getAttribute('data-cookiekey');
                    window.toggleSelection(key, nombre);
                });
            });
        }

        // Funciones de interacción
        window.toggleSelection = function(cookieKey, nombre) {
            let list = cookieKey === 'conocidosSeleccionados' ? getConocidosSeleccionados() : getConocimientosSeleccionados();
            const idx = list.indexOf(nombre);
            if(idx > -1) list.splice(idx,1); else list.push(nombre);
            if(cookieKey === 'conocidosSeleccionados') {
                setConocidosSeleccionados(list);
                if (window.saveConocidosSeleccionados) window.saveConocidosSeleccionados(list);
            } else {
                setConocimientosSeleccionados(list);
                if (window.saveConocimientosSeleccionados) window.saveConocimientosSeleccionados(list);
            }
            // Volver a renderizar para reflejar el cambio
            if(cookieKey === 'conocidosSeleccionados') renderCheckboxList(personajes, 'conocidos-list', 'conocidosSeleccionados');
            else renderCheckboxList(personajesFacciones, 'conocimientos-list', 'conocimientosSeleccionados');
        }

        function updateCurrentTest(testId) {
            localStorage.setItem('currentTest', testId);
            document.getElementById('objective-text').textContent = testObjectives[testId];
            if (window.saveCurrentTest) window.saveCurrentTest(testId);
        }

        function updateTimeOfDay(timeOfDay) {
            localStorage.setItem('timeOfDay', timeOfDay);
            console.log('🕐 Momento del día actualizado a:', timeOfDay);
            if (window.saveTimeOfDay) window.saveTimeOfDay(timeOfDay);
        }

        // Función FORZADA v1.58: Sobrescribir Firebase directamente
        function applyTimeOfDay() {
            const selector = document.getElementById('time-of-day');
            const selectedValue = selector.value;
            
            console.log('🚨 FORZANDO ESCRITURA DIRECTA A FIREBASE v1.58');
            console.log('📍 Valor del dropdown:', selectedValue);
            console.log('📍 localStorage ANTES:', localStorage.getItem('timeOfDay'));
            
            // MÉTODO 1: Escritura directa agresiva a Firebase
            if (window.saveTimeOfDay) {
                console.log('🔥 ESCRIBIENDO DIRECTAMENTE A FIREBASE:', selectedValue);
                window.saveTimeOfDay(selectedValue);
            } else {
                console.error('❌ window.saveTimeOfDay no disponible');
            }
            
            // MÉTODO 2: Sobrescribir localStorage también
            localStorage.removeItem('timeOfDay'); // Limpiar primero
            localStorage.setItem('timeOfDay', selectedValue); // Establecer nuevo
            
            console.log('📍 localStorage DESPUÉS:', localStorage.getItem('timeOfDay'));
            console.log('📊 Valor FORZADO:', {
                dropdown: selectedValue,
                localStorage: localStorage.getItem('timeOfDay'),
                timestamp: Date.now()
            });
            
            // Confirmación visual
            const originalBg = selector.style.backgroundColor;
            selector.style.backgroundColor = '#ff4757'; // Rojo para mostrar acción forzada
            setTimeout(() => {
                selector.style.backgroundColor = originalBg;
            }, 1000);
            
            alert(`🚨 FORZADO: ${selectedValue.toUpperCase()}\n\n⚠️ Si no funciona, hay problema en Firebase.`);
        }
        
        // Función de DEBUGGING: Ver qué tiene Firebase almacenado
        function debugFirebaseTimeOfDay() {
            console.log('🔍 DEBUGGING FIREBASE TIMEOFDAY:');
            console.log('📍 localStorage actual:', localStorage.getItem('timeOfDay'));
            console.log('📍 Dropdown actual:', document.getElementById('time-of-day').value);
            
            // Intentar leer directamente de Firebase si es posible
            if (window.database && typeof window.database === 'object') {
                console.log('🔥 Firebase database disponible');
                // Aquí podríamos hacer una lectura directa si necesario
            } else {
                console.log('❌ Firebase database no accesible desde aquí');
            }
        }
        
        // Hacer la función disponible globalmente para testing
        window.debugFirebaseTimeOfDay = debugFirebaseTimeOfDay;
        
        // FUNCIÓN DE EMERGENCIA: Resetear Firebase timeOfDay
        function resetFirebaseTimeOfDay() {
            console.log('🚨 RESETEANDO FIREBASE TIMEOFDAY COMPLETAMENTE...');
            
            // Método 1: Establecer a 'dia' por defecto
            if (window.saveTimeOfDay) {
                console.log('🔥 Método 1: Forzando "dia" en Firebase...');
                window.saveTimeOfDay('dia');
                
                setTimeout(() => {
                    console.log('🔄 Estableciendo localStorage a "dia"...');
                    localStorage.removeItem('timeOfDay');
                    localStorage.setItem('timeOfDay', 'dia');
                    
                    console.log('🔄 Estableciendo dropdown a "dia"...');
                    document.getElementById('time-of-day').value = 'dia';
                    
                    console.log('✅ Reset completo ejecutado');
                }, 1000);
            }
            
            alert('🚨 RESET FIREBASE EJECUTADO\n\nEspera 3 segundos y recarga ambas páginas.');
        }
        
        // FUNCIÓN DE EMERGENCIA: Borrar completamente la entrada de Firebase
        function deleteFirebaseTimeOfDay() {
            console.log('💀 BORRANDO ENTRADA FIREBASE TIMEOFDAY...');
            
            if (window.saveTimeOfDay) {
                // Intentar borrar estableciendo null
                console.log('🔥 Enviando null a Firebase...');
                window.saveTimeOfDay(null);
                
                setTimeout(() => {
                    console.log('🔄 Reestableciendo con "dia"...');
                    window.saveTimeOfDay('dia');
                    localStorage.setItem('timeOfDay', 'dia');
                    document.getElementById('time-of-day').value = 'dia';
                }, 2000);
            }
            
            alert('💀 BORRADO FIREBASE EJECUTADO\n\nEspera 5 segundos y recarga ambas páginas.');
        }
        
        // Hacer funciones disponibles globalmente
        window.resetFirebaseTimeOfDay = resetFirebaseTimeOfDay;
        window.deleteFirebaseTimeOfDay = deleteFirebaseTimeOfDay;

        // Función para cargar y mostrar los últimos mensajes del chat (solo para el panel de control)
        function loadChatMessages() {
            let mensajes = [];
            try {
                mensajes = JSON.parse(localStorage.getItem('mensajes-publico-expanded') || '[]');
                if (!Array.isArray(mensajes)) mensajes = [];
            } catch (e) {
                mensajes = [];
            }
            
            const chat = document.getElementById('chat-messages');
            if (!chat) return;
            
            // Limpiar completamente el chat del PANEL DE CONTROL antes de recargar
            chat.innerHTML = '';
            
            if (!mensajes || mensajes.length === 0) {
                chat.innerHTML = '<div style="color:#888;font-size:13px;text-align:center;">(El chat global está vacío)</div>';
                return;
            }
            
            // Renderizar solo los últimos mensajes (admin + jugador) EN EL PANEL DE CONTROL
            const messagesHTML = mensajes.map(msg => {
                // Determinar el color y estilo según el tipo de mensaje
                let usernameColor = '#cccccc';
                let backgroundColor = 'transparent';
                let borderLeft = '';
                let statusLabel = '';
                
                if (msg.isPlayerMessage || (msg.sender || '').toLowerCase() === 'xiii') {
                    usernameColor = '#00ccff';
                    backgroundColor = 'rgba(0, 204, 255, 0.1)';
                    borderLeft = 'border-left: 3px solid #00ccff;';
                    statusLabel = ' (JUGADOR)';
                } else if (msg.isAdminMessage) {
                    usernameColor = '#00ff00';
                    backgroundColor = 'rgba(0, 255, 0, 0.1)';
                    borderLeft = 'border-left: 3px solid #00ff00;';
                    statusLabel = ' (ÚLTIMO ENVIADO)';
                }
                
                return `<div class="chat-message" style="background: ${backgroundColor}; ${borderLeft} padding: 8px; margin: 2px 0; border-radius: 4px;">
                    <span class="username" style="color: ${usernameColor}; font-weight: bold;">${msg.sender || msg.user || 'SISTEMA'}:</span> 
                    <span class="content" style="margin-left: 8px;">${msg.content || msg.text || ''}</span> 
                    <span style="float:right;font-size:11px;color:#888;">${msg.time || ''}${statusLabel}</span>
                </div>`;
            }).join('');
            
            chat.innerHTML = messagesHTML;
            chat.scrollTop = chat.scrollHeight;
            
            console.log(`📧 Panel de control actualizado con ${mensajes.length} últimos mensajes`);
        }
        window.loadChatMessages = loadChatMessages;

        // Modificar la función sendMessage para enviar mensaje temporal sin guardar
        function sendMessage() {
            const message = document.getElementById('message-input').value.trim();
            const usernameInput = document.getElementById('public-username-input');
            let sender = usernameInput.value.trim() || 'SISTEMA';
            
            if (!message) {
                alert('Por favor, escribe un mensaje');
                return;
            }
            
            try {
                // Crear mensaje del admin
                const newMessage = {
                    sender: sender,
                    content: message,
                    time: new Date().toLocaleTimeString(),
                    timestamp: Date.now(),
                    isAdminMessage: true
                };
                
                // Chat normal: simplemente añadir el mensaje al final
                const existingMessages = JSON.parse(localStorage.getItem('mensajes-publico-expanded') || '[]');
                existingMessages.push(newMessage);
                
                // Guardar todos los mensajes
                localStorage.setItem('mensajes-publico-expanded', JSON.stringify(existingMessages));
                
                console.log('📤 ENVIANDO A FIREBASE - Total mensajes:', existingMessages.length);
                console.log('📤 Último mensaje:', newMessage);
                console.log('📤 Array completo a Firebase:', existingMessages);
                
                if (window.saveChat) {
                    window.saveChat(existingMessages);
                    console.log('✅ Función saveChat ejecutada');
                } else {
                    console.error('❌ window.saveChat no disponible');
                }
                
                // Actualizar solo el panel de control (Firebase se encarga del resto)
                loadChatMessages();
                
                // Limpiar formulario
                document.getElementById('message-input').value = '';
                localStorage.setItem('lastPublicUsername', sender);
                
                console.log('✅ Proceso completo - Mensaje del admin enviado:', newMessage.content);
            } catch (error) {
                console.error('❌ Error al enviar mensaje temporal:', error);
                alert('Error al enviar el mensaje');
            }
        }
        
        // Función para mostrar mensaje temporal en el control panel
        function displayTemporaryMessage(message) {
            const chat = document.getElementById('chat-messages');
            if (!chat) return;
            
            const messageHTML = `<div class="chat-message temp-message" style="background: rgba(0, 255, 0, 0.1); border-left: 2px solid #00ff00; padding: 8px; margin: 2px 0; border-radius: 4px; opacity: 0.9;">
                <span class="username" style="color: #00ff00; font-weight: bold;">${message.sender}:</span> 
                <span class="content" style="margin-left: 8px;">${message.content}</span> 
                <span style="float:right;font-size:11px;color:#888;">${message.time} (ENVIADO)</span>
            </div>`;
            
            chat.insertAdjacentHTML('beforeend', messageHTML);
            chat.scrollTop = chat.scrollHeight;
            
            // Remover el mensaje temporal después de 10 segundos
            setTimeout(() => {
                const tempMessages = chat.querySelectorAll('.temp-message');
                if (tempMessages.length > 0) {
                    tempMessages[0].remove();
                }
            }, 10000);
        }

        function sendPMMessage() {
            const pmAmount = document.getElementById('pm-input').value.trim();
            const message = document.getElementById('pm-message-input').value.trim();
            const usernameInput = document.getElementById('pm-username-input');
            let sender = usernameInput.value.trim() || 'SISTEMA';
            
            if (!pmAmount || !message) {
                alert('Por favor, completa tanto el monto de PM como el mensaje');
                return;
            }
            
            if (isNaN(pmAmount) || parseInt(pmAmount) <= 0) {
                alert('Por favor, ingresa un monto de PM válido');
                return;
            }
            
            try {
                // Crear mensaje del admin con PM (formato compatible con botón de aceptar)
                const fullContent = `${message} ¡+${pmAmount} PM!`;
                const newMessage = {
                    sender: sender,
                    content: fullContent,
                    time: new Date().toLocaleTimeString(),
                    timestamp: Date.now(),
                    isAdminMessage: true
                };
                
                // Chat normal: simplemente añadir el mensaje al final
                const existingMessages = JSON.parse(localStorage.getItem('mensajes-publico-expanded') || '[]');
                existingMessages.push(newMessage);
                
                // Guardar todos los mensajes
                localStorage.setItem('mensajes-publico-expanded', JSON.stringify(existingMessages));
                
                console.log('📤 ENVIANDO PM A FIREBASE - Total mensajes:', existingMessages.length);
                console.log('📤 Mensaje PM:', newMessage);
                
                if (window.saveChat) {
                    window.saveChat(existingMessages);
                    console.log('✅ Función saveChat ejecutada para PM');
                } else {
                    console.error('❌ window.saveChat no disponible para PM');
                }
                
                // NO actualizar PM automáticamente - el jugador debe hacer clic en "Aceptar"
                // statsManager.updatePM(pmAmount); // Comentado - ahora se suma cuando acepta
                
                // Actualizar solo el panel de control (Firebase se encarga del resto)
                loadChatMessages();
                
                // Limpiar formulario
                document.getElementById('pm-input').value = '';
                document.getElementById('pm-message-input').value = '';
                localStorage.setItem('lastPMUsername', sender);
                
                console.log('✅ Proceso completo - Mensaje PM del admin enviado con botón de aceptar:', newMessage.content);
                console.log('🎯 El jugador debe hacer clic en "Aceptar" para recibir los PM');
            } catch (error) {
                console.error('❌ Error al enviar mensaje temporal de PM:', error);
                alert('Error al enviar el mensaje');
            }
        }

        function sendDirectMessage() {
            const sender = document.getElementById('dm-custom-sender').value.trim();
            const content = document.getElementById('dm-content').value.trim();
            
            if (!sender) {
                alert('Por favor, escribe el nombre del remitente');
                return;
            }
            
            if (!content) {
                alert('Por favor, escribe un mensaje');
                return;
            }
            
            try {
                // Usar el nuevo sistema de mensajes directos
                const directMessages = JSON.parse(localStorage.getItem('directMessages') || '{"inbox":[],"system":[],"shop":[],"personal":[]}');
                
                // Crear mensaje para el nuevo sistema
                const messageObj = {
                    id: Date.now() + Math.random(),
                    sender: sender,
                    content: content,
                    timestamp: Date.now(),
                    time: new Date().toLocaleString(),
                    type: 'personal',
                    category: 'personal'
                };
                
                // Añadir a personal Y a inbox para que aparezca en "Bandeja de entrada"
                if (!directMessages.personal) {
                    directMessages.personal = [];
                }
                if (!directMessages.inbox) {
                    directMessages.inbox = [];
                }
                
                directMessages.personal.unshift(messageObj);
                // También añadir a inbox para que aparezca en "Bandeja de entrada"
                directMessages.inbox.unshift({...messageObj, category: 'personal'});
                
                // Guardar en localStorage
                localStorage.setItem('directMessages', JSON.stringify(directMessages));
                
                // Intentar conectar con Firebase si está disponible
                if (window.database) {
                    // También guardarlo en el sistema antiguo para compatibilidad
                    const oldMessages = JSON.parse(localStorage.getItem('mensajes-directos') || '[]');
                    oldMessages.push({
                        sender: sender,
                        content: content,
                        time: new Date().toLocaleTimeString(),
                        type: 'admin'
                    });
                    localStorage.setItem('mensajes-directos', JSON.stringify(oldMessages));
                    
                    // Guardar en Firebase
                    if (window.saveMensajesDirectos) {
                        window.saveMensajesDirectos(oldMessages);
                    }
                }
                
                // Limpiar el formulario
                document.getElementById('dm-custom-sender').value = '';
                document.getElementById('dm-content').value = '';
                
                // Notificar éxito
                alert(`Mensaje personal enviado correctamente desde "${sender}"`);
                
                console.log('✅ Mensaje directo enviado:', messageObj);
            } catch (error) {
                console.error('❌ Error al enviar mensaje directo:', error);
                alert('Error al enviar el mensaje');
            }
        }

        function updateDirectPM() {
            const pmAmount = document.getElementById('pm-direct-input').value;
            if (pmAmount && !isNaN(pmAmount)) {
                const newTotal = parseInt(pmAmount);
                    const description = prompt('Descripción del ajuste:', 'Ajuste directo de PM');
                    if (description !== null) {
                    // Usar la función establecerPM que maneja la lógica correctamente
                    if (window.establecerPM) {
                        window.establecerPM(newTotal);
                    } else {
                        // Fallback al sistema de transacciones
                        window.pmTransactions.setTotal(newTotal);
                    }
                        
                        document.getElementById('pm-direct-input').value = '';
                        updateUserList();
                        
                        // Notificar a la tienda si está abierta
                        if (window.parent) {
                            window.parent.postMessage({
                                type: 'updatePM',
                                value: newTotal
                            }, '*');
                        }
                    
                    console.log(`✅ PM establecido a: ${newTotal}`);
                }
            }
        }

        function addPM() {
            const pmAmount = document.getElementById('pm-add-input').value;
            if (pmAmount && !isNaN(pmAmount)) {
                const amount = parseInt(pmAmount);
                const description = prompt('Descripción de la transacción:', 'Sumar PM');
                if (description !== null) {
                    // Usar la función sumarPM que maneja la lógica correctamente
                    if (window.sumarPM) {
                        window.sumarPM(amount, description);
                    } else {
                        // Fallback al sistema de transacciones
                        window.pmTransactions.addTransaction(amount, description);
                    }
                    
                    document.getElementById('pm-add-input').value = '';
                    updateUserList();
                    console.log(`✅ PM sumado: +${amount}`);
                }
            }
        }

        function subtractPM() {
            const pmAmount = document.getElementById('pm-add-input').value;
            if (pmAmount && !isNaN(pmAmount)) {
                const amount = parseInt(pmAmount);
                const description = prompt('Descripción de la transacción:', 'Restar PM');
                if (description !== null) {
                    // Usar la función restarPM que maneja la lógica correctamente
                    if (window.restarPM) {
                        window.restarPM(amount, description);
                    } else {
                        // Fallback al sistema de transacciones
                        window.pmTransactions.addTransaction(-amount, description);
                    }
                    
                    document.getElementById('pm-add-input').value = '';
                    updateUserList();
                    console.log(`✅ PM restado: -${amount}`);
                }
            }
        }

        function updateSpectators() {
            const spectators = document.getElementById('spectators-input').value;
            persistentStorage.updateAudience(spectators);
            if (window.saveAudience) window.saveAudience(parseInt(spectators));
            document.getElementById('spectators-input').value = '';
            updateUserList();
        }

        function updateRating() {
            const rating = document.getElementById('rating-input').value;
            persistentStorage.updateRating(rating);
            if (window.saveRating) window.saveRating(parseFloat(rating));
            document.getElementById('rating-input').value = '';
            updateUserList();
        }

        // Inicializar inmediatamente al cargar la página
        persistentStorage.init();
        updateUserList();
        loadChatMessages(); // Cargar mensajes del chat al inicio
        
        // También inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            persistentStorage.init();
            updateUserList();
            loadChatMessages(); // Cargar mensajes del chat cuando el DOM esté listo
            
            // Cargar valores actuales en los inputs
            document.getElementById('spectators-input').value = persistentStorage.data.audience;
            document.getElementById('rating-input').value = persistentStorage.data.rating;
            
            // Cargar la prueba actual
            const currentTest = localStorage.getItem('currentTest') || 'prueba0';
            document.getElementById('current-test').value = currentTest;
            document.getElementById('objective-text').textContent = testObjectives[currentTest];

            // Cargar el último usuario usado en los campos de usuario
            const lastPublicUsername = localStorage.getItem('lastPublicUsername') || '';
            document.getElementById('public-username-input').value = lastPublicUsername;
            const lastPMUsername = localStorage.getItem('lastPMUsername') || '';
            document.getElementById('pm-username-input').value = lastPMUsername;

            // Cargar el momento del día actual
            const currentTimeOfDay = localStorage.getItem('timeOfDay') || 'dia';
            document.getElementById('time-of-day').value = currentTimeOfDay;

            // Renderizar las listas de conocidos y conocimientos
            renderCheckboxList(personajes, 'conocidos-list', 'conocidosSeleccionados');
            renderCheckboxList(personajesFacciones, 'conocimientos-list', 'conocimientosSeleccionados');
        });

        // PANEL DE CONTROL v0.95 - ELIMINADOS MENSAJES HARDCODEADOS
        // Los mensajes ahora vienen exclusivamente del sistema contextual del juego principal
    </script>
    <script type="module">
        // Funciones para guardar en Firebase
        window.saveConcursanteName = function(numero, nombre) {
            window.database.ref(`nombresConcursantes/${numero}`).set(nombre);
        };
        window.saveAudience = function(valor) { window.audienceRef.set(valor); };
        window.saveRating = function(valor) { window.ratingRef.set(valor); };
        window.savePM = function(valor) { window.pmRef.set(valor); };
        window.saveChat = function(arr) { window.chatRef.set(arr); };
        window.saveConocidosSeleccionados = function(arr) { window.conocidosRef.set(arr); };
        window.saveConocimientosSeleccionados = function(arr) { window.conocimientosRef.set(arr); };
        window.saveMensajesDirectos = function(arr) { window.mensajesRef.set(arr); };
        window.saveCurrentTest = function(valor) { window.currentTestRef.set(valor); };
        window.saveTimeOfDay = function(valor) { window.timeOfDayRef.set(valor); };
        window.saveMessageFilters = function(filters) { window.messageFiltersRef.set(filters); };

        // Listeners para sincronización en tiempo real
        window.conocidosRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localStorage.setItem('conocidosSeleccionados', JSON.stringify(data));
                renderCheckboxList(personajes, 'conocidos-list', 'conocidosSeleccionados');
            }
        });

        window.conocimientosRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localStorage.setItem('conocimientosSeleccionados', JSON.stringify(data));
                renderCheckboxList(personajesFacciones, 'conocimientos-list', 'conocimientosSeleccionados');
            }
        });

        window.mensajesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localStorage.setItem('mensajes-directos', JSON.stringify(data));
            }
        });

        window.currentTestRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localStorage.setItem('currentTest', data);
                document.getElementById('current-test').value = data;
                document.getElementById('objective-text').textContent = testObjectives[data];
            }
        });

        window.timeOfDayRef.on('value', (snapshot) => {
            const data = snapshot.val();
            console.log('🔥 FIREBASE LISTENER ACTIVADO - timeOfDay:', data);
            console.log('📍 localStorage antes del listener:', localStorage.getItem('timeOfDay'));
            console.log('📍 Dropdown antes del listener:', document.getElementById('time-of-day').value);
            
            if (data) {
                localStorage.setItem('timeOfDay', data);
                document.getElementById('time-of-day').value = data;
                console.log('✅ FIREBASE SOBRESCRIBIÓ CON:', data);
                console.log('📍 localStorage después:', localStorage.getItem('timeOfDay'));
                console.log('📍 Dropdown después:', document.getElementById('time-of-day').value);
            } else {
                console.log('⚠️ Firebase timeOfDay es null/undefined');
            }
        });

        window.messageFiltersRef.on('value', (snapshot) => {
            const data = snapshot.val();
            console.log('🔥 FIREBASE LISTENER ACTIVADO - messageFilters:', data);
            
            if (data) {
                // Actualizar sistema local
                MESSAGE_FILTERS.enabledCategories = data;
                localStorage.setItem('messageFilters', JSON.stringify(data));
                
                // Actualizar checkboxes visuales
                Object.keys(data).forEach(category => {
                    const checkbox = document.getElementById(`filter-${category}`);
                    if (checkbox) {
                        checkbox.checked = data[category];
                    }
                });
                
                console.log('✅ FIREBASE SOBRESCRIBIÓ FILTROS CON:', data);
            } else {
                console.log('⚠️ Firebase messageFilters es null/undefined - Inicializando...');
                
                // Si Firebase está vacío, inicializar con valores por defecto
                const defaultFilters = MESSAGE_FILTERS.enabledCategories;
                window.messageFiltersRef.set(defaultFilters).then(() => {
                    console.log('✅ CONTROL PANEL inicializó filtros en Firebase:', defaultFilters);
                }).catch(error => {
                    console.error('❌ Error inicializando filtros en Firebase:', error);
                });
            }
        });

        window.nombresRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                Object.entries(data).forEach(([numero, nombre]) => {
                    localStorage.setItem(`nombreConcursante_${numero}`, nombre);
                });
            }
        });

        window.audienceRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data !== null) {
                localStorage.setItem('spectators', data);
                persistentStorage.data.audience = parseInt(data);
                document.getElementById('spectators-input').value = data;
                updateUserList();
            }
        });

        window.ratingRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data !== null) {
                localStorage.setItem('rating', data);
                persistentStorage.data.rating = parseFloat(data);
                document.getElementById('rating-input').value = data;
                updateUserList();
            }
        });

        window.pmRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data !== null) {
                localStorage.setItem('playerPM', data);
                persistentStorage.data.playerPM = parseInt(data);
                updateUserList();
            }
        });

        window.chatRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localStorage.setItem('mensajes-publico-expanded', JSON.stringify(data));
                loadChatMessages(); // Actualizar el chat cuando cambie en Firebase
            }
        });
    </script>
    <script>
        // Conectar con las funciones PM del iframe padre si están disponibles
        if (window.parent && window.parent !== window) {
            // Intentar acceder a las funciones PM del padre
            window.sumarPM = window.parent.sumarPM;
            window.restarPM = window.parent.restarPM;
            window.establecerPM = window.parent.establecerPM;
            window.pmTransactions = window.parent.pmTransactions;
            
            console.log('🔗 Conectado con sistema PM del iframe padre:', {
                sumarPM: !!window.sumarPM,
                restarPM: !!window.restarPM,
                establecerPM: !!window.establecerPM,
                pmTransactions: !!window.pmTransactions
            });
        } else {
            console.log('⚠️ No se encontró iframe padre, usando funciones locales');
        }

        // Crear funciones PM locales si no están disponibles desde el padre
        if (!window.sumarPM) {
            window.sumarPM = function(cantidad, razon) {
                const currentPM = parseInt(localStorage.getItem('playerPM') || '0');
                const newTotal = currentPM + cantidad;
                localStorage.setItem('playerPM', newTotal.toString());
                if (window.savePM) window.savePM(newTotal);
                console.log(`✅ PM sumado localmente: +${cantidad} (Total: ${newTotal})`);
                return newTotal;
            };
        }

        if (!window.restarPM) {
            window.restarPM = function(cantidad, razon) {
                const currentPM = parseInt(localStorage.getItem('playerPM') || '0');
                const newTotal = Math.max(0, currentPM - cantidad);
                localStorage.setItem('playerPM', newTotal.toString());
                if (window.savePM) window.savePM(newTotal);
                console.log(`✅ PM restado localmente: -${cantidad} (Total: ${newTotal})`);
                return newTotal;
            };
        }

        if (!window.establecerPM) {
            window.establecerPM = function(total) {
                localStorage.setItem('playerPM', total.toString());
                if (window.savePM) window.savePM(total);
                console.log(`✅ PM establecido localmente: ${total}`);
                return total;
            };
        }

        // Funciones originales
        if (typeof updateUserList === 'function') window.updateUserList = updateUserList;
        if (typeof renderCheckboxList === 'function') window.renderCheckboxList = renderCheckboxList;
        if (typeof updateCurrentTest === 'function') window.updateCurrentTest = updateCurrentTest;
        if (typeof sendMessage === 'function') window.sendMessage = sendMessage;
        if (typeof sendPMMessage === 'function') window.sendPMMessage = sendPMMessage;
        if (typeof sendDirectMessage === 'function') window.sendDirectMessage = sendDirectMessage;
        if (typeof addPM === 'function') window.addPM = addPM;
        if (typeof subtractPM === 'function') window.subtractPM = subtractPM;
        if (typeof updateSpectators === 'function') window.updateSpectators = updateSpectators;
        if (typeof updateRating === 'function') window.updateRating = updateRating;

        // === SISTEMA DE FILTROS DE MENSAJES ===
        
        // Inicializar sistema de filtros
        window.MESSAGE_FILTERS = {
            enabledCategories: {
                'fan': true,
                'picante': true,
                'humillante': true,
                'relleno': true,
                'queja': true,
                'divertido': true,
                'insulto': true
            },
            
            setFilter: function(category, enabled) {
                this.enabledCategories[category] = enabled;
                localStorage.setItem('messageFilters', JSON.stringify(this.enabledCategories));
                console.log(`🎛️ Filtro ${category}: ${enabled ? 'ACTIVADO' : 'DESACTIVADO'}`);
                
                // Notificar a otros sistemas si existen
                if (window.contextualSystem && typeof window.contextualSystem.refreshMessages === 'function') {
                    window.contextualSystem.refreshMessages();
                }
            },
            
            getEnabledCategories: function() {
                return this.enabledCategories;
            },
            
            loadFromStorage: function() {
                const saved = localStorage.getItem('messageFilters');
                if (saved) {
                    try {
                        this.enabledCategories = JSON.parse(saved);
                        this.updateCheckboxes();
                    } catch (e) {
                        console.error('Error loading message filters:', e);
                    }
                }
            },
            
            updateCheckboxes: function() {
                Object.keys(this.enabledCategories).forEach(category => {
                    const checkbox = document.getElementById(`filter-${category}`);
                    if (checkbox) {
                        checkbox.checked = this.enabledCategories[category];
                    }
                });
            }
        };

        // Funciones para el manejo de filtros
        function toggleMessageFilter(category, enabled) {
            MESSAGE_FILTERS.setFilter(category, enabled);
            
            // *** SINCRONIZAR CON FIREBASE (igual que timeOfDay) ***
            if (window.saveMessageFilters) {
                window.saveMessageFilters(MESSAGE_FILTERS.enabledCategories);
            }
        }

        function enableAllFilters() {
            Object.keys(MESSAGE_FILTERS.enabledCategories).forEach(category => {
                MESSAGE_FILTERS.setFilter(category, true);
                const checkbox = document.getElementById(`filter-${category}`);
                if (checkbox) checkbox.checked = true;
            });
            // *** SINCRONIZAR CON FIREBASE ***
            if (window.saveMessageFilters) {
                window.saveMessageFilters(MESSAGE_FILTERS.enabledCategories);
            }
        }

        function disableAllFilters() {
            Object.keys(MESSAGE_FILTERS.enabledCategories).forEach(category => {
                MESSAGE_FILTERS.setFilter(category, false);
                const checkbox = document.getElementById(`filter-${category}`);
                if (checkbox) checkbox.checked = false;
            });
            // *** SINCRONIZAR CON FIREBASE ***
            if (window.saveMessageFilters) {
                window.saveMessageFilters(MESSAGE_FILTERS.enabledCategories);
            }
        }

        function resetFiltersToDefault() {
            Object.keys(MESSAGE_FILTERS.enabledCategories).forEach(category => {
                MESSAGE_FILTERS.setFilter(category, true);
                const checkbox = document.getElementById(`filter-${category}`);
                if (checkbox) checkbox.checked = true;
            });
            // *** SINCRONIZAR CON FIREBASE ***
            if (window.saveMessageFilters) {
                window.saveMessageFilters(MESSAGE_FILTERS.enabledCategories);
            }
        }

        // Inicializar filtros al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            MESSAGE_FILTERS.loadFromStorage();
            
            // Mostrar estado inicial en consola
            console.log('🎛️ Sistema de filtros inicializado:', MESSAGE_FILTERS.getEnabledCategories());
        });

        // Exponer funciones globalmente para compatibilidad
        window.toggleMessageFilter = toggleMessageFilter;
        window.enableAllFilters = enableAllFilters;
        window.disableAllFilters = disableAllFilters;
        window.resetFiltersToDefault = resetFiltersToDefault;
    </script>

    <!-- Add the ranking system script -->
    <script src="ranking-system.js"></script>
    <script>
        // Function to render the editable ranking table
        function renderAdminRanking() {
            const tableBody = document.getElementById('rankingTableBody');
            if (!tableBody) {
                console.error('No se encontró el elemento rankingTableBody');
                return;
            }

            const ranking = rankingSystem.getRanking();
            console.log('Renderizando tabla con ranking:', ranking);
            tableBody.innerHTML = '';

            ranking.forEach((participant, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <input type="number" 
                               id="number-input-${participant.number}"
                               value="${participant.number}" 
                               min="1" max="999">
                    </td>
                    <td>
                        <input type="number" 
                               id="pm-input-${participant.number}"
                               value="${participant.pm}" 
                               min="0">
                    </td>
                    <td>
                        <button onclick="saveParticipantData(${participant.number}, this)">Guardar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Function to update participant's PM
        function updateParticipantPM(number, newPM) {
            console.log(`Intentando actualizar PM para #${number} a ${newPM}`);
            if (newPM < 0) {
                console.error('Valor negativo no permitido');
                return false;
            }
            return rankingSystem.updateParticipantPM(number, parseInt(newPM));
        }

        // Function to update participant's number
        function updateParticipantNumber(oldNumber, newNumber) {
            console.log(`Intentando actualizar número de participante de #${oldNumber} a #${newNumber}`);
            if (newNumber < 1 || newNumber > 999) {
                console.error('Número fuera del rango permitido (1-999)');
                return false;
            }
            return rankingSystem.updateParticipantNumber(oldNumber, parseInt(newNumber));
        }

        // Function to save participant's data (number and PM)
        async function saveParticipantData(number, button) {
            console.log(`Iniciando guardado para participante #${number}`);
            const pmInput = document.getElementById(`pm-input-${number}`);
            const numberInput = document.getElementById(`number-input-${number}`);
            
            if (!pmInput || !numberInput) {
                console.error(`No se encontraron los inputs para el participante #${number}`);
                return;
            }

            const newPM = parseInt(pmInput.value);
            const newNumber = parseInt(numberInput.value);
            
            if (isNaN(newPM) || newPM < 0) {
                alert('Por favor, introduce un PM válido mayor o igual a 0');
                return;
            }
            
            if (isNaN(newNumber) || newNumber < 1 || newNumber > 999) {
                alert('Por favor, introduce un número de participante válido entre 1 y 999');
                return;
            }

            // Deshabilitar el botón mientras se guarda
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Guardando...';
            button.style.backgroundColor = '#666';

            try {
                let updateSuccess = true;
                
                // Actualizar el número si ha cambiado
                if (newNumber !== number) {
                    console.log(`Intentando actualizar número de participante de #${number} a #${newNumber}`);
                    if (!updateParticipantNumber(number, newNumber)) {
                        throw new Error(`No se pudo actualizar el número del participante #${number}`);
                    }
                }
                
                // Actualizar el PM
                console.log(`Intentando actualizar PM para #${newNumber} a ${newPM}`);
                if (!updateParticipantPM(newNumber, newPM)) {
                    throw new Error(`No se pudo actualizar el PM del participante #${newNumber}`);
                }
                
                if (updateSuccess) {
                    console.log('Actualización local exitosa, guardando en Firebase...');
                    // Esperar a que se complete la operación en Firebase
                    await rankingSystem.saveRanking();
                    
                    console.log('Guardado en Firebase exitoso');
                    // Feedback visual de éxito
                    button.textContent = '¡Guardado!';
                    button.style.backgroundColor = '#2ed573';
                    
                    // Si el número cambió, actualizar la tabla
                    if (newNumber !== number) {
                        setTimeout(() => {
                            renderAdminRanking();
                        }, 1000);
                    }
                    
                    setTimeout(() => {
                        button.disabled = false;
                        button.textContent = originalText;
                        button.style.backgroundColor = '';
                    }, 1500);
                }
            } catch (error) {
                console.error('Error detallado al guardar:', error);
                alert(`Error al guardar: ${error.message}`);
                button.textContent = 'Error';
                button.style.backgroundColor = '#ff4757';
                
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                    button.style.backgroundColor = '';
                }, 1500);
            }
        }

        // Initialize the admin ranking table
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Inicializando panel de control...');
            if (rankingSystem) {
                rankingSystem.init(); // Inicializar el sistema de ranking
                renderAdminRanking(); // Renderizar la tabla inicial
            } else {
                console.error('Sistema de ranking no disponible');
            }
        });
    </script>
</body>
</html> 