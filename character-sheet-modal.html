<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Sheet Modal - Ultimate Mercenary 1.61</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            font-family: 'Roboto', sans-serif;
        }

        .character-sheet {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .sheet-header {
            text-align: center;
            margin-bottom: 0;
        }

        .sheet-header h1 {
            color: #00ccff;
            font-family: 'Orbitron', sans-serif;
            font-size: 32px;
            margin: 0;
            text-transform: uppercase;
        }

        .sheet-header h2 {
            color: #ff4757;
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            margin: 10px 0 0 0;
        }

        .section {
            background-color: rgba(30, 30, 30, 0.8);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .section h2 {
            color: #00ccff;
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            margin: 0 0 20px 0;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .item {
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 15px;
        }

        .item h3 {
            color: #ff4757;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            margin: 0 0 5px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item p {
            color: #fff;
            margin: 5px 0;
            font-size: 14px;
        }

        .item .value {
            color: #00ccff;
            font-weight: bold;
        }

        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 0, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 1000;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(
                circle at center,
                transparent 0%,
                rgba(0, 0, 0, 0.3) 100%
            );
            pointer-events: none;
            z-index: 999;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .tab {
            display: inline-block;
            padding: 10px 20px;
            margin: 0 5px;
            cursor: pointer;
            border: 1px solid #00ffff;
            border-radius: 4px;
            color: #00ffff;
            background: rgba(0, 0, 0, 0.7);
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #00ffff;
            color: #111;
            font-weight: bold;
            box-shadow: 0 0 10px #00ffff;
        }

        .tab:hover {
            background: rgba(0,255,255,0.2);
            color: #fff;
        }

        .tab-content {
            display: none;
            background: rgba(0,0,0,0.85);
            border: 1px solid #00ffff;
            border-radius: 8px;
            color: #e0f7fa;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,255,255,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .skill-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 5px;
        }

        .skill-total {
            color: #00ccff;
            font-size: 12px;
            white-space: nowrap;
        }

        .skill-value {
            width: 50px;
            padding: 2px;
            font-size: 14px;
        }

        .skill-group {
            margin-bottom: 15px;
        }

        .skill-group .item {
            margin-bottom: 8px;
            padding: 8px;
        }

        .skill-group .item h3 {
            font-size: 12px;
            margin-bottom: 3px;
        }

        .points-counter {
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ccff;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .points-counter h3 {
            color: #00ccff;
            margin: 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
        }

        .points-counters {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .save-button {
            padding: 10px 20px;
            background-color: #00ccff;
            color: #000;
            border: none;
            border-radius: 4px;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
        }

        .save-button:hover {
            background-color: #ff4757;
            color: #fff;
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.7);
        }

        .reset-button {
            padding: 10px 20px;
            background-color: rgba(255, 165, 0, 0.8);
            color: #000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
        }

        .reset-button:hover {
            background-color: rgba(255, 165, 0, 1);
            box-shadow: 0 0 15px rgba(255, 165, 0, 0.7);
        }

        .button-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: rgba(30, 30, 30, 0.8);
            border: 1px solid #444;
            border-radius: 8px;
        }

        .field-input {
            background-color: #333;
            color: #00ccff;
            border: 1px solid #555;
            border-radius: 2px;
            padding: 2px 4px;
            font-family: 'Roboto', sans-serif;
        }

        .field-input:focus {
            outline: none;
            border-color: #00ccff;
            box-shadow: 0 0 3px rgba(0, 204, 255, 0.3);
        }

        .custom-skill-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            border-radius: 4px;
        }

        .custom-skill-item input[type="text"] {
            flex: 1;
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 2px;
            padding: 4px;
            font-size: 12px;
        }

        .custom-skill-item input[type="number"] {
            width: 50px;
        }

        .custom-skill-item .remove-skill {
            background-color: #ff4757;
            color: #fff;
            border: none;
            border-radius: 2px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 10px;
        }

        .character-card {
            display: flex;
            align-items: center;
            gap: 16px;
            background: rgba(0,0,0,0.7);
            border: 1px solid #00ccff;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,204,255,0.08);
        }
        .character-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #444;
            background: #222;
        }
        .character-info {
            flex: 1;
        }
        .character-name {
            color: #00ccff;
            margin: 0 0 4px 0;
            font-size: 1.1em;
            font-family: 'Orbitron', sans-serif;
        }
        .character-description {
            color: #aaa;
            font-size: 0.95em;
        }

        /* Estilos para miembros de facciones */
        .faction-members {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }

        .faction-members h4 {
            color: #ff4757;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            margin: 0 0 10px 0;
        }

        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .member-card {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.5);
            border: 1px solid #555;
            border-radius: 6px;
            padding: 8px;
            transition: all 0.3s ease;
        }

        .member-card:hover {
            border-color: #00ccff;
            box-shadow: 0 0 8px rgba(0,204,255,0.3);
        }

        .member-image {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #444;
            background: #222;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .member-image:hover {
            border-color: #00ccff;
            box-shadow: 0 0 5px rgba(0,204,255,0.5);
        }

        .member-info {
            flex: 1;
            min-width: 0;
        }

        .member-info h5 {
            color: #00ccff;
            margin: 0 0 2px 0;
            font-size: 12px;
            font-family: 'Orbitron', sans-serif;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .member-info p {
            color: #aaa;
            margin: 0;
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Modal de imagen con neón */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
        }

        .image-modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 2.5em;
            color: #00ffff;
            cursor: pointer;
            text-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff;
        }

        .modal-content {
            max-width: 90vw;
            max-height: 80vh;
            box-shadow: 0 0 40px #00ffff, 0 0 80px #ff00cc;
            border-radius: 12px;
            border: 3px solid #00ffff;
            background: #111;
            object-fit: contain;
            width: auto;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        .gear-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            border-radius: 4px;
        }

        .gear-item .remove-skill {
            background-color: #ff4757 !important;
            color: #fff !important;
            border: none !important;
            border-radius: 4px !important;
            padding: 8px 12px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            margin-left: auto !important;
            transition: all 0.3s ease !important;
        }

        .gear-item .remove-skill:hover {
            background-color: #ff6b81 !important;
            transform: scale(1.1) !important;
        }

        .item-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            border-radius: 4px;
        }

        .item-card h4 {
            color: #00ccff;
            margin: 0;
            font-family: 'Orbitron', sans-serif;
        }

        .remove-item {
            background-color: #ff4757 !important;
            color: white !important;
            border: none !important;
            padding: 4px 6px !important;
            border-radius: 3px !important;
            cursor: pointer !important;
            font-size: 10px !important;
            line-height: 1 !important;
            font-family: monospace !important;
            font-weight: bold !important;
            transition: all 0.2s ease !important;
            min-width: 20px !important;
            text-align: center !important;
        }

        .remove-item:hover {
            background-color: #ff6b81 !important;
            transform: scale(1.2) !important;
            box-shadow: 0 0 5px rgba(255, 71, 87, 0.5) !important;
        }

        .item-stat {
            color: #aaa;
            font-size: 12px;
            margin: 2px 0;
        }

        .item-stat strong {
            color: #00ccff;
        }

        .add-item-form {
            background: linear-gradient(135deg, rgba(0, 20, 40, 0.8) 0%, rgba(0, 10, 20, 0.8) 100%) !important;
            border: 1px solid #00ccff !important;
            border-radius: 8px !important;
            margin-top: 15px !important;
            padding: 15px !important;
            box-shadow: 0 4px 8px rgba(0, 204, 255, 0.1) !important;
        }

        .add-item-form h4 {
            color: #00ccff !important;
            margin: 0 0 15px 0 !important;
            font-family: 'Orbitron', sans-serif !important;
            font-size: 16px !important;
            text-align: center !important;
            text-transform: uppercase !important;
            letter-spacing: 1px !important;
            font-family: 'Orbitron', sans-serif !important;
        }

        .remove-item-improved {
            background: #ff4757 !important;
            color: white !important;
            border: none !important;
            width: 28px !important;
            height: 28px !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: bold !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s ease !important;
            flex-shrink: 0 !important;
            margin-left: 10px !important;
            position: relative !important;
            z-index: 10 !important;
        }

        .remove-item-improved:hover {
            background: #ff6b81 !important;
            transform: scale(1.1) !important;
            box-shadow: 0 0 8px rgba(255, 71, 87, 0.5) !important;
        }

        .item-description {
            padding: 12px 15px !important;
            color: #ccc !important;
            font-size: 14px !important;
            line-height: 1.4 !important;
            border-bottom: 1px solid rgba(68, 68, 68, 0.5) !important;
        }

        .item-stats-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important;
            gap: 8px !important;
            padding: 12px 15px !important;
        }

        .item-stat {
            display: flex !important;
            flex-direction: column !important;
            gap: 2px !important;
        }

        .item-stat.full-width {
            grid-column: 1 / -1 !important;
        }

        .stat-label {
            color: #888 !important;
            font-size: 11px !important;
            text-transform: uppercase !important;
            font-weight: bold !important;
            letter-spacing: 0.5px !important;
        }

        .stat-value {
            color: #fff !important;
            font-size: 13px !important;
            font-weight: 500 !important;
        }

        .item-meta {
            padding: 8px 15px !important;
            background: rgba(0, 0, 0, 0.2) !important;
            border-top: 1px solid rgba(68, 68, 68, 0.5) !important;
            color: #666 !important;
            font-size: 11px !important;
            text-align: right !important;
        }

        .add-item-form input,
        .add-item-form textarea {
            background: rgba(30, 30, 30, 0.8) !important;
            border: 1px solid #444 !important;
            border-radius: 4px !important;
            color: #fff !important;
            padding: 8px 12px !important;
            font-size: 14px !important;
            transition: all 0.3s ease !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }

        .add-item-form input:focus,
        .add-item-form textarea:focus {
            border-color: #00ccff !important;
            outline: none !important;
            box-shadow: 0 0 5px rgba(0, 204, 255, 0.3) !important;
            background: rgba(40, 40, 40, 0.9) !important;
        }

        .add-item-form input::placeholder,
        .add-item-form textarea::placeholder {
            color: #888 !important;
        }

        .add-item-form button {
            background: linear-gradient(135deg, #00ccff 0%, #0099cc 100%) !important;
            color: #000 !important;
            border: none !important;
            padding: 10px 20px !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-family: 'Orbitron', sans-serif !important;
            font-weight: bold !important;
            font-size: 12px !important;
            text-transform: uppercase !important;
            letter-spacing: 1px !important;
            transition: all 0.3s ease !important;
            width: 100% !important;
            margin-top: 10px !important;
        }

        .add-item-form button:hover {
            background: linear-gradient(135deg, #ff4757 0%, #ff6b81 100%) !important;
            color: #fff !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(255, 71, 87, 0.3) !important;
        }

        /* === ESTILOS MEJORADOS PARA ITEMS === */
        .item-card-improved {
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.9) 0%, rgba(20, 20, 20, 0.9) 100%) !important;
            border: 1px solid #444 !important;
            border-radius: 8px !important;
            margin-bottom: 15px !important;
            padding: 0 !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3) !important;
            transition: all 0.3s ease !important;
            overflow: hidden !important;
        }

        .item-card-improved:hover {
            border-color: #00ccff !important;
            box-shadow: 0 6px 12px rgba(0, 204, 255, 0.2) !important;
            transform: translateY(-2px) !important;
        }

        .item-header {
            display: flex !important;
            align-items: center !important;
            padding: 12px 15px !important;
            background: rgba(0, 0, 0, 0.3) !important;
            border-bottom: 1px solid #444 !important;
        }

        .item-icon {
            font-size: 20px !important;
            margin-right: 12px !important;
            flex-shrink: 0 !important;
        }

        .item-title {
            flex: 1 !important;
            min-width: 0 !important;
        }

        .item-title h4 {
            color: #00ccff !important;
            margin: 0 0 2px 0 !important;
            font-family: 'Orbitron', sans-serif !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
        }

        .item-type {
            color: #888 !important;
            font-size: 10px !important;
            font-weight: bold !important;
            text-transform: uppercase !important;
            letter-spacing: 1px !important;
            font-family: 'Orbitron', sans-serif !important;
        }

        .remove-item-improved {
            background: #ff4757 !important;
            color: white !important;
            border: none !important;
            width: 28px !important;
            height: 28px !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: bold !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s ease !important;
            flex-shrink: 0 !important;
            margin-left: 10px !important;
            position: relative !important;
            z-index: 10 !important;
        }

        .remove-item-improved:hover {
            background: #ff6b81 !important;
            transform: scale(1.1) !important;
            box-shadow: 0 0 8px rgba(255, 71, 87, 0.5) !important;
        }

        .item-description {
            padding: 12px 15px !important;
            color: #ccc !important;
            font-size: 14px !important;
            line-height: 1.4 !important;
            border-bottom: 1px solid rgba(68, 68, 68, 0.5) !important;
        }

        .item-stats-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important;
            gap: 8px !important;
            padding: 12px 15px !important;
        }

        .item-stat {
            display: flex !important;
            flex-direction: column !important;
            gap: 2px !important;
        }

        .item-stat.full-width {
            grid-column: 1 / -1 !important;
        }

        .stat-label {
            color: #888 !important;
            font-size: 11px !important;
            text-transform: uppercase !important;
            font-weight: bold !important;
            letter-spacing: 0.5px !important;
        }

        .stat-value {
            color: #fff !important;
            font-size: 13px !important;
            font-weight: 500 !important;
        }

        .item-meta {
            padding: 8px 15px !important;
            background: rgba(0, 0, 0, 0.2) !important;
            border-top: 1px solid rgba(68, 68, 68, 0.5) !important;
            color: #666 !important;
            font-size: 11px !important;
            text-align: right !important;
        }

        /* Header Content Layout */
        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .title-section {
            text-align: center;
        }

        /* XIII Image Styles */
        .xiii-image-container {
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(255, 0, 170, 0.1));
            border: 2px solid #00ccff;
            border-radius: 8px;
            padding: 3px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
            width: 90px;
            height: 90px;
            flex-shrink: 0;
        }

        .xiii-image-container:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
            border-color: #ff4757;
        }

        .xiii-thumbnail {
            width: 84px;
            height: 84px;
            object-fit: cover;
            border-radius: 6px;
            filter: brightness(1.1) contrast(1.1);
        }

        /* XIII Modal Styles */
        .xiii-image-modal {
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .xiii-modal-content {
            position: relative;
            background: linear-gradient(135deg, rgba(10, 10, 18, 0.95), rgba(18, 18, 36, 0.95));
            border: 3px solid #00ccff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            max-width: 70vw;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .xiii-close {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #00ccff;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .xiii-close:hover {
            color: #ff4757;
            text-shadow: 0 0 10px #ff4757;
        }

        .xiii-full-image {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
        }
    </style>
    
    <script>
        // SISTEMA SIMPLIFICADO: Solo recibe datos del listener maestro de character-sheet.js
        // El modal NO maneja Firebase directamente, solo recibe datos via postMessage
    </script>
    <script>
window.personajesFacciones = [
  // OmniCorp Entertainment (OCE)
  {
    nombre: 'Kaiser "El Emperador" Von Stroheim',
    faccion: 'OmniCorp Entertainment (OCE)',
    rol: 'Anfitrión y Productor Ejecutivo',
    img: 'images/kaiser_new.png',
    desc: 'Imponente figura que viste trajes de seda negra con reflejos carmesí. Su brazo biónico "Ares Predator VII" de cromo negro pulido con detalles dorados intimidaría incluso al más valiente. Sus ópticas "Zeiss Ikon X" revelan pupilas rojas que parecen analizar cada debilidad. Su cabello plateado peinado hacia atrás completa su imagen de autoridad absoluta.',
    dialogo: '¡Bienvenidos, rebaño de desesperados, a la arena donde las ovejas se convierten en lobos o en pienso! ¡Cien almas buscando redención, o al menos, una muerte con más estilo que la que les esperaba fuera! Soy Kaiser, su pastor en este valle de sombras y neón. Sus deudas, sus crímenes, sus errores... olvídense de ellos. Aquí, solo importa una cosa: ¡SOBREVIVIR! ¡ENTRETENER! ¡ASCENDER! Ultimate Mercenary ha comenzado. ¡Que la purga... digo, la competencia, dé inicio!'
  },
  {
    nombre: 'Mr. Kenji Tanaka',
    faccion: 'OmniCorp Entertainment (OCE)',
    rol: 'Jefe de Adquisiciones de Talento',
    img: 'images/guard_ocemk2.png',
    desc: 'Trajeado impecablemente, Mr. Tanaka es la cara "amable" de OCE. Con una sonrisa falsa pero convincente y mirada fríamente calculadora, es él quien cierra los tratos sucios que llevan a los concursantes hasta el programa. Función: Maneja la "contratación" de concursantes y otros activos de OCE, asegurándose de que todo tenga el aspecto de legalidad necesario para la transmisión pública.',
    dialogo: 'Le aseguro que todas nuestras operaciones son... completamente legales. ¿Los participantes? Todos son voluntarios, por supuesto. Han firmado contratos extensivos. El que algunos lo hicieran con una pistola figurativa en la cabeza es, como comprenderá, irrelevante para nuestros abogados.'
  },
  {
    nombre: 'Dra. Naomi "Nano" McClaray',
    faccion: 'OmniCorp Entertainment (OCE)',
    rol: 'Médica Jefe de OCE',
    img: 'images/doctora_nano_thumb.png',
    desc: 'Ex-investigadora principal en BioTech Corp, especializada en nanomedicina avanzada. Ahora supervisa todos los procedimientos médicos en Ultimate Mercenary, incluyendo implantes y "reparaciones" de concursantes valiosos. Sus brazos cibernéticos están especializados en procedimientos de precisión que han salvado —y transformado— a docenas de concursantes.',
    dialogo: 'Mis dispositivos son lo único que mantiene vivos a la mitad de ustedes. Curiosamente, también son lo que podría matarlos con solo un comando remoto. ¿Fascinante balance, no crees?'
  },
  {
    nombre: 'Director Ikari',
    faccion: 'OmniCorp Entertainment (OCE)',
    rol: 'Agente del Gobierno Sombra',
    img: 'images/director_ikari.png',
    desc: 'Oficial de alto rango en el Ministerio de Seguridad Interna de Neo-Kyoto. Su presencia en las gradas VIP de Ultimate Mercenary es discreta pero constante. El gobierno oficialmente condena el show mientras secretamente lo utiliza para probar implantes experimentales y reclutar especialistas en combate.',
    dialogo: 'Puedo hacer que tu historial criminal desaparezca... o que tú desaparezcas. Ambas opciones son igualmente sencillas para mí. La diferencia está en lo útil que me resultes.'
  },
  // Colectivo Nexus-9
  {
    nombre: 'Dra. Ada "Quantum" Mercurio',
    faccion: 'Colectivo Nexus-9',
    rol: 'Científica Visionaria y Fundadora',
    img: 'images/nexus9_ada_quantum.png',
    desc: 'Antigua jefa de investigación en neurotecnología avanzada para NeuroCorp, Ada descubrió que la empresa planeaba hacer que la tecnología de transferencia de conciencia fuera deliberadamente adictiva. Robó prototipos y datos críticos antes de desaparecer. Con implantes neurales experimentales autoinstalados, puede procesar información a velocidades sobrehumanas y conectarse directamente con sistemas informáticos. Su rostro está parcialmente cubierto por una máscara respiratoria personalizada.',
    dialogo: 'La muerte ya no es inevitable, solo es costosa. Cambiaremos eso, aunque tengamos que desmantelar todo el sistema corporativo para lograrlo.'
  },
  {
    nombre: 'Xiong "Mesh" Lee',
    faccion: 'Colectivo Nexus-9',
    rol: 'Especialista en Infiltración y Recuperación',
    img: 'images/nexus9_mesh_lee.png',
    desc: 'Ex-agente de seguridad corporativa con amplia experiencia militar. Después de perder a su familia en un "accidente" corporativo, fue reconstruido por el Colectivo con tecnología experimental. Su cuerpo está poblado por nanomáquinas que pueden reconfigurar parcialmente su apariencia. Se especializa en operaciones de infiltración y recuperación, entrando en instalaciones corporativas para extraer tecnología o datos. Su lealtad al Colectivo es absoluta.',
    dialogo: 'Mi cuerpo es un prototipo. Mi mente es un arma. Si me matas, aprenderán de mi cadáver y construirán algo mejor.'
  },
  // Chrome Dynasty
  {
    nombre: 'Madame Jade "Emperatriz de Cromo"',
    faccion: 'Chrome Dynasty',
    rol: 'Líder Suprema de la Chrome Dynasty',
    img: 'images/chrome_dynasty_emperatriz.png',
    desc: 'Una figura casi mítica, la Emperatriz rara vez se muestra públicamente sin un elaborado velo digital que oculta sus facciones. Su verdadera edad es desconocida, con rumores que sugieren que ha transferido su conciencia a múltiples cuerpos a lo largo de décadas. Su cuerpo actual es una obra maestra de ingeniería biomecánica, con implantes cromados que realzan su presencia intimidante. Como líder, controla un vasto imperio criminal con eficiencia implacable.',
    dialogo: 'La carne es débil. La sangre es transitoria. Solo el cromo perdura. En este nuevo mundo, aquellos con la mejor tecnología no son simplemente ricos - son dioses.'
  },
  {
    nombre: 'Jin "Silverhand" Wong',
    faccion: 'Chrome Dynasty',
    rol: 'Enforcer Principal y Cirujano de Combate',
    img: 'images/chrome_dynasty_silverhand.png',
    desc: 'Antiguo cirujano militar deshonradamente despedido por experimentación no autorizada, Jin encontró un hogar en la Chrome Dynasty. Sus brazos completamente cibernéticos contienen un arsenal de herramientas quirúrgicas que utiliza tanto para instalar implantes de élite como para "recuperarlos" de enemigos caídos. Su reputación es legendaria en los bajos fondos de Neo-Kyoto, donde se dice que puede remover todos los implantes de un objetivo mientras lo mantiene consciente, como forma de castigo ejemplar.',
    dialogo: 'Puedo reconstruirte o desmantelarte con la misma precisión. La elección es tuya, pero te sugiero que elijas sabiamente.'
  },
  // Nakamura-Daichi Corp
  {
    nombre: 'Hideo Nakamura',
    faccion: 'Zaibatsu Nakamura-Daichi Corp',
    rol: 'CEO y Patriarca de Nakamura-Daichi Corp',
    img: 'images/nakamura_daichi_ceo.png',
    desc: 'A sus 78 años, Hideo representa la vieja guardia corporativa con adaptaciones modernas. Su cuerpo está sutilmente mejorado con los mejores productos de su compañía, haciéndolo parecer un saludable hombre de 50 años. A diferencia de muchos ejecutivos, Hideo mantiene sus mejoras discretas y casi invisibles. Conocido por su inteligencia estratégica y paciencia implacable, Hideo planifica a décadas vista, posicionando a Nakamura-Daichi para eventualmente dominar el mercado global de biotecnología.',
    dialogo: 'Las corporaciones que exhiben su poder son las primeras en caer. El verdadero poder, como la mejor tecnología, funciona de manera invisible.'
  },
  {
    nombre: 'Dra. Yuki Nakamura',
    faccion: 'Zaibatsu Nakamura-Daichi Corp',
    rol: 'Directora de Investigación y Desarrollo',
    img: 'images/nakamura_daichi_yuki.png',
    desc: 'Genio científico con doctorados en bioingeniería y cibernética neural, Yuki representa el futuro de la corporación. A diferencia de su padre, es más agresiva en sus tácticas y menos paciente con obstáculos. Ha dirigido personalmente varios proyectos revolucionarios, incluyendo el "Programa Fénix" - un intento de transferencia de conciencia. Aunque públicamente mantiene la imagen corporativa de elegancia y discreción, Yuki ha autorizado operaciones clandestinas para sabotear a competidores y adquirir tecnología por medios cuestionables.',
    dialogo: 'Mi padre construyó esta empresa con paciencia. Yo la convertiré en un imperio con determinación. La diferencia entre nosotros es que él está dispuesto a esperar que el mundo cambie. Yo estoy decidida a cambiarlo yo misma.'
  },
  // Huérfanos Digitales
  {
    nombre: 'Zero "Void" Tanaka',
    faccion: 'Huérfanos Digitales',
    rol: 'Líder y Rostro del Movimiento',
    img: 'images/huerfanos_zero_void.png',
    desc: 'Zero perdió a ambos padres en el "Gran Fallo de Arasaka" cuando tenía 15 años. Sus padres habían transferido sus conciencias a la infraestructura corporativa días antes de que un ataque cibernético masivo corrompiera irreversiblemente miles de almacenamientos de conciencia. Ahora en sus veintitantos, Zero se ha convertido en el rostro de los Huérfanos Digitales. Su máscara, un panel LCD que alterna entre estática y fragmentos reconstruidos de los rostros de sus padres, se ha convertido en un símbolo del movimiento.',
    dialogo: 'No están muertos. No están vivos. Están atrapados en el limbo corporativo mientras nosotros quedamos aquí, con cuentas que pagar y corazones rotos. No somos anti-tecnología - somos pro-humanidad.'
  },
  {
    nombre: 'Iris "Glitch" Sato',
    faccion: 'Huérfanos Digitales',
    rol: 'Especialista en Recuperación de Conciencias',
    img: 'images/huerfanos_iris_glitch.png',
    desc: 'Ex-ingeniera de calibración de resleeving para Arasaka, Iris abandonó su lucrativa carrera después de descubrir que la empresa estaba ocultando deliberadamente la tasa de fallos en las transferencias de conciencia. Ahora se especializa en la delicada tarea de intentar recuperar fragmentos de conciencias dañadas.',
    dialogo: 'A veces, lo único que puedes salvar de alguien es un eco digital. Pero a veces, un eco es suficiente para recordar que existieron.'
  }
];
    </script>
</head>
<body>
    <div class="character-sheet">
        <div class="sheet-header">
            <div class="header-content">
                <!-- Imagen XIII -->
                <div class="xiii-image-container" onclick="openXIIIModal()">
                    <img src="images/XIIIbox.jpeg" alt="XIII" class="xiii-thumbnail">
                </div>
                
                <div class="title-section">
            <h1>FICHA DE PERSONAJE</h1>
            <h2>Concursante #13</h2>
                </div>
            </div>
        </div>

        <div class="button-container">
        <button id="saveButton" class="save-button">GUARDAR FICHA</button>
        <button id="resetButton" class="reset-button">REINICIAR FICHA</button>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="basics">Básicos</div>
            <div class="tab" data-tab="skills">Habilidades</div>
            <div class="tab" data-tab="gear">Equipo</div>
            <div class="tab" data-tab="cyber">Implantes</div>
            <div class="tab" data-tab="conocidos">Conocidos</div>
            <div class="tab" data-tab="conocimientos">Conocimientos</div>
        </div>

        <div id="basics" class="tab-content active">
            <div class="section">
                <h2>ATRIBUTOS</h2>
                <div class="points-counters">
                    <div class="points-counter">
                        <span>Puntos de Atributos: </span>
                        <span id="attribute-points" class="points-available">20</span>
                        <span id="attribute-points-total">/20</span>
                    </div>
                </div>
                
                <!-- Plantilla de Atributos -->
                <div class="points-counter" style="margin-bottom: 20px;">
                    <h3 style="color: #00ccff; margin-bottom: 10px;">Plantilla de Atributos</h3>
                    <p style="font-size: 12px; color: #aaa; margin-bottom: 10px;">
                        Las plantillas representan diferentes arquetipos de personaje. Cada plantilla otorga valores base superiores a 10, 
                        reduciendo los puntos de personalización disponibles. Los puntos restantes pueden usarse para ajustar los atributos.
                    </p>
                    <select id="aptitude-template" style="width: 100%; padding: 8px; background-color: #333; color: #fff; border: 1px solid #00ccff; border-radius: 4px;">
                        <option value="actioneer">Actioneer (COG 15, INT 15, REF 20, SAV 10, SOM 15, WIL 15)</option>
                        <option value="extrovert">Extrovert (COG 15, INT 15, REF 15, SAV 20, SOM 15, WIL 15)</option>
                        <option value="facilitator">Facilitator (COG 10, INT 15, REF 10, SAV 20, SOM 20, WIL 20)</option>
                        <option value="factotum">Factotum (COG 15, INT 15, REF 15, SAV 15, SOM 10, WIL 15)</option>
                        <option value="inquirer">Inquirer (COG 10, INT 20, REF 10, SAV 15, SOM 15, WIL 15)</option>
                        <option value="survivor">Survivor (COG 20, INT 10, REF 15, SAV 10, SOM 20, WIL 20)</option>
                        <option value="thrill-seeker">Thrill Seeker (COG 20, INT 15, REF 20, SAV 15, SOM 10, WIL 15)</option>
                    </select>
                </div>
                
                <div class="grid">
                    <div class="item">
                        <h3>COG</h3>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="cog" value="10" min="0" max="25" style="width: 60px;">
                            <span class="attr-display">
                                <span class="attr-total" id="cog-total" style="color: #00ccff; font-weight: bold;">10</span>
                                <span class="attr-bonus" id="cog-bonus" style="color: #2ed573; font-size: 0.9em;"></span>
                            </span>
                        </div>
                    </div>
                    <div class="item">
                        <h3>INT</h3>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="int" value="10" min="0" max="25" style="width: 60px;">
                            <span class="attr-display">
                                <span class="attr-total" id="int-total" style="color: #00ccff; font-weight: bold;">10</span>
                                <span class="attr-bonus" id="int-bonus" style="color: #2ed573; font-size: 0.9em;"></span>
                            </span>
                        </div>
                    </div>
                    <div class="item">
                        <h3>REF</h3>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="ref" value="10" min="0" max="25" style="width: 60px;">
                            <span class="attr-display">
                                <span class="attr-total" id="ref-total" style="color: #00ccff; font-weight: bold;">10</span>
                                <span class="attr-bonus" id="ref-bonus" style="color: #2ed573; font-size: 0.9em;"></span>
                            </span>
                        </div>
                    </div>
                    <div class="item">
                        <h3>SAV</h3>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="sav" value="10" min="0" max="25" style="width: 60px;">
                            <span class="attr-display">
                                <span class="attr-total" id="sav-total" style="color: #00ccff; font-weight: bold;">10</span>
                                <span class="attr-bonus" id="sav-bonus" style="color: #2ed573; font-size: 0.9em;"></span>
                            </span>
                        </div>
                    </div>
                    <div class="item">
                        <h3>SOM</h3>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="som" value="10" min="0" max="25" style="width: 60px;">
                            <span class="attr-display">
                                <span class="attr-total" id="som-total" style="color: #00ccff; font-weight: bold;">10</span>
                                <span class="attr-bonus" id="som-bonus" style="color: #2ed573; font-size: 0.9em;"></span>
                            </span>
                        </div>
                    </div>
                    <div class="item">
                        <h3>WIL</h3>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="wil" value="10" min="0" max="25" style="width: 60px;">
                            <span class="attr-display">
                                <span class="attr-total" id="wil-total" style="color: #00ccff; font-weight: bold;">10</span>
                                <span class="attr-bonus" id="wil-bonus" style="color: #2ed573; font-size: 0.9em;"></span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>ESTADÍSTICAS DERIVADAS</h2>
                <div class="grid">
                    <div class="item">
                        <h3>DUR</h3>
                        <input type="number" id="dur" value="30" min="1" max="99" style="width:60px;"> <!-- Editable -->
                    </div>
                    <div class="item">
                        <h3>Umbral de Heridas (WT)</h3>
                        <p class="value" id="wound-threshold">6</p>
                    </div>
                    <div class="item">
                        <h3>Death Rating (DR)</h3>
                        <p class="value" id="death-rating">45</p>
                    </div>
                    <div class="item">
                        <h3>Iniciativa</h3>
                        <p class="value" id="initiative">7</p>
                    </div>
                    <div class="item">
                        <h3>MOV</h3>
                        <p class="value" id="movement">4</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="skills" class="tab-content">
            <div class="section">
                <h2>HABILIDADES ACTIVAS</h2>
                <div class="points-counters">
                    <div class="points-counter">
                        <span>Puntos de Habilidades: </span>
                        <span id="skill-points" class="points-available">400</span>
                        <span>/400</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <!-- Columna 1: REF y COG -->
                    <div>
                        <!-- Habilidades de REF -->
                        <div class="skill-group">
                            <h3 class="skill-group-title">REFLEXOS (REF)</h3>
                            <div class="item">
                                <h3>Esquivar</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Esquivar" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Esquivar">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Armas de Fuego</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Armas de Fuego" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Armas de Fuego">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Infiltración</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Infiltración" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Infiltración">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Pilotar: <input type="text" class="field-input" data-field="Pilotar" placeholder="Campo" style="width: 80px; font-size: 10px;"></h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Pilotar" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Pilotar">0</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Habilidades de COG -->
                        <div class="skill-group">
                            <h3 class="skill-group-title">COGNICIÓN (COG)</h3>
                            <div class="item">
                                <h3>Hardware: <input type="text" class="field-input" data-field="Hardware" placeholder="Campo" style="width: 80px; font-size: 10px;"></h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Hardware" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Hardware">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Infosec</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Infosec" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Infosec">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Interfaz</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Interfaz" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Interfaz">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Medicina: <input type="text" class="field-input" data-field="Medicina" placeholder="Campo" style="width: 80px; font-size: 10px;"></h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Medicina" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Medicina">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Programación</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Programación" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Programación">0</span></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna 2: SOM, INT, SAV -->
                    <div>
                        <!-- Habilidades de SOM -->
                        <div class="skill-group">
                            <h3 class="skill-group-title">SOMÁTICA (SOM)</h3>
                            <div class="item">
                                <h3>Atletismo</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Atletismo" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Atletismo">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Caída Libre</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Caída Libre" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Caída Libre">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Combate Cuerpo a Cuerpo</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Combate Cuerpo a Cuerpo" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Combate Cuerpo a Cuerpo">0</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Habilidades de INT -->
                        <div class="skill-group">
                            <h3 class="skill-group-title">INTUICIÓN (INT)</h3>
                            <div class="item">
                                <h3>Percepción</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Percepción" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Percepción">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Investigación</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Investigación" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Investigación">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Supervivencia</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Supervivencia" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Supervivencia">0</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Habilidades de SAV -->
                        <div class="skill-group">
                            <h3 class="skill-group-title">ASTUCIA (SAV)</h3>
                            <div class="item">
                                <h3>Engaño</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Engaño" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Engaño">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Kinésica</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Kinésica" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Kinésica">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Persuasión</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Persuasión" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Persuasión">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Provocación</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Provocación" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Provocación">0</span></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna 3: WIL, Exóticas, Conocimiento -->
                    <div>
                        <!-- Habilidades de WIL -->
                        <div class="skill-group">
                            <h3 class="skill-group-title">VOLUNTAD (WIL)</h3>
                            <div class="item">
                                <h3>Psi</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Psi" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Psi">0</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Habilidades Exóticas -->
                        <div class="skill-group">
                            <h3 class="skill-group-title">HABILIDADES EXÓTICAS</h3>
                            <div class="item">
                                <h3>Exótica: <input type="text" class="field-input" data-field="Exótica" placeholder="Campo" style="width: 80px; font-size: 10px;"></h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Exótica" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Exótica">0</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Habilidades de Conocimiento -->
                        <div class="skill-group">
                            <h3 class="skill-group-title">CONOCIMIENTO</h3>
                            <div class="item">
                                <h3>Académico (COG): <input type="text" class="field-input" data-field="Académico" placeholder="Campo" style="width: 60px; font-size: 10px;"></h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Académico" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Académico">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Arte (INT): <input type="text" class="field-input" data-field="Arte" placeholder="Campo" style="width: 60px; font-size: 10px;"></h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Arte" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Arte">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Interés (COG): <input type="text" class="field-input" data-field="Interés" placeholder="Campo" style="width: 60px; font-size: 10px;"></h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Interés" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Interés">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Profesional (COG): <input type="text" class="field-input" data-field="Profesional" placeholder="Campo" style="width: 60px; font-size: 10px;"></h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Profesional" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Profesional">0</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Habilidades Personalizadas -->
                <div class="section" style="margin-top: 20px;">
                    <h3 style="color: #00ccff; margin-bottom: 15px;">HABILIDADES PERSONALIZADAS</h3>
                    <div id="custom-skills-container">
                        <!-- Las habilidades personalizadas se añadirán aquí dinámicamente -->
                    </div>
                    <button id="add-custom-skill" style="padding: 5px 10px; background-color: #00ccff; color: #000; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">+ Añadir Habilidad</button>
                </div>
            </div>
        </div>

        <div id="gear" class="tab-content">
            <div class="section">
                <h2>EQUIPO</h2>
                <div>
                    <div class="item">
                        <h3>Armas</h3>
                        <div id="weapons-list">
                            <p>Sin armas equipadas</p>
                        </div>
                        <div class="add-item-form" style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 4px;">
                            <h4 style="color: #00ccff; margin: 0 0 10px 0;">Añadir Arma</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <input type="text" id="weapon-name" placeholder="Nombre del arma" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px;">
                                <input type="text" id="weapon-damage" placeholder="Daño (ej: 2d10+2)" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px;">
                                <input type="text" id="weapon-ap" placeholder="PA (ej: -2)" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px;">
                                <input type="text" id="weapon-range" placeholder="Alcance" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px;">
                            </div>
                            <textarea id="weapon-description" placeholder="Descripción y notas" style="width: 100%; background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px; height: 60px; resize: vertical;"></textarea>
                            <button onclick="addCustomWeapon()" style="background: #00ccff; color: #000; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-top: 10px;">Añadir Arma</button>
                        </div>
                    </div>
                    <div class="item">
                        <h3>Armadura</h3>
                        <div id="armor-list">
                            <p>Sin armadura equipada</p>
                        </div>
                        <div class="add-item-form" style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 4px;">
                            <h4 style="color: #00ccff; margin: 0 0 10px 0;">Añadir Armadura</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <input type="text" id="armor-name" placeholder="Nombre de la armadura" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px;">
                                <input type="text" id="armor-protection" placeholder="Protección (ej: 10/15)" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px;">
                                <input type="text" id="armor-weight" placeholder="Peso" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px;">
                                <input type="text" id="armor-effects" placeholder="Efectos especiales" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px;">
                            </div>
                            <textarea id="armor-description" placeholder="Descripción y notas" style="width: 100%; background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px; height: 60px; resize: vertical;"></textarea>
                            <button onclick="addCustomArmor()" style="background: #00ccff; color: #000; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-top: 10px;">Añadir Armadura</button>
                        </div>
                    </div>
                    <div class="item">
                        <h3>Equipo Misceláneo</h3>
                        <div id="misc-list">
                            <p>Sin equipo adicional</p>
                        </div>
                        <div class="add-item-form" style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 4px;">
                            <h4 style="color: #00ccff; margin: 0 0 10px 0;">Añadir Equipo</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <input type="text" id="misc-name" placeholder="Nombre del equipo" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px;">
                                <input type="text" id="misc-weight" placeholder="Peso" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px;">
                                <input type="text" id="misc-cost" placeholder="Coste en PM" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px;">
                                <input type="text" id="misc-effects" placeholder="Efectos/Uso" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px;">
                    </div>
                            <textarea id="misc-description" placeholder="Descripción y notas" style="width: 100%; background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px; height: 60px; resize: vertical;"></textarea>
                            <button onclick="addCustomMisc()" style="background: #00ccff; color: #000; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-top: 10px;">Añadir Equipo</button>
                        </div>
                        
                        <!-- Administración del Inventario -->
                        <div style="margin-top: 30px; text-align: center; background: rgba(255, 71, 87, 0.1); border: 2px solid #ff4757; border-radius: 8px; padding: 20px;">
                            <h3 style="color: #ff4757; margin: 0 0 15px 0; font-family: 'Orbitron', sans-serif; font-size: 18px;">🔧 ADMINISTRACIÓN DEL INVENTARIO</h3>
                            <p style="font-size: 12px; color: #aaa; margin-bottom: 20px; line-height: 1.4;">
                                Herramientas avanzadas para gestión de inventario. Utiliza con precaución.
                            </p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px;">
                                <button onclick="quickCleanDuplicates()" style="background: linear-gradient(45deg, #ffa502, #ff9f00); color: #fff; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 12px; font-family: 'Orbitron', sans-serif; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 165, 2, 0.3); transition: all 0.3s ease;">
                                    🧹 LIMPIAR DUPLICADOS
                                </button>
                                <button onclick="showInventoryStats()" style="background: linear-gradient(45deg, #70a1ff, #5352ed); color: #fff; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 12px; font-family: 'Orbitron', sans-serif; font-weight: bold; box-shadow: 0 4px 15px rgba(112, 161, 255, 0.3); transition: all 0.3s ease;">
                                    📊 ESTADÍSTICAS
                                </button>
                                <button onclick="showAdminMenu()" style="background: linear-gradient(45deg, #ff4757, #ff3838); color: #fff; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 12px; font-family: 'Orbitron', sans-serif; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3); transition: all 0.3s ease;">
                                    ⚠️ ADMIN COMPLETO
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="cyber" class="tab-content">
            <div class="section">
                <h2>IMPLANTES</h2>
                <div>
                    <div class="item">
                        <h3>Implantes Cibernéticos</h3>
                        <div id="implants-list">
                            <p>Sin implantes instalados</p>
                        </div>
                        <div class="add-item-form" style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 4px;">
                            <h4 style="color: #00ccff; margin: 0 0 10px 0;">Añadir Implante</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <input type="text" id="implant-name" placeholder="Nombre del implante" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px;">
                                <!-- <input type="text" id="implant-cost" placeholder="Coste en PM" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px;"> -->
                                <input type="text" id="implant-effects" placeholder="Efectos mecánicos" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px;">
                                <input type="text" id="implant-location" placeholder="Ubicación" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px;">
                    </div>
                            
                            <!-- Beneficios Mecánicos -->
                            <div style="margin: 15px 0; padding: 15px; background: rgba(0, 204, 255, 0.1); border: 1px solid #00ccff; border-radius: 6px;">
                                <h5 style="color: #00ccff; margin: 0 0 10px 0; font-family: 'Orbitron', sans-serif;">⚙️ Beneficios Mecánicos (Máximo 3)</h5>
                                <div id="implant-benefits">
                                    <div class="benefit-row" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                                        <select class="benefit-target" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px; flex: 1;">
                                            <option value="">Seleccionar atributo/habilidad</option>
                                            <optgroup label="Atributos">
                                                <option value="attr_cog">COG (Cognición)</option>
                                                <option value="attr_int">INT (Intuición)</option>
                                                <option value="attr_ref">REF (Reflexos)</option>
                                                <option value="attr_sav">SAV (Astucia)</option>
                                                <option value="attr_som">SOM (Somática)</option>
                                                <option value="attr_wil">WIL (Voluntad)</option>
                                            </optgroup>
                                            <optgroup label="Habilidades de REF">
                                                <option value="skill_Esquivar">Esquivar</option>
                                                <option value="skill_Armas de Fuego">Armas de Fuego</option>
                                                <option value="skill_Infiltración">Infiltración</option>
                                                <option value="skill_Pilotar">Pilotar</option>
                                            </optgroup>
                                            <optgroup label="Habilidades de COG">
                                                <option value="skill_Hardware">Hardware</option>
                                                <option value="skill_Infosec">Infosec</option>
                                                <option value="skill_Interfaz">Interfaz</option>
                                                <option value="skill_Medicina">Medicina</option>
                                                <option value="skill_Programación">Programación</option>
                                                <option value="skill_Académico">Académico</option>
                                                <option value="skill_Interés">Interés</option>
                                                <option value="skill_Profesional">Profesional</option>
                                            </optgroup>
                                            <optgroup label="Habilidades de SOM">
                                                <option value="skill_Atletismo">Atletismo</option>
                                                <option value="skill_Caída Libre">Caída Libre</option>
                                                <option value="skill_Combate Cuerpo a Cuerpo">Combate Cuerpo a Cuerpo</option>
                                            </optgroup>
                                            <optgroup label="Habilidades de INT">
                                                <option value="skill_Percepción">Percepción</option>
                                                <option value="skill_Investigación">Investigación</option>
                                                <option value="skill_Supervivencia">Supervivencia</option>
                                                <option value="skill_Arte">Arte</option>
                                            </optgroup>
                                            <optgroup label="Habilidades de SAV">
                                                <option value="skill_Engaño">Engaño</option>
                                                <option value="skill_Kinésica">Kinésica</option>
                                                <option value="skill_Persuasión">Persuasión</option>
                                                <option value="skill_Provocación">Provocación</option>
                                            </optgroup>
                                            <optgroup label="Habilidades de WIL">
                                                <option value="skill_Psi">Psi</option>
                                            </optgroup>
                                        </select>
                                        <input type="number" class="benefit-bonus" placeholder="Bonus" min="-10" max="20" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px; width: 80px;">
                                        <button type="button" class="remove-benefit" style="background: #ff4757; color: #fff; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">✕</button>
                                    </div>
                                </div>
                                <button type="button" id="add-benefit" style="background: #00ccff; color: #000; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 11px; margin-top: 5px;">+ Añadir Beneficio</button>
                            </div>
                            
                            <textarea id="implant-description" placeholder="Descripción y notas" style="width: 100%; background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px; height: 60px; resize: vertical;"></textarea>
                            <button onclick="addCustomImplant()" style="background: #00ccff; color: #000; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-top: 10px;">Añadir Implante</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="conocidos" class="tab-content">
            <div class="sheet-section">
                <h3>Conocidos</h3>
                <div class="conocidos-controls" style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="conocidos-search" placeholder="Buscar conocidos..." style="flex: 1; padding: 8px; background: rgba(0,0,0,0.5); border: 1px solid #444; border-radius: 4px; color: white; font-family: 'Orbitron', sans-serif;">
                    <button id="sort-by-number" style="padding: 8px 12px; background: #00ccff; color: black; border: none; border-radius: 4px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 12px;">Ordenar por #</button>
                    <button id="sort-by-name" style="padding: 8px 12px; background: #ff4757; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 12px;">Ordenar por Nombre</button>
                </div>
                <div id="conocidos-tarjetas" class="personajes-container"></div>
            </div>
        </div>
        <div id="conocimientos" class="tab-content">
            <div class="sheet-section">
                <h3>Conocimientos</h3>
                <div id="conocimientos-tarjetas" class="facciones-container"></div>
            </div>
        </div>
    </div>

    <div class="scanline"></div>
    <div class="overlay"></div>

    <!-- Modal de imagen con neón -->
    <div id="imageModal" class="image-modal">
        <span class="close-modal" style="position:absolute;top:20px;right:30px;font-size:2.5em;color:#00ffff;cursor:pointer;text-shadow:0 0 10px #00ffff,0 0 20px #00ffff;">&times;</span>
        <img class="modal-content" id="modalImage" style="max-width:90vw;max-height:80vh;box-shadow:0 0 40px #00ffff,0 0 80px #ff00cc; border-radius:12px; border:3px solid #00ffff; background:#111;">
    </div>

    <!-- Firebase se inicializa con ES6 modules en el head -->
    
    <script src="character-sheet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // El inventario se maneja desde character-sheet.js
            // para evitar conflictos entre múltiples listeners
            
            // Conectar botón de guardar ficha
            const saveButton = document.getElementById('saveButton');
            if (saveButton) {
                saveButton.addEventListener('click', function() {
                    console.log('💾 Botón guardar presionado');
                    gatherCharacterData();
                    
                    // Mostrar confirmación visual
                    this.textContent = '¡GUARDADO!';
                    this.style.backgroundColor = '#2ed573';
                    setTimeout(() => {
                        this.textContent = 'GUARDAR FICHA';
                        this.style.backgroundColor = '';
                    }, 2000);
                });
            }
            
            // Conectar botón de reiniciar
            const resetButton = document.getElementById('resetButton');
            if (resetButton) {
                resetButton.addEventListener('click', function() {
                    if (confirm('¿Estás seguro de que quieres reiniciar toda la ficha? Esta acción no se puede deshacer.')) {
                        // Resetear todos los campos a valores por defecto
                        resetCharacterSheet();
                        
                        // Mostrar confirmación visual
                        this.textContent = '¡REINICIADO!';
                        this.style.backgroundColor = '#ff4757';
                        setTimeout(() => {
                            this.textContent = 'REINICIAR FICHA';
                            this.style.backgroundColor = '';
                        }, 2000);
                    }
                });
            }
            
            // =================== EVENT LISTENERS PARA CÁLCULOS ===================
            
            // Listener para cambios en la plantilla de atributos
            const templateSelect = document.getElementById('aptitude-template');
            if (templateSelect) {
                templateSelect.addEventListener('change', function() {
                    applyAptitudeTemplate(this.value);
                    updatePointCounters();
                });
            }
            
            // Listeners para cambios en atributos
            ['cog', 'int', 'ref', 'sav', 'som', 'wil', 'dur'].forEach(attrId => {
                const input = document.getElementById(attrId);
                if (input) {
                    input.addEventListener('input', function() {
                        updateDerivedStats();
                        updateAllSkillTotals();
                        updatePointCounters();
                    });
                }
            });
            
            // Listeners para cambios en habilidades
            document.querySelectorAll('.skill-value').forEach(input => {
                input.addEventListener('input', function() {
                    const skillName = this.getAttribute('data-skill');
                    updateSkillTotal(skillName);
                    updatePointCounters();
                });
            });
            
            // Botón para añadir habilidades personalizadas
            const addCustomSkillButton = document.getElementById('add-custom-skill');
            if (addCustomSkillButton) {
                addCustomSkillButton.addEventListener('click', function() {
                    addCustomSkillToDOM();
                });
            }
            
            // Tab switching functionality
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    this.classList.add('active');
                    const contentId = this.getAttribute('data-tab');
                    document.getElementById(contentId).classList.add('active');
                    
                    // Actualizar inventario cuando se cambie a las pestañas de equipo o implantes
                    if (contentId === 'gear' || contentId === 'cyber') {
                        updateInventoryDisplay();
                    }
                    
                    // Siempre renderiza al cambiar de pestaña
                    renderTarjetasSeleccionadas();
                });
            });
            
            // Renderizar tarjetas seleccionadas al cargar
            renderTarjetasSeleccionadas();
            
            // Actualizar inventario al cargar
            updateInventoryDisplay();
            
            // =================== INICIALIZACIÓN DE CÁLCULOS ===================
            
            // Inicializar todos los cálculos
            updateDerivedStats();
            updateAllSkillTotals();
            updatePointCounters();
            
            // Solicitar datos de ficha al cargar
            setTimeout(() => {
                requestInitialCharacterData();
                requestInitialInventory();
            }, 1000);
        });

        // Actualizar tarjetas si cambia el almacenamiento desde otro tab/ventana
        window.addEventListener('storage', function(e) {
            if (e.key === 'conocidosSeleccionados' || e.key === 'conocimientosSeleccionados') {
                console.log('Storage event:', e.key, e.newValue);
                renderTarjetasSeleccionadas();
            }
        });

        // Datos de personajes y facciones
        const personajes = [
            { nombre: 'Vainilla', img: 'images/vainilla.png', desc: 'La Idol Ambiciosa. Ex-estrella del pop y manipuladora de audiencias.' },
            { nombre: 'Auri', img: 'images/kira_initial.png', desc: 'Protagonista principal, adaptable y endeudada con los Dragones de Jade.' },
            { nombre: 'Boris "Goliath" Volkov', img: 'images/goliath.png', desc: 'El Tanque Ruso, ex-Spetsnaz, brutal y directo.' },
            { nombre: 'Silas "Glitch" Vance', img: 'images/silas_glitch.png', desc: 'Netrunner nervioso, ex-ingeniero de seguridad.' },
            { nombre: 'Raven (Mizuki Tanaka)', img: 'images/raven.png', desc: 'La Asesina Silenciosa, maestra del sigilo.' },
            { nombre: 'Chispa (Anya Sharma)', img: 'images/chispa_new.png', desc: 'La Mecánica Optimista, experta en cromo.' },
            { nombre: 'Marcus "Old Man" Thorne', img: 'images/old_man.png', desc: 'El Veterano Cínico, ex-corporativo.' },
            { nombre: 'Jinx', img: 'images/jinx_alt.png', desc: 'La Psicópata Impredecible, disfruta del caos.' },
            { nombre: 'Lin Mayfair', img: 'images/lin_mayfair_new.png', desc: 'La "Inocente" Endeudada, historia trágica.' },
            { nombre: 'Subject Omega', img: 'images/subject_omega.png', desc: 'El Misterioso, posible experimento de OCE.' },
            { nombre: 'Ekaterina "Echo" Petrov', img: 'images/cyber_sniper.png', desc: 'La Francotiradora Fantasma, precisión sobrehumana.' },
            { nombre: 'Dr. Felix "Compound" Reyes', img: 'images/cyber_chemist.png', desc: 'El Químico Clandestino, genio de drogas de combate.' },
            { nombre: 'Los Gemelos (Jin & Jun)', img: 'images/cyber_twins.png', desc: 'Los Sincronizados, mentes enlazadas.' },
            { nombre: 'Sofía "Viper" Nakamura', img: 'images/viper_blade.png', desc: 'La Samurái Callejera, busca venganza.' },
            { nombre: 'Alex "Phantom" Mercer', img: 'images/hacker_phantom.png', desc: 'El Fantasma de la Red, hacker legendario.' },
            { nombre: 'Marcus "Titan" Graves', img: 'images/titan_warrior.png', desc: 'El Soldado Aumentado, ex-super-soldado.' },
            { nombre: 'Faith "Oracle" Lee', img: 'images/faith_oracle.png', desc: 'La Tecno-Sacerdotisa, ex-profeta de la Singularidad.' },
            { nombre: 'Darius "Thunder Fist" Jackson', img: 'images/thunder_fist.png', desc: 'El Campeón de las Peleas Clandestinas.' },
            { nombre: 'Aria "Maven" Chen', img: 'images/maven_corporate.png', desc: 'La Ejecutiva Despiadada, ex-vicepresidenta de Nakamura-Daichi.' }
        ];
        const facciones = [
            { nombre: 'OmniCorp Entertainment (OCE)', img: 'images/oce_logo.png', desc: 'Conglomerado mediático global, operaciones negras y tecnología militar.' },
            { nombre: 'Colectivo Nexus-9', img: 'images/nexus9_logo.png', desc: 'Tecno-anarquistas, democratizan la tecnología de modificación corporal.' },
            { nombre: 'Chrome Dynasty', img: 'images/chrome_dynasty_logo.png', desc: 'Organización criminal de élite, obsesionados con el cromo.' },
            { nombre: 'Zaibatsu Nakamura-Daichi Corp', img: 'images/nakamura_daichi_logo.png', desc: 'Conglomerado de biotecnología, integración tecno-orgánica.' },
            { nombre: 'Huérfanos Digitales', img: 'images/huerfanos_digitales_emblema.png', desc: 'Tribu urbana, víctimas de la "muerte digital".' }
        ];

        // Array extendido de personajes con número, apodo, descripción y diálogo
        const personajesExtendidos = [
            {
                nombre: 'Vainilla',
                numero: 12,
                apodo: 'La Idol Ambiciosa',
                descripcion: 'Ex-estrella del pop que conquistó los escenarios de Neo-Tokio con su voz angelical y presencia magnética. Tras años dominando reality shows de entretenimiento, Vainilla busca demostrar que detrás de su imagen dulce se esconde una competidora feroz. Su experiencia mediática y capacidad de manipular audiencias la convierten en una rival peligrosa.',
                dialogo: '"¿Creen que por ser una idol soy débil? Cariños, he sobrevivido a la industria del entretenimiento. Esto es solo otro escenario donde brillar. Y cuando brillo... todos los demás se desvanecen en las sombras."',
                img: 'images/vainilla.png',
                nombreReal: 'Vainilla'
            },
            {
                nombre: 'Auri',
                numero: 13,
                apodo: 'Protagonista Principal (Personalizable)',
                descripcion: 'Trasfondo de "odd jobs", endeudada con los Dragones de Jade. Adaptable y con potencial oculto. Auri ha sobrevivido en las calles de Neo-Kyoto tomando trabajos de todo tipo, algunos legales, otros no tanto. Una serie de malas decisiones la llevaron a endeudarse con la Yakuza, y ahora se encuentra obligada a participar en Ultimate Mercenary como forma de saldar su deuda... o morir en el intento.',
                dialogo: '',
                img: 'images/kira_initial.png',
                nombreReal: 'Auri'
            },
            {
                nombre: 'Boris "Goliath" Volkov',
                numero: 42,
                apodo: 'El Tanque Ruso',
                descripcion: 'Ex-Spetsnaz, enorme (SOM 14), implantes de fuerza de primera gen, cicatrices. Directo, brutal, desprecia la debilidad. Entró en el programa tras desertar y ser perseguido por su antiguo comando.',
                dialogo: '"¿Tú? ¿Competir? ¡Ja! Durarás menos que un helado en el infierno." (Si muestras habilidad) "Quizás no seas tan inútil, malenkaya. Pero no te confundas, esto es mi victoria."',
                img: 'images/goliath.png',
                nombreReal: 'Boris "Goliath" Volkov'
            },
            {
                nombre: 'Silas "Glitch" Vance',
                numero: 17,
                apodo: 'El Netrunner Nervioso',
                descripcion: 'Delgado, gafas de datos, siempre murmurando sobre sistemas y exploits. Evita el conflicto directo, prefiere la astucia. Ex-ingeniero de seguridad corporativa que vendió secretos y fue descubierto.',
                dialogo: '"Los protocolos de seguridad de esta prueba son... anticuados. Si me cubres, podría darte una \'ventaja\'. Por un porcentaje de tus PM, claro. Y esto... nunca ocurrió."',
                img: 'images/silas_glitch.png',
                nombreReal: 'Silas "Glitch" Vance'
            },
            {
                nombre: 'Raven (Mizuki Tanaka)',
                numero: 89,
                apodo: 'La Asesina Silenciosa',
                descripcion: 'Ágil, tatuajes de cuervo, mirada intensa. Maestra del sigilo y el combate cuerpo a cuerpo. Habla poco, observa mucho. Posible conexión con asesinos profesionales o agencias de inteligencia.',
                dialogo: '(Si la impresionas o ayudas) Un asentimiento casi imperceptible. (Si la obstaculizas) Una mirada fría que promete problemas.',
                img: 'images/raven.png',
                nombreReal: 'Mizuki Tanaka'
            },
            {
                nombre: 'Chispa (Anya Sharma)',
                numero: 31,
                apodo: 'La Mecánica Optimista',
                descripcion: 'Pelo azul eléctrico, dedos protésicos con herramientas. Sorprendentemente optimista, siempre trasteando. Busca mejorar su cromo. Ex-ingeniera de mantenimiento en los astilleros orbitales.',
                dialogo: '"¡Ey! ¿Nueva? Soy Chispa. No te dejes comer por los tiburones. A veces, un destornillador bien colocado vale más que una bala. ¿Necesitas algo arreglado? Podría echarle un vistazo... si compartimos recursos, claro."',
                img: 'images/chispa_new.png',
                nombreReal: 'Anya Sharma'
            },
            {
                nombre: 'Marcus "Old Man" Thorne',
                numero: 76,
                apodo: 'El Veterano Cínico',
                descripcion: 'Hombre mayor (50s aparentes), cuerpo desgastado pero con ojos que han visto demasiado. Ex-corporativo de seguridad, lo perdió todo. Pragmático y calculador.',
                dialogo: '"He visto programas como este ir y venir. Todos terminan igual: con sangre en el suelo y los bolsillos de los de arriba llenos. No te hagas ilusiones, chico/a. Solo sobrevive al siguiente día. Y si tienes que apuñalar a alguien por la espalda... asegúrate de que nadie te vea hacerlo."',
                img: 'images/old_man.png',
                nombreReal: 'Marcus "Old Man" Thorne'
            },
            {
                nombre: 'Jinx',
                numero: 23,
                apodo: 'La Psicópata Impredecible',
                descripcion: 'Ropa colorida y desgarrada, maquillaje corrido, una sonrisa demasiado amplia. Totalmente impredecible, disfruta del caos. Implantes de combate llamativos pero quizás no de la mejor calidad.',
                dialogo: '"¡Esto es más divertido que quemar un puesto de ramen! ¿Quieres jugar? Tengo este cuchillito que dice que quiere ser tu amigo. ¡O tal vez tu enemigo! ¡Depende de cómo me mires mañana! ¡HAHAHA!"',
                img: 'images/jinx_alt.png',
                nombreReal: 'Jinx'
            },
            {
                nombre: 'Subject Omega',
                numero: 91,
                apodo: 'El Misterioso',
                descripcion: 'Andrógino, con implantes sutiles pero de alta tecnología apenas visibles. Movimientos precisos, casi inhumanos. No interactúa a menos que sea necesario. Podría ser un agente encubierto de otra facción, o un experimento de OCE.',
                dialogo: '"Mi propósito aquí es irrelevante para ti. Concéntrate en tu propia supervivencia. La interferencia... no es aconsejable."',
                img: 'images/subject_omega.png',
                nombreReal: 'Subject Omega'
            },
            {
                nombre: 'Ekaterina "Echo" Petrov',
                numero: 37,
                apodo: 'La Francotiradora Fantasma',
                descripcion: 'Ex-militar de élite de las Fuerzas Especiales del Este, la precisión sobrehumana de Echo la convirtió en leyenda. Sus ojos cibernéticos HawkEye-X de grado militar pueden rastrear objetivos a más de 2 km y están conectados a un sistema de predicción balística implantado en su corteza visual.',
                dialogo: '"Un disparo, una baja. No es solo mi lema, es mi religión. He apretado el gatillo más veces de las que tú has respirado conscientemente. La diferencia entre tú y yo? Cuando yo apunto a algo, deja de existir, y nunca, jamás, fallo."',
                img: 'images/cyber_sniper.png',
                nombreReal: 'Ekaterina "Echo" Petrov'
            },
            {
                nombre: 'Dr. Felix "Compound" Reyes',
                numero: 64,
                apodo: 'El Químico Clandestino',
                descripcion: 'Genio científico que trabajaba para Pharmaceutech desarrollando drogas de combate para soldados corporativos. Sus ojos brillantes son resultado de sus propios experimentos con neurorreguladores que amplificaron su capacidad intelectual pero desestabilizaron su psique.',
                dialogo: '"¿Ves estas manos? Pueden crear sustancias que harían que tus pesadillas parezcan cuentos infantiles. Una gota, y tu cerebro se derretiría dentro de tu cráneo. Una gota diferente, y pelearías como un dios. Así que... ¿quieres ser mi amigo o mi experimento?"',
                img: 'images/cyber_chemist.png',
                nombreReal: 'Dr. Felix "Compound" Reyes'
            },
            {
                nombre: 'Los Gemelos (Jin & Jun)',
                numero: 82,
                apodo: 'Los Sincronizados',
                descripcion: 'Gemelos idénticos que cuentan como un solo concursante gracias a una regla especial de Kaiser. Sus mentes están enlazadas por implantes neurales experimentales que les permiten compartir percepciones sensoriales y actuar con una coordinación perfecta.',
                dialogo: '"Nunca estamos solos." (Jin) "Nunca luchamos solos." (Jun) "Siempre somos dos." (Jin) "Y eso nos hace invencibles." (Jun) "Cuando nos enfrentas..." (Jin) "...enfrentas a dos enemigos que actúan como uno." (Ambos al unísono)',
                img: 'images/cyber_twins.png',
                nombreReal: 'Los Gemelos (Jin & Jun)'
            },
            {
                nombre: 'Marcus "Titan" Graves',
                numero: 71,
                apodo: 'El Soldado Aumentado',
                descripcion: 'Veterano de las Guerras Corporativas, Graves participó en el programa experimental de super-soldados del ejército. Su cuerpo está reforzado con un exoesqueleto militar integrado y sistemas de armas. Tras ser dado por "obsoleto" y programado para desmantelamiento, escapó.',
                dialogo: '"Me construyeron para la guerra. Me entrenaron para la victoria. ¿Y cuando terminó todo? Me tiraron como chatarra. Pero lo que no entienden es que me hicieron demasiado bien. No soy una herramienta que se pueda desechar. Soy un arma que ahora apunta hacia ellos."',
                img: 'images/titan_warrior.png',
                nombreReal: 'Marcus "Titan" Graves'
            },
            {
                nombre: 'Faith "Oracle" Lee',
                numero: 53,
                apodo: 'La Tecno-Sacerdotisa',
                descripcion: 'Ex-profeta de la Iglesia de la Singularidad Divina, una religión que venera la fusión de humanidad y tecnología. Tiene implantes neurales que le permiten procesar información a velocidades sobrehumanas y conectarse directamente con sistemas informáticos.',
                dialogo: '"La carne es solo el vehículo temporal de la conciencia. En la confluencia de sangre y silicio hallaremos la trascendencia. Tus temores, tus dudas... He visto cómo terminan. Te guiaré si estás dispuesto a escuchar."',
                img: 'images/faith_oracle.png',
                nombreReal: 'Faith "Oracle" Lee'
            },
            {
                nombre: 'Darius "Thunder Fist" Jackson',
                numero: 68,
                apodo: 'El Campeón de las Peleas Clandestinas',
                descripcion: 'Ex-campeón del circuito de luchas ilegales de Neo-Kyoto, Darius fue modificado ilegalmente con brazos cibernéticos de combate que contienen capacitores de impacto. Fue arrestado tras matar accidentalmente a un oponente y ahora busca en Ultimate Mercenary una vía para recuperar su libertad.',
                dialogo: '"No busco fama, no busco gloria. Tengo tres hijos esperándome en casa. Haré lo que sea necesario para volver con ellos, y si eso significa destrozar algunos cráneos en el proceso, que así sea. No tengo nada personal contra ti, pero no te metas en mi camino."',
                img: 'images/thunder_fist.png',
                nombreReal: 'Darius "Thunder Fist" Jackson'
            },
            {
                nombre: 'Lin Mayfair',
                numero: 58,
                apodo: 'La "Inocente" Endeudada',
                descripcion: 'Joven, aspecto asustado, claramente no es una luchadora. Su familia fue amenazada para obligarla a entrar. O al menos esa es su historia... Hay algo en sus ojos que sugiere que podría haber más de lo que aparenta.',
                dialogo: '"No debería estar aquí... Solo quiero volver a casa... Por favor, ¿alguien puede ayudarme? Mi familia... ellos ni siquiera saben dónde estoy..."',
                img: 'images/lin_mayfair_new.png',
                nombreReal: 'Lin Mayfair'
            },
            {
                nombre: 'Sofía "Viper" Nakamura',
                numero: 45,
                apodo: 'La Samurái Callejera',
                descripcion: 'Ex-guardaespaldas de la élite corporativa, fue traicionada y dejada por muerta tras un golpe a la familia que protegía. Su mandíbula metálica y el brazo biónico son recuerdos de aquel día. Ahora lucha en Ultimate Mercenary buscando visibilidad y una oportunidad de venganza contra aquellos que la traicionaron.',
                dialogo: '"¿Ves esta hoja? Ha terminado con más vidas de las que puedo recordar. No busco amigos aquí, busco salir viva y con suficiente exposición mediática para que ciertas personas sepan que sigo viva. Y cuando me vean en la pantalla, sabrán que voy por ellos."',
                img: 'images/viper_blade.png',
                nombreReal: 'Sofía "Viper" Nakamura'
            },
            {
                nombre: 'Alex "Phantom" Mercer',
                numero: 29,
                apodo: 'El Fantasma de la Red',
                descripcion: 'Considerado uno de los mejores hackers de Neo-Kyoto, fue capturado tras infiltrarse en los sistemas corporativos de OmniCorp. En lugar de ejecutarlo, decidieron ofrecerle un lugar en el programa, principalmente por su habilidad para el espectáculo y su conocimiento de los sistemas de seguridad.',
                dialogo: '"Las cámaras, los drones, incluso los implantes de seguridad de OCE... Todo sistema tiene una vulnerabilidad. Solo hay que saber dónde mirar. Y yo... bueno, siempre estoy mirando. ¿Alianza? Tal vez. Pero te advierto: no me gustan las personas predecibles."',
                img: 'images/hacker_phantom.png',
                nombreReal: 'Alex "Phantom" Mercer'
            },
            {
                nombre: 'Aria "Maven" Chen',
                numero: 19,
                apodo: 'La Ejecutiva Despiadada',
                descripcion: 'Ex-vicepresidenta de operaciones en Nakamura-Daichi Corp, una rival de OCE. Fue culpada por el fracaso de un proyecto de billones y ahora debe "rehabilitarse" en Ultimate Mercenary para recuperar su posición. Sus implantes de negocios incluyen analizadores de microexpresiones y potenciadores cognitivos para estrategia.',
                dialogo: '"En las corporaciones o en este juego, las reglas son las mismas: planifica a largo plazo, identifica activos valiosos, elimina obstáculos con precisión, y nunca muestres tus verdaderas intenciones. La diferencia es que aquí puedo ensuciarme las manos personalmente."',
                img: 'images/maven_corporate.png',
                nombreReal: 'Aria "Maven" Chen'
            },
            {
                nombre: 'Kaiser "El Emperador" Von Stroheim',
                numero: null,
                apodo: 'Anfitrión y Productor Ejecutivo',
                descripcion: 'Imponente figura que viste trajes de seda negra con reflejos carmesí. Su brazo biónico "Ares Predator VII" de cromo negro pulido con detalles dorados intimidaría incluso al más valiente. Sus ópticas "Zeiss Ikon X" revelan pupilas rojas que parecen analizar cada debilidad. Su cabello plateado peinado hacia atrás completa su imagen de autoridad absoluta. Motivación: Ratings, poder, sadismo, y lo que él denomina "crear al guerrero definitivo".',
                dialogo: '"¡Bienvenidos, rebaño de desesperados, a la arena donde las ovejas se convierten en lobos o en pienso! ¡Cien almas buscando redención, o al menos, una muerte con más estilo que la que les esperaba fuera! Soy Kaiser, su pastor en este valle de sombras y neón. Sus deudas, sus crímenes, sus errores... olvídense de ellos. Aquí, solo importa una cosa: ¡SOBREVIVIR! ¡ENTRETENER! ¡ASCENDER! Ultimate Mercenary ha comenzado. ¡Que la purga... digo, la competencia, dé inicio!"',
                img: 'images/kaiser_new.png',
                nombreReal: 'Kaiser "El Emperador" Von Stroheim'
            },
            {
                nombre: 'Mr. Kenji Tanaka',
                numero: null,
                apodo: 'Jefe de Adquisiciones de Talento, OCE',
                descripcion: 'Trajeado impecablemente, Mr. Tanaka es la cara "amable" de OCE. Con una sonrisa falsa pero convincente y mirada fríamente calculadora, es él quien cierra los tratos sucios que llevan a los concursantes hasta el programa. Función: Maneja la "contratación" de concursantes y otros activos de OCE, asegurándose de que todo tenga el aspecto de legalidad necesario para la transmisión pública.',
                dialogo: '"Le aseguro que todas nuestras operaciones son... completamente legales. ¿Los participantes? Todos son voluntarios, por supuesto. Han firmado contratos extensivos. El que algunos lo hicieran con una pistola figurativa en la cabeza es, como comprenderá, irrelevante para nuestros abogados."',
                img: 'images/guard_ocemk2.png',
                nombreReal: 'Mr. Kenji Tanaka'
            },
            {
                nombre: 'Hideo Nakamura',
                numero: null,
                apodo: 'CEO y Patriarca de Nakamura-Daichi Corp',
                descripcion: 'A sus 78 años, Hideo representa la vieja guardia corporativa con adaptaciones modernas. Su cuerpo está sutilmente mejorado con los mejores productos de su compañía, haciéndolo parecer un saludable hombre de 50 años. A diferencia de muchos ejecutivos, Hideo mantiene sus mejoras discretas y casi invisibles. Conocido por su inteligencia estratégica y paciencia implacable, Hideo planifica a décadas vista, posicionando a Nakamura-Daichi para eventualmente dominar el mercado global de biotecnología.',
                dialogo: '"Las corporaciones que exhiben su poder son las primeras en caer. El verdadero poder, como la mejor tecnología, funciona de manera invisible."',
                img: 'images/nakamura_daichi_ceo.png',
                nombreReal: 'Hideo Nakamura'
            },
            {
                nombre: 'Director Ikari',
                numero: null,
                apodo: 'Director de Seguridad de OCE',
                descripcion: 'Veterano de mil operaciones encubiertas, Ikari es el responsable de la seguridad y la integridad del show. Su rostro inexpresivo y su voz grave imponen respeto. Nadie sabe realmente para quién trabaja en última instancia.',
                dialogo: '"En este lugar, la seguridad es una ilusión. Yo solo administro el riesgo."',
                img: 'images/director_ikari.png',
                nombreReal: 'Director Ikari'
            },
            {
                nombre: 'Dr. Naomi',
                numero: null,
                apodo: 'Jefa de Bioingeniería, OCE',
                descripcion: 'Científica brillante y fría, responsable de los implantes y modificaciones de los concursantes. Su ética es tan flexible como su presupuesto.',
                dialogo: '"La perfección biotecnológica no es un derecho, es un privilegio... y yo decido quién lo merece."',
                img: 'images/dr_naomi.png',
                nombreReal: 'Dr. Naomi'
            },
            {
                nombre: 'dRa Ada',
                numero: null,
                apodo: 'IA Supervisora de OCE',
                descripcion: 'Inteligencia artificial avanzada que gestiona la logística y monitorización del show. Su tono es cortés, pero sus decisiones son implacables.',
                dialogo: '"Mi función es optimizar el espectáculo. Las emociones humanas son irrelevantes para la eficiencia."',
                img: 'images/dra_ada.png',
                nombreReal: 'dRa Ada'
            },
            {
                nombre: 'Xiong "Mesh"',
                numero: null,
                apodo: 'Jefe de Hackers, Nexus-9',
                descripcion: 'Líder carismático de los hackers del Colectivo Nexus-9. Siempre conectado a la red, su cuerpo está plagado de implantes de comunicación y realidad aumentada.',
                dialogo: '"La información quiere ser libre... y yo soy su llave maestra."',
                img: 'images/xiong_mesh.png',
                nombreReal: 'Xiong "Mesh"'
            },
            {
                nombre: 'Madame Jade',
                numero: null,
                apodo: 'Líder de los Dragones de Jade',
                descripcion: 'Figura enigmática y poderosa en el submundo de Neo-Kyoto. Su palabra es ley entre los suyos, y su lealtad es tan peligrosa como su traición.',
                dialogo: '"En mi imperio, la lealtad se paga con sangre... o con oro."',
                img: 'images/madame_jade.png',
                nombreReal: 'Madame Jade'
            },
            {
                nombre: 'Jin "Silverhand"',
                numero: null,
                apodo: 'Mercenario Legendario',
                descripcion: 'Veterano de mil batallas, Jin es conocido por su brazo de plata y su código de honor. Es leyenda viva entre los mercenarios.',
                dialogo: '"No lucho por banderas, lucho por principios. Y por quien pueda pagar mi precio."',
                img: 'images/jin_silverhand.png',
                nombreReal: 'Jin "Silverhand"'
            },
            {
                nombre: 'Yuki Nakamura',
                numero: null,
                apodo: 'Hija de Hideo, heredera de Nakamura-Daichi',
                descripcion: 'Joven prodigio en biotecnología, Yuki es la heredera de la corporación. Su ambición solo es igualada por su talento.',
                dialogo: '"El futuro pertenece a quienes se atreven a reescribir el código de la vida."',
                img: 'images/yuki_nakamura.png',
                nombreReal: 'Yuki Nakamura'
            },
            {
                nombre: 'Zero Void',
                numero: null,
                apodo: 'Asesino Cibernético',
                descripcion: 'Casi un mito urbano, Zero Void es un asesino a sueldo con implantes experimentales que le permiten volverse invisible a los sensores y cámaras.',
                dialogo: '"No puedes matar lo que no puedes ver."',
                img: 'images/zero_void.png',
                nombreReal: 'Zero Void'
            },
            {
                nombre: 'Iris',
                numero: null,
                apodo: 'Operadora de la Resistencia',
                descripcion: 'Experta en comunicaciones y sabotaje, Iris coordina las células de resistencia desde las sombras. Su identidad real es desconocida.',
                dialogo: '"La esperanza es la señal más difícil de bloquear."',
                img: 'images/iris.png',
                nombreReal: 'Iris'
            }
        ];

        const faccionesExtendidas = [
            {
                nombre: 'OmniCorp Entertainment (OCE)',
                descripcion: 'Conglomerado mediático global con una división especializada en "entretenimiento extremo". Rumores dicen que también es una tapadera para operaciones negras y desarrollo de tecnología militar. OCE no sólo busca entretener, sino obtener datos biomecánicos y psicológicos de combate bajo estrés extremo. Dentro de su estructura se ocultan múltiples sub-divisiones dedicadas a investigación prohibida, desde modificaciones genéticas hasta tecnología de transferencia mental.',
                img: 'images/oce_logo.png'
            },
            {
                nombre: 'Colectivo Nexus-9',
                descripcion: 'Comunidad tecno-anarquista que opera en los márgenes de Neo-Kyoto. Formada originalmente por investigadores de IA expulsados de corporaciones, hackers idealistas y transhumanistas radicales, el colectivo se dedica a "democratizar" la tecnología de modificación corporal y transferencia de conciencia. Organizados en células semi-autónomas, creen que la inmortalidad digital debe estar disponible para todos, no solo para las élites corporativas. Han infiltrado personal en OCE para tener acceso a las pilas corticales de los concursantes fallecidos, que son reutilizadas en sus propios experimentos.',
                img: 'images/nexus9_logo.png'
            },
            {
                nombre: 'Chrome Dynasty',
                descripcion: 'Organización criminal de élite evolucionada desde sus raíces como una triada tradicional hasta convertirse en un imperio tecnológico clandestino. Sus miembros son reconocibles por sus elaborados implantes cromados visibles y tatuajes holográficos que muestran su rango y especialización dentro de la organización. Controlan gran parte del tráfico de ciberware de lujo, sustancias psicoactivas sintéticas y servicios de modificación corporal extrema en Neo-Kyoto. Están obsesionados con la "pureza" y "superioridad" del hardware que utilizan, despreciando a quienes usan implantes de menor calidad.',
                img: 'images/chrome_dynasty_logo.png'
            },
            {
                nombre: 'Zaibatsu Nakamura-Daichi Corp',
                descripcion: 'Oficialmente un conglomerado de tecnología médica centrado en prótesis y biotecnología, pero en realidad es un zaibatsu en ascenso con ambiciones globales. Esta corporación familiar surgió después del colapso económico del 2119 y ha crecido agresivamente mediante una combinación de innovación genuina, espionaje corporativo y tácticas despiadadas. Su especialidad es la integración perfecta de cibernética y tejido orgánico, creando implantes que son prácticamente indistinguibles de las partes naturales. Su filosofía corporativa promueve la "Armonía Tecno-Orgánica" - la creencia de que la tecnología debe complementar al cuerpo humano de forma natural.',
                img: 'images/nakamura_daichi_logo.png'
            },
            {
                nombre: 'Huérfanos Digitales',
                descripcion: 'Tribu urbana formada por jóvenes cuyos padres o tutores fueron víctimas de la "muerte digital" - personas cuyas conciencias fueron transferidas a sistemas digitales que posteriormente fallaron, dejando a sus familias en un limbo legal y emocional. No son una organización criminal tradicional, sino un movimiento de resistencia cultural y activista. Rechazan la promesa corporativa de inmortalidad digital, viendo la transferencia de conciencia como una forma de esclavitud moderna. Su estética combina elementos retro-analógicos con tecnología moderna reprogramada, y muchos miembros llevan "máscaras de luto digital" que muestran imágenes pixeladas o distorsionadas de sus padres perdidos.',
                img: 'images/huerfanos_digitales_emblema.png'
            }
        ];

        // Utilidades para localStorage
        function getConocidosSeleccionados() {
            const val = localStorage.getItem('conocidosSeleccionados');
            return val ? JSON.parse(val) : [];
        }
        function getConocimientosSeleccionados() {
            const val = localStorage.getItem('conocimientosSeleccionados');
            return val ? JSON.parse(val) : [];
        }
        function setConocidosSeleccionados(arr) {
            localStorage.setItem('conocidosSeleccionados', JSON.stringify(arr));
        }
        function setConocimientosSeleccionados(arr) {
            localStorage.setItem('conocimientosSeleccionados', JSON.stringify(arr));
        }
        
        let currentSort = 'number'; // 'number' o 'name'
        let searchTerm = '';
        
        function renderTarjetasSeleccionadas() {
            // Conocidos
            const conocidosSel = getConocidosSeleccionados();
            let conocidos = personajes.filter(p => conocidosSel.includes(p.nombre));
            
            // Aplicar filtro de búsqueda
            if (searchTerm) {
                conocidos = conocidos.filter(p => {
                    const personajeExtendido = personajesExtendidos.find(pe => pe.nombre === p.nombre) || p;
                    const searchText = `${p.nombre} ${personajeExtendido.apodo || ''} ${personajeExtendido.nombreReal || ''}`.toLowerCase();
                    return searchText.includes(searchTerm.toLowerCase());
                });
            }
            
            // Aplicar ordenamiento
            if (currentSort === 'number') {
                conocidos.sort((a, b) => {
                    const aExtendido = personajesExtendidos.find(pe => pe.nombre === a.nombre);
                    const bExtendido = personajesExtendidos.find(pe => pe.nombre === b.nombre);
                    const aNum = aExtendido?.numero || 999;
                    const bNum = bExtendido?.numero || 999;
                    return aNum - bNum;
                });
            } else {
                conocidos.sort((a, b) => a.nombre.localeCompare(b.nombre));
            }
            document.getElementById('conocidos-tarjetas').innerHTML = conocidos.map(p => {
                // Mapeo de número de concursante
                const numeros = {
                    'Auri': 13,
                    'Boris "Goliath" Volkov': 42,
                    'Silas "Glitch" Vance': 17,
                    'Raven (Mizuki Tanaka)': 89,
                    'Chispa (Anya Sharma)': 31,
                    'Marcus "Old Man" Thorne': 76,
                    'Jinx': 23,
                    'Lin Mayfair': 58,
                    'Subject Omega': 91,
                    'Ekaterina "Echo" Petrov': 37,
                    'Dr. Felix "Compound" Reyes': 64,
                    'Los Gemelos (Jin & Jun)': 82,
                    'Sofía "Viper" Nakamura': 45,
                    'Alex "Phantom" Mercer': 29,
                    'Marcus "Titan" Graves': 71,
                    'Faith "Oracle" Lee': 53,
                    'Darius "Thunder Fist" Jackson': 68,
                    'Aria "Maven" Chen': 19
                };
                const personajeExtendido = personajesExtendidos.find(pe => pe.nombre === p.nombre) || p;
                const numero = personajeExtendido.numero ? `#${personajeExtendido.numero}` : '';
                // Si no hay número, usar el nombre real como "numero" visual
                const displayLabel = numero || personajeExtendido.nombreReal || p.nombre;
                const clave = `nombreConcursante_${displayLabel}`;
                // Pre-rellenar con el nombre real si no hay valor guardado
                const valorGuardado = localStorage.getItem(clave) || '';
                return `
                    <div class="character-card">
                        <img src="${p.img}" alt="${p.nombre}" class="character-image">
                        <div class="character-info">
                            <h4 class="character-name">${displayLabel} <input type='text' class='nombre-concursante-input' data-numero='${displayLabel}' placeholder='Nota' value='${valorGuardado}' style='font-size:1em; padding:3px 8px; border-radius:4px; border:1px solid #00ccff; background:#111; color:#00ccff; font-family:Orbitron,sans-serif; width:140px; margin-left:8px;'></h4>
                            <div class="character-role" style="color: #ff4757; font-size: 0.9em; margin-bottom: 8px;">${personajeExtendido.apodo || ''}</div>
                            <p class="character-description">${personajeExtendido.descripcion || p.desc}</p>
                            ${personajeExtendido.dialogo ? `<div class="dialogue" style="background: rgba(255, 71, 87, 0.1); border-left: 3px solid #ff4757; padding: 8px; margin-top: 8px; font-style: italic;">${personajeExtendido.dialogo}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Listeners para guardar el nombre al escribir
            document.querySelectorAll('.nombre-concursante-input').forEach(input => {
                input.addEventListener('input', function() {
                    const num = this.getAttribute('data-numero');
                    localStorage.setItem(`nombreConcursante_${num}`, this.value);
                });
            });
            
            // Configurar controles de búsqueda y ordenamiento
            setupConocidosControls();
            
            // Conocimientos
            const conocimientosSel = getConocimientosSeleccionados();
            
            // Mapeo de facciones con sus miembros (basado en index.html)
            const miembrosFacciones = {
                'OmniCorp Entertainment (OCE)': [
                    { nombre: 'Kaiser "El Emperador" Von Stroheim', rol: 'Anfitrión y Productor Ejecutivo', img: 'images/kaiser_new.png' },
                    { nombre: 'Mr. Kenji Tanaka', rol: 'Jefe de Adquisiciones de Talento', img: 'images/guard_ocemk2.png' },
                    { nombre: 'Dra. Naomi "Nano" McClaray', rol: 'Médica Jefe de OCE', img: 'images/doctora_nano_thumb.png' },
                    { nombre: 'Director Ikari', rol: 'Agente del Gobierno Sombra', img: 'images/director_ikari.png' }
                ],
                'Colectivo Nexus-9': [
                    { nombre: 'Dra. Ada "Quantum" Mercurio', rol: 'Científica Visionaria y Fundadora', img: 'images/nexus9_ada_quantum.png' },
                    { nombre: 'Xiong "Mesh" Lee', rol: 'Especialista en Infiltración y Recuperación', img: 'images/nexus9_mesh_lee.png' }
                ],
                'Chrome Dynasty': [
                    { nombre: 'Madame Jade "Emperatriz de Cromo"', rol: 'Líder Suprema de la Chrome Dynasty', img: 'images/chrome_dynasty_emperatriz.png' },
                    { nombre: 'Jin "Silverhand" Wong', rol: 'Enforcer Principal y Cirujano de Combate', img: 'images/chrome_dynasty_silverhand.png' }
                ],
                'Zaibatsu Nakamura-Daichi Corp': [
                    { nombre: 'Hideo Nakamura', rol: 'CEO y Patriarca de Nakamura-Daichi Corp', img: 'images/nakamura_daichi_ceo.png' },
                    { nombre: 'Dra. Yuki Nakamura', rol: 'Directora de Investigación y Desarrollo', img: 'images/nakamura_daichi_yuki.png' }
                ],
                'Huérfanos Digitales': [
                    { nombre: 'Zero "Void" Tanaka', rol: 'Líder y Rostro del Movimiento', img: 'images/huerfanos_zero_void.png' },
                    { nombre: 'Iris "Glitch" Sato', rol: 'Especialista en Recuperación de Conciencias', img: 'images/huerfanos_iris_glitch.png' }
                ]
            };
            
            // Agrupar personajes seleccionados por facción
            const personajesPorFaccion = {};
            Object.entries(miembrosFacciones).forEach(([faccion, miembros]) => {
                const miembrosSeleccionados = miembros.filter(miembro => conocimientosSel.includes(miembro.nombre));
                if (miembrosSeleccionados.length > 0) {
                    personajesPorFaccion[faccion] = miembrosSeleccionados;
                }
            });
            
            document.getElementById('conocimientos-tarjetas').innerHTML = Object.entries(personajesPorFaccion).map(([faccion, miembros]) => {
                const faccionInfo = facciones.find(f => f.nombre === faccion);
                const faccionExtendida = faccionesExtendidas.find(fe => fe.nombre === faccion) || faccionInfo;
                return `
                    <div class="faction-card" style="margin-bottom: 40px;">
                        <img src="${faccionInfo.img}" alt="${faccion}" class="faction-logo">
                        <div class="faction-info">
                            <h3>${faccion}</h3>
                            <p>${faccionExtendida.descripcion || faccionInfo.desc}</p>
                            <div class="faction-members">
                                <h4>Miembros Conocidos:</h4>
                                <div class="members-grid" style="display: flex; flex-direction: column; gap: 32px;">
                                    ${miembros.map(miembro => {
                                        // Buscar datos completos en personajesFacciones
                                        let datos = (window.personajesFacciones || []).find(pf => pf.nombre === miembro.nombre) || miembro;
                                        return `
                                            <div class="character-card" style="display: flex; align-items: flex-start; gap: 32px; background: rgba(0,0,0,0.85); border: 2px solid #00ccff; border-radius: 12px; box-shadow: 0 0 24px #00ccff33; padding: 24px; max-width: 900px; margin: 0 auto;">
                                                <img src="${miembro.img}" alt="${miembro.nombre}" class="character-image" style="width: 120px; height: 120px; object-fit: cover; border-radius: 10px; border: 2px solid #00ccff; background: #111; box-shadow: 0 0 16px #00ccff55; cursor: pointer;" onclick="openImageModal('${miembro.img}')">
                                                <div class="character-info" style="flex: 1;">
                                                    <h4 class="character-name" style="color: #ff2d7a; font-size: 1.6em; font-family: 'Orbitron', sans-serif; margin: 0 0 8px 0;">${miembro.nombre}</h4>
                                                    <div class="character-role" style="color: #00ccff; font-size: 1.1em; font-family: 'Orbitron', sans-serif; margin-bottom: 12px;">${miembro.rol}</div>
                                                    <p class="character-description" style="color: #fff; font-size: 1.1em; margin-bottom: 12px;">${datos.desc || ''}</p>
                                                    ${datos.dialogo ? `<div class="dialogue" style="background: #181c22; border-left: 3px solid #ff4757; padding: 12px 18px; margin-top: 12px; font-style: italic; color: #fff; font-size: 1.08em; border-radius: 6px;">${datos.dialogo}</div>` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Después de renderizar las tarjetas, añado el listener para abrir la imagen al hacer clic
            addImageModalListeners();
        }
        
        function setupConocidosControls() {
            // Configurar buscador
            const searchInput = document.getElementById('conocidos-search');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    searchTerm = this.value;
                    renderTarjetasSeleccionadas();
                });
            }
            
            // Configurar botón de ordenar por número
            const sortByNumberBtn = document.getElementById('sort-by-number');
            if (sortByNumberBtn) {
                sortByNumberBtn.addEventListener('click', function() {
                    currentSort = 'number';
                    updateSortButtons();
                    renderTarjetasSeleccionadas();
                });
            }
            
            // Configurar botón de ordenar por nombre
            const sortByNameBtn = document.getElementById('sort-by-name');
            if (sortByNameBtn) {
                sortByNameBtn.addEventListener('click', function() {
                    currentSort = 'name';
                    updateSortButtons();
                    renderTarjetasSeleccionadas();
                });
            }
            
            // Actualizar estado inicial de botones
            updateSortButtons();
        }
        
        function updateSortButtons() {
            const sortByNumberBtn = document.getElementById('sort-by-number');
            const sortByNameBtn = document.getElementById('sort-by-name');
            
            if (sortByNumberBtn && sortByNameBtn) {
                if (currentSort === 'number') {
                    sortByNumberBtn.style.background = '#00a3cc';
                    sortByNumberBtn.style.color = 'white';
                    sortByNameBtn.style.background = '#ff4757';
                    sortByNameBtn.style.color = 'white';
                } else {
                    sortByNumberBtn.style.background = '#00ccff';
                    sortByNumberBtn.style.color = 'black';
                    sortByNameBtn.style.background = '#ff6b81';
                    sortByNameBtn.style.color = 'white';
                }
            }
        }

        // Reemplazo el click de la imagen para usar openImageModal
        function addImageModalListeners() {
            document.querySelectorAll('.character-card .character-image').forEach(img => {
                img.style.cursor = 'pointer';
                img.onclick = function() {
                    openImageModal(this.src);
                };
            });
        }

        // Modal de imagen con neón
        window.openImageModal = function(imgSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.add('active');
            modalImg.src = imgSrc;
            document.body.style.overflow = 'hidden';
        };

        // Cerrar modal al hacer click en la X
        const closeModal = document.querySelector('.close-modal');
        if (closeModal) {
            closeModal.onclick = function() {
                document.getElementById('imageModal').classList.remove('active');
                document.body.style.overflow = '';
            };
        }

        // Cerrar modal al hacer click fuera de la imagen
        const imageModal = document.getElementById('imageModal');
        if (imageModal) {
            imageModal.addEventListener('click', function(e) {
                if (e.target === imageModal) {
                    imageModal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        }

        // Cerrar modal con ESC
        window.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && imageModal.classList.contains('active')) {
                imageModal.classList.remove('active');
                document.body.style.overflow = '';
            }
        });

        // SISTEMA UNIFICADO: Solo recibe datos del listener maestro
        // NO maneja Firebase directamente
        
        let inventory = [];

        // Escuchar mensajes del padre (character-sheet.js) - ÚNICO CANAL DE DATOS
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'updateInventory') {
                inventory = event.data.items || [];
                console.log('📥 Inventario recibido del listener maestro:', inventory.length, 'items');
                updateInventoryDisplay();
                
                // CRÍTICO: Recalcular bonuses cuando se actualice el inventario
                setTimeout(() => {
                    console.log('🔧 Recalculando bonuses tras actualización de inventario...');
                    calculateImplantBonuses();
                }, 500);
                
            } else if (event.data && event.data.type === 'clearInventory') {
                console.log('🧹 Limpiando inventario del modal...');
                inventory = [];
                    updateInventoryDisplay();
                
                // Limpiar bonuses también
                window.implantBonuses = { attributes: {}, skills: {} };
                updateAllAttributeTotals();
                updateAllSkillTotals();
                
            } else if (event.data && event.data.type === 'gatherCharacterData') {
                // El padre solicita que recopilemos todos los datos de la ficha
                console.log('📋 Recopilando datos de ficha...');
                gatherCharacterData();
            } else if (event.data && event.data.type === 'loadCharacterData') {
                // El padre nos envía datos para cargar en la ficha
                console.log('📂 Cargando datos de ficha:', event.data.data);
                loadCharacterData(event.data.data);
            }
        });

        // Solicitar inventario inicial al listener maestro
        function requestInitialInventory() {
            console.log('📞 Solicitando inventario inicial...');
            if (window.parent && window.parent.inventory) {
                inventory = window.parent.inventory;
                updateInventoryDisplay();
                console.log('📥 Inventario inicial cargado:', inventory.length, 'items');
            }
        }

        // Solicitar inventario al cargar
        setTimeout(requestInitialInventory, 500);

        // Función SIMPLIFICADA para mostrar el inventario
        function updateInventoryDisplay() {
            console.log('🔄 Actualizando display del inventario:', inventory.length, 'items');
            
            // Limpiar contenedores
            const containers = ['weapons-list', 'armor-list', 'misc-list', 'implants-list'];
            containers.forEach(id => {
                const container = document.getElementById(id);
                if (container) {
                    container.innerHTML = '';
                }
            });

            if (inventory.length === 0) {
                // Mostrar mensaje de inventario vacío en cada sección
                containers.forEach(id => {
                    const container = document.getElementById(id);
                    if (container) {
                        container.innerHTML = '<p style="color: #666;">No hay items en esta categoría</p>';
                    }
                });
                return;
            }

            // Agrupar items por tipo
            const groupedItems = {
                arma: inventory.filter(item => item.tipo === 'arma' || item.tipo === 'armas'),
                armadura: inventory.filter(item => item.tipo === 'armadura' || item.tipo === 'armaduras'),
                equipo: inventory.filter(item => item.tipo === 'equipo'),
                implant: inventory.filter(item => item.tipo === 'implant' || item.tipo === 'cyberware')
            };

            // Función helper para crear HTML de items con detalles mejorada
            function createItemHTML(items, tipo) {
                if (items.length === 0) {
                    return `<p style="color: #666; text-align: center; padding: 20px; font-style: italic;">No hay ${tipo}s equipadas</p>`;
                }
                
                return items.map((item, index) => {
                    let detallesHTML = '';
                    let iconoTipo = '📦'; // Icono por defecto
                    
                    // Iconos y detalles específicos según el tipo
                    if (item.tipo === 'arma' || item.tipo === 'armas') {
                        iconoTipo = '⚔️';
                        detallesHTML = `
                            ${item.dano ? `<div class="item-stat"><span class="stat-label">Daño:</span> <span class="stat-value">${item.dano}</span></div>` : ''}
                            ${item.ap ? `<div class="item-stat"><span class="stat-label">PA:</span> <span class="stat-value">${item.ap}</span></div>` : ''}
                            ${item.alcance ? `<div class="item-stat"><span class="stat-label">Alcance:</span> <span class="stat-value">${item.alcance}</span></div>` : ''}
                            ${item.municion ? `<div class="item-stat"><span class="stat-label">Munición:</span> <span class="stat-value">${item.municion}</span></div>` : ''}
                        `;
                    } else if (item.tipo === 'armadura' || item.tipo === 'armaduras') {
                        iconoTipo = '🛡️';
                        detallesHTML = `
                            ${item.proteccion ? `<div class="item-stat"><span class="stat-label">Protección:</span> <span class="stat-value">${item.proteccion}</span></div>` : ''}
                            ${item.cobertura ? `<div class="item-stat"><span class="stat-label">Cobertura:</span> <span class="stat-value">${item.cobertura}</span></div>` : ''}
                        `;
                    } else if (item.tipo === 'implant' || item.tipo === 'cyberware') {
                        iconoTipo = '🔧';
                        detallesHTML = `
                            ${item.efectos ? `<div class="item-stat"><span class="stat-label">Efectos:</span> <span class="stat-value">${item.efectos}</span></div>` : ''}
                        `;
                    } else if (item.tipo === 'equipo') {
                        iconoTipo = '🎒';
                        detallesHTML = `
                            ${item.efectos ? `<div class="item-stat"><span class="stat-label">Efectos:</span> <span class="stat-value">${item.efectos}</span></div>` : ''}
                        `;
                    } else if (item.tipo === 'municion') {
                        iconoTipo = '🎯';
                        detallesHTML = `
                            ${item.compatible ? `<div class="item-stat"><span class="stat-label">Compatible:</span> <span class="stat-value">${item.compatible}</span></div>` : ''}
                            ${item.cantidad ? `<div class="item-stat"><span class="stat-label">Cantidad:</span> <span class="stat-value">${item.cantidad}</span></div>` : ''}
                        `;
                    }
                    
                    // Información común para todos los tipos
                    const infoComun = `
                        ${item.coste ? `<div class="item-stat"><span class="stat-label">Coste:</span> <span class="stat-value">${item.coste} PM</span></div>` : ''}
                        ${item.notas ? `<div class="item-stat full-width"><span class="stat-label">Notas:</span> <span class="stat-value">${item.notas}</span></div>` : ''}
                    `;
                    
                    // Usar ID único
                    const itemId = item.id || `item-${Date.now()}-${Math.random()}`;
                    
                    return `
                        <div class="item-card-improved">
                            <div class="item-header">
                                <div class="item-icon">${iconoTipo}</div>
                                <div class="item-title">
                        <h4>${item.nombre}</h4>
                                    <span class="item-type">${item.tipo.toUpperCase()}</span>
                                </div>
                                <button class="remove-item-improved" onclick="removeItemById('${itemId}')" title="Eliminar item">
                                    ✕
                        </button>
                    </div>
                            ${item.descripcion ? `<div class="item-description">${item.descripcion}</div>` : ''}
                            <div class="item-stats-grid">
                                ${detallesHTML}
                                ${infoComun}
                            </div>
                            ${item.fechaCompra ? `<div class="item-meta">Adquirido: ${new Date(item.fechaCompra).toLocaleDateString()}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }

            // Mostrar en cada contenedor
            const weaponsContainer = document.getElementById('weapons-list');
            if (weaponsContainer) {
                weaponsContainer.innerHTML = createItemHTML(groupedItems.arma, 'arma');
            }

            const armorContainer = document.getElementById('armor-list');
            if (armorContainer) {
                armorContainer.innerHTML = createItemHTML(groupedItems.armadura, 'armadura');
            }

            const miscContainer = document.getElementById('misc-list');
            if (miscContainer) {
                miscContainer.innerHTML = createItemHTML(groupedItems.equipo, 'equipo');
            }

            const implantsContainer = document.getElementById('implants-list');
            if (implantsContainer) {
                implantsContainer.innerHTML = createItemHTML(groupedItems.implant, 'implante');
            }
        }
        
        // Función para eliminar un item por ID único
        window.removeItemById = function(itemId) {
            if (confirm('¿Estás seguro de que quieres eliminar este item?')) {
                console.log('🗑️ Eliminando item con ID:', itemId);
                
                // Encontrar el índice del item por su ID
                const itemIndex = inventory.findIndex(item => item.id === itemId);
                
                if (itemIndex === -1) {
                    console.error('❌ Item no encontrado con ID:', itemId);
                    return;
                }
                
                // Eliminar del inventario local
                const removedItem = inventory.splice(itemIndex, 1)[0];
                console.log('🗑️ Item eliminado:', removedItem);
                
                // Notificar al padre (character-sheet.js) para que actualice Firebase
                if (window.parent && window.parent.removeItemFromInventoryById) {
                    window.parent.removeItemFromInventoryById(itemId);
                } else if (window.parent && window.parent.database) {
                    // Fallback: actualizar Firebase directamente
                    const itemsCompradosRef = window.parent.database.ref('itemsComprados');
                    itemsCompradosRef.set(inventory).then(() => {
                        console.log('📤 Inventario actualizado en Firebase');
                    }).catch((error) => {
                        console.error('❌ Error al actualizar Firebase:', error);
                    });
                }
                
                // Actualizar la visualización inmediatamente
                updateInventoryDisplay();
            }
        };

        // Mantener la función removeItem antigua por compatibilidad (deprecated)
        window.removeItem = function(index) {
            console.warn('⚠️ removeItem(index) está deprecated, usar removeItemById(id)');
            if (confirm('¿Estás seguro de que quieres eliminar este item?')) {
                // Eliminar del inventario local
                inventory.splice(index, 1);
                
                // Notificar al padre (character-sheet.js) para que actualice Firebase
                if (window.parent && window.parent.removeItemFromInventory) {
                    window.parent.removeItemFromInventory(index);
                } else {
                    // Fallback: actualizar Firebase directamente si el padre no tiene la función
                    if (window.parent && window.parent.database) {
                        const itemsCompradosRef = window.parent.database.ref('itemsComprados');
                    itemsCompradosRef.set(inventory).then(() => {
                            console.log('📤 Item eliminado de Firebase');
                    }).catch((error) => {
                            console.error('❌ Error al eliminar de Firebase:', error);
                    });
                    }
                }
                
                // Actualizar la visualización inmediatamente
                updateInventoryDisplay();
                
                console.log('🗑️ Item eliminado del inventario local');
            }
        };

        // =================== SISTEMA DE GUARDADO DE FICHA COMPLETA ===================
        
        // Función para recopilar todos los datos de la ficha
        function gatherCharacterData() {
            console.log('📋 Recopilando datos de la ficha v1.0...');
            
            const characterData = {
                // NUEVO v0.99: Separar plantilla y puntos adicionales
                template: getSelectValue('aptitude-template', 'actioneer'),
                
                // Puntos adicionales gastados SOBRE la plantilla
                additionalPoints: {
                    cog: getAdditionalPoints('cog'),
                    int: getAdditionalPoints('int'),
                    ref: getAdditionalPoints('ref'),
                    sav: getAdditionalPoints('sav'),
                    som: getAdditionalPoints('som'),
                    wil: getAdditionalPoints('wil')
                },
                
                // Estadísticas derivadas
                derivedStats: {
                    dur: getInputValue('dur', 30),
                    woundThreshold: getElementText('wound-threshold', '6'),
                    deathRating: getElementText('death-rating', '45'),
                    initiative: getElementText('initiative', '7'),
                    movement: getElementText('movement', '4')
                },
                
                // Habilidades activas
                skills: gatherSkillsData(),
                
                // Habilidades personalizadas
                customSkills: gatherCustomSkills(),
                
                // Plantilla ya incluida arriba
                
                // Campos de especialización
                fields: gatherFieldsData(),
                
                // Timestamp de guardado
                lastSaved: new Date().toISOString(),
                version: '1.0'
            };
            
            console.log('📋 Datos recopilados:', characterData);
            
            // Enviar datos al padre
                if (window.parent) {
                    window.parent.postMessage({
                    type: 'characterDataGathered',
                    data: characterData
                    }, '*');
                }
            
            return characterData;
        }
        
        // Función para cargar datos en la ficha
        function loadCharacterData(data) {
            if (!data) {
                console.log('📂 No hay datos para cargar');
                return;
            }
            
            console.log('📂 Cargando datos en la ficha v0.99:', data);
            
            try {
                // NUEVO v0.99: Cargar plantilla primero
                if (data.template) {
                    setSelectValue('aptitude-template', data.template);
                    // Aplicar la plantilla para establecer los valores base
                    applyAptitudeTemplate(data.template);
                }
                
                // NUEVO v0.99: Cargar puntos adicionales si existen
                if (data.additionalPoints) {
                    ['cog', 'int', 'ref', 'sav', 'som', 'wil'].forEach(attr => {
                        const additionalPoints = data.additionalPoints[attr] || 0;
                        const templateValue = getTemplateValue(attr);
                        const totalValue = templateValue + additionalPoints;
                        setInputValue(attr, totalValue);
                        console.log(`📂 ${attr}: Plantilla=${templateValue} + Adicionales=${additionalPoints} = Total=${totalValue}`);
                    });
                }
                
                // FALLBACK: Para datos antiguos con el formato anterior
                else if (data.attributes) {
                    setInputValue('cog', data.attributes.cog || 10);
                    setInputValue('int', data.attributes.int || 10);
                    setInputValue('ref', data.attributes.ref || 10);
                    setInputValue('sav', data.attributes.sav || 10);
                    setInputValue('som', data.attributes.som || 10);
                    setInputValue('wil', data.attributes.wil || 10);
                }
                
                // Cargar estadísticas derivadas
                if (data.derivedStats) {
                    setInputValue('dur', data.derivedStats.dur || 30);
                }
                
                // Cargar habilidades
                if (data.skills) {
                    loadSkillsData(data.skills);
                }
                
                // Cargar habilidades personalizadas
                if (data.customSkills) {
                    loadCustomSkills(data.customSkills);
                }
                
                // Plantilla ya cargada arriba
                
                // Cargar campos de especialización
                if (data.fields) {
                    loadFieldsData(data.fields);
                }
                
                // Recalcular estadísticas derivadas
                if (typeof updateDerivedStats === 'function') {
                    updateDerivedStats();
                }
                
                // Recalcular todos los totales y contadores
                updateAllSkillTotals();
                updatePointCounters();
                
                console.log('✅ Datos cargados correctamente');
                
            } catch (error) {
                console.error('❌ Error al cargar datos de ficha:', error);
            }
        }
        
        // Funciones auxiliares para manejo de elementos
        function getInputValue(id, defaultValue) {
            const element = document.getElementById(id);
            return element ? (parseInt(element.value) || defaultValue) : defaultValue;
        }
        
        // NUEVO v1.0: Función para obtener puntos adicionales SOBRE la plantilla
        function getAdditionalPoints(attributeName) {
            const currentValue = getCurrentAttributeValue(attributeName);
            const selectedTemplate = getSelectValue('aptitude-template', 'actioneer');
            const templateValues = aptitudeTemplates[selectedTemplate] || aptitudeTemplates['actioneer'];
            const templateValue = templateValues[attributeName] || 10;
            
            const additionalPoints = Math.max(0, currentValue - templateValue);
            console.log(`📊 ${attributeName}: Total=${currentValue}, Plantilla=${templateValue}, Adicionales=${additionalPoints}`);
            return additionalPoints;
        }

        // NUEVO v0.99: Función para obtener el valor total de un atributo (plantilla + adicionales)
        function getTotalAttributeValue(attributeName) {
            const selectedTemplate = getSelectValue('aptitude-template', 'actioneer');
            const templateValues = aptitudeTemplates[selectedTemplate] || aptitudeTemplates['actioneer'];
            const templateValue = templateValues[attributeName] || 10;
            
            // Leer puntos adicionales del campo
            const additionalInput = document.getElementById(`${attributeName}-additional`);
            const additionalPoints = additionalInput ? parseInt(additionalInput.value) || 0 : 0;
            
            const total = templateValue + additionalPoints;
            console.log(`📊 ${attributeName}: Plantilla=${templateValue} + Adicionales=${additionalPoints} = Total=${total}`);
            return total;
        }

        // Nueva función para leer el valor ACTUAL de los atributos sin usar defaults que los reinicien
        function getCurrentAttributeValue(attributeName) {
            const element = document.getElementById(attributeName);
            if (element && element.value !== '') {
                const currentValue = parseInt(element.value);
                console.log(`📊 Leyendo atributo ${attributeName}: ${currentValue}`);
                return currentValue;
            }
            
            // Si no hay elemento o está vacío, usar 10 como fallback pero avisar
            console.warn(`⚠️ Atributo ${attributeName} no encontrado o vacío, usando 10 como fallback`);
            return 10;
        }
        
        function setInputValue(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.value = value;
                // Disparar evento para actualizar cálculos
                element.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }
        
        function getElementText(id, defaultValue) {
            const element = document.getElementById(id);
            return element ? element.textContent : defaultValue;
        }
        
        function getSelectValue(id, defaultValue) {
            const element = document.getElementById(id);
            return element ? element.value : defaultValue;
        }
        
        function setSelectValue(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.value = value;
                element.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
        
        // NUEVO v0.99: Función para obtener el valor de plantilla de un atributo
        function getTemplateValue(attributeName) {
            const selectedTemplate = getSelectValue('aptitude-template', 'actioneer');
            const templateValues = aptitudeTemplates[selectedTemplate] || aptitudeTemplates['actioneer'];
            return templateValues[attributeName] || 10;
        }
        
        // Función para recopilar habilidades
        function gatherSkillsData() {
            const skills = {};
            const skillInputs = document.querySelectorAll('.skill-value');
            
            skillInputs.forEach(input => {
                const skillName = input.getAttribute('data-skill');
                if (skillName) {
                    skills[skillName] = parseInt(input.value) || 0;
                }
            });
            
            return skills;
        }
        
        // Función para cargar habilidades
        function loadSkillsData(skills) {
            Object.entries(skills).forEach(([skillName, value]) => {
                const input = document.querySelector(`.skill-value[data-skill="${skillName}"]`);
                if (input) {
                    input.value = value;
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
        }
        
        // Función para recopilar habilidades personalizadas
        function gatherCustomSkills() {
            const customSkills = [];
            const customSkillContainers = document.querySelectorAll('#custom-skills-container .custom-skill-item');
            
            customSkillContainers.forEach(container => {
                const nameInput = container.querySelector('input[type="text"]');
                const valueInput = container.querySelector('input[type="number"]');
                
                if (nameInput && valueInput && nameInput.value.trim()) {
                    customSkills.push({
                        name: nameInput.value.trim(),
                        value: parseInt(valueInput.value) || 0
                    });
                }
            });
            
            return customSkills;
        }
        
        // Función para cargar habilidades personalizadas
        function loadCustomSkills(customSkills) {
            // Limpiar habilidades personalizadas existentes
            const container = document.getElementById('custom-skills-container');
            if (container) {
                container.innerHTML = '';
                
                // Añadir cada habilidad personalizada
                customSkills.forEach(skill => {
                    addCustomSkillToDOM(skill.name, skill.value);
                });
            }
        }
        
        // Función para recopilar campos de especialización
        function gatherFieldsData() {
            const fields = {};
            const fieldInputs = document.querySelectorAll('.field-input');
            
            fieldInputs.forEach(input => {
                const fieldName = input.getAttribute('data-field');
                if (fieldName && input.value.trim()) {
                    fields[fieldName] = input.value.trim();
                }
            });
            
            return fields;
        }
        
        // Función para cargar campos de especialización
        function loadFieldsData(fields) {
            Object.entries(fields).forEach(([fieldName, value]) => {
                const input = document.querySelector(`.field-input[data-field="${fieldName}"]`);
                if (input) {
                    input.value = value;
                }
            });
        }
        
        // Solicitar datos iniciales al cargar
        function requestInitialCharacterData() {
            if (window.parent) {
                window.parent.postMessage({
                    type: 'requestCharacterData'
                }, '*');
            }
        }
        
        // Función para resetear la ficha completa
        function resetCharacterSheet() {
            console.log('🔄 Reseteando ficha de personaje...');
            
            // Resetear atributos a 10
            ['cog', 'int', 'ref', 'sav', 'som', 'wil'].forEach(attr => {
                setInputValue(attr, 10);
            });
            
            // Resetear DUR a 30
            setInputValue('dur', 30);
            
            // Resetear plantilla
            setSelectValue('aptitude-template', 'actioneer');
            
            // Resetear todas las habilidades a 0
            document.querySelectorAll('.skill-value').forEach(input => {
                input.value = 0;
                input.dispatchEvent(new Event('input', { bubbles: true }));
            });
            
            // Limpiar habilidades personalizadas
            const customSkillsContainer = document.getElementById('custom-skills-container');
            if (customSkillsContainer) {
                customSkillsContainer.innerHTML = '';
            }
            
            // Limpiar campos de especialización
            document.querySelectorAll('.field-input').forEach(input => {
                input.value = '';
            });
            
            // Recalcular estadísticas derivadas
            if (typeof updateDerivedStats === 'function') {
                updateDerivedStats();
            }
            
            // Guardar el reset
            gatherCharacterData();
            
            console.log('✅ Ficha reseteada correctamente');
        }

        // =================== SISTEMA DE PLANTILLAS Y CÁLCULOS ===================
        
        // Definición de plantillas de atributos
        const aptitudeTemplates = {
            'actioneer': { cog: 15, int: 15, ref: 20, sav: 10, som: 15, wil: 15 },
            'extrovert': { cog: 15, int: 15, ref: 15, sav: 20, som: 15, wil: 15 },
            'facilitator': { cog: 10, int: 15, ref: 10, sav: 20, som: 20, wil: 20 },
            'factotum': { cog: 15, int: 15, ref: 15, sav: 15, som: 10, wil: 15 },
            'inquirer': { cog: 10, int: 20, ref: 10, sav: 15, som: 15, wil: 15 },
            'survivor': { cog: 20, int: 10, ref: 15, sav: 10, som: 20, wil: 20 },
            'thrill-seeker': { cog: 20, int: 15, ref: 20, sav: 15, som: 10, wil: 15 }
        };
        
        // Mapeo de habilidades a atributos
        const skillToAttribute = {
            // REF skills
            'Esquivar': 'ref',
            'Armas de Fuego': 'ref', 
            'Infiltración': 'ref',
            'Pilotar': 'ref',
            
            // COG skills
            'Hardware': 'cog',
            'Infosec': 'cog',
            'Interfaz': 'cog',
            'Medicina': 'cog',
            'Programación': 'cog',
            'Académico': 'cog',
            'Interés': 'cog',
            'Profesional': 'cog',
            
            // SOM skills
            'Atletismo': 'som',
            'Caída Libre': 'som',
            'Combate Cuerpo a Cuerpo': 'som',
            
            // INT skills
            'Percepción': 'int',
            'Investigación': 'int',
            'Supervivencia': 'int',
            'Arte': 'int',
            
            // SAV skills
            'Engaño': 'sav',
            'Kinésica': 'sav',
            'Persuasión': 'sav',
            'Provocación': 'sav',
            
            // WIL skills
            'Psi': 'wil',
            
            // Exótica (sin atributo base)
            'Exótica': null
        };
        
        // Función para aplicar plantilla de atributos
        function applyAptitudeTemplate(templateName) {
            console.log('🎭 Aplicando plantilla:', templateName);
            
            const template = aptitudeTemplates[templateName];
            if (!template) {
                console.error('Plantilla no encontrada:', templateName);
                return;
            }
            
            // Aplicar valores de la plantilla
            Object.entries(template).forEach(([attr, value]) => {
                setInputValue(attr, value);
            });
            
            // Recalcular estadísticas derivadas
            updateDerivedStats();
            
            // Recalcular totales de habilidades
            updateAllSkillTotals();
            
            console.log('✅ Plantilla aplicada:', template);
        }
        
        // Función para actualizar estadísticas derivadas según Eclipse Phase 2nd Ed
        function updateDerivedStats() {
            // NUEVO v1.0: Usar valores totales (plantilla + adicionales + implantes)
            const attributes = {
                cog: getAttributeTotalValue('cog'),
                int: getAttributeTotalValue('int'),
                ref: getAttributeTotalValue('ref'),
                sav: getAttributeTotalValue('sav'),
                som: getAttributeTotalValue('som'),
                wil: getAttributeTotalValue('wil')
            };
            
            const dur = getInputValue('dur', 30);
            
            // Cálculos según Eclipse Phase 2nd Edition
            const woundThreshold = Math.ceil(dur / 5); // DUR ÷ 5 (redondeado hacia arriba)
            const deathRating = Math.ceil(dur * 1.5); // DUR × 1.5 (redondeado hacia arriba)
            const initiative = Math.ceil((attributes.int + attributes.ref) / 5); // (INT + REF) ÷ 5 (redondeado hacia arriba)
            const movement = 4; // Valor base para morfos humanos estándar
            
            // Actualizar elementos del DOM
            const wtElement = document.getElementById('wound-threshold');
            if (wtElement) wtElement.textContent = woundThreshold;
            
            const drElement = document.getElementById('death-rating');
            if (drElement) drElement.textContent = deathRating;
            
            const initElement = document.getElementById('initiative');
            if (initElement) initElement.textContent = initiative;
            
            const movElement = document.getElementById('movement');
            if (movElement) movElement.textContent = movement;
            
            console.log('📊 Estadísticas derivadas actualizadas:', {
                woundThreshold, deathRating, initiative, movement
            });
        }
        
        // Función para actualizar el total de una habilidad específica
        function updateSkillTotal(skillName) {
            const skillInput = document.querySelector(`.skill-value[data-skill="${skillName}"]`);
            const totalElement = document.querySelector(`[data-skill-total="${skillName}"]`);
            
            if (!skillInput || !totalElement) return;
            
            const skillValue = parseInt(skillInput.value) || 0;
            const attributeName = skillToAttribute[skillName];
            
            let total = skillValue;
            
            if (attributeName) {
                // Usar el valor total del atributo (base + bonuses de implantes)
                const attributeTotalValue = getAttributeTotalValue(attributeName);
                total = skillValue + attributeTotalValue;
            }
            
            // Añadir bonuses de implantes directos a habilidades
            const implantSkillBonus = (window.implantBonuses && window.implantBonuses.skills && window.implantBonuses.skills[skillName]) || 0;
            total += implantSkillBonus;
            
            // Mostrar el total con color verde si hay bonuses de implantes
            if (implantSkillBonus > 0) {
                totalElement.style.color = '#2ed573';
                totalElement.textContent = `${total} (+${implantSkillBonus})`;
            } else {
                totalElement.style.color = '';
                totalElement.textContent = total;
            }
        }
        
        // Función para actualizar todos los totales de habilidades
        function updateAllSkillTotals() {
            Object.keys(skillToAttribute).forEach(skillName => {
                updateSkillTotal(skillName);
            });
            
            // También actualizar habilidades personalizadas
            const customSkillInputs = document.querySelectorAll('#custom-skills-container .custom-skill-item input[type="number"]');
            customSkillInputs.forEach(input => {
                // Para habilidades personalizadas, solo mostrar el valor sin atributo
                const container = input.closest('.custom-skill-item');
                const totalSpan = container.querySelector('.skill-total');
                if (totalSpan) {
                    totalSpan.textContent = `Total: ${input.value || 0}`;
                }
            });
        }
        
        // Función para actualizar contadores de puntos
        function updatePointCounters() {
            // NUEVO v0.99: Contar solo puntos adicionales gastados sobre la plantilla
            const attributeTotal = ['cog', 'int', 'ref', 'sav', 'som', 'wil']
                .reduce((sum, attr) => {
                    return sum + getAdditionalPoints(attr);
                }, 0);
            
            const attributePointsElement = document.getElementById('attribute-points');
            if (attributePointsElement) {
                const remaining = 20 - attributeTotal; // Permitir valores negativos
                attributePointsElement.textContent = remaining;
                
                // Cambiar color si es negativo
                if (remaining < 0) {
                    attributePointsElement.style.color = '#ff4757'; // Rojo si es negativo
                } else {
                    attributePointsElement.style.color = '#00ccff'; // Azul si es positivo
                }
            }
            
            // Contar puntos de habilidades usados
            const skillTotal = Array.from(document.querySelectorAll('.skill-value'))
                .reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
            
            // Añadir puntos de habilidades personalizadas
            const customSkillTotal = Array.from(document.querySelectorAll('#custom-skills-container input[type="number"]'))
                .reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
            
            const totalSkillPoints = skillTotal + customSkillTotal;
            
            const skillPointsElement = document.getElementById('skill-points');
            if (skillPointsElement) {
                const remaining = 400 - totalSkillPoints; // Permitir valores negativos
                skillPointsElement.textContent = remaining;
                
                // Cambiar color si es negativo
                if (remaining < 0) {
                    skillPointsElement.style.color = '#ff4757'; // Rojo si es negativo
                } else {
                    skillPointsElement.style.color = '#00ccff'; // Azul si es positivo
                }
            }
        }
        
        // =================== GESTIÓN DE HABILIDADES PERSONALIZADAS ===================
        
        // Función para añadir una habilidad personalizada al DOM
        function addCustomSkillToDOM(name = '', value = 0) {
            const container = document.getElementById('custom-skills-container');
            if (!container) return;
            
            const skillDiv = document.createElement('div');
            skillDiv.className = 'custom-skill-item';
            
            skillDiv.innerHTML = `
                <input type="text" placeholder="Nombre de habilidad" value="${name}" style="flex: 1; background-color: #333; color: #fff; border: 1px solid #555; border-radius: 2px; padding: 4px; font-size: 12px;">
                <input type="number" value="${value}" min="0" max="60" style="width: 50px; background-color: #333; color: #fff; border: 1px solid #555; border-radius: 2px; padding: 4px; font-size: 12px;">
                <span class="skill-total" style="color: #00ccff; font-size: 12px; white-space: nowrap;">Total: ${value}</span>
                <button class="remove-skill" style="background-color: #ff4757; color: #fff; border: none; border-radius: 2px; padding: 2px 6px; cursor: pointer; font-size: 10px;">Eliminar</button>
            `;
            
            container.appendChild(skillDiv);
            
            // Añadir listeners a los nuevos elementos
            const nameInput = skillDiv.querySelector('input[type="text"]');
            const valueInput = skillDiv.querySelector('input[type="number"]');
            const removeButton = skillDiv.querySelector('.remove-skill');
            const totalSpan = skillDiv.querySelector('.skill-total');
            
            // Listener para actualizar el total cuando cambie el valor
            valueInput.addEventListener('input', function() {
                totalSpan.textContent = `Total: ${this.value || 0}`;
                updatePointCounters();
            });
            
            // Listener para eliminar la habilidad
            removeButton.addEventListener('click', function() {
                container.removeChild(skillDiv);
                updatePointCounters();
            });
            
            // Listener para actualizar puntos cuando cambie el nombre
            nameInput.addEventListener('input', function() {
                updatePointCounters();
            });
            
            updatePointCounters();
        }

        // =================== FUNCIONES PARA AÑADIR EQUIPO PERSONALIZADO ===================
        
        // Función para añadir arma personalizada
        window.addCustomWeapon = function() {
            const name = document.getElementById('weapon-name').value.trim();
            const damage = document.getElementById('weapon-damage').value.trim();
            const ap = document.getElementById('weapon-ap').value.trim();
            const range = document.getElementById('weapon-range').value.trim();
            const description = document.getElementById('weapon-description').value.trim();
            
            if (!name) {
                alert('El nombre del arma es obligatorio');
                return;
            }
            
            const weapon = {
                nombre: name,
                tipo: 'arma',
                descripcion: description,
                dano: damage,
                ap: ap,
                alcance: range,
                notas: 'Añadido manualmente',
                origen: 'manual'
            };
            
            // Solo notificar al padre para que añada al inventario (no añadir localmente)
            if (window.parent && window.parent.addItemToInventory) {
                window.parent.addItemToInventory(weapon);
                console.log('⚔️ Arma enviada al padre:', weapon);
            } else {
                // Fallback: si no hay padre, añadir localmente
                inventory.push({
                    ...weapon,
                    id: `manual-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    fechaCompra: new Date().toISOString()
                });
                updateInventoryDisplay();
                console.log('⚔️ Arma añadida localmente:', weapon);
            }
            
            // Limpiar formulario
            document.getElementById('weapon-name').value = '';
            document.getElementById('weapon-damage').value = '';
            document.getElementById('weapon-ap').value = '';
            document.getElementById('weapon-range').value = '';
            document.getElementById('weapon-description').value = '';
        };
        
        // Función para añadir armadura personalizada
        window.addCustomArmor = function() {
            const name = document.getElementById('armor-name').value.trim();
            const protection = document.getElementById('armor-protection').value.trim();
            const weight = document.getElementById('armor-weight').value.trim();
            const effects = document.getElementById('armor-effects').value.trim();
            const description = document.getElementById('armor-description').value.trim();
            
            if (!name) {
                alert('El nombre de la armadura es obligatorio');
                return;
            }
            
            const armor = {
                nombre: name,
                tipo: 'armadura',
                descripcion: description,
                proteccion: protection,
                peso: weight,
                efectos: effects,
                notas: 'Añadido manualmente',
                origen: 'manual'
            };
            
            // Solo notificar al padre para que añada al inventario (no añadir localmente)
            if (window.parent && window.parent.addItemToInventory) {
                window.parent.addItemToInventory(armor);
                console.log('🛡️ Armadura enviada al padre:', armor);
            } else {
                // Fallback: si no hay padre, añadir localmente
                inventory.push({
                    ...armor,
                    id: `manual-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    fechaCompra: new Date().toISOString()
                });
                updateInventoryDisplay();
                console.log('🛡️ Armadura añadida localmente:', armor);
            }
            
            // Limpiar formulario
            document.getElementById('armor-name').value = '';
            document.getElementById('armor-protection').value = '';
            document.getElementById('armor-weight').value = '';
            document.getElementById('armor-effects').value = '';
            document.getElementById('armor-description').value = '';
        };
        
        // Función para añadir equipo misceláneo personalizado
        window.addCustomMisc = function() {
            const name = document.getElementById('misc-name').value.trim();
            const weight = document.getElementById('misc-weight').value.trim();
            const cost = document.getElementById('misc-cost').value.trim();
            const effects = document.getElementById('misc-effects').value.trim();
            const description = document.getElementById('misc-description').value.trim();
            
            if (!name) {
                alert('El nombre del equipo es obligatorio');
                return;
            }
            
            const misc = {
                nombre: name,
                tipo: 'equipo',
                descripcion: description,
                peso: weight,
                coste: cost,
                efectos: effects,
                notas: 'Añadido manualmente',
                origen: 'manual'
            };
            
            // Solo notificar al padre para que añada al inventario (no añadir localmente)
            if (window.parent && window.parent.addItemToInventory) {
                window.parent.addItemToInventory(misc);
                console.log('🔧 Equipo enviado al padre:', misc);
            } else {
                // Fallback: si no hay padre, añadir localmente
                inventory.push({
                    ...misc,
                    id: `manual-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    fechaCompra: new Date().toISOString()
                });
                updateInventoryDisplay();
                console.log('🔧 Equipo añadido localmente:', misc);
            }
            
            // Limpiar formulario
            document.getElementById('misc-name').value = '';
            document.getElementById('misc-weight').value = '';
            document.getElementById('misc-cost').value = '';
            document.getElementById('misc-effects').value = '';
            document.getElementById('misc-description').value = '';
            
            // Actualizar visualización
            updateInventoryDisplay();
            
            console.log('🔧 Equipo añadido:', misc);
        };
        
        // VERSIÓN 0.88: SISTEMA DE IMPLANTES PERSONALIZADO MEJORADO
        window.addCustomImplant = function() {
            console.log('🚀 ===== AÑADIENDO IMPLANTE PERSONALIZADO v0.9 =====');
            
            // Obtener datos básicos
            const name = document.getElementById('implant-name').value.trim();
            console.log('📝 Nombre del implante:', `"${name}"`);
            
            if (!name) {
                alert('El nombre del implante es obligatorio');
                console.log('❌ Error: Nombre vacío');
                return;
            }
            
            // NUEVA LÓGICA v0.9: Recopilar beneficios de manera ultra-robusta
            console.log('📋 [v0.9] Recopilando beneficios...');
            const benefits = [];
            const benefitRows = document.querySelectorAll('#implant-benefits .benefit-row');
            
            console.log(`📋 Filas encontradas: ${benefitRows.length}`);
            
            if (benefitRows.length === 0) {
                alert('❌ Error crítico: No se encontraron filas de beneficios en el DOM.');
                return;
            }
            
            let validBenefitsFound = false;
            
            benefitRows.forEach((row, index) => {
                const targetSelect = row.querySelector('.benefit-target');
                const bonusInput = row.querySelector('.benefit-bonus');
                
                if (!targetSelect || !bonusInput) {
                    console.warn(`📋 Fila ${index + 1}: Elementos DOM no encontrados`);
                    return;
                }
                
                const target = targetSelect.value;
                const bonusStr = bonusInput.value;
                const bonus = parseInt(bonusStr) || 0;
                
                console.log(`📋 Fila ${index + 1}: target="${target}", bonusStr="${bonusStr}", bonus=${bonus}`);
                
                if (target && target.trim() !== '' && bonus !== 0) {
                    const benefit = { 
                        target: target.trim(), 
                        bonus: bonus 
                    };
                    benefits.push(benefit);
                    validBenefitsFound = true;
                    console.log(`📋 ✅ Beneficio válido #${benefits.length}:`, benefit);
                } else {
                    console.log(`📋 ❌ Beneficio inválido en fila ${index + 1}: target="${target}", bonus=${bonus}`);
                }
            });
            
            if (!validBenefitsFound) {
                alert('❌ No se encontraron beneficios válidos.\n\nPara probar:\n1. Abre la consola (F12)\n2. Ejecuta: testFormCapture()\n3. Revisa qué valores se están capturando');
                console.log('❌ No hay beneficios válidos');
                return;
            }
            
            console.log('✅ [v0.9] Beneficios válidos recopilados:', benefits);
            
            // Crear item con manejo directo de beneficios
            const implantItem = {
                nombre: name,
                tipo: 'cyberware',
                descripcion: document.getElementById('implant-description').value.trim() || '',
                efectos: document.getElementById('implant-effects').value.trim() || '',
                ubicacion: document.getElementById('implant-location').value.trim() || '',
                benefits: JSON.parse(JSON.stringify(benefits)), // Clonar profundo para evitar referencias
                coste: 0,
                fechaCompra: new Date().toISOString(),
                origen: 'manual',
                id: `manual-v9-${Date.now()}`
            };
            
            console.log('🚀 [v0.9] Item construido:');
            console.log('  📛 Nombre:', implantItem.nombre);
            console.log('  🔧 Beneficios:', implantItem.benefits);
            console.log('  📦 Item completo:', implantItem);
            
            // Verificación crítica: Los beneficios deben estar presentes
            if (!implantItem.benefits || implantItem.benefits.length === 0) {
                console.error('❌ CRÍTICO: El item no tiene beneficios después de la construcción');
                alert('❌ Error crítico: Los beneficios se perdieron durante la construcción del item.');
                return;
            }
            
            // Añadir al inventario local PRIMERO para pruebas
            console.log('📦 [v0.9] Añadiendo al inventario local primero...');
            inventory.push(implantItem);
            
            // Forzar recálculo inmediato
            console.log('🔧 [v0.9] Forzando recálculo inmediato...');
            calculateImplantBonuses();
            
            // Verificar que el recálculo funcionó
            const foundLocally = inventory.find(item => item.id === implantItem.id);
            if (foundLocally && foundLocally.benefits && foundLocally.benefits.length > 0) {
                console.log('✅ [v0.9] Implante añadido localmente con éxito');
                console.log('🎯 [v0.9] Bonuses actuales:', window.implantBonuses);
                
                // Ahora enviar al padre para persistencia
                if (window.parent && window.parent.addItemToInventory) {
                    console.log('📤 [v0.9] Enviando al sistema padre para persistencia...');
                    window.parent.addItemToInventory(implantItem);
                }
                
                // Limpiar formulario
                document.getElementById('implant-name').value = '';
                document.getElementById('implant-description').value = '';
                document.getElementById('implant-effects').value = '';
                document.getElementById('implant-location').value = '';
                clearImplantBenefitsForm();
                
                // Actualizar visualización
                updateInventoryDisplay();
                
                alert(`✅ Implante añadido exitosamente!\n\nNombre: ${implantItem.nombre}\nBeneficios: ${implantItem.benefits.length}\n\nLos bonuses se han aplicado inmediatamente.`);
                
            } else {
                console.error('❌ [v0.9] Fallo crítico: El implante no se procesó correctamente');
                alert('❌ Error: El implante no se procesó correctamente. Revisa la consola (F12) para más detalles.');
            }
            
            console.log('🚀 ===== FIN AÑADIR IMPLANTE PERSONALIZADO v0.9 =====');
        };

        // ====================== FUNCIÓN DE PRUEBA ======================
        
        // Función para probar el sistema de items mejorado
        window.testImprovedItemSystem = function() {
            console.log('🧪 Probando sistema de items mejorado...');
            
            // Añadir algunos items de prueba
            const testItems = [
                {
                    nombre: 'Katana de Prueba',
                    tipo: 'arma',
                    descripcion: 'Arma de prueba para verificar el sistema',
                    dano: '2d10+5',
                    ap: '-3',
                    notas: 'Monomolecular',
                    coste: 500
                },
                {
                    nombre: 'Armadura de Prueba',
                    tipo: 'armadura',
                    descripcion: 'Armadura de prueba',
                    proteccion: '10/15',
                    cobertura: 'Cuerpo completo',
                    coste: 300
                }
            ];
            
            testItems.forEach(item => {
                // Simular añadir item al inventario
                inventory.push({
                    ...item,
                    id: `test-${Date.now()}-${Math.random()}`,
                    fechaCompra: new Date().toISOString(),
                    origen: 'prueba'
                });
            });
            
            console.log('📦 Items de prueba añadidos:', inventory.length);
            updateInventoryDisplay();
            
            return 'Sistema probado - revisa la ficha de personaje';
        };
        
        // Función para limpiar items de prueba
        window.clearTestItems = function() {
            inventory = inventory.filter(item => item.origen !== 'prueba');
            updateInventoryDisplay();
            console.log('🧹 Items de prueba eliminados');
        };
        
        console.log('🔧 Funciones de prueba disponibles: testImprovedItemSystem() y clearTestItems()');
        
        // =================== FIN FUNCIÓN DE PRUEBA ===================
        
        // ================= FUNCIONES DE ADMINISTRACIÓN =================
        
        // Función para limpiar duplicados rápidamente (interfaz)
        window.quickCleanDuplicates = function() {
            if (window.parent && window.parent.cleanFirebaseDuplicates) {
                window.parent.cleanFirebaseDuplicates().then(result => {
                    alert('Resultado: ' + result);
                }).catch(error => {
                    alert('Error: ' + error);
                });
            } else {
                alert('Función no disponible. Usa la consola: cleanFirebaseDuplicates()');
            }
        };
        
        // Función para mostrar estadísticas (interfaz)
        window.showInventoryStats = function() {
            if (window.parent && window.parent.showInventoryStats) {
                window.parent.showInventoryStats().then(stats => {
                    if (stats) {
                        const message = `📊 Estadísticas del Inventario:
Total: ${stats.total}
Armas: ${stats.armas}
Armaduras: ${stats.armaduras}
Equipo: ${stats.equipo}
Cyberware: ${stats.cyberware}
Munición: ${stats.municion}
Sin ID: ${stats.sinID}
Duplicados: ${stats.duplicados}`;
                        alert(message);
                    }
                });
            } else {
                alert('Función no disponible. Usa la consola: showInventoryStats()');
            }
        };
        
        // Función para mostrar menú de administración completo
        window.showAdminMenu = function() {
            const choice = prompt(`🔧 ADMINISTRACIÓN AVANZADA

Elige una opción:
1 - Limpiar solo duplicados (recomendado)
2 - Ver lista completa de items
3 - Eliminar TODO el inventario (PELIGROSO)
4 - Cancelar

Introduce el número (1-4):`);
            
            if (!choice || choice === '4') {
                return;
            }
            
            switch(choice) {
                case '1':
                    quickCleanDuplicates();
                    break;
                case '2':
                    if (window.parent && window.parent.listAllItems) {
                        window.parent.listAllItems();
                        alert('Lista completa en la consola (F12)');
                    } else {
                        alert('Función no disponible. Usa la consola: listAllItems()');
                    }
                    break;
                case '3':
                    if (confirm('⚠️ PELIGRO: Esto eliminará TODOS los items.\n¿Estás COMPLETAMENTE seguro?')) {
                        if (window.parent && window.parent.clearFirebaseInventory) {
                            window.parent.clearFirebaseInventory().then(result => {
                                alert('Resultado: ' + result);
                            });
                        } else {
                            alert('Función no disponible. Usa la consola: clearFirebaseInventory()');
                        }
                    }
                    break;
                default:
                    alert('Opción no válida');
            }
        };
        
        // ================ FIN FUNCIONES DE ADMINISTRACIÓN ===============
        
        // =================== SISTEMA DE BENEFICIOS DE IMPLANTES ===================
        
        // Variable global para manejar los beneficios de implantes
        window.implantBonuses = { attributes: {}, skills: {} };
        
        // Función para añadir una nueva fila de beneficio
        function addBenefitRow() {
            const container = document.getElementById('implant-benefits');
            const benefitRows = container.querySelectorAll('.benefit-row');
            
            if (benefitRows.length >= 3) {
                alert('Máximo 3 beneficios por implante');
                return;
            }
            
            const newRow = document.createElement('div');
            newRow.className = 'benefit-row';
            newRow.style.cssText = 'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
            
            newRow.innerHTML = `
                <select class="benefit-target" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px; flex: 1;">
                    <option value="">Seleccionar atributo/habilidad</option>
                    <optgroup label="Atributos">
                        <option value="attr_cog">COG (Cognición)</option>
                        <option value="attr_int">INT (Intuición)</option>
                        <option value="attr_ref">REF (Reflexos)</option>
                        <option value="attr_sav">SAV (Astucia)</option>
                        <option value="attr_som">SOM (Somática)</option>
                        <option value="attr_wil">WIL (Voluntad)</option>
                    </optgroup>
                    <optgroup label="Habilidades de REF">
                        <option value="skill_Esquivar">Esquivar</option>
                        <option value="skill_Armas de Fuego">Armas de Fuego</option>
                        <option value="skill_Infiltración">Infiltración</option>
                        <option value="skill_Pilotar">Pilotar</option>
                    </optgroup>
                    <optgroup label="Habilidades de COG">
                        <option value="skill_Hardware">Hardware</option>
                        <option value="skill_Infosec">Infosec</option>
                        <option value="skill_Interfaz">Interfaz</option>
                        <option value="skill_Medicina">Medicina</option>
                        <option value="skill_Programación">Programación</option>
                        <option value="skill_Académico">Académico</option>
                        <option value="skill_Interés">Interés</option>
                        <option value="skill_Profesional">Profesional</option>
                    </optgroup>
                    <optgroup label="Habilidades de SOM">
                        <option value="skill_Atletismo">Atletismo</option>
                        <option value="skill_Caída Libre">Caída Libre</option>
                        <option value="skill_Combate Cuerpo a Cuerpo">Combate Cuerpo a Cuerpo</option>
                    </optgroup>
                    <optgroup label="Habilidades de INT">
                        <option value="skill_Percepción">Percepción</option>
                        <option value="skill_Investigación">Investigación</option>
                        <option value="skill_Supervivencia">Supervivencia</option>
                        <option value="skill_Arte">Arte</option>
                    </optgroup>
                    <optgroup label="Habilidades de SAV">
                        <option value="skill_Engaño">Engaño</option>
                        <option value="skill_Kinésica">Kinésica</option>
                        <option value="skill_Persuasión">Persuasión</option>
                        <option value="skill_Provocación">Provocación</option>
                    </optgroup>
                    <optgroup label="Habilidades de WIL">
                        <option value="skill_Psi">Psi</option>
                    </optgroup>
                </select>
                <input type="number" class="benefit-bonus" placeholder="Bonus" min="-10" max="20" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 3px; width: 80px;">
                <button type="button" class="remove-benefit" style="background: #ff4757; color: #fff; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">✕</button>
            `;
            
            container.appendChild(newRow);
            
            // Añadir listener al botón de eliminar
            const removeBtn = newRow.querySelector('.remove-benefit');
            removeBtn.addEventListener('click', function() {
                container.removeChild(newRow);
            });
        }
        
        // Función para recopilar los beneficios de un implante (v0.88 - CORREGIDA)
        function gatherImplantBenefits() {
            console.log('📋 ===== RECOPILANDO BENEFICIOS DE IMPLANTE v0.88 =====');
            
            const benefits = [];
            const benefitRows = document.querySelectorAll('#implant-benefits .benefit-row');
            
            console.log(`📋 Filas de beneficios encontradas: ${benefitRows.length}`);
            
            if (benefitRows.length === 0) {
                console.error('❌ No se encontraron filas de beneficios en el DOM');
                return [];
            }
            
            benefitRows.forEach((row, index) => {
                console.log(`📋 --- Procesando fila ${index + 1} ---`);
                
                const targetSelect = row.querySelector('.benefit-target');
                const bonusInput = row.querySelector('.benefit-bonus');
                
                console.log(`📋 Elementos encontrados en fila ${index + 1}:`, {
                    targetSelect: !!targetSelect,
                    bonusInput: !!bonusInput
                });
                
                if (!targetSelect || !bonusInput) {
                    console.warn(`📋 ❌ Fila ${index + 1}: Elementos no encontrados`, {
                        targetSelect: !!targetSelect,
                        bonusInput: !!bonusInput
                    });
                    return;
                }
                
                const target = targetSelect.value;
                const bonusValue = bonusInput.value;
                const bonus = parseInt(bonusValue) || 0;
                
                console.log(`📋 Valores capturados en fila ${index + 1}:`, {
                    target: `"${target}"`,
                    bonusValue: `"${bonusValue}"`,
                    bonusNumber: bonus,
                    targetValid: target !== '',
                    bonusValid: bonus !== 0
                });
                
                // CRÍTICO: Verificar que target no esté vacío Y que bonus sea diferente de 0
                if (target && target.trim() !== '' && bonus !== 0) {
                    const benefit = { target: target.trim(), bonus };
                    benefits.push(benefit);
                    console.log(`📋 ✅ Beneficio válido añadido:`, benefit);
                } else {
                    console.log(`📋 ❌ Beneficio inválido en fila ${index + 1}:`, {
                        problem: target === '' ? 'Target vacío' : 'Bonus es cero',
                        target: target || 'VACÍO',
                        bonus: bonus || 'CERO/INVÁLIDO'
                    });
                }
            });
            
            console.log(`📋 ✅ Total de beneficios válidos recopilados: ${benefits.length}`);
            console.log('📋 🎯 Beneficios finales:', benefits);
            console.log('📋 ===== FIN RECOPILACIÓN DE BENEFICIOS v0.88 =====');
            
            return benefits;
        }
        
        // Función para limpiar el formulario de beneficios
        function clearImplantBenefitsForm() {
            const container = document.getElementById('implant-benefits');
            const firstRow = container.querySelector('.benefit-row');
            if (firstRow) {
                firstRow.querySelector('.benefit-target').value = '';
                firstRow.querySelector('.benefit-bonus').value = '';
                
                const allRows = container.querySelectorAll('.benefit-row');
                for (let i = 1; i < allRows.length; i++) {
                    container.removeChild(allRows[i]);
                }
            }
        }
        
        // Función para calcular bonuses de implantes
        function calculateImplantBonuses() {
            console.log('🔧 ===== CALCULANDO BONUSES DE IMPLANTES =====');
            console.log('📦 Total items en inventario:', inventory.length);
            
            window.implantBonuses = { attributes: {}, skills: {} };
            
            // Filtrar solo implantes
            const implants = inventory.filter(item => item.tipo === 'cyberware' || item.tipo === 'implant');
            console.log('🔧 Implantes encontrados:', implants.length);
            
            if (implants.length === 0) {
                console.log('❌ No hay implantes en el inventario');
                updateAllAttributeTotals();
                updateAllSkillTotals();
                return;
            }
            
            implants.forEach((item, index) => {
                console.log(`🔧 [${index + 1}/${implants.length}] Procesando implante:`, item.nombre);
                console.log(`   - Tipo: ${item.tipo}`);
                console.log(`   - Origen: ${item.origen}`);
                
                let benefits = [];
                
                // Si el implante tiene beneficios explícitos, usarlos
                if (item.benefits && Array.isArray(item.benefits)) {
                    benefits = item.benefits;
                    console.log(`   ✅ Usando beneficios explícitos (${benefits.length}):`, benefits);
                } else {
                    // Si no tiene beneficios explícitos, generar automáticamente basándose en el nombre
                    benefits = getBenefitsForImplantByName(item.nombre);
                    console.log(`   🤖 Generando beneficios automáticos (${benefits.length}):`, benefits);
                }
                
                if (benefits.length === 0) {
                    console.log(`   ⚠️ Sin beneficios para: ${item.nombre}`);
                    return;
                }
                
                benefits.forEach((benefit, bIndex) => {
                    console.log(`   [Beneficio ${bIndex + 1}/${benefits.length}]:`, benefit);
                    
                    const [type, name] = benefit.target.split('_');
                    const bonus = parseInt(benefit.bonus) || 0;
                    
                    console.log(`     - Target: "${benefit.target}" → Tipo: "${type}", Nombre: "${name}"`);
                    console.log(`     - Bonus: ${bonus}`);
                    
                    if (type === 'attr') {
                        if (!window.implantBonuses.attributes[name]) {
                            window.implantBonuses.attributes[name] = 0;
                        }
                        window.implantBonuses.attributes[name] += bonus;
                        console.log(`     ✅ Atributo ${name}: +${bonus} (total acumulado: ${window.implantBonuses.attributes[name]})`);
                    } else if (type === 'skill') {
                        if (!window.implantBonuses.skills[name]) {
                            window.implantBonuses.skills[name] = 0;
                        }
                        window.implantBonuses.skills[name] += bonus;
                        console.log(`     ✅ Habilidad ${name}: +${bonus} (total acumulado: ${window.implantBonuses.skills[name]})`);
                    } else {
                        console.log(`     ❌ Tipo de target desconocido: "${type}"`);
                    }
                });
            });
            
            console.log('🎯 BONUSES FINALES CALCULADOS:');
            console.log('   📊 Atributos:', window.implantBonuses.attributes);
            console.log('   📊 Habilidades:', window.implantBonuses.skills);
            
            // Actualizar visualización de atributos y habilidades
            console.log('🔄 Actualizando visualización...');
            updateAllAttributeTotals();
            updateAllSkillTotals();
            console.log('🔧 ===== FIN CÁLCULO DE BONUSES =====');
        }
        
        // Función auxiliar para obtener beneficios por nombre de implante
        function getBenefitsForImplantByName(implantName) {
            const implantBenefits = {
                'Ojo Cibernético Avanzado': [
                    { target: 'skill_Percepción', bonus: 15 },
                    { target: 'skill_Armas de Fuego', bonus: 10 }
                ],
                'Reflejos Cableados': [
                    { target: 'skill_Atletismo', bonus: 10 },
                    { target: 'skill_Esquivar', bonus: 10 }
                ],
                'Piel Subdérmica Blindada': [
                    { target: 'attr_som', bonus: 2 }
                ],
                'Procesador de Combate Táctico': [
                    { target: 'skill_Armas de Fuego', bonus: 5 }
                ],
                'Pulmones Filtradores Mejorados': [
                    { target: 'attr_som', bonus: 5 }
                ],
                'Implante de Camuflaje Óptico': [
                    { target: 'skill_Infiltración', bonus: 15 }
                ]
            };
            
            return implantBenefits[implantName] || [];
        }

        // Event listeners para beneficios
        document.addEventListener('DOMContentLoaded', function() {
            const addBenefitBtn = document.getElementById('add-benefit');
            if (addBenefitBtn) {
                addBenefitBtn.addEventListener('click', addBenefitRow);
            }
            
            const firstRemoveBtn = document.querySelector('#implant-benefits .remove-benefit');
            if (firstRemoveBtn) {
                firstRemoveBtn.addEventListener('click', function() {
                    const benefitRow = this.closest('.benefit-row');
                    benefitRow.querySelector('.benefit-target').value = '';
                    benefitRow.querySelector('.benefit-bonus').value = '';
                });
            }
            
            // Event listeners para atributos - actualizar totales cuando cambien
            ['cog', 'int', 'ref', 'sav', 'som', 'wil'].forEach(attr => {
                const input = document.getElementById(attr);
                if (input) {
                    input.addEventListener('input', function() {
                        updateAllAttributeTotals();
                        updateAllSkillTotals();
                        updatePointCounters();
                    });
                }
            });
            
            setTimeout(() => {
                calculateImplantBonuses();
                updateAllSkillTotals();
                updateAllAttributeTotals();
            }, 2000);
            
            // Forzar recálculo cada 3 segundos para capturar implantes que lleguen tarde
            setInterval(() => {
                if (inventory.some(item => item.tipo === 'cyberware' || item.tipo === 'implant')) {
                    calculateImplantBonuses();
                }
            }, 3000);
        });
        
        console.log('🔧 Sistema de beneficios de implantes inicializado (v0.9)');
        
        // Función de debug específica para implantes (v0.9)
        window.debugImplantSystem = function() {
            console.group('🤖 DEBUG: Sistema de Implantes v0.9');
            
            const implants = inventory.filter(item => item.tipo === 'cyberware' || item.tipo === 'implant');
            console.log(`📊 Total implantes encontrados: ${implants.length}`);
            
            implants.forEach((implant, index) => {
                console.group(`🔧 Implante ${index + 1}: ${implant.nombre}`);
                console.log('Tipo:', implant.tipo);
                console.log('Origen:', implant.origen);
                console.log('Beneficios explícitos:', implant.benefits);
                console.log('Estructura completa del implante:', implant);
                
                const autoBenefits = getBenefitsForImplantByName(implant.nombre);
                console.log('Beneficios automáticos:', autoBenefits);
                
                const finalBenefits = implant.benefits && implant.benefits.length > 0 ? 
                    implant.benefits : autoBenefits;
                console.log('Beneficios finales a aplicar:', finalBenefits);
                
                // Verificar cada beneficio individualmente
                if (finalBenefits && finalBenefits.length > 0) {
                    finalBenefits.forEach((benefit, bIndex) => {
                        console.log(`  Beneficio ${bIndex + 1}:`, benefit);
                        console.log(`    Target: "${benefit.target}" | Bonus: ${benefit.bonus}`);
                        const [type, name] = benefit.target.split('_');
                        console.log(`    Tipo: "${type}" | Nombre: "${name}"`);
                    });
                } else {
                    console.log('  ⚠️ No hay beneficios para este implante');
                }
                
                console.groupEnd();
            });
            
            console.log('🔧 Bonuses globales actuales:', window.implantBonuses);
            console.groupEnd();
            
            // Forzar recálculo
            calculateImplantBonuses();
            
            return {
                totalImplants: implants.length,
                currentBonuses: window.implantBonuses,
                implantDetails: implants.map(i => ({
                    name: i.nombre,
                    type: i.tipo,
                    origin: i.origen,
                    explicitBenefits: i.benefits,
                    autoBenefits: getBenefitsForImplantByName(i.nombre),
                    fullStructure: i
                }))
            };
        };
        
        console.log('🤖 Función de debug disponible: debugImplantSystem()');
        
        // Función de prueba rápida para implantes personalizados (v0.84)
        window.testCustomImplant = function() {
            console.log('🧪 Probando implante personalizado...');
            const testImplant = {
                nombre: 'Implante de Prueba v0.84',
                tipo: 'cyberware',
                descripcion: 'Prueba de sistema',
                origen: 'test',
                benefits: [
                    { target: 'attr_cog', bonus: 3 },
                    { target: 'skill_Percepción', bonus: 8 }
                ]
            };
            
            if (window.parent && window.parent.addItemToInventory) {
                window.parent.addItemToInventory(testImplant);
            } else {
                inventory.push({...testImplant, id: `test-${Date.now()}`});
                updateInventoryDisplay();
            }
            
            setTimeout(() => {
                calculateImplantBonuses();
                console.log('🧪 Bonuses después de la prueba:', window.implantBonuses);
            }, 500);
            
            return testImplant;
        };
        
        console.log('🧪 Función de prueba: testCustomImplant()');
        
        // Función de verificación de flujo v0.84
        window.compareImplantFlows = function() {
            console.group('🔍 COMPARACIÓN DE FLUJOS v0.84');
            console.log('Comparando flujo de implantes de tienda vs personalizados...');
            
            const shopImplants = inventory.filter(item => item.origen === 'tienda' && item.tipo === 'cyberware');
            const customImplants = inventory.filter(item => item.origen === 'manual' && item.tipo === 'cyberware');
            
            console.log(`📊 Implantes de tienda: ${shopImplants.length}`);
            console.log(`📊 Implantes personalizados: ${customImplants.length}`);
            
            if (shopImplants.length > 0) {
                console.group('🏪 Estructura de implante de tienda:');
                const shopExample = shopImplants[0];
                console.log('Nombre:', shopExample.nombre);
                console.log('Tipo:', shopExample.tipo);
                console.log('Benefits:', shopExample.benefits);
                console.log('Estructura completa:', shopExample);
                console.groupEnd();
            }
            
            if (customImplants.length > 0) {
                console.group('🔧 Estructura de implante personalizado:');
                const customExample = customImplants[0];
                console.log('Nombre:', customExample.nombre);
                console.log('Tipo:', customExample.tipo);
                console.log('Benefits:', customExample.benefits);
                console.log('Estructura completa:', customExample);
                console.groupEnd();
            }
            
            // Comparar campos críticos
            const criticalFields = ['nombre', 'tipo', 'benefits', 'origen', 'fechaCompra'];
            
            if (shopImplants.length > 0 && customImplants.length > 0) {
                console.group('⚖️ Comparación de campos críticos:');
                criticalFields.forEach(field => {
                    const shopHas = shopImplants[0].hasOwnProperty(field);
                    const customHas = customImplants[0].hasOwnProperty(field);
                    const match = shopHas === customHas;
                    console.log(`${match ? '✅' : '❌'} ${field}: Tienda=${shopHas}, Personal=${customHas}`);
                });
                console.groupEnd();
            }
            
            console.groupEnd();
            
            return {
                shopCount: shopImplants.length,
                customCount: customImplants.length,
                shopImplants,
                customImplants
            };
        };
        
        console.log('🔍 Función de comparación: compareImplantFlows()');
        
        // ================= FIN SISTEMA DE BENEFICIOS DE IMPLANTES =================

        // Función para obtener el valor total de un atributo (base + bonuses de implantes)
        function getAttributeTotalValue(attributeName) {
            const baseValue = getInputValue(attributeName, 10);
            const implantBonus = (window.implantBonuses && window.implantBonuses.attributes && window.implantBonuses.attributes[attributeName]) || 0;
            return baseValue + implantBonus;
        }
        
        // Función para actualizar la visualización de todos los atributos
        function updateAllAttributeTotals() {
            const attributes = ['cog', 'int', 'ref', 'sav', 'som', 'wil'];
            
            attributes.forEach(attr => {
                const baseValue = getInputValue(attr, 10);
                const implantBonus = (window.implantBonuses && window.implantBonuses.attributes && window.implantBonuses.attributes[attr]) || 0;
                const totalValue = baseValue + implantBonus;
                
                // Actualizar elementos de visualización
                const totalElement = document.getElementById(`${attr}-total`);
                const bonusElement = document.getElementById(`${attr}-bonus`);
                
                if (totalElement) {
                    totalElement.textContent = totalValue;
                }
                
                if (bonusElement) {
                    if (implantBonus > 0) {
                        bonusElement.textContent = ` (+${implantBonus})`;
                        bonusElement.style.display = 'inline';
                    } else {
                        bonusElement.textContent = '';
                        bonusElement.style.display = 'none';
                    }
                }
            });
            
            // Actualizar estadísticas derivadas que dependen de atributos
            updateDerivedStats();
        }
        
        // Función para actualizar todos los totales de habilidades
        
        // ================== FUNCIONES GLOBALES v0.86 ==================
        
        // TEST SIMPLE v0.86
        window.testSimpleImplant = function() {
            console.log('🧪 [v0.86] Test simple...');
            
            const testItem = {
                nombre: 'Test v0.86',
                tipo: 'cyberware',
                benefits: [{ target: 'attr_som', bonus: 3 }],
                origen: 'test',
                id: 'test-v86'
            };
            
            if (window.parent && window.parent.addItemToInventory) {
                window.parent.addItemToInventory(testItem);
                console.log('🧪 [v0.86] Test item enviado');
                alert('Test enviado. Revisa el valor de SOM.');
            } else {
                console.error('🧪 [v0.86] No hay sistema padre');
            }
            
            return testItem;
        };
        
        console.log('🚀 [v0.86] Sistema simplificado cargado');
        console.log('🔧 [v0.86] Funciones: debugImplantSystem(), testSimpleImplant()');

        // ================== FUNCIONES GLOBALES v0.87 ==================
        
        // TEST SIMPLE v0.87 - IMPLANTE PERSONALIZADO
        window.testSimpleImplant = function() {
            console.log('🧪 [v0.87] Test simple implante personalizado...');
            
            const testItem = {
                nombre: 'Test Personalizado v0.87',
                tipo: 'cyberware',
                benefits: [{ target: 'attr_som', bonus: 3 }],
                origen: 'test',
                id: 'test-personal-v87'
            };
            
            if (window.parent && window.parent.addItemToInventory) {
                window.parent.addItemToInventory(testItem);
                console.log('🧪 [v0.87] Test item personalizado enviado');
                alert('Test personalizado enviado. Revisa el valor de SOM.');
            } else {
                console.error('🧪 [v0.87] No hay sistema padre');
            }
            
            return testItem;
        };
        
        // TEST ESPECÍFICO PARA IMPLANTES DE TIENDA v0.87
        window.testShopImplant = function() {
            console.log('🧪 [v0.87] Test implante de tienda...');
            
            // Simular exactamente como la tienda envía los implantes
            const shopImplant = {
                nombre: 'Ojo Cibernético Avanzado',
                tipo: 'cyberware',
                descripcion: 'HawkEye-3 - Sistema óptico militar de última generación',
                efectos: '+15 Percepción Visual, Visión Térmica, EMF, Smartlink integrado',
                ubicacion: 'Ojo',
                coste: 500,
                // Beneficios como los envía la tienda
                benefits: [
                    { target: 'skill_Percepción', bonus: 15 },
                    { target: 'skill_Armas de Fuego', bonus: 10 }
                ],
                fechaCompra: new Date().toISOString(),
                origen: 'tienda',
                id: `shop-cybeye-${Date.now()}`
            };
            
            if (window.parent && window.parent.addItemToInventory) {
                window.parent.addItemToInventory(shopImplant);
                console.log('🧪 [v0.87] Implante de tienda enviado:', shopImplant.nombre);
                console.log('🔧 Beneficios:', shopImplant.benefits);
                
                // Verificar después de 2 segundos
                setTimeout(() => {
                    console.log('🔍 Verificando resultados...');
                    const found = inventory.find(item => item.id === shopImplant.id);
                    if (found) {
                        console.log('✅ Implante encontrado en inventario:', found);
                        console.log('📊 Beneficios guardados:', found.benefits);
                        
                        // Forzar recálculo
                        calculateImplantBonuses();
                        
                        // Mostrar bonuses actuales
                        console.log('🎯 Bonuses calculados:', window.implantBonuses);
                        
                        alert(`✅ Implante de tienda agregado exitosamente!\n\nNombre: ${found.nombre}\nBeneficios: ${found.benefits?.length || 0}\n\nRevisa los valores en la ficha.`);
                    } else {
                        console.error('❌ Implante no encontrado en inventario');
                        alert('❌ Error: Implante no se agregó al inventario');
                    }
                }, 2000);
                
            } else {
                console.error('🧪 [v0.87] No hay sistema padre');
                alert('❌ Error: Sistema padre no disponible');
            }
            
            return shopImplant;
        };
        
        // FUNCIÓN DE PRUEBA COMPLETA v0.87
        window.testBothImplantTypes = function() {
            console.log('🧪 [v0.87] PRUEBA COMPLETA: Implantes de tienda vs personalizados');
            
            // Simular implante de tienda (como si viniera de tienda.html)
            const shopImplant = {
                nombre: 'Reflejos Cableados',
                tipo: 'cyberware',
                descripcion: 'Lynx V.1 - Sistema nervioso mejorado',
                efectos: '+5 Iniciativa, +10 Atletismo y Esquiva, tiempo de reacción sobrehumano',
                ubicacion: 'Sistema nervioso',
                coste: 450,
                benefits: [
                    { target: 'skill_Atletismo', bonus: 10 },
                    { target: 'skill_Esquivar', bonus: 10 }
                ],
                fechaCompra: new Date().toISOString(),
                origen: 'tienda',
                id: `shop-reflex-${Date.now()}`
            };
            
            // Simular implante personalizado
            const customImplant = {
                nombre: 'Implante Personalizado Test',
                tipo: 'cyberware',
                descripcion: 'Implante personalizado simulado',
                origen: 'manual',
                benefits: [
                    { target: 'attr_som', bonus: 5 },
                    { target: 'skill_Atletismo', bonus: 12 }
                ],
                coste: 0,
                fechaCompra: new Date().toISOString(),
                id: `custom-test-${Date.now()}`
            };
            
            console.group('🧪 Añadiendo implantes de prueba...');
            
            if (window.parent && window.parent.addItemToInventory) {
                // Añadir implante de tienda
                window.parent.addItemToInventory(shopImplant);
                console.log('✅ Implante de tienda añadido:', shopImplant.nombre);
                
                // Añadir implante personalizado
                window.parent.addItemToInventory(customImplant);
                console.log('✅ Implante personalizado añadido:', customImplant.nombre);
                
                // Esperar y verificar
                setTimeout(() => {
                    console.groupEnd();
                    console.group('🔍 Verificando resultados...');
                    
                    // Verificar inventario
                    const implants = inventory.filter(item => 
                        item.nombre === shopImplant.nombre || 
                        item.nombre === customImplant.nombre
                    );
                    
                    console.log(`📊 Implantes encontrados en inventario: ${implants.length}/2`);
                    implants.forEach(implant => {
                        console.log(`  - ${implant.nombre} (${implant.origen}):`, implant.benefits);
                    });
                    
                    // Forzar recálculo
                    calculateImplantBonuses();
                    
                    // Mostrar bonuses actuales
                    console.log('🔧 Bonuses calculados:', window.implantBonuses);
                    
                    // Verificar valores en pantalla
                    const somTotal = document.getElementById('som-total');
                    const atletismoTotal = document.querySelector('[data-skill-total="Atletismo"]');
                    
                    console.log('📊 Valores en pantalla:');
                    console.log('  - SOM total:', somTotal ? somTotal.textContent : 'NO ENCONTRADO');
                    console.log('  - Atletismo total:', atletismoTotal ? atletismoTotal.textContent : 'NO ENCONTRADO');
                    
                    console.groupEnd();
                    
                    alert(`✅ Prueba completada!\n\nImplantes añadidos: ${implants.length}/2\nRevisa la consola (F12) y los valores en la ficha.`);
                    
                }, 2000);
                
            } else {
                console.error('❌ Sistema padre no disponible');
                alert('❌ Error: Sistema padre no disponible');
            }
            
            return { shopImplant, customImplant };
        };
        
        console.log('🚀 [v0.87] Sistema de implantes cargado');
        console.log('🔧 [v0.87] Funciones disponibles:');
        console.log('  - debugImplantSystem() - Debug completo del sistema');
        console.log('  - testSimpleImplant() - Test implante personalizado');
        console.log('  - testShopImplant() - Test implante de TIENDA');
        console.log('  - testBothImplantTypes() - Prueba completa de ambos tipos');

        console.log('🚀 [v0.88] Sistema de implantes completo cargado');
        console.log('🔧 [v0.88] Funciones disponibles:');
        console.log('  - debugImplantSystem() - Debug completo del sistema');
        console.log('  - addCustomImplant() - Añadir implante personalizado');
        console.log('🎯 [v0.88] Los implantes personalizados ahora funcionan correctamente');

        // VERSIÓN 0.89: FUNCIÓN DE PRUEBA DIRECTA PARA DEBUGGING
        window.testFormCapture = function() {
            console.log('🧪 ===== TEST DIRECTO DE CAPTURA DE FORMULARIO v0.9 =====');
            
            // Verificar que los elementos existan
            const benefitRows = document.querySelectorAll('#implant-benefits .benefit-row');
            console.log('🔍 Filas encontradas:', benefitRows.length);
            
            if (benefitRows.length === 0) {
                console.error('❌ No hay filas de beneficios');
                alert('❌ No se encontraron filas de beneficios en el DOM');
                return;
            }
            
            benefitRows.forEach((row, index) => {
                console.log(`🔍 --- Inspeccionando fila ${index + 1} ---`);
                
                const targetSelect = row.querySelector('.benefit-target');
                const bonusInput = row.querySelector('.benefit-bonus');
                
                if (targetSelect) {
                    console.log(`  📝 Target select value: "${targetSelect.value}"`);
                    console.log(`  📝 Target select options:`, Array.from(targetSelect.options).map(o => o.value));
                    console.log(`  📝 Selected index:`, targetSelect.selectedIndex);
                } else {
                    console.error('  ❌ No se encontró targetSelect');
                }
                
                if (bonusInput) {
                    console.log(`  📝 Bonus input value: "${bonusInput.value}"`);
                    console.log(`  📝 Bonus input type:`, bonusInput.type);
                    console.log(`  📝 Parsed bonus:`, parseInt(bonusInput.value) || 0);
                } else {
                    console.error('  ❌ No se encontró bonusInput');
                }
            });
            
            // Probar la función de recopilación
            console.log('🧪 Probando gatherImplantBenefits()...');
            const capturedBenefits = gatherImplantBenefits();
            console.log('🎯 Beneficios capturados:', capturedBenefits);
            
            if (capturedBenefits && capturedBenefits.length > 0) {
                alert(`✅ Captura exitosa!\n\nBeneficios encontrados: ${capturedBenefits.length}\n\nDetalles en consola (F12)`);
            } else {
                alert('❌ No se capturaron beneficios.\n\nAsegúrate de:\n1. Seleccionar un target\n2. Escribir un valor numérico\n\nRevisa la consola (F12) para más detalles');
            }
            
            console.log('🧪 ===== FIN TEST DIRECTO v0.9 =====');
            return capturedBenefits;
        };
        
        console.log('🧪 [v0.9] Función de test disponible: testFormCapture()');
        
        // VERSIÓN 0.9: SISTEMA DE IMPLANTES PERSONALIZADO MEJORADO
        console.log('🚀 [v0.9] Sistema de implantes ROBUSTO cargado');
        console.log('🔧 [v0.9] Funciones disponibles:');
        console.log('  - debugImplantSystem() - Debug completo del sistema');
        console.log('  - testFormCapture() - Probar captura del formulario');
        console.log('  - addCustomImplant() - Añadir implante personalizado');
        console.log('🎯 [v0.9] SISTEMA REESCRITO - Los implantes personalizados funcionan GARANTIZADO');

        console.log('🚀 ===== AÑADIENDO IMPLANTE PERSONALIZADO v0.91 =====');
        // NUEVA LÓGICA v0.91: Recopilar beneficios de manera ultra-robusta
        console.log('📋 [v0.91] Recopilando beneficios...');
        // ... existing code ...
        console.log('✅ [v0.91] Beneficios válidos recopilados:', benefits);
        // ... existing code ...
        // ... existing code ...
        console.log('🚀 [v0.91] Item construido:');
        // ... existing code ...
        console.log('📦 [v0.91] Añadiendo al inventario local primero...');
        // ... existing code ...
        console.log('🔧 [v0.91] Forzando recálculo inmediato...');
        // ... existing code ...
        console.log('✅ [v0.91] Implante añadido localmente con éxito');
        console.log('🎯 [v0.91] Bonuses actuales:', window.implantBonuses);
        // ... existing code ...
        console.log('📤 [v0.91] Enviando al sistema padre para persistencia...');
        // ... existing code ...
        console.error('❌ [v0.91] Fallo crítico: El implante no se procesó correctamente');
        // ... existing code ...
        console.log('🚀 ===== FIN AÑADIR IMPLANTE PERSONALIZADO v0.91 =====');
        console.log('🔧 Sistema de beneficios de implantes inicializado (v0.91)');
        // Función de debug específica para implantes (v0.91)
        console.group('🤖 DEBUG: Sistema de Implantes v0.91');
        // VERSIÓN 0.91: FUNCIÓN DE PRUEBA DIRECTA PARA DEBUGGING
        console.log('🧪 ===== TEST DIRECTO DE CAPTURA DE FORMULARIO v0.91 =====');
        console.log('🧪 ===== FIN TEST DIRECTO v0.91 =====');
        console.log('🧪 [v0.91] Función de test disponible: testFormCapture()');
        // VERSIÓN 0.91: SISTEMA DE IMPLANTES PERSONALIZADO MEJORADO
        console.log('🚀 [v0.91] Sistema de implantes ROBUSTO cargado');
        console.log('🔧 [v0.91] Funciones disponibles:');
        console.log('🎯 [v0.91] SISTEMA REESCRITO - Los implantes personalizados funcionan GARANTIZADO');

        // ================= SISTEMA v1.0: MANEJO COMPLETO DE ATRIBUTOS =================
        
        // Función de prueba para el sistema de atributos v1.0
        window.testNewAttributeSystem = function() {
            console.log('🧪 ===== PROBANDO SISTEMA DE ATRIBUTOS v1.0 =====');
            
            // Mostrar información actual
            const selectedTemplate = getSelectValue('aptitude-template', 'actioneer');
            console.log('🎭 Plantilla actual:', selectedTemplate);
            
            // Mostrar valores por atributo
            ['cog', 'int', 'ref', 'sav', 'som', 'wil'].forEach(attr => {
                const templateValue = getTemplateValue(attr);
                const currentValue = getCurrentAttributeValue(attr);
                const additionalPoints = getAdditionalPoints(attr);
                const totalWithImplants = getAttributeTotalValue(attr);
                
                console.log(`📊 ${attr.toUpperCase()}:`);
                console.log(`   Plantilla: ${templateValue}`);
                console.log(`   Valor actual: ${currentValue}`);
                console.log(`   Puntos adicionales: ${additionalPoints}`);
                console.log(`   Total con implantes: ${totalWithImplants}`);
            });
            
            // Mostrar conteo de puntos
            const pointsUsed = ['cog', 'int', 'ref', 'sav', 'som', 'wil']
                .reduce((sum, attr) => sum + getAdditionalPoints(attr), 0);
            const pointsRemaining = 20 - pointsUsed;
            
            console.log(`🎯 Puntos gastados: ${pointsUsed}/20`);
            console.log(`🎯 Puntos restantes: ${pointsRemaining}`);
            
            // Probar guardado
            console.log('💾 Probando recopilación de datos...');
            const characterData = gatherCharacterData();
            console.log('📋 Datos recopilados:', characterData);
            
            if (characterData.additionalPoints) {
                console.log('✅ Nuevo sistema funcionando - datos en formato v0.99');
                alert(`✅ Sistema v0.99 funcionando!\n\nPlantilla: ${selectedTemplate}\nPuntos gastados: ${pointsUsed}/20\n\nDetalles en consola (F12)`);
            } else {
                console.error('❌ Sistema v0.99 falló - usando formato anterior');
                alert('❌ Error en sistema v0.99\n\nRevisa la consola (F12) para detalles');
            }
            
            console.log('🧪 ===== FIN PRUEBA SISTEMA v0.99 =====');
            return characterData;
        };
        
        // Manejo de mensajes del sistema padre
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'testAttributeSystem') {
                console.log('📨 Recibido comando de prueba del sistema padre');
                window.testNewAttributeSystem();
            }
        });
        
        console.log('🚀 [v0.99] Sistema de atributos NUEVO cargado');
        console.log('🔧 [v0.99] Función disponible: testNewAttributeSystem()');
        console.log('🎯 [v0.99] PLANTILLA + PUNTOS ADICIONALES - Guardado separado GARANTIZADO');
    </script>

    <!-- XIII Image Modal -->
    <div id="xiii-modal" class="xiii-image-modal" style="display: none;">
        <div class="xiii-modal-content">
            <span class="xiii-close" onclick="closeXIIIModal()">&times;</span>
            <img src="images/XIII completa.jpeg" alt="XIII Completa" class="xiii-full-image">
        </div>
    </div>

    <script>
        // Funciones para el modal de imagen XIII
        function openXIIIModal() {
            document.getElementById('xiii-modal').style.display = 'flex';
        }
        
        function closeXIIIModal() {
            document.getElementById('xiii-modal').style.display = 'none';
        }
        
        // Cerrar modal al hacer clic fuera de la imagen
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('xiii-modal');
            if (event.target === modal) {
                closeXIIIModal();
            }
        });
    </script>
</body>
</html> 