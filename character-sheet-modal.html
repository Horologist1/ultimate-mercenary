<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personaje</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            font-family: 'Roboto', sans-serif;
        }

        .character-sheet {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .sheet-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .sheet-header h1 {
            color: #00ccff;
            font-family: 'Orbitron', sans-serif;
            font-size: 32px;
            margin: 0;
            text-transform: uppercase;
        }

        .sheet-header h2 {
            color: #ff4757;
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            margin: 10px 0 0 0;
        }

        .section {
            background-color: rgba(30, 30, 30, 0.8);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .section h2 {
            color: #00ccff;
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            margin: 0 0 20px 0;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .item {
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 15px;
        }

        .item h3 {
            color: #ff4757;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            margin: 0 0 5px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item p {
            color: #fff;
            margin: 5px 0;
            font-size: 14px;
        }

        .item .value {
            color: #00ccff;
            font-weight: bold;
        }

        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 0, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 1000;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(
                circle at center,
                transparent 0%,
                rgba(0, 0, 0, 0.3) 100%
            );
            pointer-events: none;
            z-index: 999;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .tab {
            display: inline-block;
            padding: 10px 20px;
            margin: 0 5px;
            cursor: pointer;
            border: 1px solid #00ffff;
            border-radius: 4px;
            color: #00ffff;
            background: rgba(0, 0, 0, 0.7);
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #00ffff;
            color: #111;
            font-weight: bold;
            box-shadow: 0 0 10px #00ffff;
        }

        .tab:hover {
            background: rgba(0,255,255,0.2);
            color: #fff;
        }

        .tab-content {
            display: none;
            background: rgba(0,0,0,0.85);
            border: 1px solid #00ffff;
            border-radius: 8px;
            color: #e0f7fa;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,255,255,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .skill-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 5px;
        }

        .skill-total {
            color: #00ccff;
            font-size: 12px;
            white-space: nowrap;
        }

        .skill-value {
            width: 50px;
            padding: 2px;
            font-size: 14px;
        }

        .skill-group {
            margin-bottom: 15px;
        }

        .skill-group .item {
            margin-bottom: 8px;
            padding: 8px;
        }

        .skill-group .item h3 {
            font-size: 12px;
            margin-bottom: 3px;
        }

        .points-counter {
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ccff;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .points-counter h3 {
            color: #00ccff;
            margin: 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
        }

        .points-counters {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .save-button {
            padding: 10px 20px;
            background-color: #00ccff;
            color: #000;
            border: none;
            border-radius: 4px;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
        }

        .save-button:hover {
            background-color: #ff4757;
            color: #fff;
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.7);
        }

        .reset-button {
            padding: 10px 20px;
            background-color: rgba(255, 165, 0, 0.8);
            color: #000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
        }

        .reset-button:hover {
            background-color: rgba(255, 165, 0, 1);
            box-shadow: 0 0 15px rgba(255, 165, 0, 0.7);
        }

        .button-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: rgba(30, 30, 30, 0.8);
            border: 1px solid #444;
            border-radius: 8px;
        }

        .field-input {
            background-color: #333;
            color: #00ccff;
            border: 1px solid #555;
            border-radius: 2px;
            padding: 2px 4px;
            font-family: 'Roboto', sans-serif;
        }

        .field-input:focus {
            outline: none;
            border-color: #00ccff;
            box-shadow: 0 0 3px rgba(0, 204, 255, 0.3);
        }

        .custom-skill-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            border-radius: 4px;
        }

        .custom-skill-item input[type="text"] {
            flex: 1;
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 2px;
            padding: 4px;
            font-size: 12px;
        }

        .custom-skill-item input[type="number"] {
            width: 50px;
        }

        .custom-skill-item .remove-skill {
            background-color: #ff4757;
            color: #fff;
            border: none;
            border-radius: 2px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 10px;
        }

        .character-card {
            display: flex;
            align-items: center;
            gap: 16px;
            background: rgba(0,0,0,0.7);
            border: 1px solid #00ccff;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,204,255,0.08);
        }
        .character-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #444;
            background: #222;
        }
        .character-info {
            flex: 1;
        }
        .character-name {
            color: #00ccff;
            margin: 0 0 4px 0;
            font-size: 1.1em;
            font-family: 'Orbitron', sans-serif;
        }
        .character-description {
            color: #aaa;
            font-size: 0.95em;
        }

        /* Modal de imagen con ne√≥n */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
        }

        .image-modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 2.5em;
            color: #00ffff;
            cursor: pointer;
            text-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff;
        }

        .modal-content {
            max-width: 90vw;
            max-height: 80vh;
            box-shadow: 0 0 40px #00ffff, 0 0 80px #ff00cc;
            border-radius: 12px;
            border: 3px solid #00ffff;
            background: #111;
            object-fit: contain;
            width: auto;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        .gear-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            border-radius: 4px;
        }

        .gear-item .remove-skill {
            background-color: #ff4757 !important;
            color: #fff !important;
            border: none !important;
            border-radius: 4px !important;
            padding: 8px 12px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            margin-left: auto !important;
            transition: all 0.3s ease !important;
        }

        .gear-item .remove-skill:hover {
            background-color: #ff6b81 !important;
            transform: scale(1.1) !important;
        }

        .item-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            border-radius: 4px;
        }

        .item-card h4 {
            color: #00ccff;
            margin: 0;
            font-family: 'Orbitron', sans-serif;
        }

        .remove-item {
            background-color: #ff4757 !important;
            color: #fff !important;
            border: none !important;
            border-radius: 4px !important;
            padding: 8px 12px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            margin-left: auto !important;
            transition: all 0.3s ease !important;
        }

        .remove-item:hover {
            background-color: #ff6b81 !important;
            transform: scale(1.1) !important;
        }
    </style>
    
    <script>
        // SISTEMA SIMPLIFICADO: Solo delegaci√≥n al listener maestro de character-sheet.js
        // Eliminar funciones duplicadas - usar las del padre
        
        window.clearPurchasedItems = function() {
            if (window.parent && window.parent.clearPurchasedItems) {
                window.parent.clearPurchasedItems();
            } else {
                alert('Funci√≥n no disponible desde el modal');
            }
        };
        
        window.nuclearClearItems = function() {
            if (window.parent && window.parent.fullReset) {
                window.parent.fullReset();
            } else {
                alert('Funci√≥n no disponible desde el modal');
            }
        };
    </script>
</head>
<body>
    <div class="character-sheet">
        <div class="sheet-header">
            <h1>FICHA DE PERSONAJE</h1>
            <h2>Concursante #13</h2>
        </div>

        <div class="button-container">
            <button id="saveButton" class="save-button">GUARDAR FICHA</button>

            <button id="clearItemsButton" class="reset-button" style="background-color: #ff9500; margin: 10px 0;">LIMPIAR ITEMS COMPRADOS</button>

            <button id="nuclearClearButton" class="reset-button" style="background-color: #ff4757; margin: 10px 0;">üö® LIMPIEZA NUCLEAR</button>

            <button id="resetButton" class="reset-button">REINICIAR FICHA</button>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="basics">B√°sicos</div>
            <div class="tab" data-tab="skills">Habilidades</div>
            <div class="tab" data-tab="gear">Equipo</div>
            <div class="tab" data-tab="cyber">Implantes</div>
            <div class="tab" data-tab="conocidos">Conocidos</div>
            <div class="tab" data-tab="conocimientos">Conocimientos</div>
        </div>

        <div id="basics" class="tab-content active">
            <div class="section">
                <h2>ATRIBUTOS</h2>
                <div class="points-counters">
                    <div class="points-counter">
                        <span>Puntos de Atributos: </span>
                        <span id="attribute-points" class="points-available">20</span>
                        <span id="attribute-points-total">/20</span>
                    </div>
                </div>
                
                <!-- Plantilla de Atributos -->
                <div class="points-counter" style="margin-bottom: 20px;">
                    <h3 style="color: #00ccff; margin-bottom: 10px;">Plantilla de Atributos</h3>
                    <p style="font-size: 12px; color: #aaa; margin-bottom: 10px;">
                        Las plantillas representan diferentes arquetipos de personaje. Cada plantilla otorga valores base superiores a 10, 
                        reduciendo los puntos de personalizaci√≥n disponibles. Los puntos restantes pueden usarse para ajustar los atributos.
                    </p>
                    <select id="aptitude-template" style="width: 100%; padding: 8px; background-color: #333; color: #fff; border: 1px solid #00ccff; border-radius: 4px;">
                        <option value="actioneer">Actioneer (COG 15, INT 15, REF 20, SAV 10, SOM 15, WIL 15)</option>
                        <option value="extrovert">Extrovert (COG 15, INT 15, REF 15, SAV 20, SOM 15, WIL 15)</option>
                        <option value="facilitator">Facilitator (COG 10, INT 15, REF 10, SAV 20, SOM 20, WIL 20)</option>
                        <option value="factotum">Factotum (COG 15, INT 15, REF 15, SAV 15, SOM 10, WIL 15)</option>
                        <option value="inquirer">Inquirer (COG 10, INT 20, REF 10, SAV 15, SOM 15, WIL 15)</option>
                        <option value="survivor">Survivor (COG 20, INT 10, REF 15, SAV 10, SOM 20, WIL 20)</option>
                        <option value="thrill-seeker">Thrill Seeker (COG 20, INT 15, REF 20, SAV 15, SOM 10, WIL 15)</option>
                    </select>
                </div>
                
                <div class="grid">
                    <div class="item">
                        <h3>COG</h3>
                        <input type="number" id="cog" value="10" min="0" max="20">
                    </div>
                    <div class="item">
                        <h3>INT</h3>
                        <input type="number" id="int" value="10" min="0" max="20">
                    </div>
                    <div class="item">
                        <h3>REF</h3>
                        <input type="number" id="ref" value="10" min="0" max="20">
                    </div>
                    <div class="item">
                        <h3>SAV</h3>
                        <input type="number" id="sav" value="10" min="0" max="20">
                    </div>
                    <div class="item">
                        <h3>SOM</h3>
                        <input type="number" id="som" value="10" min="0" max="20">
                    </div>
                    <div class="item">
                        <h3>WIL</h3>
                        <input type="number" id="wil" value="10" min="0" max="20">
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>ESTAD√çSTICAS DERIVADAS</h2>
                <div class="grid">
                    <div class="item">
                        <h3>DUR</h3>
                        <input type="number" id="dur" value="30" min="1" max="99" style="width:60px;"> <!-- Editable -->
                    </div>
                    <div class="item">
                        <h3>Umbral de Heridas (WT)</h3>
                        <p class="value" id="wound-threshold">6</p>
                    </div>
                    <div class="item">
                        <h3>Death Rating (DR)</h3>
                        <p class="value" id="death-rating">45</p>
                    </div>
                    <div class="item">
                        <h3>Iniciativa</h3>
                        <p class="value" id="initiative">7</p>
                    </div>
                    <div class="item">
                        <h3>MOV</h3>
                        <p class="value" id="movement">4</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="skills" class="tab-content">
            <div class="section">
                <h2>HABILIDADES ACTIVAS</h2>
                <div class="points-counters">
                    <div class="points-counter">
                        <span>Puntos de Habilidades: </span>
                        <span id="skill-points" class="points-available">400</span>
                        <span>/400</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <!-- Columna 1: REF y COG -->
                    <div>
                        <!-- Habilidades de REF -->
                        <div class="skill-group">
                            <h3 class="skill-group-title">REFLEXOS (REF)</h3>
                            <div class="item">
                                <h3>Esquivar</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Esquivar" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Esquivar">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Armas de Fuego</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Armas de Fuego" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Armas de Fuego">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Infiltraci√≥n</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Infiltraci√≥n" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Infiltraci√≥n">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Pilotar: <input type="text" class="field-input" data-field="Pilotar" placeholder="Campo" style="width: 80px; font-size: 10px;"></h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Pilotar" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Pilotar">0</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Habilidades de COG -->
                        <div class="skill-group">
                            <h3 class="skill-group-title">COGNICI√ìN (COG)</h3>
                            <div class="item">
                                <h3>Hardware: <input type="text" class="field-input" data-field="Hardware" placeholder="Campo" style="width: 80px; font-size: 10px;"></h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Hardware" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Hardware">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Infosec</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Infosec" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Infosec">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Interfaz</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Interfaz" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Interfaz">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Medicina: <input type="text" class="field-input" data-field="Medicina" placeholder="Campo" style="width: 80px; font-size: 10px;"></h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Medicina" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Medicina">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Programaci√≥n</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Programaci√≥n" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Programaci√≥n">0</span></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna 2: SOM, INT, SAV -->
                    <div>
                        <!-- Habilidades de SOM -->
                        <div class="skill-group">
                            <h3 class="skill-group-title">SOM√ÅTICA (SOM)</h3>
                            <div class="item">
                                <h3>Atletismo</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Atletismo" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Atletismo">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Ca√≠da Libre</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Ca√≠da Libre" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Ca√≠da Libre">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Combate Cuerpo a Cuerpo</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Combate Cuerpo a Cuerpo" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Combate Cuerpo a Cuerpo">0</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Habilidades de INT -->
                        <div class="skill-group">
                            <h3 class="skill-group-title">INTUICI√ìN (INT)</h3>
                            <div class="item">
                                <h3>Percepci√≥n</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Percepci√≥n" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Percepci√≥n">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Investigaci√≥n</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Investigaci√≥n" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Investigaci√≥n">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Supervivencia</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Supervivencia" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Supervivencia">0</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Habilidades de SAV -->
                        <div class="skill-group">
                            <h3 class="skill-group-title">ASTUCIA (SAV)</h3>
                            <div class="item">
                                <h3>Enga√±o</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Enga√±o" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Enga√±o">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Kin√©sica</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Kin√©sica" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Kin√©sica">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Persuasi√≥n</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Persuasi√≥n" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Persuasi√≥n">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Provocaci√≥n</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Provocaci√≥n" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Provocaci√≥n">0</span></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna 3: WIL, Ex√≥ticas, Conocimiento -->
                    <div>
                        <!-- Habilidades de WIL -->
                        <div class="skill-group">
                            <h3 class="skill-group-title">VOLUNTAD (WIL)</h3>
                            <div class="item">
                                <h3>Psi</h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Psi" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Psi">0</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Habilidades Ex√≥ticas -->
                        <div class="skill-group">
                            <h3 class="skill-group-title">HABILIDADES EX√ìTICAS</h3>
                            <div class="item">
                                <h3>Ex√≥tica: <input type="text" class="field-input" data-field="Ex√≥tica" placeholder="Campo" style="width: 80px; font-size: 10px;"></h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Ex√≥tica" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Ex√≥tica">0</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Habilidades de Conocimiento -->
                        <div class="skill-group">
                            <h3 class="skill-group-title">CONOCIMIENTO</h3>
                            <div class="item">
                                <h3>Acad√©mico (COG): <input type="text" class="field-input" data-field="Acad√©mico" placeholder="Campo" style="width: 60px; font-size: 10px;"></h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Acad√©mico" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Acad√©mico">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Arte (INT): <input type="text" class="field-input" data-field="Arte" placeholder="Campo" style="width: 60px; font-size: 10px;"></h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Arte" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Arte">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Inter√©s (COG): <input type="text" class="field-input" data-field="Inter√©s" placeholder="Campo" style="width: 60px; font-size: 10px;"></h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Inter√©s" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Inter√©s">0</span></span>
                                </div>
                            </div>
                            <div class="item">
                                <h3>Profesional (COG): <input type="text" class="field-input" data-field="Profesional" placeholder="Campo" style="width: 60px; font-size: 10px;"></h3>
                                <div class="skill-row">
                                    <input type="number" class="skill-value" data-skill="Profesional" value="0" min="0" max="60">
                                    <span class="skill-total">Total: <span class="value" data-skill-total="Profesional">0</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Habilidades Personalizadas -->
                <div class="section" style="margin-top: 20px;">
                    <h3 style="color: #00ccff; margin-bottom: 15px;">HABILIDADES PERSONALIZADAS</h3>
                    <div id="custom-skills-container">
                        <!-- Las habilidades personalizadas se a√±adir√°n aqu√≠ din√°micamente -->
                    </div>
                    <button id="add-custom-skill" style="padding: 5px 10px; background-color: #00ccff; color: #000; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">+ A√±adir Habilidad</button>
                </div>
            </div>
        </div>

        <div id="gear" class="tab-content">
            <div class="section">
                <h2>EQUIPO</h2>
                <div>
                    <div class="item">
                        <h3>Armas</h3>
                        <div id="weapons-list">
                            <p>Sin armas equipadas</p>
                        </div>
                        <button class="button add-item" data-type="weapon">+ A√±adir Arma</button>
                    </div>
                    <div class="item">
                        <h3>Armadura</h3>
                        <div id="armor-list">
                            <p>Sin armadura equipada</p>
                        </div>
                        <button class="button add-item" data-type="armor">+ A√±adir Armadura</button>
                    </div>
                    <div class="item">
                        <h3>Equipo Miscel√°neo</h3>
                        <div id="misc-list">
                            <p>Sin equipo adicional</p>
                        </div>
                        <button class="button add-item" data-type="misc">+ A√±adir Equipo</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="cyber" class="tab-content">
            <div class="section">
                <h2>IMPLANTES</h2>
                <div>
                    <div class="item">
                        <h3>Implantes Cibern√©ticos</h3>
                        <div id="implants-list">
                            <p>Sin implantes instalados</p>
                        </div>
                        <button class="button add-item" data-type="implant">+ A√±adir Implante</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="conocidos" class="tab-content">
            <div class="sheet-section">
                <h3>Conocidos</h3>
                <div id="conocidos-tarjetas" class="personajes-container"></div>
            </div>
        </div>
        <div id="conocimientos" class="tab-content">
            <div class="sheet-section">
                <h3>Conocimientos</h3>
                <div id="conocimientos-tarjetas" class="facciones-container"></div>
            </div>
        </div>
    </div>

    <div class="scanline"></div>
    <div class="overlay"></div>

    <!-- Modal de imagen con ne√≥n -->
    <div id="imageModal" class="image-modal">
        <span class="close-modal" style="position:absolute;top:20px;right:30px;font-size:2.5em;color:#00ffff;cursor:pointer;text-shadow:0 0 10px #00ffff,0 0 20px #00ffff;">&times;</span>
        <img class="modal-content" id="modalImage" style="max-width:90vw;max-height:80vh;box-shadow:0 0 40px #00ffff,0 0 80px #ff00cc; border-radius:12px; border:3px solid #00ffff; background:#111;">
    </div>

    <!-- Firebase se inicializa con ES6 modules en el head -->
    
    <script src="character-sheet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // El inventario se maneja desde character-sheet.js
            // para evitar conflictos entre m√∫ltiples listeners
            
            // Tab switching functionality
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    this.classList.add('active');
                    const contentId = this.getAttribute('data-tab');
                    document.getElementById(contentId).classList.add('active');
                    
                    // Actualizar inventario cuando se cambie a las pesta√±as de equipo o implantes
                    if (contentId === 'gear' || contentId === 'cyber') {
                        updateInventoryDisplay();
                    }
                    
                    // Siempre renderiza al cambiar de pesta√±a
                    renderTarjetasSeleccionadas();
                });
            });
            
            // Renderizar tarjetas seleccionadas al cargar
            renderTarjetasSeleccionadas();
            
            // Actualizar inventario al cargar
            updateInventoryDisplay();
        });

        // Actualizar tarjetas si cambia el almacenamiento desde otro tab/ventana
        window.addEventListener('storage', function(e) {
            if (e.key === 'conocidosSeleccionados' || e.key === 'conocimientosSeleccionados') {
                console.log('Storage event:', e.key, e.newValue);
                renderTarjetasSeleccionadas();
            }
        });

        // Datos de personajes y facciones
        const personajes = [
            { nombre: 'Auri', img: 'images/kira_initial.png', desc: 'Protagonista principal, adaptable y endeudada con los Dragones de Jade.' },
            { nombre: 'Boris "Goliath" Volkov', img: 'images/goliath.png', desc: 'El Tanque Ruso, ex-Spetsnaz, brutal y directo.' },
            { nombre: 'Silas "Glitch" Vance', img: 'images/silas_glitch.png', desc: 'Netrunner nervioso, ex-ingeniero de seguridad.' },
            { nombre: 'Raven (Mizuki Tanaka)', img: 'images/raven.png', desc: 'La Asesina Silenciosa, maestra del sigilo.' },
            { nombre: 'Chispa (Anya Sharma)', img: 'images/chispa_new.png', desc: 'La Mec√°nica Optimista, experta en cromo.' },
            { nombre: 'Marcus "Old Man" Thorne', img: 'images/old_man.png', desc: 'El Veterano C√≠nico, ex-corporativo.' },
            { nombre: 'Jinx', img: 'images/jinx_alt.png', desc: 'La Psic√≥pata Impredecible, disfruta del caos.' },
            { nombre: 'Lin Mayfair', img: 'images/lin_mayfair_new.png', desc: 'La "Inocente" Endeudada, historia tr√°gica.' },
            { nombre: 'Subject Omega', img: 'images/subject_omega.png', desc: 'El Misterioso, posible experimento de OCE.' },
            { nombre: 'Ekaterina "Echo" Petrov', img: 'images/cyber_sniper.png', desc: 'La Francotiradora Fantasma, precisi√≥n sobrehumana.' },
            { nombre: 'Dr. Felix "Compound" Reyes', img: 'images/cyber_chemist.png', desc: 'El Qu√≠mico Clandestino, genio de drogas de combate.' },
            { nombre: 'Los Gemelos (Jin & Jun)', img: 'images/cyber_twins.png', desc: 'Los Sincronizados, mentes enlazadas.' },
            { nombre: 'Sof√≠a "Viper" Nakamura', img: 'images/viper_blade.png', desc: 'La Samur√°i Callejera, busca venganza.' },
            { nombre: 'Alex "Phantom" Mercer', img: 'images/hacker_phantom.png', desc: 'El Fantasma de la Red, hacker legendario.' },
            { nombre: 'Marcus "Titan" Graves', img: 'images/titan_warrior.png', desc: 'El Soldado Aumentado, ex-super-soldado.' },
            { nombre: 'Faith "Oracle" Lee', img: 'images/faith_oracle.png', desc: 'La Tecno-Sacerdotisa, ex-profeta de la Singularidad.' },
            { nombre: 'Darius "Thunder Fist" Jackson', img: 'images/thunder_fist.png', desc: 'El Campe√≥n de las Peleas Clandestinas.' },
            { nombre: 'Aria "Maven" Chen', img: 'images/maven_corporate.png', desc: 'La Ejecutiva Despiadada, ex-vicepresidenta de Nakamura-Daichi.' }
        ];
        const facciones = [
            { nombre: 'OmniCorp Entertainment (OCE)', img: 'images/oce_logo.png', desc: 'Conglomerado medi√°tico global, operaciones negras y tecnolog√≠a militar.' },
            { nombre: 'Colectivo Nexus-9', img: 'images/nexus9_logo.png', desc: 'Tecno-anarquistas, democratizan la tecnolog√≠a de modificaci√≥n corporal.' },
            { nombre: 'Chrome Dynasty', img: 'images/chrome_dynasty_logo.png', desc: 'Organizaci√≥n criminal de √©lite, obsesionados con el cromo.' },
            { nombre: 'Zaibatsu Nakamura-Daichi Corp', img: 'images/nakamura_daichi_logo.png', desc: 'Conglomerado de biotecnolog√≠a, integraci√≥n tecno-org√°nica.' },
            { nombre: 'Hu√©rfanos Digitales', img: 'images/huerfanos_digitales_emblema.png', desc: 'Tribu urbana, v√≠ctimas de la "muerte digital".' }
        ];

        // Array extendido de personajes con n√∫mero, apodo, descripci√≥n y di√°logo
        const personajesExtendidos = [
            {
                nombre: 'Auri',
                numero: 13,
                apodo: 'Protagonista Principal (Personalizable)',
                descripcion: 'Trasfondo de "odd jobs", endeudada con los Dragones de Jade. Adaptable y con potencial oculto. Auri ha sobrevivido en las calles de Neo-Kyoto tomando trabajos de todo tipo, algunos legales, otros no tanto. Una serie de malas decisiones la llevaron a endeudarse con la Yakuza, y ahora se encuentra obligada a participar en Ultimate Mercenary como forma de saldar su deuda... o morir en el intento.',
                dialogo: '',
                img: 'images/kira_initial.png',
                nombreReal: 'Auri'
            },
            {
                nombre: 'Boris "Goliath" Volkov',
                numero: 42,
                apodo: 'El Tanque Ruso',
                descripcion: 'Ex-Spetsnaz, enorme (SOM 14), implantes de fuerza de primera gen, cicatrices. Directo, brutal, desprecia la debilidad. Entr√≥ en el programa tras desertar y ser perseguido por su antiguo comando.',
                dialogo: '"¬øT√∫? ¬øCompetir? ¬°Ja! Durar√°s menos que un helado en el infierno." (Si muestras habilidad) "Quiz√°s no seas tan in√∫til, malenkaya. Pero no te confundas, esto es mi victoria."',
                img: 'images/goliath.png',
                nombreReal: 'Boris "Goliath" Volkov'
            },
            {
                nombre: 'Silas "Glitch" Vance',
                numero: 17,
                apodo: 'El Netrunner Nervioso',
                descripcion: 'Delgado, gafas de datos, siempre murmurando sobre sistemas y exploits. Evita el conflicto directo, prefiere la astucia. Ex-ingeniero de seguridad corporativa que vendi√≥ secretos y fue descubierto.',
                dialogo: '"Los protocolos de seguridad de esta prueba son... anticuados. Si me cubres, podr√≠a darte una \'ventaja\'. Por un porcentaje de tus PM, claro. Y esto... nunca ocurri√≥."',
                img: 'images/silas_glitch.png',
                nombreReal: 'Silas "Glitch" Vance'
            },
            {
                nombre: 'Raven (Mizuki Tanaka)',
                numero: 89,
                apodo: 'La Asesina Silenciosa',
                descripcion: '√Ågil, tatuajes de cuervo, mirada intensa. Maestra del sigilo y el combate cuerpo a cuerpo. Habla poco, observa mucho. Posible conexi√≥n con asesinos profesionales o agencias de inteligencia.',
                dialogo: '(Si la impresionas o ayudas) Un asentimiento casi imperceptible. (Si la obstaculizas) Una mirada fr√≠a que promete problemas.',
                img: 'images/raven.png',
                nombreReal: 'Mizuki Tanaka'
            },
            {
                nombre: 'Chispa (Anya Sharma)',
                numero: 31,
                apodo: 'La Mec√°nica Optimista',
                descripcion: 'Pelo azul el√©ctrico, dedos prot√©sicos con herramientas. Sorprendentemente optimista, siempre trasteando. Busca mejorar su cromo. Ex-ingeniera de mantenimiento en los astilleros orbitales.',
                dialogo: '"¬°Ey! ¬øNueva? Soy Chispa. No te dejes comer por los tiburones. A veces, un destornillador bien colocado vale m√°s que una bala. ¬øNecesitas algo arreglado? Podr√≠a echarle un vistazo... si compartimos recursos, claro."',
                img: 'images/chispa_new.png',
                nombreReal: 'Anya Sharma'
            },
            {
                nombre: 'Marcus "Old Man" Thorne',
                numero: 76,
                apodo: 'El Veterano C√≠nico',
                descripcion: 'Hombre mayor (50s aparentes), cuerpo desgastado pero con ojos que han visto demasiado. Ex-corporativo de seguridad, lo perdi√≥ todo. Pragm√°tico y calculador.',
                dialogo: '"He visto programas como este ir y venir. Todos terminan igual: con sangre en el suelo y los bolsillos de los de arriba llenos. No te hagas ilusiones, chico/a. Solo sobrevive al siguiente d√≠a. Y si tienes que apu√±alar a alguien por la espalda... aseg√∫rate de que nadie te vea hacerlo."',
                img: 'images/old_man.png',
                nombreReal: 'Marcus "Old Man" Thorne'
            },
            {
                nombre: 'Jinx',
                numero: 23,
                apodo: 'La Psic√≥pata Impredecible',
                descripcion: 'Ropa colorida y desgarrada, maquillaje corrido, una sonrisa demasiado amplia. Totalmente impredecible, disfruta del caos. Implantes de combate llamativos pero quiz√°s no de la mejor calidad.',
                dialogo: '"¬°Esto es m√°s divertido que quemar un puesto de ramen! ¬øQuieres jugar? Tengo este cuchillito que dice que quiere ser tu amigo. ¬°O tal vez tu enemigo! ¬°Depende de c√≥mo me mires ma√±ana! ¬°HAHAHA!"',
                img: 'images/jinx_alt.png',
                nombreReal: 'Jinx'
            },
            {
                nombre: 'Subject Omega',
                numero: 91,
                apodo: 'El Misterioso',
                descripcion: 'Andr√≥gino, con implantes sutiles pero de alta tecnolog√≠a apenas visibles. Movimientos precisos, casi inhumanos. No interact√∫a a menos que sea necesario. Podr√≠a ser un agente encubierto de otra facci√≥n, o un experimento de OCE.',
                dialogo: '"Mi prop√≥sito aqu√≠ es irrelevante para ti. Conc√©ntrate en tu propia supervivencia. La interferencia... no es aconsejable."',
                img: 'images/subject_omega.png',
                nombreReal: 'Subject Omega'
            },
            {
                nombre: 'Ekaterina "Echo" Petrov',
                numero: 37,
                apodo: 'La Francotiradora Fantasma',
                descripcion: 'Ex-militar de √©lite de las Fuerzas Especiales del Este, la precisi√≥n sobrehumana de Echo la convirti√≥ en leyenda. Sus ojos cibern√©ticos HawkEye-X de grado militar pueden rastrear objetivos a m√°s de 2 km y est√°n conectados a un sistema de predicci√≥n bal√≠stica implantado en su corteza visual.',
                dialogo: '"Un disparo, una baja. No es solo mi lema, es mi religi√≥n. He apretado el gatillo m√°s veces de las que t√∫ has respirado conscientemente. La diferencia entre t√∫ y yo? Cuando yo apunto a algo, deja de existir, y nunca, jam√°s, fallo."',
                img: 'images/cyber_sniper.png',
                nombreReal: 'Ekaterina "Echo" Petrov'
            },
            {
                nombre: 'Dr. Felix "Compound" Reyes',
                numero: 64,
                apodo: 'El Qu√≠mico Clandestino',
                descripcion: 'Genio cient√≠fico que trabajaba para Pharmaceutech desarrollando drogas de combate para soldados corporativos. Sus ojos brillantes son resultado de sus propios experimentos con neurorreguladores que amplificaron su capacidad intelectual pero desestabilizaron su psique.',
                dialogo: '"¬øVes estas manos? Pueden crear sustancias que har√≠an que tus pesadillas parezcan cuentos infantiles. Una gota, y tu cerebro se derretir√≠a dentro de tu cr√°neo. Una gota diferente, y pelear√≠as como un dios. As√≠ que... ¬øquieres ser mi amigo o mi experimento?"',
                img: 'images/cyber_chemist.png',
                nombreReal: 'Dr. Felix "Compound" Reyes'
            },
            {
                nombre: 'Los Gemelos (Jin & Jun)',
                numero: 82,
                apodo: 'Los Sincronizados',
                descripcion: 'Gemelos id√©nticos que cuentan como un solo concursante gracias a una regla especial de Kaiser. Sus mentes est√°n enlazadas por implantes neurales experimentales que les permiten compartir percepciones sensoriales y actuar con una coordinaci√≥n perfecta.',
                dialogo: '"Nunca estamos solos." (Jin) "Nunca luchamos solos." (Jun) "Siempre somos dos." (Jin) "Y eso nos hace invencibles." (Jun) "Cuando nos enfrentas..." (Jin) "...enfrentas a dos enemigos que act√∫an como uno." (Ambos al un√≠sono)',
                img: 'images/cyber_twins.png',
                nombreReal: 'Los Gemelos (Jin & Jun)'
            },
            {
                nombre: 'Marcus "Titan" Graves',
                numero: 71,
                apodo: 'El Soldado Aumentado',
                descripcion: 'Veterano de las Guerras Corporativas, Graves particip√≥ en el programa experimental de super-soldados del ej√©rcito. Su cuerpo est√° reforzado con un exoesqueleto militar integrado y sistemas de armas. Tras ser dado por "obsoleto" y programado para desmantelamiento, escap√≥.',
                dialogo: '"Me construyeron para la guerra. Me entrenaron para la victoria. ¬øY cuando termin√≥ todo? Me tiraron como chatarra. Pero lo que no entienden es que me hicieron demasiado bien. No soy una herramienta que se pueda desechar. Soy un arma que ahora apunta hacia ellos."',
                img: 'images/titan_warrior.png',
                nombreReal: 'Marcus "Titan" Graves'
            },
            {
                nombre: 'Faith "Oracle" Lee',
                numero: 53,
                apodo: 'La Tecno-Sacerdotisa',
                descripcion: 'Ex-profeta de la Iglesia de la Singularidad Divina, una religi√≥n que venera la fusi√≥n de humanidad y tecnolog√≠a. Tiene implantes neurales que le permiten procesar informaci√≥n a velocidades sobrehumanas y conectarse directamente con sistemas inform√°ticos.',
                dialogo: '"La carne es solo el veh√≠culo temporal de la conciencia. En la confluencia de sangre y silicio hallaremos la trascendencia. Tus temores, tus dudas... He visto c√≥mo terminan. Te guiar√© si est√°s dispuesto a escuchar."',
                img: 'images/faith_oracle.png',
                nombreReal: 'Faith "Oracle" Lee'
            },
            {
                nombre: 'Darius "Thunder Fist" Jackson',
                numero: 68,
                apodo: 'El Campe√≥n de las Peleas Clandestinas',
                descripcion: 'Ex-campe√≥n del circuito de luchas ilegales de Neo-Kyoto, Darius fue modificado ilegalmente con brazos cibern√©ticos de combate que contienen capacitores de impacto. Fue arrestado tras matar accidentalmente a un oponente y ahora busca en Ultimate Mercenary una v√≠a para recuperar su libertad.',
                dialogo: '"No busco fama, no busco gloria. Tengo tres hijos esper√°ndome en casa. Har√© lo que sea necesario para volver con ellos, y si eso significa destrozar algunos cr√°neos en el proceso, que as√≠ sea. No tengo nada personal contra ti, pero no te metas en mi camino."',
                img: 'images/thunder_fist.png',
                nombreReal: 'Darius "Thunder Fist" Jackson'
            },
            {
                nombre: 'Kaiser "El Emperador" Von Stroheim',
                numero: null,
                apodo: 'Anfitri√≥n y Productor Ejecutivo',
                descripcion: 'Imponente figura que viste trajes de seda negra con reflejos carmes√≠. Su brazo bi√≥nico "Ares Predator VII" de cromo negro pulido con detalles dorados intimidar√≠a incluso al m√°s valiente. Sus √≥pticas "Zeiss Ikon X" revelan pupilas rojas que parecen analizar cada debilidad. Su cabello plateado peinado hacia atr√°s completa su imagen de autoridad absoluta. Motivaci√≥n: Ratings, poder, sadismo, y lo que √©l denomina "crear al guerrero definitivo".',
                dialogo: '"¬°Bienvenidos, reba√±o de desesperados, a la arena donde las ovejas se convierten en lobos o en pienso! ¬°Cien almas buscando redenci√≥n, o al menos, una muerte con m√°s estilo que la que les esperaba fuera! Soy Kaiser, su pastor en este valle de sombras y ne√≥n. Sus deudas, sus cr√≠menes, sus errores... olv√≠dense de ellos. Aqu√≠, solo importa una cosa: ¬°SOBREVIVIR! ¬°ENTRETENER! ¬°ASCENDER! Ultimate Mercenary ha comenzado. ¬°Que la purga... digo, la competencia, d√© inicio!"',
                img: 'images/kaiser_new.png',
                nombreReal: 'Kaiser "El Emperador" Von Stroheim'
            },
            {
                nombre: 'Mr. Kenji Tanaka',
                numero: null,
                apodo: 'Jefe de Adquisiciones de Talento, OCE',
                descripcion: 'Trajeado impecablemente, Mr. Tanaka es la cara "amable" de OCE. Con una sonrisa falsa pero convincente y mirada fr√≠amente calculadora, es √©l quien cierra los tratos sucios que llevan a los concursantes hasta el programa. Funci√≥n: Maneja la "contrataci√≥n" de concursantes y otros activos de OCE, asegur√°ndose de que todo tenga el aspecto de legalidad necesario para la transmisi√≥n p√∫blica.',
                dialogo: '"Le aseguro que todas nuestras operaciones son... completamente legales. ¬øLos participantes? Todos son voluntarios, por supuesto. Han firmado contratos extensivos. El que algunos lo hicieran con una pistola figurativa en la cabeza es, como comprender√°, irrelevante para nuestros abogados."',
                img: 'images/guard_ocemk2.png',
                nombreReal: 'Mr. Kenji Tanaka'
            },
            {
                nombre: 'Hideo Nakamura',
                numero: null,
                apodo: 'CEO y Patriarca de Nakamura-Daichi Corp',
                descripcion: 'A sus 78 a√±os, Hideo representa la vieja guardia corporativa con adaptaciones modernas. Su cuerpo est√° sutilmente mejorado con los mejores productos de su compa√±√≠a, haci√©ndolo parecer un saludable hombre de 50 a√±os. A diferencia de muchos ejecutivos, Hideo mantiene sus mejoras discretas y casi invisibles. Conocido por su inteligencia estrat√©gica y paciencia implacable, Hideo planifica a d√©cadas vista, posicionando a Nakamura-Daichi para eventualmente dominar el mercado global de biotecnolog√≠a.',
                dialogo: '"Las corporaciones que exhiben su poder son las primeras en caer. El verdadero poder, como la mejor tecnolog√≠a, funciona de manera invisible."',
                img: 'images/nakamura_daichi_ceo.png',
                nombreReal: 'Hideo Nakamura'
            },
            {
                nombre: 'Director Ikari',
                numero: null,
                apodo: 'Director de Seguridad de OCE',
                descripcion: 'Veterano de mil operaciones encubiertas, Ikari es el responsable de la seguridad y la integridad del show. Su rostro inexpresivo y su voz grave imponen respeto. Nadie sabe realmente para qui√©n trabaja en √∫ltima instancia.',
                dialogo: '"En este lugar, la seguridad es una ilusi√≥n. Yo solo administro el riesgo."',
                img: 'images/director_ikari.png',
                nombreReal: 'Director Ikari'
            },
            {
                nombre: 'Dr. Naomi',
                numero: null,
                apodo: 'Jefa de Bioingenier√≠a, OCE',
                descripcion: 'Cient√≠fica brillante y fr√≠a, responsable de los implantes y modificaciones de los concursantes. Su √©tica es tan flexible como su presupuesto.',
                dialogo: '"La perfecci√≥n biotecnol√≥gica no es un derecho, es un privilegio... y yo decido qui√©n lo merece."',
                img: 'images/dr_naomi.png',
                nombreReal: 'Dr. Naomi'
            },
            {
                nombre: 'dRa Ada',
                numero: null,
                apodo: 'IA Supervisora de OCE',
                descripcion: 'Inteligencia artificial avanzada que gestiona la log√≠stica y monitorizaci√≥n del show. Su tono es cort√©s, pero sus decisiones son implacables.',
                dialogo: '"Mi funci√≥n es optimizar el espect√°culo. Las emociones humanas son irrelevantes para la eficiencia."',
                img: 'images/dra_ada.png',
                nombreReal: 'dRa Ada'
            },
            {
                nombre: 'Xiong "Mesh"',
                numero: null,
                apodo: 'Jefe de Hackers, Nexus-9',
                descripcion: 'L√≠der carism√°tico de los hackers del Colectivo Nexus-9. Siempre conectado a la red, su cuerpo est√° plagado de implantes de comunicaci√≥n y realidad aumentada.',
                dialogo: '"La informaci√≥n quiere ser libre... y yo soy su llave maestra."',
                img: 'images/xiong_mesh.png',
                nombreReal: 'Xiong "Mesh"'
            },
            {
                nombre: 'Madame Jade',
                numero: null,
                apodo: 'L√≠der de los Dragones de Jade',
                descripcion: 'Figura enigm√°tica y poderosa en el submundo de Neo-Kyoto. Su palabra es ley entre los suyos, y su lealtad es tan peligrosa como su traici√≥n.',
                dialogo: '"En mi imperio, la lealtad se paga con sangre... o con oro."',
                img: 'images/madame_jade.png',
                nombreReal: 'Madame Jade'
            },
            {
                nombre: 'Jin "Silverhand"',
                numero: null,
                apodo: 'Mercenario Legendario',
                descripcion: 'Veterano de mil batallas, Jin es conocido por su brazo de plata y su c√≥digo de honor. Es leyenda viva entre los mercenarios.',
                dialogo: '"No lucho por banderas, lucho por principios. Y por quien pueda pagar mi precio."',
                img: 'images/jin_silverhand.png',
                nombreReal: 'Jin "Silverhand"'
            },
            {
                nombre: 'Yuki Nakamura',
                numero: null,
                apodo: 'Hija de Hideo, heredera de Nakamura-Daichi',
                descripcion: 'Joven prodigio en biotecnolog√≠a, Yuki es la heredera de la corporaci√≥n. Su ambici√≥n solo es igualada por su talento.',
                dialogo: '"El futuro pertenece a quienes se atreven a reescribir el c√≥digo de la vida."',
                img: 'images/yuki_nakamura.png',
                nombreReal: 'Yuki Nakamura'
            },
            {
                nombre: 'Zero Void',
                numero: null,
                apodo: 'Asesino Cibern√©tico',
                descripcion: 'Casi un mito urbano, Zero Void es un asesino a sueldo con implantes experimentales que le permiten volverse invisible a los sensores y c√°maras.',
                dialogo: '"No puedes matar lo que no puedes ver."',
                img: 'images/zero_void.png',
                nombreReal: 'Zero Void'
            },
            {
                nombre: 'Iris',
                numero: null,
                apodo: 'Operadora de la Resistencia',
                descripcion: 'Experta en comunicaciones y sabotaje, Iris coordina las c√©lulas de resistencia desde las sombras. Su identidad real es desconocida.',
                dialogo: '"La esperanza es la se√±al m√°s dif√≠cil de bloquear."',
                img: 'images/iris.png',
                nombreReal: 'Iris'
            }
        ];

        const faccionesExtendidas = [
            {
                nombre: 'OmniCorp Entertainment (OCE)',
                descripcion: 'Conglomerado medi√°tico global con una divisi√≥n especializada en "entretenimiento extremo". Rumores dicen que tambi√©n es una tapadera para operaciones negras y desarrollo de tecnolog√≠a militar. OCE no s√≥lo busca entretener, sino obtener datos biomec√°nicos y psicol√≥gicos de combate bajo estr√©s extremo. Dentro de su estructura se ocultan m√∫ltiples sub-divisiones dedicadas a investigaci√≥n prohibida, desde modificaciones gen√©ticas hasta tecnolog√≠a de transferencia mental.',
                img: 'images/oce_logo.png'
            },
            {
                nombre: 'Colectivo Nexus-9',
                descripcion: 'Comunidad tecno-anarquista que opera en los m√°rgenes de Neo-Kyoto. Formada originalmente por investigadores de IA expulsados de corporaciones, hackers idealistas y transhumanistas radicales, el colectivo se dedica a "democratizar" la tecnolog√≠a de modificaci√≥n corporal y transferencia de conciencia. Organizados en c√©lulas semi-aut√≥nomas, creen que la inmortalidad digital debe estar disponible para todos, no solo para las √©lites corporativas. Han infiltrado personal en OCE para tener acceso a las pilas corticales de los concursantes fallecidos, que son reutilizadas en sus propios experimentos.',
                img: 'images/nexus9_logo.png'
            },
            {
                nombre: 'Chrome Dynasty',
                descripcion: 'Organizaci√≥n criminal de √©lite evolucionada desde sus ra√≠ces como una triada tradicional hasta convertirse en un imperio tecnol√≥gico clandestino. Sus miembros son reconocibles por sus elaborados implantes cromados visibles y tatuajes hologr√°ficos que muestran su rango y especializaci√≥n dentro de la organizaci√≥n. Controlan gran parte del tr√°fico de ciberware de lujo, sustancias psicoactivas sint√©ticas y servicios de modificaci√≥n corporal extrema en Neo-Kyoto. Est√°n obsesionados con la "pureza" y "superioridad" del hardware que utilizan, despreciando a quienes usan implantes de menor calidad.',
                img: 'images/chrome_dynasty_logo.png'
            },
            {
                nombre: 'Zaibatsu Nakamura-Daichi Corp',
                descripcion: 'Oficialmente un conglomerado de tecnolog√≠a m√©dica centrado en pr√≥tesis y biotecnolog√≠a, pero en realidad es un zaibatsu en ascenso con ambiciones globales. Esta corporaci√≥n familiar surgi√≥ despu√©s del colapso econ√≥mico del 2119 y ha crecido agresivamente mediante una combinaci√≥n de innovaci√≥n genuina, espionaje corporativo y t√°cticas despiadadas. Su especialidad es la integraci√≥n perfecta de cibern√©tica y tejido org√°nico, creando implantes que son pr√°cticamente indistinguibles de las partes naturales. Su filosof√≠a corporativa promueve la "Armon√≠a Tecno-Org√°nica" - la creencia de que la tecnolog√≠a debe complementar al cuerpo humano de forma natural.',
                img: 'images/nakamura_daichi_logo.png'
            },
            {
                nombre: 'Hu√©rfanos Digitales',
                descripcion: 'Tribu urbana formada por j√≥venes cuyos padres o tutores fueron v√≠ctimas de la "muerte digital" - personas cuyas conciencias fueron transferidas a sistemas digitales que posteriormente fallaron, dejando a sus familias en un limbo legal y emocional. No son una organizaci√≥n criminal tradicional, sino un movimiento de resistencia cultural y activista. Rechazan la promesa corporativa de inmortalidad digital, viendo la transferencia de conciencia como una forma de esclavitud moderna. Su est√©tica combina elementos retro-anal√≥gicos con tecnolog√≠a moderna reprogramada, y muchos miembros llevan "m√°scaras de luto digital" que muestran im√°genes pixeladas o distorsionadas de sus padres perdidos.',
                img: 'images/huerfanos_digitales_emblema.png'
            }
        ];

        // Utilidades para localStorage
        function getConocidosSeleccionados() {
            const val = localStorage.getItem('conocidosSeleccionados');
            return val ? JSON.parse(val) : [];
        }
        function getConocimientosSeleccionados() {
            const val = localStorage.getItem('conocimientosSeleccionados');
            return val ? JSON.parse(val) : [];
        }
        function setConocidosSeleccionados(arr) {
            localStorage.setItem('conocidosSeleccionados', JSON.stringify(arr));
        }
        function setConocimientosSeleccionados(arr) {
            localStorage.setItem('conocimientosSeleccionados', JSON.stringify(arr));
        }
        function renderTarjetasSeleccionadas() {
            // Conocidos
            const conocidosSel = getConocidosSeleccionados();
            const conocidos = personajes.filter(p => conocidosSel.includes(p.nombre));
            document.getElementById('conocidos-tarjetas').innerHTML = conocidos.map(p => {
                // Mapeo de n√∫mero de concursante
                const numeros = {
                    'Auri': 13,
                    'Boris "Goliath" Volkov': 42,
                    'Silas "Glitch" Vance': 17,
                    'Raven (Mizuki Tanaka)': 89,
                    'Chispa (Anya Sharma)': 31,
                    'Marcus "Old Man" Thorne': 76,
                    'Jinx': 23,
                    'Lin Mayfair': 58,
                    'Subject Omega': 91,
                    'Ekaterina "Echo" Petrov': 37,
                    'Dr. Felix "Compound" Reyes': 64,
                    'Los Gemelos (Jin & Jun)': 82,
                    'Sof√≠a "Viper" Nakamura': 45,
                    'Alex "Phantom" Mercer': 29,
                    'Marcus "Titan" Graves': 71,
                    'Faith "Oracle" Lee': 53,
                    'Darius "Thunder Fist" Jackson': 68,
                    'Aria "Maven" Chen': 19
                };
                const personajeExtendido = personajesExtendidos.find(pe => pe.nombre === p.nombre) || p;
                const numero = personajeExtendido.numero ? `#${personajeExtendido.numero}` : '';
                // Si no hay n√∫mero, usar el nombre real como "numero" visual
                const displayLabel = numero || personajeExtendido.nombreReal || p.nombre;
                const clave = `nombreConcursante_${displayLabel}`;
                // Pre-rellenar con el nombre real si no hay valor guardado
                const valorGuardado = localStorage.getItem(clave) || '';
                return `
                    <div class="character-card">
                        <img src="${p.img}" alt="${p.nombre}" class="character-image">
                        <div class="character-info">
                            <h4 class="character-name">${displayLabel} <input type='text' class='nombre-concursante-input' data-numero='${displayLabel}' placeholder='Nota' value='${valorGuardado}' style='font-size:1em; padding:3px 8px; border-radius:4px; border:1px solid #00ccff; background:#111; color:#00ccff; font-family:Orbitron,sans-serif; width:140px; margin-left:8px;'></h4>
                            <div class="character-role" style="color: #ff4757; font-size: 0.9em; margin-bottom: 8px;">${personajeExtendido.apodo || ''}</div>
                            <p class="character-description">${personajeExtendido.descripcion || p.desc}</p>
                            ${personajeExtendido.dialogo ? `<div class="dialogue" style="background: rgba(255, 71, 87, 0.1); border-left: 3px solid #ff4757; padding: 8px; margin-top: 8px; font-style: italic;">${personajeExtendido.dialogo}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Listeners para guardar el nombre al escribir
            document.querySelectorAll('.nombre-concursante-input').forEach(input => {
                input.addEventListener('input', function() {
                    const num = this.getAttribute('data-numero');
                    localStorage.setItem(`nombreConcursante_${num}`, this.value);
                });
            });
            
            // Event listener para el bot√≥n de limpieza nuclear
            const nuclearClearButton = document.getElementById('nuclearClearButton');
            if (nuclearClearButton) {
                nuclearClearButton.addEventListener('click', function() {
                    window.nuclearClearItems();
                });
            }
            
            // Conocimientos
            const conocimientosSel = getConocimientosSeleccionados();
            const conocimientos = facciones.filter(f => conocimientosSel.includes(f.nombre));
            document.getElementById('conocimientos-tarjetas').innerHTML = conocimientos.map(f => {
                const faccionExtendida = faccionesExtendidas.find(fe => fe.nombre === f.nombre) || f;
                return `
                    <div class="faction-card">
                        <img src="${f.img}" alt="${f.nombre}" class="faction-logo">
                        <div class="faction-info">
                            <h3>${f.nombre}</h3>
                            <p>${faccionExtendida.descripcion || f.desc}</p>
                        </div>
                    </div>
                `;
            }).join('');

            // Despu√©s de renderizar las tarjetas, a√±ado el listener para abrir la imagen al hacer clic
            addImageModalListeners();
        }

        // Reemplazo el click de la imagen para usar openImageModal
        function addImageModalListeners() {
            document.querySelectorAll('.character-card .character-image').forEach(img => {
                img.style.cursor = 'pointer';
                img.onclick = function() {
                    openImageModal(this.src);
                };
            });
        }

        // Modal de imagen con ne√≥n
        window.openImageModal = function(imgSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.add('active');
            modalImg.src = imgSrc;
            document.body.style.overflow = 'hidden';
        };

        // Cerrar modal al hacer click en la X
        const closeModal = document.querySelector('.close-modal');
        if (closeModal) {
            closeModal.onclick = function() {
                document.getElementById('imageModal').classList.remove('active');
                document.body.style.overflow = '';
            };
        }

        // Cerrar modal al hacer click fuera de la imagen
        const imageModal = document.getElementById('imageModal');
        if (imageModal) {
            imageModal.addEventListener('click', function(e) {
                if (e.target === imageModal) {
                    imageModal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        }

        // Cerrar modal con ESC
        window.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && imageModal.classList.contains('active')) {
                imageModal.classList.remove('active');
                document.body.style.overflow = '';
            }
        });

        // SISTEMA UNIFICADO: Solo recibe datos del listener maestro
        // NO maneja Firebase directamente
        
        let inventory = [];

        // Escuchar mensajes del padre (character-sheet.js) - √öNICO CANAL DE DATOS
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'updateInventory') {
                inventory = event.data.items || [];
                console.log('üì• Inventario recibido del listener maestro:', inventory.length, 'items');
                updateInventoryDisplay();
            } else if (event.data && event.data.type === 'clearInventory') {
                console.log('üßπ Limpiando inventario del modal...');
                inventory = [];
                updateInventoryDisplay();
            }
        });

        // Solicitar inventario inicial al listener maestro
        function requestInitialInventory() {
            if (window.parent && window.parent.characterSheet) {
                const allItems = [
                    ...(window.parent.characterSheet.equipment || []),
                    ...(window.parent.characterSheet.implants || [])
                ];
                inventory = allItems;
                updateInventoryDisplay();
                console.log('üì• Inventario inicial cargado:', inventory.length, 'items');
            }
        }

        // Solicitar inventario al cargar
        setTimeout(requestInitialInventory, 500);

        function updateInventoryDisplay() {
            // Limpiar contenedores primero
            const containers = ['weapons-list', 'armor-list', 'misc-list', 'implants-list'];
            containers.forEach(id => {
                const container = document.getElementById(id);
                if (container) container.innerHTML = '';
            });

            // Agrupar items por tipo
            const groupedItems = inventory.reduce((acc, item) => {
                acc[item.tipo] = acc[item.tipo] || [];
                acc[item.tipo].push(item);
                return acc;
            }, {});

            // Actualizar cada secci√≥n
            updateSection('arma', 'weapons-list', 'Arma');
            updateSection('armadura', 'armor-list', 'Armadura');
            updateSection('equipo', 'misc-list', 'Equipo');
            updateSection('implant', 'implants-list', 'Implante');

            function updateSection(type, containerId, title) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                const items = groupedItems[type] || [];
                if (items.length === 0) {
                    container.innerHTML = `<p class="no-items">No hay ${title.toLowerCase()}s en el inventario</p>`;
                    return;
                }

                container.innerHTML = items.map((item, index) => `
                    <div class="item-card" data-item-index="${index}">
                        <h4>${item.nombre}</h4>
                        ${item.descripcion ? `<p class="item-description">${item.descripcion}</p>` : ''}
                        ${item.dano ? `<p class="item-stat">Da√±o: ${item.dano}</p>` : ''}
                        ${item.proteccion ? `<p class="item-stat">Protecci√≥n: ${item.proteccion}</p>` : ''}
                        ${item.efectos ? `<p class="item-effects">${item.efectos}</p>` : ''}
                        <button class="remove-item" onclick="removeItem(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }
        }
        
        // Funci√≥n para eliminar un item
        window.removeItem = function(index) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este item?')) {
                // Eliminar del inventario local
                inventory.splice(index, 1);
                
                // Notificar al padre (character-sheet.js) para que actualice Firebase
                if (window.parent && window.parent.removeItemFromInventory) {
                    window.parent.removeItemFromInventory(index);
                } else {
                    // Fallback: actualizar Firebase directamente si el padre no tiene la funci√≥n
                    if (window.parent && window.parent.database) {
                        const itemsCompradosRef = window.parent.database.ref('itemsComprados');
                        itemsCompradosRef.set(inventory).then(() => {
                            console.log('üì§ Item eliminado de Firebase');
                        }).catch((error) => {
                            console.error('‚ùå Error al eliminar de Firebase:', error);
                        });
                    }
                }
                
                // Actualizar la visualizaci√≥n inmediatamente
                updateInventoryDisplay();
                
                console.log('üóëÔ∏è Item eliminado del inventario local');
            }
        };
    </script>
</body>
</html> 