<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Mercenary 0.73</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="chat-publico.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
        }

        .main-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .background-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            opacity: 0.4;
            pointer-events: none;
            background-color: #000;
        }

        video#background-video {
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .ui-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            background-color: rgba(0, 0, 0, 0.8);
            padding: 15px 15px 5px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
            height: 140px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            height: 100%;
            padding: 0;
        }

        .logo {
            height: 120px;
            transition: transform 0.3s ease;
            object-fit: contain;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .title-container h1 {
            font-size: 24px;
            margin: 0;
            color: #00ccff;
        }

        .title-container h2 {
            font-size: 18px;
            margin: 0;
            color: #ff4757;
        }

        .main-area {
            flex: 1;
            display: flex;
            padding: 10px 20px;
            gap: 15px;
            height: calc(100vh - 90px);
            margin-top: 10px;
            overflow: hidden;
        }

        .chat-container {
            flex: 1.5;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-height: calc(100vh - 110px);
            min-height: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            min-height: 0;
            max-height: calc(100vh - 180px);
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            border: 1px solid #444;
            transition: all 0.3s ease;
        }

        .chat-message:hover {
            transform: translateX(5px);
        }

        .chat-message .username {
            color: #00ccff;
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-message .content {
            color: #fff;
        }

        .chat-message.system {
            background-color: rgba(255, 71, 87, 0.2);
            border-color: #ff4757;
        }

        .chat-message.highlight {
            background-color: rgba(0, 204, 255, 0.2);
            border-color: #00ccff;
            animation: pulse 2s infinite;
        }

        .chat-message .tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .chat-message .tag.vip {
            background-color: #ffd700;
            color: #000;
        }

        .chat-message .tag.sponsored {
            background-color: #ff4757;
            color: #fff;
        }

        .chat-message .pm-button {
            display: inline-block;
            margin-left: 10px;
            padding: 2px 8px;
            background-color: #2ed573;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .chat-message .pm-button:hover {
            background-color: #7bed9f;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 204, 255, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(0, 204, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 204, 255, 0); }
        }

        .chat-input-container {
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.9);
            border-top: 1px solid #444;
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            background-color: rgba(30, 30, 30, 0.8);
            border: 1px solid #444;
            border-radius: 4px;
            color: white;
        }

        .chat-submit {
            background-color: #ff4757;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        .opacity-toggle {
            background-color: #00ccff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .opacity-toggle:hover {
            background-color: #00a3cc;
        }

        .chat-container.transparent {
            background-color: rgba(0, 0, 0, 0.4);
        }

        .sidebar {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 10px;
            max-width: 300px;
            margin-left: auto;
            height: 100%;
        }

        .sidebar-section {
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            border: 1px solid #444;
            padding: 12px;
        }

        .sidebar-section h3 {
            color: #00ccff;
            margin: 0 0 15px 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            padding: 8px;
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            border: 1px solid #444;
        }

        .stat-icon {
            width: 24px;
            height: 24px;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            color: #00ccff;
            font-size: 12px;
        }

        .stat-value {
            color: #ff4757;
            font-size: 18px;
            font-weight: bold;
        }

        .sidebar-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .sidebar-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            background-color: rgba(30, 30, 30, 0.8);
            border: 1px solid #444;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sidebar-button:hover {
            background-color: rgba(255, 71, 87, 0.2);
            border-color: #ff4757;
        }

        .sidebar-button img {
            width: 24px;
            height: 24px;
        }

        .objective-display {
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            border: 1px solid #444;
            padding: 10px 10px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
            min-height: 170px;
        }

        .objective-display h4 {
            color: #ff4757;
            margin: 0 0 10px 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 15px;
        }

        .objective-display p {
            color: #fff;
            margin: 0;
            font-size: 13px;
            line-height: 1.4;
        }

        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 0, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 1000;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(
                circle at center,
                transparent 0%,
                rgba(0, 0, 0, 0.3) 100%
            );
            pointer-events: none;
            z-index: 999;
        }

        .rules-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            overflow-y: auto;
        }

        .rules-content {
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            border: 1px solid #444;
            color: white;
        }

        .rules-content h1 {
            color: #00ccff;
            text-align: center;
            margin-bottom: 30px;
        }

        .rules-content section {
            margin-bottom: 30px;
        }

        .rules-content h2 {
            color: #ff4757;
            margin-bottom: 15px;
        }

        .rules-content ul {
            list-style: none;
            padding: 0;
        }

        .rules-content li {
            margin-bottom: 10px;
            padding: 10px;
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            border: 1px solid #444;
        }

        .accept-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: #ff4757;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 30px;
            transition: background-color 0.3s;
        }

        .accept-btn:hover {
            background-color: #ff6b81;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background-color: rgba(255, 71, 87, 0.8);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            z-index: 1000;
        }

        .back-button:hover {
            background-color: rgba(255, 71, 87, 1);
        }

        .messages-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
        }

        .messages-content {
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            border: 1px solid #444;
            color: white;
        }

        .message-item {
            margin-bottom: 15px;
            padding: 15px;
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            border: 1px solid #444;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .message-sender {
            color: #00ccff;
            font-weight: bold;
        }

        .message-time {
            color: #666;
            font-size: 12px;
        }

        .message-content {
            color: #fff;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-line;
        }

        .logout-button {
            background-color: rgba(255, 71, 87, 0.8);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-right: 65px;
        }

        .logout-button:hover {
            background-color: rgba(255, 71, 87, 1);
            transform: translateY(-2px);
        }

        .current-objective {
            background-color: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }

        .current-objective h3 {
            color: #ff4757;
            margin: 0 0 10px 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
        }

        .current-objective p {
            color: #fff;
            margin: 0;
            font-size: 14px;
            line-height: 1.4;
        }

        .cyberpunk-quote {
            background-color: rgba(0, 0, 0, 0.8);
            border-left: 4px solid #ff4757;
            padding: 20px;
            margin: 20px 0;
            color: #00ccff;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1em;
            line-height: 1.6;
            text-shadow: 0 0 10px rgba(0, 204, 255, 0.5);
            position: relative;
            overflow: hidden;
        }

        .cyberpunk-quote::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 0%, rgba(255, 71, 87, 0.1) 50%, transparent 100%);
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .messages-section {
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            border: 1px solid #444;
            padding: 20px;
            margin-top: 20px;
        }

        .messages-section h3 {
            color: #00ccff;
            margin: 0 0 15px 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
        }

        .messages-container {
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            border: 1px solid #444;
        }

        .message-item {
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            border-left: 3px solid #00ccff;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .message-sender {
            color: #ff4757;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
        }

        .message-time {
            color: #666;
            font-size: 12px;
        }

        .message-content {
            color: #fff;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Estilos específicos para diferentes tipos de mensajes */
        .message-item[data-type="shop"] {
            border-left-color: #2ecc71;
        }

        .message-item[data-type="achievement"] {
            border-left-color: #f1c40f;
        }

        .message-item[data-type="warning"] {
            border-left-color: #e74c3c;
        }

        /* Estilos para el modal de mensajes directos */
        .messages-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .tab-button {
            background-color: rgba(30, 30, 30, 0.8);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 8px 15px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-button.active {
            background-color: #ff4757;
            border-color: #ff4757;
        }

        .messages-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .message-item {
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #00ccff;
        }

        .message-item[data-type="system"] {
            border-left-color: #ff4757;
        }

        .message-item[data-type="shop"] {
            border-left-color: #2ecc71;
        }

        .message-item[data-type="achievement"] {
            border-left-color: #f1c40f;
        }

        .message-item[data-type="warning"] {
            border-left-color: #e74c3c;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .message-sender {
            color: #00ccff;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
        }

        .message-time {
            color: #666;
            font-size: 12px;
        }

        .message-content {
            color: #fff;
            font-size: 14px;
            line-height: 1.4;
        }

        .message-image {
            width: 100%;
            max-width: 200px;
            margin: 10px 0;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #00ccff;
        }

        .message-image img {
            width: 100%;
            height: auto;
            display: block;
        }

        .message-actions {
            margin-top: 10px;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .delete-button {
            background-color: #ff4757;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .delete-button:hover {
            background-color: #ff6b81;
            transform: translateY(-2px);
        }

        .purchase-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.95);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #00ccff;
            color: #00ccff;
            display: none;
            z-index: 9999;
            animation: slideIn 0.5s ease-out;
            box-shadow: 0 0 20px rgba(0, 204, 255, 0.3);
            min-width: 300px;
            font-family: 'Orbitron', sans-serif;
        }

        .purchase-message h4 {
            color: #ff4757;
            margin: 0 0 10px 0;
            font-size: 1.2em;
            text-transform: uppercase;
        }

        .purchase-message p {
            margin: 5px 0;
            font-size: 1.1em;
        }

        .purchase-message .warning {
            color: #ff4757;
            font-weight: bold;
            margin-top: 10px;
            font-size: 0.9em;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        .accept-button {
            background-color: #00ccff;
            color: #000;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .accept-button:hover {
            background-color: #00a3cc;
            transform: translateY(-2px);
        }

        .no-messages {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }

        /* Estilos para los botones de acción */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .action-button {
            width: 100%;
            padding: 12px;
            background-color: #ff4757;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .action-button:hover {
            background-color: #ff6b81;
            transform: translateY(-2px);
        }

        /* Estilos para el modal de estadísticas */
        .modal {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
        }

        .modal-content {
            position: relative;
            background-color: rgba(0, 0, 0, 0.95);
            margin: 50px auto;
            padding: 20px;
            width: 80%;
            max-width: 1000px;
            border-radius: 8px;
            border: 1px solid #444;
            box-shadow: 0 0 20px rgba(0, 204, 255, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .modal-header h2 {
            color: #00ccff;
            margin: 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
        }

        .close-button {
            padding: 10px 20px !important;
            background-color: rgba(255, 71, 87, 0.8) !important;
            color: white !important;
            border: none !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-family: 'Orbitron', sans-serif !important;
            font-weight: bold !important;
            font-size: 14px !important;
            transition: all 0.3s ease !important;
        }

        .close-button:hover {
            background-color: rgba(255, 71, 87, 1) !important;
            color: white !important;
            transform: translateY(-1px) !important;
        }

        .modal-body {
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            padding: 20px;
            min-height: 600px;
        }

        /* Forzar visibilidad y z-index de los modales */
        #test-modal, .modal, .messages-modal {
            z-index: 3000 !important;
        }
        #test-modal[style*="display: block"], .modal[style*="display: block"] {
            display: block !important;
        }

        .pm-accept-btn {
            transition: background 0.2s, color 0.2s;
        }
    </style>
</head>
<body>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBVc1a4E4_y-YJZV5ZqFQzTr1T8Txe8TmQ",
            authDomain: "ultimatemercenary-1e212.firebaseapp.com",
            projectId: "ultimatemercenary-1e212",
            storageBucket: "ultimatemercenary-1e212.firebasestorage.app",
            messagingSenderId: "683730871364",
            appId: "1:683730871364:web:350aaf7a296ad34db28811",
            databaseURL: "https://ultimatemercenary-1e212-default-rtdb.firebaseio.com/"
        };
        
        // Inicializar Firebase (versión 8)
        if (!window.firebaseApp) {
            window.firebaseApp = firebase.initializeApp(firebaseConfig);
            window.database = firebase.database();
        }

        // Referencias
        const conocidosRef = window.database.ref('conocidosSeleccionados');
        const conocimientosRef = window.database.ref('conocimientosSeleccionados');
        const mensajesRef = window.database.ref('mensajes-directos');
        const currentTestRef = window.database.ref('currentTest');
        const nombresRef = window.database.ref('nombresConcursantes');
        const audienceRef = window.database.ref('audience');
        const ratingRef = window.database.ref('rating');
        const pmRef = window.database.ref('playerPM');
        const pmTransactionsRef = window.database.ref('pmTransactions');
        const chatRef = window.database.ref('mensajes-publico-expanded');

        // Listeners de sincronización
        conocidosRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localStorage.setItem('conocidosSeleccionados', JSON.stringify(data));
                if (window.renderTarjetasSeleccionadas) window.renderTarjetasSeleccionadas();
            }
        });
        conocimientosRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localStorage.setItem('conocimientosSeleccionados', JSON.stringify(data));
                if (window.renderTarjetasSeleccionadas) window.renderTarjetasSeleccionadas();
            }
        });
        mensajesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localStorage.setItem('mensajes-directos', JSON.stringify(data));
                if (window.loadDirectMessages) window.loadDirectMessages();
            }
        });
        currentTestRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localStorage.setItem('currentTest', data);
                if (window.updateObjective) window.updateObjective();
            }
        });
        nombresRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                Object.entries(data).forEach(([numero, nombre]) => {
                    localStorage.setItem(`nombreConcursante_${numero}`, nombre);
                });
                if (window.renderTarjetasSeleccionadas) window.renderTarjetasSeleccionadas();
            }
        });
        audienceRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data !== null) {
                localStorage.setItem('spectators', data);
                if (window.updateStatusPanel) window.updateStatusPanel();
                if (window.updateUserList) window.updateUserList();
            }
        });
        ratingRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data !== null) {
                localStorage.setItem('rating', data);
                if (window.updateStatusPanel) window.updateStatusPanel();
                if (window.updateUserList) window.updateUserList();
            }
        });
        pmRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data !== null) {
                // Solo actualizar si no hay transacciones locales
                if (window.pmTransactions && window.pmTransactions.transactions && window.pmTransactions.transactions.length === 0) {
                    // Si es la primera vez, crear una transacción inicial
                    window.pmTransactions.addTransaction(data, 'PM inicial');
                }
            }
        });
        pmTransactionsRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localStorage.setItem('pmTransactions', JSON.stringify(data));
                if (window.pmTransactions) {
                    window.pmTransactions.updateUI();
                }
            }
        });
        chatRef.on('value', (snapshot) => {
            const data = snapshot.val();
            // Ensure data is an array, or provide an empty array if null/undefined
            // Firebase Realtime Database often returns objects for lists unless pushed with numeric keys.
            // If 'data' is an object of messages, convert to array.
            const messagesArray = Array.isArray(data) ? data : (data ? Object.values(data) : []);

            localStorage.setItem('mensajes-publico-expanded', JSON.stringify(messagesArray));
            if (window.renderGlobalChatMessages) {
                console.log("[Firebase Chat Listener] Calling renderGlobalChatMessages.");
                window.renderGlobalChatMessages(messagesArray);
            } else {
                // This might happen if Firebase loads and fires this event before the main DOM is fully parsed.
                // The initChatSystem on DOMContentLoaded should handle initial rendering from localStorage anyway.
                console.warn("[Firebase Chat Listener] renderGlobalChatMessages function not found at the moment of Firebase data arrival. Chat will render on DOMContentLoaded or next update.");
            }
        });
    </script>
    <div class="main-container">
        <!-- Video de fondo -->
        <video id="background-video" class="background-video" autoplay loop muted playsinline>
            <source src="videos/prueba0.mp4" type="video/mp4">
        </video>
        
        <!-- Contenedor de la interfaz -->
        <div class="ui-container">
            <!-- Barra superior -->
            <div class="top-bar">
                <div class="logo-container">
                    <img src="images/oce_logo.png" alt="OmniCorp Entertainment Logo" class="logo">
                    <div class="title-container">
                        <h1>ULTIMATE MERCENARY 0.73</h1>
                        <h2>Concursante #13</h2>
                    </div>
                </div>
                <button class="logout-button" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> CERRAR SESIÓN
                </button>
            </div>
            
            <!-- Área principal -->
            <div class="main-area">
                <!-- Chat -->
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <!-- Los mensajes se añadirán dinámicamente -->
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chat-input" placeholder="Escribe un mensaje...">
                        <button class="chat-submit" id="chat-submit"><i class="fas fa-paper-plane"></i></button>
                        <button class="opacity-toggle" id="opacity-toggle" title="Alternar transparencia del chat">
                            <i class="fas fa-adjust"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Panel lateral -->
                <div class="sidebar">
                    <!-- Estadísticas -->
                    <div class="sidebar-section">
                        <h3>ESTADÍSTICAS</h3>
                        <div class="stat-item">
                            <div class="stat-info">
                                <div class="stat-label">Audiencia</div>
                                <div class="stat-value" id="audience-value">0</div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-info">
                                <div class="stat-label">Rating</div>
                                <div class="stat-value" id="rating-value">0.0</div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-info">
                                <div class="stat-label">PM</div>
                                <div class="stat-value" id="pm-value">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones -->
                    <div class="sidebar-section" style="margin-top:auto; margin-bottom:auto;">
                        <h3>ACCIONES</h3>
                        <div class="action-buttons">
                            <button class="action-button" onclick="openShop()">TIENDA</button>
                            <button class="action-button" onclick="openMessages()">MENSAJES</button>
                            <button class="action-button" onclick="openObjective()">OBJETIVO</button>
                            <button class="action-button" onclick="openStats()">ESTADÍSTICAS</button>
                        </div>
                    </div>
                    
                    <!-- Objetivo actual -->
                    <div class="sidebar-section" style="margin-top:auto; flex-grow:1; min-height:200px;">
                        <h3>OBJETIVO ACTUAL</h3>
                        <div class="objective-display" id="current-objective" style="font-size:13px; padding:10px;">
                            <h4 id="objective-title" style="font-size:15px;">Cargando...</h4>
                            <p id="objective-description" style="font-size:13px;">Cargando objetivo...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal de Mensajes Directos -->
        <div id="messages-modal" class="messages-modal">
            <div class="messages-content">
                <h2>MENSAJES DIRECTOS</h2>
                <div class="messages-tabs">
                    <button class="tab-button active" data-tab="inbox">Bandeja de Entrada</button>
                    <button class="tab-button" data-tab="system">Sistema</button>
                    <button class="tab-button" data-tab="shop">Tienda</button>
                </div>
                <div id="messages-list" class="messages-list">
                    <!-- Los mensajes se añadirán dinámicamente -->
                </div>
                <button class="accept-btn" onclick="document.getElementById('messages-modal').style.display='none'">CERRAR</button>
            </div>
        </div>

        <!-- NEW Objective Modal - Ensure any old #test-modal is removed -->
        <div id="test-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.71); z-index: 5000;">
            <div style="background-color: #111; color: #fff; max-width: 900px; width: 95vw; min-width: 320px; margin: 40px auto; padding: 40px 40px 30px 40px; border: 2px solid #ff4757; border-radius: 12px; box-shadow: 0 0 40px 10px rgba(255,71,87,0.25); max-height: 90vh; display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 18px; margin-bottom: 18px; border-bottom: 1.5px solid #444;">
                    <h2 id="objective-modal-title" style="color: #ff4757; font-family: 'Orbitron', sans-serif; margin: 0; font-size: 28px; letter-spacing: 1px;">OBJETIVO</h2>
                    <button onclick="document.getElementById('test-modal').style.display='none'" style="background: #ff4757; color: white; border: none; padding: 10px 22px; border-radius: 4px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 16px;">CERRAR</button>
                </div>
                <div id="objective-modal-description" style="font-size: 18px; line-height: 1.7; flex: 1 1 auto; overflow-y: auto; max-height: 70vh;">
                    <!-- Descripción del objetivo -->
                </div>
            </div>
        </div>
        <!-- END OF NEW Objective Modal -->

        <div class="overlay" style="z-index:50;"></div>
    </div>

    <!-- Secciones de Conocidos y Conocimientos -->
    <div class="sheet-section">
        <h3>Conocidos</h3>
        <div id="conocidos-tarjetas" class="personajes-container"></div>
    </div>
    <div class="sheet-section">
        <h3>Conocimientos</h3>
        <div id="conocimientos-tarjetas" class="facciones-container"></div>
    </div>

    <script src="mensajes-publico-expanded.js"></script>
    <script>
    // Exponer funciones de UI globalmente para los listeners de Firebase
    if (typeof updateStatusPanel === 'function') window.updateStatusPanel = updateStatusPanel;
    if (typeof updateObjective === 'function') window.updateObjective = updateObjective;
    if (typeof loadChatMessages === 'function') window.loadChatMessages = loadChatMessages;
    if (typeof renderTarjetasSeleccionadas === 'function') window.renderTarjetasSeleccionadas = renderTarjetasSeleccionadas;
    if (typeof loadDirectMessages === 'function') window.loadDirectMessages = loadDirectMessages;
    if (typeof updateUserList === 'function') window.updateUserList = updateUserList;
    </script>
    <script>
    function logout() {
        // Solo elimina claves de login (ajusta los nombres si usas otros)
        localStorage.removeItem('user');
        localStorage.removeItem('sessionToken');
        sessionStorage.clear();
        document.cookie.split(';').forEach(function(c) {
            document.cookie = c.replace(/^ +/, '').replace(/=.*/, '=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/');
        });
        window.location.replace('login.html');
    }
    window.logout = logout;
    function openStats() {
        const statsWindow = document.createElement('div');
        statsWindow.className = 'modal';
        statsWindow.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ESTADÍSTICAS</h2>
                    <button class="close-button" onclick="this.parentElement.parentElement.parentElement.remove()">VOLVER</button>
                </div>
                <div class="modal-body">
                    <iframe src="character-sheet-modal.html" style="width: 100%; height: 600px; border: none;"></iframe>
                </div>
            </div>
        `;
        document.body.appendChild(statsWindow);
        window.fichaIframe = statsWindow.querySelector('iframe');
        
        // Esperar a que el iframe cargue
        window.fichaIframe.onload = function() {
            // Enviar el inventario actual
            window.fichaIframe.contentWindow.postMessage({
                type: 'updateInventory',
                items: window.inventory.getItems()
            }, '*');
        };
    }
    window.openStats = openStats;
    </script>
    <script>
    // --- MODALES Y FUNCIONES GLOBALES (openShop, openMessages, openObjective) ---
    function openShop() {
        console.log('[DEBUG] openShop called');
        const shopWindow = document.createElement('div');
        shopWindow.className = 'modal';
        shopWindow.style.zIndex = 3000;
        shopWindow.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2>TIENDA</h2>
                    <button class="close-button" onclick="this.parentElement.parentElement.parentElement.remove()">VOLVER</button>
                </div>
                <div class="modal-body">
                    <iframe src="tienda.html" style="width: 100%; height: 600px; border: none;"></iframe>
                </div>
            </div>
        `;
        document.body.appendChild(shopWindow);
        window.tiendaIframe = shopWindow.querySelector('iframe');
    }
    window.openShop = openShop;

    function openMessages() {
        document.getElementById('messages-modal').style.display = 'block';
        if (window.loadDirectMessages) window.loadDirectMessages();
    }
    window.openMessages = openMessages;

    function openObjective() {
        console.log('[DEBUG] openObjective called');
        if (window.showObjectiveModal) window.showObjectiveModal();
    }
    window.openObjective = openObjective;

    // NEW showObjectiveModal function for the refactored modal
    function showObjectiveModal() {
        const currentTestKey = localStorage.getItem('currentTest') || 'prueba0';
        const modal = document.getElementById('test-modal');
        if (!modal) {
            console.error('Objective modal not found!');
            return;
        }
        fetch(`prueba${currentTestKey.replace('prueba','')}.html`)
            .then(res => res.text())
            .then(html => {
                // Usar DOMParser para extraer TODOS los bloques .narrative-section
                let content = '';
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const sections = doc.querySelectorAll('.narrative-section');
                if (sections.length > 0) {
                    content = Array.from(sections).map(s => s.outerHTML).join('');
                } else {
                    // Si no hay bloque narrativo, usar el primer <main> o <body>
                    const main = doc.querySelector('main');
                    if (main) content = main.innerHTML;
                    else if (doc.body) content = doc.body.innerHTML;
                }
                document.getElementById('objective-modal-description').innerHTML = content;
            })
            .catch(() => {
                document.getElementById('objective-modal-description').innerHTML = '<div style="color:#f55;">No se pudo cargar la información de la prueba.</div>';
            });
        modal.style.display = 'block';
    }
    window.showObjectiveModal = showObjectiveModal;

    // Exponer funciones de UI globalmente para los listeners de Firebase
    if (typeof updateStatusPanel === 'function') window.updateStatusPanel = updateStatusPanel;
    if (typeof updateObjective === 'function') window.updateObjective = updateObjective;
    if (typeof loadChatMessages === 'function') window.loadChatMessages = loadChatMessages;
    if (typeof renderTarjetasSeleccionadas === 'function') window.renderTarjetasSeleccionadas = renderTarjetasSeleccionadas;
    if (typeof loadDirectMessages === 'function') window.loadDirectMessages = loadDirectMessages;
    if (typeof updateUserList === 'function') window.updateUserList = updateUserList;
    </script>
    <script>
    // Actualiza los valores de audiencia, rating y PM en el panel lateral
    function updateStatusPanel() {
        const audience = localStorage.getItem('spectators') || '0';
        const rating = localStorage.getItem('rating') || '0.0';
        const pm = localStorage.getItem('playerPM') || '0';
        if (document.getElementById('audience-value')) document.getElementById('audience-value').textContent = audience;
        if (document.getElementById('rating-value')) document.getElementById('rating-value').textContent = rating;
        if (document.getElementById('pm-value')) document.getElementById('pm-value').textContent = pm;
    }
    window.updateStatusPanel = updateStatusPanel;

    // Actualiza el objetivo actual en la barra lateral
    function updateObjective() {
        const testObjectives = {
            'prueba0': {
                title: 'Prueba 0: La Caída',
                desc: 'Supervivencia inicial en el hangar subterráneo. Los concursantes deben adaptarse al entorno, familiarizarse con el equipo básico y demostrar su capacidad para sobrevivir en condiciones adversas.'
            },
            'prueba1': {
                title: 'Prueba 1: Carrera de Obstáculos',
                desc: 'Completar la carrera de obstáculos industrial. Los concursantes deben superar una serie de desafíos físicos y mentales, demostrando su agilidad, resistencia y capacidad de adaptación.'
            },
            'prueba2': {
                title: 'Prueba 2: La Cosecha',
                desc: 'Recolectar plantas y materiales valiosos del Jardín Vertical. Los concursantes deben identificar, recolectar y preservar especímenes raros y peligrosos, demostrando su conocimiento y precisión.'
            },
            'prueba3': {
                title: 'Prueba 3: La Entrega',
                desc: 'Realizar entregas de paquetes en el distrito industrial. Los concursantes deben transportar cargamentos valiosos a través de zonas peligrosas, demostrando su sigilo y eficiencia.'
            }
        };
        const currentTest = localStorage.getItem('currentTest') || 'prueba0';
        const obj = testObjectives[currentTest] || testObjectives['prueba0'];
        // Barra lateral
        if (document.getElementById('objective-title')) document.getElementById('objective-title').textContent = obj.title;
        if (document.getElementById('objective-description')) document.getElementById('objective-description').textContent = obj.desc;
        // Eliminar imagen si existe
        const imgElem = document.getElementById('objective-image');
        if (imgElem && imgElem.parentNode) imgElem.parentNode.removeChild(imgElem);
    }
    window.updateObjective = updateObjective;

    // Refuerza la carga de mensajes de ejemplo en el chat si no hay mensajes reales
    window.loadChatMessages = function() {
        let mensajes = [];
        try {
            mensajes = JSON.parse(localStorage.getItem('mensajes-publico-expanded') || '[]');
            if (!Array.isArray(mensajes)) mensajes = [];
        } catch (e) {
            mensajes = [];
        }
        const chat = document.getElementById('chat-messages');
        if (!chat) return;
        if (!mensajes || mensajes.length === 0) {
            // Mensajes de ejemplo locales si el chat está vacío
            const nombresUsuarios = [
                "Neo_Kyoto_Fan42", "SamuraiStalker", "EdgerunnerGirl", "MercenaryCrazy", 
                "BloodMoney99", "ChromeHeart", "WiredNinja", "NeonShadow",
                "CyberSlice", "DeathMatch_Lover", "KatanaQueen", "StreetHunter22"
            ];
            const ejemplos = [
                "¡Vamos XIII, no decepciones a tus fans!",
                "¡Estoy apostando todo por ti, no me falles!",
                "Mira esos reflejos, ¡eres una máquina!",
                "Mi IA predictiva dice que no llegarás a la siguiente ronda, XIII...",
                "Acabo de apostar 5000 créditos a que sobrevives esta prueba",
                "OCE debería ponerte un reto REAL, XIII",
                "Ese cromo que llevas parece de segunda mano...",
                "¡Eres mi favorita desde el principio!",
                "Solo las débiles usan tanto equipo. Demuestra tu valor real.",
                "Por dios, alguien dé algo de equipo decente a la XIII",
                "¡Actúa como si tuvieras múltiples personalidades por 12 horas! ¡+70 PM!",
                "¡Marca territorios con sangre como un animal y defiéndelos a muerte! ¡+80 PM!"
            ];
            const ejemploMensajes = Array.from({length: 10}).map((_,i) => ({
                sender: nombresUsuarios[i % nombresUsuarios.length],
                content: ejemplos[i % ejemplos.length],
                time: new Date().toLocaleTimeString()
            }));
            chat.innerHTML = ejemploMensajes.map(msg =>
                `<div class=\"chat-message\"><span class="username\">${msg.sender}:</span> <span class="content">${msg.content}</span> <span style="float:right;font-size:11px;color:#888;\">${msg.time}</span></div>`
            ).join('') + '<div style="color:#888;font-size:13px;">(Mensajes de ejemplo: el chat global está vacío)</div>';
        } else {
            chat.innerHTML = mensajes.map(msg => {
                // Compatibilidad flexible
                const sender = msg.sender || msg.user || 'SISTEMA';
                const content = msg.content || msg.text || '';
                const time = msg.time || '';
                return `<div class=\"chat-message\"><span class="username\">${sender}:</span> <span class="content">${content}</span> <span style="float:right;font-size:11px;color:#888;\">${time}</span></div>`;
            }).join('');
        }
        chat.scrollTop = chat.scrollHeight;
    };
    </script>
    <script>
    // Llama a las funciones al cargar la página para inicializar la UI
    updateStatusPanel();
    updateObjective();
    renderTarjetasSeleccionadas();
    loadDirectMessages();
    </script>

    <!-- NEW CONSOLIDATED CHAT SYSTEM SCRIPT -->
    <script>
        // --- CHAT ROBUSTO Y GLOBAL ---
        let autoMsgInterval;
        function limpiarMensajesJugadorDOM() {
            // Elimina del DOM todos los mensajes del jugador
            const chatMessagesContainer = document.getElementById('chat-messages');
            if (!chatMessagesContainer) return;
            const mensajes = chatMessagesContainer.querySelectorAll('.chat-message');
            mensajes.forEach(msg => {
                const username = msg.querySelector('.username');
                if (username && username.textContent.trim().startsWith('XIII')) {
                    chatMessagesContainer.removeChild(msg);
                }
            });
        }
        function limpiarChatJugador() {
            // Borra solo los mensajes del jugador de localStorage y del DOM
            localStorage.removeItem('mensajes-jugador-sesion');
            limpiarMensajesJugadorDOM();
        }
        function limpiarChatDOMCompleto() {
            // Limpia todo el chat del DOM
            const chatMessagesContainer = document.getElementById('chat-messages');
            if (chatMessagesContainer) chatMessagesContainer.innerHTML = '';
        }
        function agregarMensajeAlChatDisplay(msgData, msgId) {
            const chatMessagesContainer = document.getElementById('chat-messages');
            if (!chatMessagesContainer) return;
            const div = document.createElement('div');
            // Colores de nicks
            let userColor = '#cccccc';
            let tag = '';
            let tagLabel = '';
            let tagStyle = '';
            // Tags immersivos posibles
            const tagsImmersivos = [
                {label: 'VIP', style: 'background:#ffd700;color:#222;border:1px solid #ffd700;'},
                {label: 'PATROCINADO', style: 'background:#ff4757;color:#fff;border:1px solid #ff4757;'},
                {label: 'FAN', style: 'background:#70a1ff;color:#fff;border:1px solid #70a1ff;'},
                {label: 'SPONSOR', style: 'background:#2ed573;color:#fff;border:1px solid #2ed573;'},
                {label: 'INFLUENCER', style: 'background:#eccc68;color:#222;border:1px solid #eccc68;'},
                {label: 'EXPERTO', style: 'background:#5352ed;color:#fff;border:1px solid #5352ed;'}
            ];
            if (msgData.tagImmersivo) {
                tagLabel = msgData.tagImmersivo;
                const found = tagsImmersivos.find(t => t.label === tagLabel);
                tagStyle = found ? found.style : tagsImmersivos[0].style;
            } else if (msgData.automatico && msgData.showTag) {
                // Solo si showTag está en true
                const tagObj = tagsImmersivos[Math.floor(Math.random() * tagsImmersivos.length)];
                tagLabel = tagObj.label;
                tagStyle = tagObj.style;
            }
            if (tagLabel) {
                tag = `<span class=\"tag\" style=\"${tagStyle}margin-left:7px;font-size:10px;padding:2px 6px;border-radius:3px;\">${tagLabel}</span>`;
            }
            if (msgData.usuario === 'XIII') {
                userColor = '#00ccff';
            } else if (msgData.usuario === 'Kaiser') {
                userColor = '#ff4757';
            } else if (msgData.automatico) {
                userColor = msgData.color || '#ffd700';
            } else {
                userColor = msgData.color || '#cccccc';
            }
            // Mensaje destacado si es PM o tiene tag especial
            const pmValue = (msgData.mensaje||'').match(/([+][0-9]+)\s*PM/) ? parseInt((msgData.mensaje.match(/([+][0-9]+)\s*PM/)||[])[1].replace('+','')) : null;
            if (pmValue || tagLabel) div.classList.add('destacado');
            div.className += ' chat-message';
            
            // Resaltar "XIII" o "#13" en el contenido del mensaje
            let mensajeContent = msgData.mensaje || '';
            mensajeContent = mensajeContent.replace(/(XIII|#13)/gi, '<span style="color:#ffd700;font-weight:bold;">$1</span>');
            
            div.innerHTML = `
                <span class=\"username\" style=\"color:${userColor};font-weight:bold;\">${msgData.usuario || 'Anónimo'}:${tag}</span>
                <span class=\"content\">${mensajeContent}</span>
                <span style=\"float:right;font-size:11px;color:#888;\">${msgData.hora || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</span>
            `;
            if (pmValue) {
                const btn = document.createElement('button');
                btn.textContent = `Aceptar +${pmValue} PM`;
                btn.className = 'pm-accept-btn';
                Object.assign(btn.style, {
                    marginLeft: '10px', fontSize: '12px', background: '#222', color: '#2ed573',
                    border: '1px solid #2ed573', borderRadius: '4px', cursor: 'pointer', transition: 'all 0.3s ease'
                });
                let pmButtonStates = JSON.parse(sessionStorage.getItem('pmSumadosParaBotones') || '{}');
                if (pmButtonStates[msgId]) {
                    btn.textContent = 'Aceptado';
                    btn.disabled = true;
                    Object.assign(btn.style, { background: '#444', color: '#aaa', cursor: 'default' });
                } else {
                    btn.onclick = function() {
                        window.sumarPM(pmValue, `PM de chat: ${msgData.mensaje}`);
                        pmButtonStates[msgId] = true;
                        sessionStorage.setItem('pmSumadosParaBotones', JSON.stringify(pmButtonStates));
                        btn.textContent = 'Aceptado';
                        btn.disabled = true;
                        Object.assign(btn.style, { background: '#444', color: '#aaa', cursor: 'default' });
                    };
                }
                div.appendChild(btn);
            }
            chatMessagesContainer.appendChild(div);
            setTimeout(() => div.style.opacity = '1', 50);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }
        window.agregarMensajeAlChatDisplay = agregarMensajeAlChatDisplay;
        function startAutoMessages() {
            if (autoMsgInterval) clearInterval(autoMsgInterval);
            const nombresUsuarios = [
                "Neo_Kyoto_Fan42", "SamuraiStalker", "EdgerunnerGirl", "MercenaryCrazy", 
                "BloodMoney99", "ChromeHeart", "WiredNinja", "NeonShadow",
                "CyberSlice", "DeathMatch_Lover", "KatanaQueen", "StreetHunter22"
            ];
            const coloresAuto = [
                '#ffb347', '#7bed9f', '#70a1ff', '#eccc68', '#ffa502', '#2ed573', '#1e90ff', '#ff6b81', '#5352ed', '#f1c40f', '#00b894', '#fdcb6e'
            ];
            const ejemplos = [
                "¡Vamos XIII, no decepciones a tus fans!",
                "¡Estoy apostando todo por ti, no me falles!",
                "Mira esos reflejos, ¡eres una máquina!",
                "Mi IA predictiva dice que no llegarás a la siguiente ronda, XIII...",
                "Acabo de apostar 5000 créditos a que sobrevives esta prueba",
                "OCE debería ponerte un reto REAL, XIII",
                "Ese cromo que llevas parece de segunda mano...",
                "¡Eres mi favorita desde el principio!",
                "Solo las débiles usan tanto equipo. Demuestra tu valor real.",
                "Por dios, alguien dé algo de equipo decente a la XIII",
                "¡Actúa como si tuvieras múltiples personalidades por 12 horas! ¡+70 PM!",
                "¡Marca territorios con sangre como un animal y defiéndelos a muerte! ¡+80 PM!"
            ];
            let autoMsgIndex = 0;
            autoMsgInterval = setInterval(() => {
                const idx = autoMsgIndex % ejemplos.length;
                // Tag immersivo solo en 1 de cada 5
                const showTag = (autoMsgIndex % 5 === 0);
                let tagImmersivo = undefined;
                if (showTag) {
                    const tagsImmersivos = ["VIP","PATROCINADO","FAN","SPONSOR","INFLUENCER","EXPERTO"];
                    tagImmersivo = tagsImmersivos[Math.floor(Math.random()*tagsImmersivos.length)];
                }
                const msg = {
                    usuario: nombresUsuarios[idx % nombresUsuarios.length],
                    mensaje: ejemplos[idx],
                    color: coloresAuto[idx % coloresAuto.length],
                    hora: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
                    automatico: true,
                    showTag,
                    tagImmersivo
                };
                const msgId = `auto-${autoMsgIndex}`;
                agregarMensajeAlChatDisplay(msg, msgId);
                autoMsgIndex++;
            }, 3500);
        }
        function initChatSystem() {
            // Al cargar la página, limpiar mensajes del jugador
            limpiarChatJugador();
            // Iniciar mensajes automáticos
            startAutoMessages();
            // NO renderizar mensajes del jugador guardados en la sesión anterior
            const chatInput = document.getElementById('chat-input');
            const chatSubmitBtn = document.getElementById('chat-submit');
            window.enviarMensajeJugador = function() {
                const text = chatInput.value.trim();
                if (!text) return;
                const playerMsg = {
                    usuario: 'XIII',
                    mensaje: text,
                    color: '#00ccff',
                    hora: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })
                };
                const uniqueMsgId = `player-${Date.now()}`;
                // Añadir al DOM
                agregarMensajeAlChatDisplay(playerMsg, uniqueMsgId);
                chatInput.value = '';
                // NO guardar en localStorage ni en Firebase
            };
            chatSubmitBtn.onclick = window.enviarMensajeJugador;
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    window.enviarMensajeJugador();
                }
            });
            window.renderGlobalChatMessages = function(messagesArray) {
                // Solo renderizar mensajes que NO sean del jugador (ignorando mayúsculas, minúsculas y espacios)
                messagesArray.forEach((msg, index) => {
                    const sender = (msg.sender || '').trim().toLowerCase();
                    if (sender === 'tú') return;
                    const msgId = msg.msg_id || `fb-${msg.sender}-${msg.time}-${index}`;
                    agregarMensajeAlChatDisplay({
                        usuario: msg.sender,
                        mensaje: msg.content,
                        hora: msg.time,
                        color: msg.sender === 'Kaiser' ? '#ff4757' : '#cccccc',
                        esReto: !!((msg.content||'').match(/([+][0-9]+)\s*PM/))
                    }, msgId);
                });
            };
            // Limpieza total al hacer logout
            window.logout = function() {
                limpiarChatJugador();
                localStorage.removeItem('user');
                localStorage.removeItem('sessionToken');
                sessionStorage.clear();
                document.cookie.split(';').forEach(function(c) {
                    document.cookie = c.replace(/^ +/, '').replace(/=.*/, '=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/');
                });
                window.location.replace('login.html');
            };
            window.addEventListener('beforeunload', limpiarChatJugador);
        }
        document.addEventListener('DOMContentLoaded', function() {
            limpiarChatDOMCompleto(); // Limpia todo el chat antes de inicializar
            initChatSystem();
        });
        window.addEventListener('beforeunload', limpiarChatJugador);
    </script>

    <!-- Función para borrar mensajes del jugador en Firebase (llámala desde la consola: borrarMensajesJugadorFirebase();) -->
    <script>
    window.borrarMensajesJugadorFirebase = function() {
        if (!window.firebase || !window.saveChat) {
            alert('Firebase no está disponible.');
            return;
        }
        const mensajes = JSON.parse(localStorage.getItem('mensajes-publico-expanded') || '[]');
        const filtrados = mensajes.filter(msg => {
            if (!msg.sender) return true;
            const sender = msg.sender.trim().toLowerCase();
            return sender !== 'tú';
        });
        window.saveChat(filtrados);
        alert('Mensajes del jugador eliminados de Firebase (puede tardar unos segundos en reflejarse).');
    };
    </script>

    <script>
    // Sistema de transacciones PM
    window.pmTransactions = {
        transactions: [],
        total: 0,

        init() {
            // Cargar transacciones guardadas
            const saved = localStorage.getItem('pmTransactions');
            if (saved) {
                this.transactions = JSON.parse(saved);
                this.total = this.transactions.reduce((sum, t) => sum + t.amount, 0);
            }
            
            // Sincronizar con Firebase
            if (window.database) {
                const pmRef = window.database.ref('playerPM');
                pmRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data !== null) {
                        this.total = parseInt(data);
                        localStorage.setItem('playerPM', this.total.toString());
                        this.updateUI();
                    }
                });
            }
            
            this.updateUI();
        },

        addTransaction(amount, reason) {
            const transaction = {
                amount,
                reason,
                timestamp: Date.now()
            };
            this.transactions.push(transaction);
            this.total += amount;
            
            // Guardar en localStorage
            localStorage.setItem('pmTransactions', JSON.stringify(this.transactions));
            localStorage.setItem('playerPM', this.total.toString());
            
            // Guardar en Firebase
            if (window.database) {
                window.database.ref('playerPM').set(this.total);
            }
            
            // Notificar a todos los iframes
            this.notifyIframes();
            
            this.updateUI();
            return this.total;
        },

        setTotal(newTotal) {
            const difference = newTotal - this.total;
            return this.addTransaction(difference, 'Ajuste manual de PM');
        },

        getTotal() {
            return this.total;
        },

        updateUI() {
            // Actualizar todos los elementos con data-pm-display
            document.querySelectorAll('[data-pm-display]').forEach(el => {
                el.textContent = this.total;
            });
            
            // Actualizar el elemento PM en el panel lateral
            const pmElement = document.getElementById('pm-value');
            if (pmElement) {
                pmElement.textContent = this.total;
            }
            
            // Notificar a todos los iframes
            this.notifyIframes();
        },

        notifyIframes() {
            // Notificar a todos los iframes
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach(iframe => {
                if (iframe.contentWindow) {
                    iframe.contentWindow.postMessage({
                        type: 'updatePM',
                        total: this.total
                    }, '*');
                }
            });
        }
    };

    // Inicializar solo el sistema PM
    window.pmTransactions.init();

    // Escuchar mensajes de los iframes (solo PM)
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'getPM') {
            // Responder con el total actual
            event.source.postMessage({
                type: 'updatePM',
                total: window.pmTransactions.getTotal()
            }, '*');
        } else if (event.data && event.data.type === 'setPM') {
            // Establecer PM desde el panel de control
            if (window.pmTransactions) {
                window.pmTransactions.setTotal(event.data.total);
            }
        }
    });

    // Funciones globales para manejar PM
    window.sumarPM = function(cantidad, razon) {
        return window.pmTransactions.addTransaction(cantidad, razon);
    };

    window.restarPM = function(cantidad, razon) {
        return window.pmTransactions.addTransaction(-cantidad, razon);
    };

    window.establecerPM = function(total) {
        return window.pmTransactions.setTotal(total);
    };

    window.comprarItem = function(itemId, precio) {
        const total = window.pmTransactions.getTotal();
        if (total >= precio) {
            window.restarPM(precio, `Compra de item ${itemId}`);
            return true;
        }
        return false;
    };
    </script>

    <!-- Versión del sistema -->
    <script>
        const SYSTEM_VERSION = '0.64';
    </script>

    <!-- Funciones para guardar en Firebase (si el usuario puede modificar) -->
    <script>
    window.saveConcursanteName = function(numero, nombre) {
        const nombreRef = window.database.ref(`nombresConcursantes/${numero}`);
        nombreRef.set(nombre);
    };
    window.saveAudience = function(valor) { audienceRef.set(valor); };
    window.saveRating = function(valor) { ratingRef.set(valor); };
    window.savePM = function(valor) { pmRef.set(valor); };
    window.saveChat = function(arr) { chatRef.set(arr); };
    window.saveConocidosSeleccionados = function(arr) { conocidosRef.set(arr); };
    window.saveConocimientosSeleccionados = function(arr) { conocimientosRef.set(arr); };
    window.saveMensajesDirectos = function(arr) { mensajesRef.set(arr); };
    window.saveCurrentTest = function(valor) { currentTestRef.set(valor); };
    </script>

    <!-- Script del sistema de inventario -->
    <script src="character-sheet.js"></script>

</body>
</html> 