<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Mercenary 1.58</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="chat-publico.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
        }

        .main-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .background-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            opacity: 0.4;
            pointer-events: none;
            background-color: #000;
        }

        video#background-video {
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .ui-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            background-color: rgba(0, 0, 0, 0.8);
            padding: 15px 15px 5px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
            height: 140px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            height: 100%;
            padding: 0;
        }

        .logo {
            height: 120px;
            transition: transform 0.3s ease;
            object-fit: contain;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .title-container h1 {
            font-size: 24px;
            margin: 0;
            color: #00ccff;
        }

        .title-container h2 {
            font-size: 18px;
            margin: 0;
            color: #ff4757;
        }

        .main-area {
            flex: 1;
            display: flex;
            padding: 10px 20px;
            gap: 15px;
            height: calc(100vh - 90px);
            margin-top: 10px;
            overflow: hidden;
        }

        .chat-container {
            flex: 1.5;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-height: calc(100vh - 110px);
            min-height: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px 0px 15px 0px;
            min-height: 0;
            max-height: calc(100vh - 180px);
            width: 100%;
            box-sizing: border-box;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px 20px;
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            border: 1px solid #444;
            transition: all 0.3s ease;
            width: calc(100% - 10px) !important;
            max-width: none !important;
            box-sizing: border-box;
            margin: 0 5px 15px 5px;
            position: relative;
        }

        .chat-message:hover {
            transform: translateX(5px);
        }

        .chat-message .username {
            color: #00ccff;
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-message .content {
            color: #fff;
        }

        .chat-message.system {
            background-color: rgba(255, 71, 87, 0.2);
            border-color: #ff4757;
        }

        .chat-message.highlight {
            background-color: rgba(0, 204, 255, 0.2);
            border-color: #00ccff;
            animation: pulse 2s infinite;
        }

        .chat-message .tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .chat-message .tag.vip {
            background-color: #ffd700;
            color: #000;
        }

        .chat-message .tag.sponsored {
            background-color: #ff4757;
            color: #fff;
        }

        .chat-message .pm-button {
            display: inline-block;
            margin-left: 10px;
            padding: 2px 8px;
            background-color: #2ed573;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .chat-message .pm-button:hover {
            background-color: #7bed9f;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 204, 255, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(0, 204, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 204, 255, 0); }
        }

        .chat-input-container {
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.9);
            border-top: 1px solid #444;
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            min-width: 0; /* Permite que el input se encoja */
            padding: 10px;
            background-color: rgba(30, 30, 30, 0.8);
            border: 1px solid #444;
            border-radius: 4px;
            color: white;
        }

        .chat-submit {
            background-color: #ff4757;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .opacity-toggle {
            background-color: #00ccff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .opacity-toggle:hover {
            background-color: #00a3cc;
        }

        .auto-scroll-toggle {
            background-color: #2ed573;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .auto-scroll-toggle:hover {
            background-color: #7bed9f;
        }

        .auto-scroll-toggle.disabled {
            background-color: #ff4757;
        }

        .auto-scroll-toggle.disabled:hover {
            background-color: #ff6b81;
        }

        .chat-container.transparent {
            background-color: rgba(0, 0, 0, 0.3);
        }

        .chat-container.transparent .chat-messages {
            background-color: rgba(0, 0, 0, 0.2);
        }

        .chat-container.transparent .chat-message {
            background-color: rgba(30, 30, 30, 0.5);
        }

        .sidebar {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 10px;
            max-width: 300px;
            margin-left: auto;
            height: 100%;
        }

        .sidebar-section {
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            border: 1px solid #444;
            padding: 12px;
        }

        .sidebar-section h3 {
            color: #00ccff;
            margin: 0 0 15px 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            padding: 8px;
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            border: 1px solid #444;
        }

        .stat-icon {
            width: 24px;
            height: 24px;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            color: #00ccff;
            font-size: 12px;
        }

        .stat-value {
            color: #ff4757;
            font-size: 18px;
            font-weight: bold;
        }

        .sidebar-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .sidebar-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            background-color: rgba(30, 30, 30, 0.8);
            border: 1px solid #444;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sidebar-button:hover {
            background-color: rgba(255, 71, 87, 0.2);
            border-color: #ff4757;
        }

        .sidebar-button img {
            width: 24px;
            height: 24px;
        }

        .objective-display {
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            border: 1px solid #444;
            padding: 10px 10px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
            min-height: 170px;
        }

        .objective-display h4 {
            color: #ff4757;
            margin: 0 0 10px 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 15px;
        }

        .objective-display p {
            color: #fff;
            margin: 0;
            font-size: 13px;
            line-height: 1.4;
        }

        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 0, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 1000;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(
                circle at center,
                transparent 0%,
                rgba(0, 0, 0, 0.3) 100%
            );
            pointer-events: none;
            z-index: 999;
        }

        .rules-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            overflow-y: auto;
        }

        .rules-content {
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            border: 1px solid #444;
            color: white;
        }

        .rules-content h1 {
            color: #00ccff;
            text-align: center;
            margin-bottom: 30px;
        }

        .rules-content section {
            margin-bottom: 30px;
        }

        .rules-content h2 {
            color: #ff4757;
            margin-bottom: 15px;
        }

        .rules-content ul {
            list-style: none;
            padding: 0;
        }

        .rules-content li {
            margin-bottom: 10px;
            padding: 10px;
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            border: 1px solid #444;
        }

        .accept-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: #ff4757;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 30px;
            transition: background-color 0.3s;
        }

        .accept-btn:hover {
            background-color: #ff6b81;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background-color: rgba(255, 71, 87, 0.8);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            z-index: 1000;
        }

        .back-button:hover {
            background-color: rgba(255, 71, 87, 1);
        }

        .messages-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
        }

        .messages-content {
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            border: 1px solid #444;
            color: white;
        }

        .message-item {
            margin-bottom: 15px;
            padding: 15px;
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            border: 1px solid #444;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .message-sender {
            color: #00ccff;
            font-weight: bold;
        }

        .message-time {
            color: #666;
            font-size: 12px;
        }

        .message-content {
            color: #fff;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-line;
        }

        .logout-button {
            background-color: rgba(255, 71, 87, 0.8);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-right: 65px;
        }

        .logout-button:hover {
            background-color: rgba(255, 71, 87, 1);
            transform: translateY(-2px);
        }

        .current-objective {
            background-color: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }

        .current-objective h3 {
            color: #ff4757;
            margin: 0 0 10px 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
        }

        .current-objective p {
            color: #fff;
            margin: 0;
            font-size: 14px;
            line-height: 1.4;
        }

        .cyberpunk-quote {
            background-color: rgba(0, 0, 0, 0.8);
            border-left: 4px solid #ff4757;
            padding: 20px;
            margin: 20px 0;
            color: #00ccff;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1em;
            line-height: 1.6;
            text-shadow: 0 0 10px rgba(0, 204, 255, 0.5);
            position: relative;
            overflow: hidden;
        }

        .cyberpunk-quote::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 0%, rgba(255, 71, 87, 0.1) 50%, transparent 100%);
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .messages-section {
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            border: 1px solid #444;
            padding: 20px;
            margin-top: 20px;
        }

        .messages-section h3 {
            color: #00ccff;
            margin: 0 0 15px 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
        }

        .messages-container {
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            border: 1px solid #444;
        }

        .message-item {
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            border-left: 3px solid #00ccff;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .message-sender {
            color: #ff4757;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
        }

        .message-time {
            color: #666;
            font-size: 12px;
        }

        .message-content {
            color: #fff;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Estilos específicos para diferentes tipos de mensajes */
        .message-item[data-type="shop"] {
            border-left-color: #2ecc71;
        }

        .message-item[data-type="achievement"] {
            border-left-color: #f1c40f;
        }

        .message-item[data-type="warning"] {
            border-left-color: #e74c3c;
        }

        /* Estilos para el modal de mensajes directos */
        .messages-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .tab-button {
            background-color: rgba(30, 30, 30, 0.8);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 8px 15px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-button.active {
            background-color: #ff4757;
            border-color: #ff4757;
        }

        .messages-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .message-item {
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #00ccff;
        }

        .message-item[data-type="system"] {
            border-left-color: #ff4757;
        }

        .message-item[data-type="shop"] {
            border-left-color: #2ecc71;
        }

        .message-item[data-type="achievement"] {
            border-left-color: #f1c40f;
        }

        .message-item[data-type="warning"] {
            border-left-color: #e74c3c;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .message-sender {
            color: #00ccff;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
        }

        .message-time {
            color: #666;
            font-size: 12px;
        }

        .message-content {
            color: #fff;
            font-size: 14px;
            line-height: 1.4;
        }

        .message-image {
            width: 100%;
            max-width: 200px;
            margin: 10px 0;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #00ccff;
        }

        .message-image img {
            width: 100%;
            height: auto;
            display: block;
        }

        .message-actions {
            margin-top: 10px;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .delete-button {
            background-color: #ff4757;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .delete-button:hover {
            background-color: #ff6b81;
            transform: translateY(-2px);
        }

        .purchase-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.95);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #00ccff;
            color: #00ccff;
            display: none;
            z-index: 9999;
            animation: slideIn 0.5s ease-out;
            box-shadow: 0 0 20px rgba(0, 204, 255, 0.3);
            min-width: 300px;
            font-family: 'Orbitron', sans-serif;
        }

        .purchase-message h4 {
            color: #ff4757;
            margin: 0 0 10px 0;
            font-size: 1.2em;
            text-transform: uppercase;
        }

        .purchase-message p {
            margin: 5px 0;
            font-size: 1.1em;
        }

        .purchase-message .warning {
            color: #ff4757;
            font-weight: bold;
            margin-top: 10px;
            font-size: 0.9em;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        .accept-button {
            background-color: #00ccff;
            color: #000;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .accept-button:hover {
            background-color: #00a3cc;
            transform: translateY(-2px);
        }

        .no-messages {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }

        /* Estilos para los botones de acción */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .action-button {
            width: 100%;
            padding: 12px;
            background-color: #ff4757;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .action-button:hover {
            background-color: #ff6b81;
            transform: translateY(-2px);
        }

        /* Estilos para el modal de estadísticas */
        .modal {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
        }

        .modal-content {
            position: relative;
            background-color: rgba(0, 0, 0, 0.95);
            margin: 50px auto;
            padding: 20px;
            width: 80%;
            max-width: 1000px;
            border-radius: 8px;
            border: 1px solid #444;
            box-shadow: 0 0 20px rgba(0, 204, 255, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .modal-header h2 {
            color: #00ccff;
            margin: 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
        }

        .close-button {
            padding: 10px 20px !important;
            background-color: rgba(255, 71, 87, 0.8) !important;
            color: white !important;
            border: none !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-family: 'Orbitron', sans-serif !important;
            font-weight: bold !important;
            font-size: 14px !important;
            transition: all 0.3s ease !important;
        }

        .close-button:hover {
            background-color: rgba(255, 71, 87, 1) !important;
            color: white !important;
            transform: translateY(-1px) !important;
        }

        .modal-body {
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: 4px;
            padding: 20px;
            min-height: 600px;
        }

        /* Forzar visibilidad y z-index de los modales */
        #test-modal, .modal, .messages-modal {
            z-index: 3000 !important;
        }
        #test-modal[style*="display: block"], .modal[style*="display: block"] {
            display: block !important;
        }

        .pm-accept-btn {
            transition: background 0.2s, color 0.2s;
        }
    </style>
</head>
<body>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBVc1a4E4_y-YJZV5ZqFQzTr1T8Txe8TmQ",
            authDomain: "ultimatemercenary-1e212.firebaseapp.com",
            projectId: "ultimatemercenary-1e212",
            storageBucket: "ultimatemercenary-1e212.firebasestorage.app",
            messagingSenderId: "683730871364",
            appId: "1:683730871364:web:350aaf7a296ad34db28811",
            databaseURL: "https://ultimatemercenary-1e212-default-rtdb.firebaseio.com/"
        };
        
        // Inicializar Firebase (versión 8)
        if (!window.firebaseApp) {
            window.firebaseApp = firebase.initializeApp(firebaseConfig);
            window.database = firebase.database();
        }

        // Referencias
        const conocidosRef = window.database.ref('conocidosSeleccionados');
        const conocimientosRef = window.database.ref('conocimientosSeleccionados');
        const mensajesRef = window.database.ref('mensajes-directos');
        const currentTestRef = window.database.ref('currentTest');
        const nombresRef = window.database.ref('nombresConcursantes');
        const audienceRef = window.database.ref('audience');
        const ratingRef = window.database.ref('rating');
        const timeOfDayRef = window.database.ref('timeOfDay');
        const pmRef = window.database.ref('playerPM');
        const pmTransactionsRef = window.database.ref('pmTransactions');
        const chatRef = window.database.ref('mensajes-publico-expanded');

        // Listeners de sincronización
        conocidosRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localStorage.setItem('conocidosSeleccionados', JSON.stringify(data));
                if (window.renderTarjetasSeleccionadas) window.renderTarjetasSeleccionadas();
            }
        });
        conocimientosRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localStorage.setItem('conocimientosSeleccionados', JSON.stringify(data));
                if (window.renderTarjetasSeleccionadas) window.renderTarjetasSeleccionadas();
            }
        });
        mensajesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localStorage.setItem('mensajes-directos', JSON.stringify(data));
                if (window.loadDirectMessages) window.loadDirectMessages();
            }
        });
        currentTestRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localStorage.setItem('currentTest', data);
                if (window.updateObjective) window.updateObjective();
            }
        });
        nombresRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                Object.entries(data).forEach(([numero, nombre]) => {
                    localStorage.setItem(`nombreConcursante_${numero}`, nombre);
                });
                if (window.renderTarjetasSeleccionadas) window.renderTarjetasSeleccionadas();
            }
        });
        audienceRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data !== null) {
                localStorage.setItem('spectators', data);
                if (window.updateStatusPanel) window.updateStatusPanel();
                if (window.updateUserList) window.updateUserList();
            }
        });
        ratingRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data !== null) {
                localStorage.setItem('rating', data);
                if (window.updateStatusPanel) window.updateStatusPanel();
                if (window.updateUserList) window.updateUserList();
            }
        });
        
        // NUEVO: Listener para timeOfDay desde Firebase con debug mejorado
        console.log('🚀 [FIREBASE] Configurando listener para timeOfDay...');
        timeOfDayRef.on('value', (snapshot) => {
            const data = snapshot.val();
            const currentLocal = localStorage.getItem('timeOfDay');
            
            console.log('🔥 [FIREBASE LISTENER] timeOfDay Firebase Listener ACTIVADO!');
            console.log('🔥 [FIREBASE LISTENER] Datos de Firebase:', data);
            console.log('🔥 [FIREBASE LISTENER] localStorage actual:', currentLocal);
            
            if (data && (data === 'dia' || data === 'noche')) {
                const oldValue = localStorage.getItem('timeOfDay');
                localStorage.setItem('timeOfDay', data);
                
                console.log(`✅ [FIREBASE SYNC] timeOfDay FORZADO: ${oldValue} → ${data}`);
                console.log('🔄 [FIREBASE SYNC] localStorage después:', localStorage.getItem('timeOfDay'));
                
                // Refrescar mensajes contextuales si el sistema está disponible
                if (window.contextualSystem && typeof window.contextualSystem.refreshMessages === 'function') {
                    console.log('🔄 [FIREBASE SYNC] Refrescando mensajes contextuales...');
                    window.contextualSystem.refreshMessages();
                } else {
                    console.warn('⚠️ [FIREBASE SYNC] contextualSystem.refreshMessages no disponible');
                }
                
                // Forzar actualización de mensajes contextuales directamente
                if (typeof window.updateContextualSystem === 'function') {
                    console.log('🔄 [FIREBASE SYNC] Ejecutando updateContextualSystem...');
                    window.updateContextualSystem();
                }
                
                // Actualizar UI si hay funciones disponibles
                if (window.updateStatusPanel) window.updateStatusPanel();
                
                // Log final de confirmación
                console.log('🎯 [FIREBASE SYNC] SYNC COMPLETADO - Valor final:', localStorage.getItem('timeOfDay'));
            } else {
                console.warn('⚠️ [FIREBASE SYNC] timeOfDay inválido o null:', data);
                // Solo establecer por defecto si realmente no existe
                if (!localStorage.getItem('timeOfDay')) {
                    localStorage.setItem('timeOfDay', 'dia');
                    console.log('📍 [FIREBASE SYNC] Establecido timeOfDay por defecto: dia');
                }
            }
        });
        
        console.log('✅ [FIREBASE] Listener timeOfDay configurado completamente');
        
        // FORZAR LECTURA INICIAL DE FIREBASE para sincronizar inmediatamente
        timeOfDayRef.once('value').then((snapshot) => {
            const firebaseValue = snapshot.val();
            const localValue = localStorage.getItem('timeOfDay');
            
            console.log('🔍 [FIREBASE INIT] Lectura inicial forzada:');
            console.log('🔍 [FIREBASE INIT] Firebase tiene:', firebaseValue);
            console.log('🔍 [FIREBASE INIT] localStorage tiene:', localValue);
            
            if (firebaseValue && firebaseValue !== localValue) {
                console.log('🚨 [FIREBASE INIT] DESINCRONIZACIÓN DETECTADA - Forzando sync...');
                localStorage.setItem('timeOfDay', firebaseValue);
                
                // Forzar actualización inmediata del sistema contextual
                if (typeof window.updateContextualSystem === 'function') {
                    console.log('🔄 [FIREBASE INIT] Ejecutando updateContextualSystem inmediatamente...');
                    window.updateContextualSystem();
                }
                
                console.log('✅ [FIREBASE INIT] Sincronización forzada completada:', localStorage.getItem('timeOfDay'));
            } else {
                console.log('✅ [FIREBASE INIT] Valores ya sincronizados');
            }
        }).catch(error => {
            console.error('❌ [FIREBASE INIT] Error leyendo valor inicial:', error);
        });
        
        pmRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data !== null) {
                // Solo actualizar si no hay transacciones locales
                if (window.pmTransactions && window.pmTransactions.transactions && window.pmTransactions.transactions.length === 0) {
                    // Si es la primera vez, crear una transacción inicial
                    window.pmTransactions.addTransaction(data, 'PM inicial');
                }
            }
        });
        pmTransactionsRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localStorage.setItem('pmTransactions', JSON.stringify(data));
                if (window.pmTransactions) {
                    window.pmTransactions.updateUI();
                }
            }
        });
        chatRef.on('value', (snapshot) => {
            const data = snapshot.val();
            // Ensure data is an array, or provide an empty array if null/undefined
            // Firebase Realtime Database often returns objects for lists unless pushed with numeric keys.
            // If 'data' is an object of messages, convert to array.
            const messagesArray = Array.isArray(data) ? data : (data ? Object.values(data) : []);

            // Chat normal: simplemente guardar todos los mensajes sin filtrar
            localStorage.setItem('mensajes-publico-expanded', JSON.stringify(messagesArray));
            
            // Log detallado para debug
            console.log(`🔥 [FIREBASE LISTENER] Recibidos ${messagesArray.length} mensajes de Firebase`);
            console.log('🔥 [FIREBASE LISTENER] Últimos 3 mensajes:', messagesArray.slice(-3));
            
            // En la primera carga, establecer el timestamp al mensaje más reciente para evitar renderizar históricos
            if (window.lastProcessedTimestamp === 0 && messagesArray.length > 0) {
                const latestTimestamp = Math.max(...messagesArray.map(msg => msg.timestamp || 0));
                window.lastProcessedTimestamp = latestTimestamp;
                console.log('🔥 [FIREBASE LISTENER] Primera carga - timestamp inicial establecido a:', latestTimestamp);
                console.log('🔥 [FIREBASE LISTENER] Saltando renderizado inicial para evitar duplicar históricos');
                return; // No renderizar en la primera carga
            }
            
            if (window.renderGlobalChatMessages) {
                console.log('🔥 [FIREBASE LISTENER] Llamando renderGlobalChatMessages...');
                window.renderGlobalChatMessages(messagesArray);
                console.log('🔥 [FIREBASE LISTENER] ✅ renderGlobalChatMessages completado');
            } else {
                console.error('🔥 [FIREBASE LISTENER] ❌ renderGlobalChatMessages no disponible');
            }
        });
    </script>
    <div class="main-container">
        <!-- Video de fondo -->
        <video id="background-video" class="background-video" autoplay loop muted playsinline>
            <source src="https://www.dropbox.com/scl/fi/1josbstrlr7detymj71j9/Prueba0.mp4?rlkey=zphfprdpum4q58xz297r8h3k9&st=sbkz57tk&dl=1" type="video/mp4">
        </video>
        
        <!-- Contenedor de la interfaz -->
        <div class="ui-container">
            <!-- Barra superior -->
            <div class="top-bar">
                <div class="logo-container">
                    <img src="images/oce_logo.png" alt="OmniCorp Entertainment Logo" class="logo">
                                    <div class="title-container">
                    <h1>ULTIMATE MERCENARY 1.59</h1>
                        <h2>Concursante #13</h2>
                    </div>
                </div>
                <button class="logout-button" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> CERRAR SESIÓN
                </button>
            </div>
            
            <!-- Área principal -->
            <div class="main-area">
                <!-- Chat -->
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <!-- Los mensajes se añadirán dinámicamente -->
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chat-input" placeholder="Escribe un mensaje...">
                        <button class="chat-submit" id="chat-submit"><i class="fas fa-paper-plane"></i></button>
                        <button class="opacity-toggle" id="opacity-toggle" title="Alternar transparencia del chat">
                            <i class="fas fa-adjust"></i>
                        </button>
                        <button class="auto-scroll-toggle" id="auto-scroll-toggle" title="Activar/Desactivar auto scroll">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Panel lateral -->
                <div class="sidebar">
                    <!-- Estadísticas -->
                    <div class="sidebar-section">
                        <h3>ESTADÍSTICAS</h3>
                        <div class="stat-item">
                            <div class="stat-info">
                                <div class="stat-label">Audiencia</div>
                                <div class="stat-value" id="audience-value">0</div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-info">
                                <div class="stat-label">Rating</div>
                                <div class="stat-value" id="rating-value">0.0</div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-info">
                                <div class="stat-label">PM</div>
                                <div class="stat-value" id="pm-value">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones -->
                    <div class="sidebar-section" style="margin-top:auto; margin-bottom:auto;">
                        <h3>ACCIONES</h3>
                        <div class="action-buttons">
                            <button class="action-button" onclick="openShop()">TIENDA</button>
                            <button class="action-button" onclick="openMessages()">MENSAJES</button>
                            <button class="action-button" onclick="openObjective()">OBJETIVO</button>
                            <button class="action-button" onclick="openStats()">ESTADÍSTICAS</button>
                        </div>
                    </div>
                    
                    <!-- Objetivo actual -->
                    <div class="sidebar-section" style="margin-top:auto; flex-grow:1; min-height:200px;">
                        <h3>OBJETIVO ACTUAL</h3>
                        <div class="objective-display" id="current-objective" style="font-size:13px; padding:10px;">
                            <h4 id="objective-title" style="font-size:15px;">Cargando...</h4>
                            <p id="objective-description" style="font-size:13px;">Cargando objetivo...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal de Mensajes Directos -->
        <div id="messages-modal" class="messages-modal">
            <div class="messages-content">
                <h2>MENSAJES DIRECTOS</h2>
                            <div class="messages-tabs">
                <button class="tab-button active" data-tab="inbox">Bandeja de Entrada</button>
                <button class="tab-button" data-tab="system">Sistema</button>
                <button class="tab-button" data-tab="shop">Tienda</button>
                <button class="tab-button" data-tab="personal">Mensajes Personales</button>
            </div>
                <div id="messages-list" class="messages-list">
                    <!-- Los mensajes se añadirán dinámicamente -->
                </div>
                <button class="accept-btn" onclick="document.getElementById('messages-modal').style.display='none'">CERRAR</button>
            </div>
        </div>

        <!-- NEW Objective Modal - Ensure any old #test-modal is removed -->
        <div id="test-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.71); z-index: 5000;">
            <div style="background-color: #111; color: #fff; max-width: 900px; width: 95vw; min-width: 320px; margin: 40px auto; padding: 40px 40px 30px 40px; border: 2px solid #ff4757; border-radius: 12px; box-shadow: 0 0 40px 10px rgba(255,71,87,0.25); max-height: 90vh; display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 18px; margin-bottom: 18px; border-bottom: 1.5px solid #444;">
                    <h2 id="objective-modal-title" style="color: #ff4757; font-family: 'Orbitron', sans-serif; margin: 0; font-size: 28px; letter-spacing: 1px;">OBJETIVO</h2>
                    <button onclick="document.getElementById('test-modal').style.display='none'" style="background: #ff4757; color: white; border: none; padding: 10px 22px; border-radius: 4px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 16px;">CERRAR</button>
                </div>
                <div id="objective-modal-description" style="font-size: 18px; line-height: 1.7; flex: 1 1 auto; overflow-y: auto; max-height: 70vh;">
                    <!-- Descripción del objetivo -->
                </div>
            </div>
        </div>
        <!-- END OF NEW Objective Modal -->

        <div class="overlay" style="z-index:50;"></div>
    </div>

    <!-- Secciones de Conocidos y Conocimientos -->
    <div class="sheet-section">
        <h3>Conocidos</h3>
        <div id="conocidos-tarjetas" class="personajes-container"></div>
    </div>
    <div class="sheet-section">
        <h3>Conocimientos</h3>
        <div id="conocimientos-tarjetas" class="facciones-container"></div>
    </div>

    <script src="mensajes-publico-expanded.js"></script>
    <script>
    // Exponer funciones de UI globalmente para los listeners de Firebase
    if (typeof updateStatusPanel === 'function') window.updateStatusPanel = updateStatusPanel;
    if (typeof updateObjective === 'function') window.updateObjective = updateObjective;
    if (typeof loadChatMessages === 'function') window.loadChatMessages = loadChatMessages;
    if (typeof renderTarjetasSeleccionadas === 'function') window.renderTarjetasSeleccionadas = renderTarjetasSeleccionadas;
    if (typeof loadDirectMessages === 'function') window.loadDirectMessages = loadDirectMessages;
    if (typeof updateUserList === 'function') window.updateUserList = updateUserList;
    </script>
    <script>
    function logout() {
        // Solo elimina claves de login (ajusta los nombres si usas otros)
        localStorage.removeItem('user');
        localStorage.removeItem('sessionToken');
        sessionStorage.clear();
        document.cookie.split(';').forEach(function(c) {
            document.cookie = c.replace(/^ +/, '').replace(/=.*/, '=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/');
        });
        window.location.replace('login.html');
    }
    window.logout = logout;
    function openStats() {
        const statsWindow = document.createElement('div');
        statsWindow.className = 'modal';
        statsWindow.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ESTADÍSTICAS</h2>
                    <button class="close-button" onclick="this.parentElement.parentElement.parentElement.remove()">VOLVER</button>
                </div>
                <div class="modal-body">
                    <iframe src="character-sheet-modal.html" style="width: 100%; height: 600px; border: none;"></iframe>
                </div>
            </div>
        `;
        document.body.appendChild(statsWindow);
        window.fichaIframe = statsWindow.querySelector('iframe');
        
        // Esperar a que el iframe cargue
        window.fichaIframe.onload = function() {
            // Enviar el inventario actual
            window.fichaIframe.contentWindow.postMessage({
                type: 'updateInventory',
                items: window.inventory.getItems()
            }, '*');
        };
    }
    window.openStats = openStats;
    </script>
    <script>
    // --- MODALES Y FUNCIONES GLOBALES (openShop, openMessages, openObjective) ---
    function openShop() {
        console.log('[DEBUG] openShop called');
        const shopWindow = document.createElement('div');
        shopWindow.className = 'modal';
        shopWindow.style.zIndex = 3000;
        shopWindow.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2>TIENDA</h2>
                    <button class="close-button" onclick="this.parentElement.parentElement.parentElement.remove()">VOLVER</button>
                </div>
                <div class="modal-body">
                    <iframe src="tienda.html" style="width: 100%; height: 600px; border: none;"></iframe>
                </div>
            </div>
        `;
        document.body.appendChild(shopWindow);
        window.tiendaIframe = shopWindow.querySelector('iframe');
    }
    window.openShop = openShop;

    function openMessages() {
        document.getElementById('messages-modal').style.display = 'block';
        if (window.directMessages) {
            // Refrescar la vista para asegurar que se muestren todos los mensajes
            window.directMessages.loadMessages();
        } else if (window.loadDirectMessages) {
            window.loadDirectMessages();
        }
    }
    window.openMessages = openMessages;

    function openObjective() {
        console.log('[DEBUG] openObjective called');
        if (window.showObjectiveModal) window.showObjectiveModal();
    }
    window.openObjective = openObjective;

    // NEW showObjectiveModal function for the refactored modal
    function showObjectiveModal() {
        const currentTestKey = localStorage.getItem('currentTest') || 'prueba0';
        const modal = document.getElementById('test-modal');
        if (!modal) {
            console.error('Objective modal not found!');
            return;
        }
        fetch(`prueba${currentTestKey.replace('prueba','')}.html`)
            .then(res => res.text())
            .then(html => {
                // Usar DOMParser para extraer TODOS los bloques .narrative-section
                let content = '';
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const sections = doc.querySelectorAll('.narrative-section');
                if (sections.length > 0) {
                    content = Array.from(sections).map(s => s.outerHTML).join('');
                } else {
                    // Si no hay bloque narrativo, usar el primer <main> o <body>
                    const main = doc.querySelector('main');
                    if (main) content = main.innerHTML;
                    else if (doc.body) content = doc.body.innerHTML;
                }
                document.getElementById('objective-modal-description').innerHTML = content;
            })
            .catch(() => {
                document.getElementById('objective-modal-description').innerHTML = '<div style="color:#f55;">No se pudo cargar la información de la prueba.</div>';
            });
        modal.style.display = 'block';
    }
    window.showObjectiveModal = showObjectiveModal;

    // Exponer funciones de UI globalmente para los listeners de Firebase
    if (typeof updateStatusPanel === 'function') window.updateStatusPanel = updateStatusPanel;
    if (typeof updateObjective === 'function') window.updateObjective = updateObjective;
    if (typeof loadChatMessages === 'function') window.loadChatMessages = loadChatMessages;
    if (typeof renderTarjetasSeleccionadas === 'function') window.renderTarjetasSeleccionadas = renderTarjetasSeleccionadas;
    if (typeof loadDirectMessages === 'function') window.loadDirectMessages = loadDirectMessages;
    if (typeof updateUserList === 'function') window.updateUserList = updateUserList;
    </script>
    <script>
    // Actualiza los valores de audiencia, rating y PM en el panel lateral
    function updateStatusPanel() {
        const audience = localStorage.getItem('spectators') || '0';
        const rating = localStorage.getItem('rating') || '0.0';
        const pm = localStorage.getItem('playerPM') || '0';
        if (document.getElementById('audience-value')) document.getElementById('audience-value').textContent = audience;
        if (document.getElementById('rating-value')) document.getElementById('rating-value').textContent = rating;
        if (document.getElementById('pm-value')) document.getElementById('pm-value').textContent = pm;
    }
    window.updateStatusPanel = updateStatusPanel;

    // Actualiza el objetivo actual en la barra lateral
    function updateObjective() {
        const testObjectives = {
            'prueba0': {
                title: 'Prueba 0: La Caída',
                desc: 'Supervivencia inicial en el hangar subterráneo. Los concursantes deben adaptarse al entorno, familiarizarse con el equipo básico y demostrar su capacidad para sobrevivir en condiciones adversas.'
            },
            'prueba1': {
                title: 'Prueba 1: Carrera de Obstáculos',
                desc: 'Completar la carrera de obstáculos industrial. Los concursantes deben superar una serie de desafíos físicos y mentales, demostrando su agilidad, resistencia y capacidad de adaptación.'
            },
            'prueba2': {
                title: 'Prueba 2: La Cosecha',
                desc: 'Recolectar plantas y materiales valiosos del Jardín Vertical. Los concursantes deben identificar, recolectar y preservar especímenes raros y peligrosos, demostrando su conocimiento y precisión.'
            },
            'prueba3': {
                title: 'Prueba 3: La Entrega',
                desc: 'Realizar entregas de paquetes en el distrito industrial. Los concursantes deben transportar cargamentos valiosos a través de zonas peligrosas, demostrando su sigilo y eficiencia.'
            }
        };

        // URLs de videos para cada prueba
        const testVideos = {
            'prueba0': 'https://www.dropbox.com/scl/fi/1josbstrlr7detymj71j9/Prueba0.mp4?rlkey=zphfprdpum4q58xz297r8h3k9&st=sbkz57tk&dl=1',
            'prueba1': 'https://www.dropbox.com/scl/fi/xlzx7txd7t258lao7h8ap/Prueba1.mp4?rlkey=uqwx6cffrab7mij8orywmxvv2&st=hkah83c2&dl=1',
            'prueba2': 'https://www.dropbox.com/scl/fi/1josbstrlr7detymj71j9/Prueba0.mp4?rlkey=zphfprdpum4q58xz297r8h3k9&st=sbkz57tk&dl=1', // Fallback hasta que tengas Prueba2.mp4
            'prueba3': 'https://www.dropbox.com/scl/fi/1josbstrlr7detymj71j9/Prueba0.mp4?rlkey=zphfprdpum4q58xz297r8h3k9&st=sbkz57tk&dl=1'  // Fallback hasta que tengas Prueba3.mp4
        };

        const currentTest = localStorage.getItem('currentTest') || 'prueba0';
        const obj = testObjectives[currentTest] || testObjectives['prueba0'];
        
        // Actualizar barra lateral
        if (document.getElementById('objective-title')) document.getElementById('objective-title').textContent = obj.title;
        if (document.getElementById('objective-description')) document.getElementById('objective-description').textContent = obj.desc;
        
        // Actualizar video de fondo
        const backgroundVideo = document.getElementById('background-video');
        const videoSource = backgroundVideo ? backgroundVideo.querySelector('source') : null;
        if (videoSource) {
            const newVideoUrl = testVideos[currentTest] || testVideos['prueba0'];
            if (videoSource.src !== newVideoUrl) {
                videoSource.src = newVideoUrl;
                backgroundVideo.load(); // Recargar el video con la nueva fuente
                console.log(`[Video Update] Cambiando video de fondo a ${currentTest}: ${newVideoUrl}`);
            }
        }
        
        // Eliminar imagen si existe
        const imgElem = document.getElementById('objective-image');
        if (imgElem && imgElem.parentNode) imgElem.parentNode.removeChild(imgElem);
    }
    window.updateObjective = updateObjective;

    // Refuerza la carga de mensajes de ejemplo en el chat si no hay mensajes reales
    window.loadChatMessages = function() {
        let mensajes = [];
        try {
            mensajes = JSON.parse(localStorage.getItem('mensajes-publico-expanded') || '[]');
            if (!Array.isArray(mensajes)) mensajes = [];
        } catch (e) {
            mensajes = [];
        }
        const chat = document.getElementById('chat-messages');
        if (!chat) return;
        if (!mensajes || mensajes.length === 0) {
            // Mensajes de ejemplo locales si el chat está vacío
            const nombresUsuarios = [
                "Neo_Kyoto_Fan42", "SamuraiStalker", "EdgerunnerGirl", "MercenaryCrazy", 
                "BloodMoney99", "ChromeHeart", "WiredNinja", "NeonShadow",
                "CyberSlice", "DeathMatch_Lover", "KatanaQueen", "StreetHunter22"
            ];
            const ejemplos = [
                "¡Vamos XIII, no decepciones a tus fans!",
                "¡Estoy apostando todo por ti, no me falles!",
                "Mira esos reflejos, ¡eres una máquina!",
                "Mi IA predictiva dice que no llegarás a la siguiente ronda, XIII...",
                "Acabo de apostar 5000 créditos a que sobrevives esta prueba",
                "OCE debería ponerte un reto REAL, XIII",
                "Ese cromo que llevas parece de segunda mano...",
                "¡Eres mi favorita desde el principio!",
                "Solo las débiles usan tanto equipo. Demuestra tu valor real.",
                "Por dios, alguien dé algo de equipo decente a la XIII",
                "¡Actúa como si tuvieras múltiples personalidades por 12 horas! ¡+70 PM!",
                "¡Marca territorios con sangre como un animal y defiéndelos a muerte! ¡+80 PM!"
            ];
            const ejemploMensajes = Array.from({length: 10}).map((_,i) => ({
                sender: nombresUsuarios[i % nombresUsuarios.length],
                content: ejemplos[i % ejemplos.length],
                time: new Date().toLocaleTimeString()
            }));
            chat.innerHTML = ejemploMensajes.map(msg =>
                `<div class=\"chat-message\"><span class="username">${msg.sender}:</span> <span class="content">${msg.content}</span> <span style="float:right;font-size:11px;color:#888;\">${msg.time}</span></div>`
            ).join('') + '<div style="color:#888;font-size:13px;">(Mensajes de ejemplo: el chat global está vacío)</div>';
        } else {
            chat.innerHTML = mensajes.map(msg => {
                // Compatibilidad flexible
                const sender = msg.sender || msg.user || 'SISTEMA';
                const content = msg.content || msg.text || '';
                const time = msg.time || '';
                return `<div class=\"chat-message\"><span class="username">${sender}:</span> <span class="content">${content}</span> <span style="float:right;font-size:11px;color:#888;\">${time}</span></div>`;
            }).join('');
        }
        chat.scrollTop = chat.scrollHeight;
    };
    </script>
    <script>
    // Llama a las funciones al cargar la página para inicializar la UI
    updateStatusPanel();
    updateObjective();
    renderTarjetasSeleccionadas();
    loadDirectMessages();
    </script>

    <!-- NEW CONSOLIDATED CHAT SYSTEM SCRIPT -->
    <script>
        // --- CHAT ROBUSTO Y GLOBAL ---
        let autoMsgInterval;
        let autoScrollEnabled = true;
        function limpiarMensajesJugadorDOM() {
            // Elimina del DOM todos los mensajes del jugador
            const chatMessagesContainer = document.getElementById('chat-messages');
            if (!chatMessagesContainer) return;
            const mensajes = chatMessagesContainer.querySelectorAll('.chat-message');
            mensajes.forEach(msg => {
                const username = msg.querySelector('.username');
                if (username && username.textContent.trim().startsWith('XIII')) {
                    chatMessagesContainer.removeChild(msg);
                }
            });
        }
        
        function limpiarMensajesAdminDOM() {
            // FUNCIÓN DESHABILITADA - Ya no eliminamos mensajes del admin para permitir sincronización
            console.log('⚠️ limpiarMensajesAdminDOM deshabilitada - mensajes del admin ahora se sincronizan');
            return;
        }
        
        function limpiarChatJugador() {
            // Borra solo los mensajes del jugador de localStorage y del DOM
            localStorage.removeItem('mensajes-jugador-sesion');
            limpiarMensajesJugadorDOM();
        }
        
        function limpiarChatCompleto() {
            // Solo limpia mensajes del jugador, NO del admin para permitir sincronización
            localStorage.removeItem('mensajes-jugador-sesion');
            limpiarMensajesJugadorDOM();
            console.log('🧹 Chat limpiado (solo mensajes del jugador) - mensajes del admin se mantienen para sincronización');
        }
        
        function limpiarChatDOMCompleto() {
            // Limpia todo el chat del DOM
            const chatMessagesContainer = document.getElementById('chat-messages');
            if (chatMessagesContainer) chatMessagesContainer.innerHTML = '';
        }
        function agregarMensajeAlChatDisplay(msgData, msgId) {
            const chatMessagesContainer = document.getElementById('chat-messages');
            if (!chatMessagesContainer) return;
            const div = document.createElement('div');
            // Colores de nicks
            let userColor = '#cccccc';
            let tag = '';
            let tagLabel = '';
            let tagStyle = '';
            // Tags immersivos posibles
            const tagsImmersivos = [
                {label: 'VIP', style: 'background:#ffd700;color:#222;border:1px solid #ffd700;'},
                {label: 'PATROCINADO', style: 'background:#ff4757;color:#fff;border:1px solid #ff4757;'},
                {label: 'FAN', style: 'background:#70a1ff;color:#fff;border:1px solid #70a1ff;'},
                {label: 'SPONSOR', style: 'background:#2ed573;color:#fff;border:1px solid #2ed573;'},
                {label: 'INFLUENCER', style: 'background:#eccc68;color:#222;border:1px solid #eccc68;'},
                {label: 'EXPERTO', style: 'background:#5352ed;color:#fff;border:1px solid #5352ed;'}
            ];
            if (msgData.tagImmersivo) {
                tagLabel = msgData.tagImmersivo;
                const found = tagsImmersivos.find(t => t.label === tagLabel);
                tagStyle = found ? found.style : tagsImmersivos[0].style;
            } else if (msgData.automatico && msgData.showTag) {
                // Solo si showTag está en true
                const tagObj = tagsImmersivos[Math.floor(Math.random() * tagsImmersivos.length)];
                tagLabel = tagObj.label;
                tagStyle = tagObj.style;
            }
            if (tagLabel) {
                tag = `<span class=\"tag\" style=\"${tagStyle}margin-left:7px;font-size:10px;padding:2px 6px;border-radius:3px;\">${tagLabel}</span>`;
            }
            if (msgData.usuario === 'XIII') {
                userColor = '#00ccff';
            } else if (msgData.usuario === 'Kaiser') {
                userColor = '#ff4757';
            } else if (msgData.automatico) {
                userColor = msgData.color || '#ffd700';
            } else {
                userColor = msgData.color || '#cccccc';
            }
            // Mensaje destacado si es PM o tiene tag especial
            const pmValue = (msgData.mensaje||'').match(/([+][0-9]+)\s*PM/) ? parseInt((msgData.mensaje.match(/([+][0-9]+)\s*PM/)||[])[1].replace('+','')) : null;
            if (pmValue || tagLabel) div.classList.add('destacado');
            div.className += ' chat-message';
            
            // Resaltar "XIII" o "#13" en el contenido del mensaje
            let mensajeContent = msgData.mensaje || '';
            mensajeContent = mensajeContent.replace(/(XIII|#13)/gi, '<span style="color:#ffd700;font-weight:bold;">$1</span>');
            
            div.innerHTML = `
                <span class=\"username\" style=\"color:${userColor};font-weight:bold;\">${msgData.usuario || 'Anónimo'}:${tag}</span>
                <span class=\"content\">${mensajeContent}</span>
                <span style=\"float:right;font-size:11px;color:#888;\">${msgData.hora || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</span>
            `;
            if (pmValue) {
                const btn = document.createElement('button');
                btn.textContent = `Aceptar +${pmValue} PM`;
                btn.className = 'pm-accept-btn';
                Object.assign(btn.style, {
                    marginLeft: '10px', fontSize: '12px', background: '#222', color: '#2ed573',
                    border: '1px solid #2ed573', borderRadius: '4px', cursor: 'pointer', transition: 'all 0.3s ease'
                });
                let pmButtonStates = JSON.parse(sessionStorage.getItem('pmSumadosParaBotones') || '{}');
                if (pmButtonStates[msgId]) {
                    btn.textContent = 'Aceptado';
                    btn.disabled = true;
                    Object.assign(btn.style, { background: '#444', color: '#aaa', cursor: 'default' });
                } else {
                    btn.onclick = function() {
                        window.sumarPM(pmValue, `PM de chat: ${msgData.mensaje}`);
                        pmButtonStates[msgId] = true;
                        sessionStorage.setItem('pmSumadosParaBotones', JSON.stringify(pmButtonStates));
                        btn.textContent = 'Aceptado';
                        btn.disabled = true;
                        Object.assign(btn.style, { background: '#444', color: '#aaa', cursor: 'default' });
                        
                        // Enviar mensaje al buzón de correo
                        if (window.directMessages) {
                            window.directMessages.addChallengeAcceptedMessage(
                                msgData.usuario || 'Usuario Anónimo',
                                msgData.mensaje || 'Reto sin descripción'
                            );
                        }
                    };
                }
                div.appendChild(btn);
            }
            chatMessagesContainer.appendChild(div);
            setTimeout(() => div.style.opacity = '1', 50);
            
            // Solo hacer scroll automático si está habilitado
            if (autoScrollEnabled) {
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            }
        }
        window.agregarMensajeAlChatDisplay = agregarMensajeAlChatDisplay;
        function startAutoMessages() {
            if (autoMsgInterval) clearInterval(autoMsgInterval);
            
            console.log('🔄 Iniciando mensajes automáticos v1.0 - SISTEMA COMPLETO');
            
            const coloresAuto = [
                '#ffb347', '#7bed9f', '#70a1ff', '#eccc68', '#ffa502', '#2ed573', '#1e90ff', '#ff6b81', '#5352ed', '#f1c40f', '#00b894', '#fdcb6e'
            ];
            
            let autoMsgIndex = 0;
            
            autoMsgInterval = setInterval(() => {
                let mensajesContextuales = [];
                let nombresContextuales = [];
                let usingContextual = false;
                
                // FORZAR inicialización del sistema contextual si no está disponible
                if (!window.getCurrentContextualMessages || !window.getContextualUsernames) {
                    console.log('🔄 Forzando inicialización del sistema contextual...');
                    
                    // Forzar actualización del sistema
                    if (window.updateContextualSystem) {
                        window.updateContextualSystem();
                    }
                    
                    // Esperar un poco más para la siguiente verificación
                    console.warn('⚠️ Sistema contextual no disponible, intentando inicializar...');
                    return;
                }
                
                // OBTENER mensajes contextuales configurados
                try {
                    mensajesContextuales = window.getCurrentContextualMessages();
                    nombresContextuales = window.getContextualUsernames();
                    
                    if (mensajesContextuales.length > 0 && nombresContextuales.length > 0) {
                        usingContextual = true;
                        console.log(`✅ Usando ${mensajesContextuales.length} mensajes contextuales configurados`);
                    } else {
                        console.error('❌ Sistema contextual devuelve arrays vacíos:', {
                            mensajes: mensajesContextuales.length,
                            usuarios: nombresContextuales.length,
                            contexto: {
                                prueba: localStorage.getItem('currentTest'),
                                momento: localStorage.getItem('timeOfDay'),
                                rating: localStorage.getItem('rating')
                            }
                        });
                        
                        // Intentar forzar actualización del contexto
                        if (window.updateContextualSystem) {
                            window.updateContextualSystem();
                        }
                        return; // Intentar en la siguiente iteración
                    }
                } catch (error) {
                    console.error('❌ Error obteniendo mensajes contextuales:', error);
                    
                    // Intentar forzar actualización del contexto
                    if (window.updateContextualSystem) {
                        window.updateContextualSystem();
                    }
                    return; // Intentar en la siguiente iteración
                }
                
                // Seleccionar mensaje aleatorio de los configurados
                const mensajeAleatorio = mensajesContextuales[Math.floor(Math.random() * mensajesContextuales.length)];
                const usuarioAleatorio = nombresContextuales[Math.floor(Math.random() * nombresContextuales.length)];
                
                // Tag immersivo solo en 1 de cada 4 (más frecuente)
                const showTag = (autoMsgIndex % 4 === 0);
                let tagImmersivo = undefined;
                if (showTag) {
                    const tagsImmersivos = ["VIP","PATROCINADO","FAN","SPONSOR","INFLUENCER","EXPERTO"];
                    tagImmersivo = tagsImmersivos[Math.floor(Math.random()*tagsImmersivos.length)];
                }
                
                const msg = {
                    usuario: usuarioAleatorio,
                    mensaje: mensajeAleatorio,
                    color: coloresAuto[autoMsgIndex % coloresAuto.length],
                    hora: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
                    automatico: true,
                    showTag,
                    tagImmersivo,
                    contextual: true // Siempre contextual en v0.97
                };
                const msgId = `auto-contextual-${autoMsgIndex}`;
                agregarMensajeAlChatDisplay(msg, msgId);
                autoMsgIndex++;
                
                console.log(`📨 [CONTEXTUAL] "${mensajeAleatorio.substring(0, 50)}..."`);
            }, 3500);
        }
        
        // Función para actualizar mensajes automáticos con nuevo contexto
        window.updateAutoMessages = function() {
            console.log('🔄 Actualizando mensajes automáticos con nuevo contexto');
            if (autoMsgInterval) {
                clearInterval(autoMsgInterval);
                startAutoMessages(); // Reiniciar con nuevos mensajes
            }
        };
        function initChatSystem() {
            // Al cargar la página, limpiar mensajes del jugador Y del admin
            limpiarChatCompleto();
            
            // Limpiar mensajes del admin periódicamente
            setInterval(() => {
                const chatContainer = document.getElementById('chat-messages');
                if (chatContainer) {
                    const mensajes = chatContainer.querySelectorAll('.chat-message');
                    mensajes.forEach(msg => {
                        const username = msg.querySelector('.username');
                        if (username) {
                            const usernameText = username.textContent.trim().toLowerCase();
                            // Detección amplia de mensajes admin
                            if (usernameText.includes('kaiser') || 
                                usernameText.includes('director') || 
                                usernameText.includes('sistema') ||
                                usernameText.includes('oce') ||
                                usernameText.includes('admin') ||
                                usernameText.includes('control') ||
                                usernameText.includes('panel')) {
                                try {
                                    chatContainer.removeChild(msg);
                                    console.log(`🗑️ [Auto-limpieza] Eliminado mensaje admin: ${usernameText}`);
                                } catch (e) {
                                    // Error silencioso
                                }
                            }
                        }
                    });
                }
            }, 2000); // Cada 2 segundos
            
            // Iniciar mensajes automáticos
            startAutoMessages();
            // NO renderizar mensajes del jugador guardados en la sesión anterior
            const chatInput = document.getElementById('chat-input');
            const chatSubmitBtn = document.getElementById('chat-submit');
            window.enviarMensajeJugador = function() {
                const text = chatInput.value.trim();
                if (!text) return;
                
                const playerMsg = {
                    sender: 'XIII',  // Cambio para consistencia con Firebase
                    content: text,   // Cambio para consistencia con Firebase
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
                    timestamp: Date.now(),
                    isPlayerMessage: true // Marca para identificar mensajes del jugador
                };
                
                // Chat normal: simplemente añadir el mensaje al final
                try {
                    const existingMessages = JSON.parse(localStorage.getItem('mensajes-publico-expanded') || '[]');
                    
                    // Añadir el nuevo mensaje al final cronológicamente
                    existingMessages.push(playerMsg);
                    
                    localStorage.setItem('mensajes-publico-expanded', JSON.stringify(existingMessages));
                    
                    console.log('🎮 JUGADOR ENVIANDO A FIREBASE - Total mensajes:', existingMessages.length);
                    console.log('🎮 Mensaje del jugador:', playerMsg);
                    
                    // Sincronizar con Firebase
                    if (window.saveChat) {
                        window.saveChat(existingMessages);
                        console.log('✅ Mensaje del jugador enviado a Firebase correctamente');
                    } else {
                        console.error('❌ window.saveChat no disponible para jugador');
                    }
                } catch (error) {
                    console.error('❌ Error guardando mensaje del jugador:', error);
                }
                
                chatInput.value = '';
            };
            chatSubmitBtn.onclick = window.enviarMensajeJugador;
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    window.enviarMensajeJugador();
                }
            });

            // Configurar botón de opacidad
            const opacityToggleBtn = document.getElementById('opacity-toggle');
            if (opacityToggleBtn) {
                opacityToggleBtn.onclick = function() {
                    const chatContainer = document.querySelector('.chat-container');
                    if (chatContainer) {
                        chatContainer.classList.toggle('transparent');
                        if (chatContainer.classList.contains('transparent')) {
                            opacityToggleBtn.title = 'Restaurar opacidad del chat';
                        } else {
                            opacityToggleBtn.title = 'Reducir opacidad del chat';
                        }
                    }
                };
            }

            // Configurar botón de auto scroll
            const autoScrollBtn = document.getElementById('auto-scroll-toggle');
            if (autoScrollBtn) {
                autoScrollBtn.onclick = function() {
                    autoScrollEnabled = !autoScrollEnabled;
                    if (autoScrollEnabled) {
                        autoScrollBtn.classList.remove('disabled');
                        autoScrollBtn.title = 'Desactivar auto scroll';
                        // Hacer scroll inmediato al reactivar
                        const chatContainer = document.getElementById('chat-messages');
                        if (chatContainer) {
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                        }
                    } else {
                        autoScrollBtn.classList.add('disabled');
                        autoScrollBtn.title = 'Activar auto scroll';
                    }
                };
            }
            // Variable global para rastrear el último timestamp procesado
            window.lastProcessedTimestamp = 0;
            
            window.renderGlobalChatMessages = function(messagesArray) {
                const chatContainer = document.getElementById('chat-messages');
                if (!chatContainer) return;
                
                console.log('📨 [RENDER] Analizando mensajes para renderizar...');
                console.log('📨 [RENDER] Último timestamp procesado:', window.lastProcessedTimestamp);
                
                // Solo procesar mensajes NUEVOS que no hemos renderizado antes
                const newMessages = messagesArray.filter(msg => {
                    const timestamp = msg.timestamp || 0;
                    return timestamp > window.lastProcessedTimestamp;
                });
                
                console.log('📨 [RENDER] Mensajes nuevos encontrados:', newMessages.length);
                
                if (newMessages.length === 0) {
                    console.log('📨 [RENDER] No hay mensajes nuevos que renderizar');
                    return;
                }
                
                // Renderizar solo los mensajes nuevos
                newMessages.forEach((msg, index) => {
                    const sender = (msg.sender || '').trim().toLowerCase();
                    const timestamp = msg.timestamp || Date.now();
                    
                    // Configurar color según el tipo de mensaje
                    let color = '#cccccc';
                    if (msg.isPlayerMessage || sender === 'xiii') {
                        color = '#00ccff'; // Color azul para mensajes del jugador
                    }
                    
                    // Generar ID único
                    const msgId = `msg-${timestamp}`;
                    
                    // Añadir el mensaje al chat
                    agregarMensajeAlChatDisplay({
                        usuario: msg.sender,
                        mensaje: msg.content,
                        hora: msg.time,
                        color: color,
                        esReto: !!((msg.content||'').match(/([+][0-9]+)\s*PM/))
                    }, msgId);
                    
                    console.log('📨 [RENDER] ✅ Mensaje nuevo añadido:', msg.sender, '-', msg.content.substring(0, 30));
                    
                    // Actualizar el último timestamp procesado
                    if (timestamp > window.lastProcessedTimestamp) {
                        window.lastProcessedTimestamp = timestamp;
                    }
                });
                
                console.log('📨 [RENDER] Último timestamp actualizado a:', window.lastProcessedTimestamp);
            };
            // Limpieza total al hacer logout
            window.logout = function() {
                limpiarChatCompleto();
                localStorage.removeItem('user');
                localStorage.removeItem('sessionToken');
                sessionStorage.clear();
                document.cookie.split(';').forEach(function(c) {
                    document.cookie = c.replace(/^ +/, '').replace(/=.*/, '=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/');
                });
                window.location.replace('login.html');
            };
            window.addEventListener('beforeunload', limpiarChatCompleto);
        }
        document.addEventListener('DOMContentLoaded', function() {
            limpiarChatDOMCompleto(); // Limpia todo el chat antes de inicializar
            initChatSystem();
        });
        window.addEventListener('beforeunload', limpiarChatCompleto);
    </script>

    <!-- Funciones de utilidad para la consola -->
    <script>
    // NUEVA v1.1: Función para forzar limpieza agresiva del admin
    window.forzarLimpiezaAgresiva = function() {
        console.log('💥 Forzando limpieza agresiva de mensajes del admin...');
        
        // Limpiar localStorage
        const mensajesFirebase = localStorage.getItem('mensajes-publico-expanded');
        if (mensajesFirebase) {
            try {
                const mensajes = JSON.parse(mensajesFirebase);
                const mensajesFiltrados = mensajes.filter(msg => {
                    const sender = (msg.sender || msg.user || '').trim().toLowerCase();
                    return !(sender.includes('kaiser') || 
                            sender.includes('director') || 
                            sender.includes('sistema') ||
                            sender.includes('oce') ||
                            sender.includes('admin') ||
                            sender.includes('control') ||
                            sender.includes('panel'));
                });
                localStorage.setItem('mensajes-publico-expanded', JSON.stringify(mensajesFiltrados));
                if (window.saveChat) window.saveChat(mensajesFiltrados);
                console.log(`🗑️ Eliminados ${mensajes.length - mensajesFiltrados.length} mensajes del localStorage`);
            } catch (e) {
                console.error('❌ Error limpiando localStorage:', e);
            }
        }
        
        // Limpiar DOM múltiples veces
        for (let i = 0; i < 3; i++) {
            setTimeout(() => {
                const chatContainer = document.getElementById('chat-messages');
                if (chatContainer) {
                    const mensajes = chatContainer.querySelectorAll('.chat-message');
                    let eliminados = 0;
                    mensajes.forEach(msg => {
                        const username = msg.querySelector('.username');
                        if (username) {
                            const usernameText = username.textContent.trim().toLowerCase();
                            if (usernameText.includes('kaiser') || 
                                usernameText.includes('director') || 
                                usernameText.includes('sistema') ||
                                usernameText.includes('oce') ||
                                usernameText.includes('admin') ||
                                usernameText.includes('control') ||
                                usernameText.includes('panel')) {
                                try {
                                    chatContainer.removeChild(msg);
                                    eliminados++;
                                } catch (e) {}
                            }
                        }
                    });
                    if (eliminados > 0) {
                        console.log(`🗑️ Pasada ${i+1}: Eliminados ${eliminados} mensajes del DOM`);
                    }
                }
            }, i * 200);
        }
        
        return 'Limpieza agresiva completada. Revisa la consola para detalles.';
    };

    // NUEVA v1.1: Función para eliminar mensajes específicos
    window.eliminarMensajesEspecificos = function() {
        console.log('🎯 Eliminando mensajes específicos problemáticos...');
        
        const chatContainer = document.getElementById('chat-messages');
        if (!chatContainer) {
            console.error('❌ Contenedor de chat no encontrado');
            return 'Error: Contenedor no encontrado';
        }
        
        const mensajes = chatContainer.querySelectorAll('.chat-message');
        let eliminados = 0;
        
        mensajes.forEach(msg => {
            const username = msg.querySelector('.username');
            const content = msg.querySelector('.content');
            
            if (username && content) {
                const usernameText = username.textContent.trim().toLowerCase();
                const contentText = content.textContent.trim().toLowerCase();
                
                // Eliminar mensajes específicos problemáticos
                if ((usernameText.includes('mercenarycrazy') && 
                     (contentText.includes('sí') || contentText.includes('entonces sí o no') || contentText.includes('80 pm'))) ||
                    (usernameText.includes('troll') && 
                     (contentText.includes('jsjajjajajajajfqfafjsfa') || contentText.includes('kek')))) {
                    
                    try {
                        chatContainer.removeChild(msg);
                        eliminados++;
                        console.log(`🗑️ Eliminado mensaje específico: ${usernameText} - ${contentText.substring(0, 30)}...`);
                    } catch (e) {
                        console.warn('⚠️ Error eliminando mensaje específico:', e);
                    }
                }
            }
        });
        
        console.log(`✅ Eliminados ${eliminados} mensajes específicos`);
        return `Eliminados ${eliminados} mensajes específicos`;
    };

    // NUEVA v1.1: Función nuclear - eliminar TODOS los mensajes
    window.limpiarChatCompleto = function() {
        console.log('💥 LIMPIEZA NUCLEAR - Eliminando TODOS los mensajes...');
        
        // Limpiar localStorage completamente
        localStorage.removeItem('mensajes-publico-expanded');
        console.log('🗑️ localStorage limpiado');
        
        // Limpiar Firebase
        if (window.saveChat) {
            window.saveChat([]);
            console.log('🗑️ Firebase limpiado');
        }
        
        // Limpiar DOM completamente
        const chatContainer = document.getElementById('chat-messages');
        if (chatContainer) {
            const mensajesAntes = chatContainer.querySelectorAll('.chat-message').length;
            chatContainer.innerHTML = '';
            console.log(`🗑️ DOM limpiado - Eliminados ${mensajesAntes} mensajes`);
        }
        
        console.log('✅ LIMPIEZA NUCLEAR COMPLETADA');
        return 'Todos los mensajes eliminados. El chat está completamente limpio.';
    };

    // DESHABILITADO: Auto-limpieza de Firebase - ahora se sincronizan todos los mensajes
    // setInterval deshabilitado para permitir sincronización completa de mensajes del admin
    console.log('⚠️ Auto-limpieza de Firebase deshabilitada para permitir sincronización completa');
    
    window.borrarMensajesJugadorFirebase = function() {
        if (!window.firebase || !window.saveChat) {
            alert('Firebase no está disponible.');
            return;
        }
        const mensajes = JSON.parse(localStorage.getItem('mensajes-publico-expanded') || '[]');
        const filtrados = mensajes.filter(msg => {
            if (!msg.sender) return true;
            const sender = msg.sender.trim().toLowerCase();
            return sender !== 'tú';
        });
        window.saveChat(filtrados);
        alert('Mensajes del jugador eliminados de Firebase (puede tardar unos segundos en reflejarse).');
    };

    // v0.96: Función para limpiar chat y reiniciar sistema híbrido
    window.limpiarChatYForzarContextual = function() {
        console.log('🧹 Limpiando chat y reiniciando sistema híbrido v0.96...');
        
        // Limpiar chat local y Firebase
        localStorage.removeItem('mensajes-publico-expanded');
        if (window.saveChat) window.saveChat([]);
        
        // Limpiar el DOM
        const chatContainer = document.getElementById('chat-messages');
        if (chatContainer) chatContainer.innerHTML = '';
        
                    // Reiniciar mensajes automáticos (contextual + fallback)
            if (window.updateAutoMessages) {
                window.updateAutoMessages();
            }
            
            console.log('✅ Chat limpiado - Sistema híbrido reiniciado (contextual + fallback temático)');
            alert('Chat limpiado. El sistema usará mensajes contextuales si están disponibles, o fallback temático para XIII.');
        };

        // NUEVA v1.0: Función para probar el sistema de atributos
        window.probarSistemaAtributos = function() {
            console.log('🧪 Probando sistema de atributos v1.0...');
            
            if (window.fichaIframe && window.fichaIframe.contentWindow) {
                const iframe = window.fichaIframe.contentWindow;
                
                // Enviar comando de prueba al iframe
                iframe.postMessage({
                    type: 'testAttributeSystem'
                }, '*');
                
                console.log('📤 Comando de prueba enviado al iframe de la ficha');
            } else {
                console.warn('⚠️ Iframe de ficha no disponible. Abre las estadísticas primero.');
                alert('Abre el panel de "Estadísticas" primero, luego ejecuta esta función.');
            }
        };

        // NUEVA v1.1: Función para probar sistema de limpieza de chat
        window.probarLimpiezaChat = function() {
            console.log('🧹 Probando sistema de limpieza de chat v1.1 (mejorado)...');
            
            // Mostrar estado actual
            const chatContainer = document.getElementById('chat-messages');
            if (chatContainer) {
                const mensajes = chatContainer.querySelectorAll('.chat-message');
                console.log(`📊 Mensajes actuales: ${mensajes.length}`);
                
                // Analizar todos los mensajes en detalle
                let jugador = 0, admin = 0, otros = 0;
                const adminMensajes = [];
                const jugadorMensajes = [];
                const otrosMensajes = [];
                
                mensajes.forEach((msg, index) => {
                    const username = msg.querySelector('.username');
                    if (username) {
                        const usernameText = username.textContent.trim();
                        const cleanUsername = usernameText.replace(':', '').trim();
                        
                        if (cleanUsername.startsWith('XIII')) {
                            jugador++;
                            jugadorMensajes.push(cleanUsername);
                        } else if (cleanUsername.startsWith('Kaiser') || 
                                   cleanUsername.startsWith('Director') || 
                                   cleanUsername.startsWith('SISTEMA') ||
                                   cleanUsername.startsWith('OCE') ||
                                   cleanUsername.includes('Admin') ||
                                   cleanUsername === 'Kaiser' ||
                                   cleanUsername === 'Director Kaiser' ||
                                   cleanUsername === 'SISTEMA OCE') {
                            admin++;
                            adminMensajes.push(cleanUsername);
                        } else {
                            otros++;
                            otrosMensajes.push(cleanUsername);
                        }
                    }
                });
                
                console.log(`👤 Mensajes del jugador (XIII): ${jugador}`);
                if (jugadorMensajes.length > 0) {
                    console.log('   📝 Usuarios del jugador:', [...new Set(jugadorMensajes)]);
                }
                
                console.log(`🔧 Mensajes del admin: ${admin}`);
                if (adminMensajes.length > 0) {
                    console.log('   📝 Usuarios admin detectados:', [...new Set(adminMensajes)]);
                }
                
                console.log(`👥 Otros mensajes: ${otros}`);
                if (otrosMensajes.length > 0 && otrosMensajes.length <= 10) {
                    console.log('   📝 Otros usuarios:', [...new Set(otrosMensajes)]);
                }
                
                // Aplicar limpieza completa
                console.log('🧹 Aplicando limpieza completa...');
                limpiarChatCompleto();
                
                // Mostrar estado después de limpieza
                const mensajesDespues = chatContainer.querySelectorAll('.chat-message');
                console.log(`✅ Mensajes después de limpieza: ${mensajesDespues.length}`);
                
                return `Limpieza completada: ${mensajes.length} → ${mensajesDespues.length} mensajes`;
            } else {
                console.error('❌ Contenedor de chat no encontrado');
                return 'Error: Contenedor no encontrado';
            }
        };



    // NUEVA v0.95: Función para probar diferentes contextos
    window.probarContextos = function() {
        console.log('🧪 Probando diferentes contextos...');
        
        const contextos = [
            {test: 'prueba0', time: 'dia', rating: '8.0', desc: 'Prueba 0, Día, Rating Alto'},
            {test: 'prueba0', time: 'dia', rating: '4.0', desc: 'Prueba 0, Día, Rating Bajo'},
            {test: 'prueba0', time: 'noche', rating: '8.0', desc: 'Prueba 0, Noche, Rating Alto'},
            {test: 'prueba0', time: 'noche', rating: '4.0', desc: 'Prueba 0, Noche, Rating Bajo'}
        ];
        
        contextos.forEach((ctx, i) => {
            setTimeout(() => {
                console.log(`\n🎯 Probando: ${ctx.desc}`);
                localStorage.setItem('currentTest', ctx.test);
                localStorage.setItem('timeOfDay', ctx.time);
                localStorage.setItem('rating', ctx.rating);
                
                if (window.updateContextualSystem) {
                    window.updateContextualSystem();
                }
                
                if (window.getCurrentContextualMessages) {
                    const messages = window.getCurrentContextualMessages();
                    console.log(`📨 ${messages.length} mensajes disponibles:`);
                    messages.slice(0, 3).forEach((msg, j) => {
                        console.log(`${j+1}. ${msg}`);
                    });
                }
            }, i * 2000);
        });
        
        // Volver al contexto original después de las pruebas
        setTimeout(() => {
            localStorage.setItem('currentTest', 'prueba0');
            localStorage.setItem('timeOfDay', 'dia');
            localStorage.setItem('rating', '7.0');
            if (window.updateContextualSystem) {
                window.updateContextualSystem();
            }
            console.log('🔄 Contexto restaurado a valores originales');
        }, contextos.length * 2000 + 1000);
    };

            console.log('🛠️ Funciones de utilidad v1.4 disponibles:');
        console.log('• limpiarChatYForzarContextual() - Limpia el chat y reinicia sistema híbrido');
        console.log('• probarContextos() - Prueba diferentes contextos automáticamente');
        console.log('• probarSistemaAtributos() - Prueba el sistema de atributos v1.0');
        console.log('• probarLimpiezaChat() - Prueba el sistema de limpieza de mensajes v1.1');
        console.log('• forzarLimpiezaAgresiva() - Fuerza la eliminación de mensajes del admin');
        console.log('• eliminarMensajesEspecificos() - Elimina los mensajes problemáticos específicos');
        console.log('• limpiarChatCompleto() - OPCIÓN NUCLEAR: Elimina TODOS los mensajes');
        console.log('• borrarMensajesJugadorFirebase() - Elimina mensajes del jugador de Firebase');
    </script>

    <script>
    // Sistema de transacciones PM
    window.pmTransactions = {
        transactions: [],
        total: 0,

        init() {
            // Cargar transacciones guardadas
            const saved = localStorage.getItem('pmTransactions');
            if (saved) {
                this.transactions = JSON.parse(saved);
                this.total = this.transactions.reduce((sum, t) => sum + t.amount, 0);
            }
            
            // Sincronizar con Firebase
            if (window.database) {
                const pmRef = window.database.ref('playerPM');
                pmRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data !== null) {
                        this.total = parseInt(data);
                        localStorage.setItem('playerPM', this.total.toString());
                        this.updateUI();
                    }
                });
            }
            
            this.updateUI();
        },

        addTransaction(amount, reason) {
            const transaction = {
                amount,
                reason,
                timestamp: Date.now()
            };
            this.transactions.push(transaction);
            this.total += amount;
            
            // Guardar en localStorage
            localStorage.setItem('pmTransactions', JSON.stringify(this.transactions));
            localStorage.setItem('playerPM', this.total.toString());
            
            // Guardar en Firebase
            if (window.database) {
                window.database.ref('playerPM').set(this.total);
            }
            
            // Notificar a todos los iframes
            this.notifyIframes();
            
            this.updateUI();
            return this.total;
        },

        setTotal(newTotal) {
            const difference = newTotal - this.total;
            return this.addTransaction(difference, 'Ajuste manual de PM');
        },

        getTotal() {
            return this.total;
        },

        updateUI() {
            // Actualizar todos los elementos con data-pm-display
            document.querySelectorAll('[data-pm-display]').forEach(el => {
                el.textContent = this.total;
            });
            
            // Actualizar el elemento PM en el panel lateral
            const pmElement = document.getElementById('pm-value');
            if (pmElement) {
                pmElement.textContent = this.total;
            }
            
            // Notificar a todos los iframes
            this.notifyIframes();
        },

        notifyIframes() {
            // Notificar a todos los iframes
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach(iframe => {
                if (iframe.contentWindow) {
                    iframe.contentWindow.postMessage({
                        type: 'updatePM',
                        total: this.total
                    }, '*');
                }
            });
        }
    };

    // Inicializar solo el sistema PM
    window.pmTransactions.init();

    // Escuchar mensajes de los iframes (solo PM)
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'getPM') {
            // Responder con el total actual
            event.source.postMessage({
                type: 'updatePM',
                total: window.pmTransactions.getTotal()
            }, '*');
        } else if (event.data && event.data.type === 'setPM') {
            // Establecer PM desde el panel de control
            if (window.pmTransactions) {
                window.pmTransactions.setTotal(event.data.total);
            }
        } else if (event.data && event.data.type === 'purchase') {
            // Interceptar compras de la tienda
            const { itemName, itemPrice, itemImage, itemDetails } = event.data;
            if (window.directMessages) {
                window.directMessages.addPurchaseMessage(itemName, itemPrice, itemImage, itemDetails || {});
            }
            console.log(`[Compra] ${itemName} por ${itemPrice} PM - Mensaje detallado enviado al buzón`);
        }
    });

    // Funciones globales para manejar PM
    window.sumarPM = function(cantidad, razon) {
        return window.pmTransactions.addTransaction(cantidad, razon);
    };

    window.restarPM = function(cantidad, razon) {
        return window.pmTransactions.addTransaction(-cantidad, razon);
    };

    window.establecerPM = function(total) {
        return window.pmTransactions.setTotal(total);
    };

    window.comprarItem = function(itemId, precio) {
        const total = window.pmTransactions.getTotal();
        if (total >= precio) {
            window.restarPM(precio, `Compra de item ${itemId}`);
            return true;
        }
        return false;
    };
    </script>

    <!-- Versión del sistema -->
    <script>
        const SYSTEM_VERSION = '1.55';
    </script>

    <!-- Sistema de Mensajes Directos -->
    <script>
    // Sistema de gestión de mensajes directos
    window.directMessages = {
        messages: {
            inbox: [],
            system: [],
            shop: [],
            personal: []
        },

        init() {
            // Cargar mensajes guardados
            const saved = localStorage.getItem('directMessages');
            if (saved) {
                try {
                    this.messages = JSON.parse(saved);
                    // Migrar mensajes antiguos si es necesario
                    this.migrateOldMessages();
                } catch (e) {
                    console.error('Error cargando mensajes:', e);
                    this.messages = { inbox: [], system: [], shop: [], personal: [] };
                }
            }

            // Configurar pestañas
            this.setupTabs();
            this.loadMessages();
        },

        // Función para migrar mensajes del formato anterior
        migrateOldMessages() {
            let needsSave = false;
            
            // Si hay mensajes en inbox que deberían estar en otras categorías
            if (this.messages.inbox && this.messages.inbox.length > 0) {
                this.messages.inbox.forEach(msg => {
                    // Determinar la categoría correcta basada en el sender
                    let targetCategory = 'inbox';
                    
                    if (msg.sender && msg.sender.includes('SISTEMA')) {
                        targetCategory = 'system';
                    } else if (msg.sender && msg.sender.includes('TIENDA')) {
                        targetCategory = 'shop';
                    } else if (msg.type === 'personal' || msg.type === 'admin') {
                        targetCategory = 'personal';
                    }
                    
                    // Si no está ya en la categoría correcta, moverlo
                    if (targetCategory !== 'inbox') {
                        const existsInTarget = this.messages[targetCategory]?.some(existing => existing.id === msg.id);
                        if (!existsInTarget) {
                            if (!this.messages[targetCategory]) {
                                this.messages[targetCategory] = [];
                            }
                            this.messages[targetCategory].push({...msg, category: targetCategory});
                            needsSave = true;
                        }
                    }
                });
                
                // Limpiar mensajes duplicados de inbox (dejar solo los que son realmente de inbox)
                this.messages.inbox = this.messages.inbox.filter(msg => {
                    return !(msg.sender && (msg.sender.includes('SISTEMA') || msg.sender.includes('TIENDA'))) 
                           && msg.type !== 'personal' && msg.type !== 'admin';
                });
                needsSave = true;
            }
            
            // Asegurar que todas las categorías existen
            if (!this.messages.personal) {
                this.messages.personal = [];
                needsSave = true;
            }
            
            if (needsSave) {
                this.saveMessages();
                console.log('🔄 Mensajes migrados al nuevo formato v1.5');
            }
        },

        setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    // Remover active de todos los botones
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    // Añadir active al botón clickeado
                    e.target.classList.add('active');
                    // Cargar mensajes de la pestaña seleccionada
                    this.loadMessages(e.target.dataset.tab);
                });
            });
        },

        addMessage(category, message) {
            if (!this.messages[category]) {
                this.messages[category] = [];
            }

            const messageObj = {
                id: Date.now() + Math.random(),
                ...message,
                timestamp: Date.now(),
                time: new Date().toLocaleString(),
                category: category // Añadir categoría para referencia
            };

            this.messages[category].unshift(messageObj); // Añadir al principio
            
            this.saveMessages();
            
            // Si el modal está abierto, recargar
            if (document.getElementById('messages-modal').style.display === 'block') {
                this.loadMessages();
            }

            return messageObj.id;
        },

        deleteMessage(category, messageId) {
            if (category === 'inbox') {
                // Si se elimina de inbox, necesitamos determinar la categoría real del mensaje
                const allMessages = [
                    ...this.messages.system.map(msg => ({...msg, originalCategory: 'system'})),
                    ...this.messages.shop.map(msg => ({...msg, originalCategory: 'shop'})),
                    ...this.messages.personal.map(msg => ({...msg, originalCategory: 'personal'})),
                    ...this.messages.inbox.map(msg => ({...msg, originalCategory: 'inbox'}))
                ];
                
                const messageToDelete = allMessages.find(msg => msg.id === messageId);
                if (messageToDelete && this.messages[messageToDelete.originalCategory]) {
                    this.messages[messageToDelete.originalCategory] = this.messages[messageToDelete.originalCategory].filter(msg => msg.id !== messageId);
                }
            } else {
                // Eliminar de la categoría específica
                if (this.messages[category]) {
                    this.messages[category] = this.messages[category].filter(msg => msg.id !== messageId);
                }
            }
            
            this.saveMessages();
            this.loadMessages();
        },

        saveMessages() {
            localStorage.setItem('directMessages', JSON.stringify(this.messages));
        },

        loadMessages(activeTab = null) {
            const messagesList = document.getElementById('messages-list');
            if (!messagesList) return;

            // Determinar pestaña activa
            if (!activeTab) {
                const activeButton = document.querySelector('.tab-button.active');
                activeTab = activeButton ? activeButton.dataset.tab : 'inbox';
            }

            // Debug: Log current state
            console.log('📧 LoadMessages - Tab actual:', activeTab);
            console.log('📧 LoadMessages - Mensajes por categoría:', {
                inbox: (this.messages.inbox || []).length,
                system: (this.messages.system || []).length,
                shop: (this.messages.shop || []).length,
                personal: (this.messages.personal || []).length
            });

            let messages = [];
            
            if (activeTab === 'inbox') {
                // Bandeja de entrada muestra TODOS los mensajes de todas las categorías, ordenados por fecha
                const allMessages = [
                    ...(this.messages.system || []).map(msg => ({...msg, category: 'system'})),
                    ...(this.messages.shop || []).map(msg => ({...msg, category: 'shop'})),
                    ...(this.messages.personal || []).map(msg => ({...msg, category: 'personal'})),
                    ...(this.messages.inbox || []).map(msg => ({...msg, category: 'inbox'}))
                ];
                
                // Eliminar duplicados por ID
                const uniqueMessages = [];
                const seenIds = new Set();
                
                for (const msg of allMessages) {
                    const id = msg.id || `${msg.sender}-${msg.content.substring(0, 20)}-${msg.timestamp}`;
                    if (!seenIds.has(id)) {
                        seenIds.add(id);
                        msg.uniqueId = id;
                        uniqueMessages.push(msg);
                    }
                }
                
                messages = uniqueMessages.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                console.log('📧 Bandeja de entrada - Total mensajes únicos:', messages.length);
            } else {
                // Otras pestañas muestran solo mensajes específicos de esa categoría
                messages = this.messages[activeTab] || [];
                console.log(`📧 ${activeTab} - Total mensajes:`, messages.length);
            }
            
            if (messages.length === 0) {
                messagesList.innerHTML = `
                    <div class="no-messages">
                        📭 No hay mensajes en esta categoría
                        ${activeTab === 'inbox' ? '<br><small>Los mensajes nuevos aparecerán aquí automáticamente</small>' : ''}
                    </div>
                `;
                return;
            }

            messagesList.innerHTML = messages.map(msg => this.renderMessage(msg, activeTab)).join('');
            console.log('📧 Mensajes renderizados en la interfaz:', messages.length);
        },

        renderMessage(msg, category) {
            const deleteButton = `<button class="delete-button" onclick="window.directMessages.deleteMessage('${category}', ${msg.id})">ELIMINAR</button>`;
            
            let imageHtml = '';
            if (msg.image) {
                imageHtml = `<div class="message-image"><img src="${msg.image}" alt="Imagen del mensaje"></div>`;
            }

            // Mostrar etiqueta de categoría si estamos en inbox
            let categoryBadge = '';
            if (category === 'inbox' && msg.category && msg.category !== 'inbox') {
                const categoryNames = {
                    'system': 'SISTEMA',
                    'shop': 'TIENDA',
                    'personal': 'PERSONAL'
                };
                const badgeColors = {
                    'system': '#ff4757',
                    'shop': '#2ed573', 
                    'personal': '#5352ed'
                };
                const badgeColor = badgeColors[msg.category] || '#747d8c';
                categoryBadge = `<span style="background: ${badgeColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; margin-left: 10px;">${categoryNames[msg.category] || msg.category.toUpperCase()}</span>`;
            }

            return `
                <div class="message-item" data-type="${msg.type || 'default'}">
                    <div class="message-header">
                        <div class="message-sender">${msg.sender || 'SISTEMA'}${categoryBadge}</div>
                        <div class="message-time">${msg.time}</div>
                    </div>
                    <div class="message-content">${msg.content}</div>
                    ${imageHtml}
                    <div class="message-actions">
                        ${deleteButton}
                    </div>
                </div>
            `;
        },

        // Función para añadir mensaje de compra mejorado
        addPurchaseMessage(itemName, itemPrice, itemImage = null, itemDetails = {}) {
            let detailsText = `Has comprado: ${itemName}\nPrecio: ${itemPrice} PM\n\n`;
            
            // Añadir detalles específicos según el tipo de item
            if (itemDetails.type) {
                detailsText += `Tipo: ${itemDetails.type}\n`;
            }
            if (itemDetails.damage) {
                detailsText += `Daño: ${itemDetails.damage}\n`;
            }
            if (itemDetails.armor) {
                detailsText += `Protección: ${itemDetails.armor}\n`;
            }
            if (itemDetails.effects) {
                detailsText += `Efectos: ${itemDetails.effects}\n`;
            }
            if (itemDetails.description) {
                detailsText += `\nDescripción: ${itemDetails.description}\n`;
            }
            
            detailsText += `\n¡Disfruta tu nueva adquisición! El item ha sido añadido automáticamente a tu inventario.`;

            const message = {
                sender: 'TIENDA OCE',
                content: detailsText,
                type: 'shop',
                image: itemImage
            };
            return this.addMessage('shop', message);
        },

        // Función para añadir mensaje de reto aceptado
        addChallengeAcceptedMessage(username, challenge) {
            const message = {
                sender: 'SISTEMA OCE',
                content: `Has aceptado un reto de ${username}: "${challenge}"\n\nRecuerda que OCE te penalizará si faltas a tu palabra y no cumples el desafío.\n\nLos PM han sido añadidos a tu cuenta automáticamente.`,
                type: 'system'
            };
            return this.addMessage('system', message);
        },

        // Función para añadir mensaje desde el panel de administración
        addAdminMessage(senderName, messageContent) {
            const message = {
                sender: senderName,
                content: messageContent,
                type: 'personal'
            };
            return this.addMessage('personal', message);
        }
    };

    // Función global para cargar mensajes directos (compatibilidad)
    window.loadDirectMessages = function() {
        if (window.directMessages) {
            window.directMessages.loadMessages();
        }
    };

    // Inicializar cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
        window.directMessages.init();
        
        // Agregar algunos mensajes de ejemplo si no hay ninguno
        if (window.directMessages.messages.system.length === 0) {
            window.directMessages.addMessage('system', {
                sender: 'SISTEMA OCE',
                content: 'Bienvenida al sistema Ultimate Mercenary v1.5\n\nTu aventura cyberpunk comienza ahora. Las reglas son simples: sobrevive, entretén a la audiencia y gana PM.\n\nNuevas funciones en v1.5:\n• Nuevo filtro de "Mensajes Personales" para comunicaciones directas del staff\n• "Bandeja de Entrada" ahora muestra todos los mensajes con etiquetas de categoría\n• Mejoras en la organización y filtrado de mensajes\n• Sistema de categorización más intuitivo y completo',
                type: 'system'
            });
        }
        
        if (window.directMessages.messages.shop.length === 0) {
            window.directMessages.addMessage('shop', {
                sender: 'TIENDA OCE',
                content: 'Bienvenida a la Tienda OCE\n\nTodos los artículos están disponibles para compra con PM. Las compras se registran automáticamente en tu inventario y recibirás confirmaciones detalladas aquí.\n\n¡Que tengas una experiencia de compra memorable!',
                type: 'shop'
            });
        }
        
        if (window.directMessages.messages.personal.length === 0) {
            window.directMessages.addMessage('personal', {
                sender: 'Director OCE',
                content: 'Bienvenida al sistema de mensajes personales v1.5\n\nAquí recibirás comunicaciones directas del staff del programa, patrocinadores especiales, y mensajes personalizados.\n\nEste canal está disponible para comunicaciones privadas importantes.\n\n¡Que tengas una experiencia memorable en Ultimate Mercenary!',
                type: 'personal'
            });
        }
        
        // Verificar si el mensaje de Kaiser ya existe antes de añadirlo
        const kaiserMessageExists = [
            ...window.directMessages.messages.inbox,
            ...window.directMessages.messages.personal
        ].some(msg => msg.sender === 'Director Kaiser' && msg.content.includes('Es hora de demostrar tu valía'));
        
        if (!kaiserMessageExists && window.directMessages.messages.inbox.length <= 2) {
            console.log('📧 Añadiendo mensaje inicial de Director Kaiser');
            window.directMessages.addMessage('inbox', {
                sender: 'Director Kaiser',
                content: 'XIII,\n\nEs hora de demostrar tu valía. La audiencia espera un espectáculo memorable. No los decepciones.\n\nRecuerda: OCE está siempre observando. Tu rendimiento determina no solo tu supervivencia, sino también las recompensas que recibirás.\n\n- Kaiser\nDirector de Operaciones, OCE',
                type: 'admin'
            });
        } else if (kaiserMessageExists) {
            console.log('✅ Mensaje de Director Kaiser ya existe, no se duplicará');
        }
    });
    </script>

    <!-- Funciones para guardar en Firebase (si el usuario puede modificar) -->
    <script>
    window.saveConcursanteName = function(numero, nombre) {
        const nombreRef = window.database.ref(`nombresConcursantes/${numero}`);
        nombreRef.set(nombre);
    };
    window.saveAudience = function(valor) { audienceRef.set(valor); };
    window.saveRating = function(valor) { ratingRef.set(valor); };
    window.savePM = function(valor) { pmRef.set(valor); };
    window.saveChat = function(arr) { chatRef.set(arr); };
    window.saveConocidosSeleccionados = function(arr) { conocidosRef.set(arr); };
    window.saveConocimientosSeleccionados = function(arr) { conocimientosRef.set(arr); };
    window.saveMensajesDirectos = function(arr) { mensajesRef.set(arr); };
    window.saveCurrentTest = function(valor) { currentTestRef.set(valor); };
    </script>

    <!-- Script del sistema de inventario -->
    <script src="character-sheet.js"></script>

    <!-- Funciones de prueba para el sistema de mensajes -->
    <script>
        // Función para probar el sistema de mensajes directos desde la consola
        window.testMessagingSystem = function() {
            console.log('🧪 Probando sistema de mensajes v0.91...');
            
            // Test 1: Mensaje de compra
            if (window.directMessages) {
                window.directMessages.addPurchaseMessage(
                    'Test Katana Monomolecular',
                    350,
                    null,
                    {
                        type: 'armas',
                        damage: '2d10+2',
                        effects: 'Corta armadura, silenciosa, exclusiva',
                        description: 'Hoja monomolecular de última generación para pruebas'
                    }
                );
                
                // Test 2: Mensaje de reto
                window.directMessages.addChallengeAcceptedMessage(
                    'TestUser_Elite',
                    'Completar la prueba sin usar armas por +75 PM'
                );
                
                // Test 3: Mensaje administrativo
                window.directMessages.addAdminMessage(
                    'Test Admin',
                    'Este es un mensaje de prueba enviado desde el panel de administración.\n\n¡El sistema funciona correctamente!'
                );
                
                console.log('✅ Sistema de mensajes funcionando correctamente');
                console.log('💬 Se han añadido 3 mensajes de prueba');
                console.log('📧 Abre el modal "Mensajes" para verlos');
                
                return 'Sistema funcionando - revisa el modal de mensajes';
            } else {
                console.error('❌ Sistema de mensajes no disponible');
                return 'Error: Sistema no disponible';
            }
        };

        // Función para forzar migración de mensajes viejos
        window.fixOldMessages = function() {
            console.log('🔧 Forzando migración de mensajes viejos...');
            
            if (window.directMessages) {
                // Limpiar localStorage y forzar migración
                const saved = localStorage.getItem('directMessages');
                if (saved) {
                    try {
                        const messages = JSON.parse(saved);
                        console.log('📧 Estado antes de migración:', messages);
                        
                        // Forzar migración
                        window.directMessages.messages = messages;
                        window.directMessages.migrateOldMessages();
                        window.directMessages.loadMessages();
                        
                        console.log('📧 Estado después de migración:', window.directMessages.messages);
                        console.log('✅ Migración completada. Abre el modal de mensajes para ver todos los mensajes en Bandeja de entrada');
                        
                        return 'Migración completada - revisa el modal de mensajes';
                    } catch (e) {
                        console.error('❌ Error durante migración:', e);
                        return 'Error durante migración';
                    }
                } else {
                    console.log('ℹ️ No hay mensajes para migrar');
                    return 'No hay mensajes para migrar';
                }
            } else {
                console.error('❌ Sistema de mensajes no disponible');
                return 'Sistema no disponible';
            }
        };

        // Función para probar la sincronización del chat
        window.testChatSync = function() {
            console.log('🧪 Probando sincronización del chat...');
            
            // Simular mensaje del jugador
            const testMsg = {
                sender: 'XIII',
                content: 'MENSAJE TEST - ' + new Date().toLocaleTimeString(),
                time: new Date().toLocaleTimeString(),
                timestamp: Date.now(),
                isPlayerMessage: true
            };
            
            console.log('📤 Enviando mensaje de prueba:', testMsg.content);
            
            // Guardar en localStorage y Firebase
            const messages = JSON.parse(localStorage.getItem('mensajes-publico-expanded') || '[]');
            messages.push(testMsg);
            localStorage.setItem('mensajes-publico-expanded', JSON.stringify(messages));
            
            if (window.saveChat) {
                window.saveChat(messages);
                console.log('✅ Mensaje enviado a Firebase');
            } else {
                console.warn('⚠️ Firebase no disponible');
            }
            
            return 'Mensaje de prueba enviado - verifica en otros dispositivos';
        };

        // Función para limpiar duplicados del mensaje de Kaiser
        window.cleanKaiserDuplicates = function() {
            console.log('🧹 Limpiando duplicados del mensaje de Kaiser...');
            
            if (!window.directMessages) {
                console.error('❌ Sistema de mensajes no disponible');
                return 'Error: Sistema no disponible';
            }
            
            let totalRemoved = 0;
            
            ['inbox', 'personal'].forEach(category => {
                if (window.directMessages.messages[category]) {
                    const originalLength = window.directMessages.messages[category].length;
                    
                    // Filtrar duplicados de Kaiser
                    const kaiserMessages = window.directMessages.messages[category].filter(msg => 
                        msg.sender === 'Director Kaiser' && msg.content.includes('Es hora de demostrar tu valía')
                    );
                    
                    if (kaiserMessages.length > 1) {
                        // Mantener solo el más reciente
                        const latestKaiser = kaiserMessages.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))[0];
                        
                        window.directMessages.messages[category] = window.directMessages.messages[category].filter(msg => {
                            if (msg.sender === 'Director Kaiser' && msg.content.includes('Es hora de demostrar tu valía')) {
                                return msg.id === latestKaiser.id || msg.timestamp === latestKaiser.timestamp;
                            }
                            return true;
                        });
                        
                        const removed = originalLength - window.directMessages.messages[category].length;
                        totalRemoved += removed;
                        console.log(`🗑️ Eliminados ${removed} duplicados de Kaiser en ${category}`);
                    }
                }
            });
            
            if (totalRemoved > 0) {
                // Guardar cambios
                window.directMessages.saveMessages();
                window.directMessages.loadMessages();
                console.log(`✅ Limpieza completada. Eliminados ${totalRemoved} duplicados en total`);
                return `Eliminados ${totalRemoved} duplicados del mensaje de Kaiser`;
            } else {
                console.log('✅ No se encontraron duplicados');
                return 'No se encontraron duplicados';
            }
        };

                                console.log('🎮 Ultimate Mercenary v1.58 - FIREBASE FORZADO POST-CARGA');
            console.log('📧 Usa testMessagingSystem() para probar el sistema de mensajes');
            console.log('📧 Usa fixOldMessages() para migrar mensajes viejos a Bandeja de entrada');
            
            // LISTENER PARA CAMBIOS DE CONTEXTO v1.56
            let lastContextReload = localStorage.getItem('contextReload') || '0';
            let lastForceReload = localStorage.getItem('forceReload') || '0';
            
            // Escuchar cambios en localStorage desde otras ventanas
            window.addEventListener('storage', function(e) {
                if (e.key === 'contextReload' && e.newValue !== lastContextReload) {
                    lastContextReload = e.newValue;
                    console.log('🔄 CAMBIO DE CONTEXTO DETECTADO - Recargando mensajes...');
                    
                    // Forzar recarga inmediata del contexto
                    if (typeof window.getContextualMessages === 'function') {
                        console.log('🎭 Forzando nueva carga de contexto desde otra ventana');
                        // Simular nueva llamada al sistema de mensajes
                        setTimeout(() => {
                            if (window.contextualMessageSystem && window.contextualMessageSystem.loadMessages) {
                                window.contextualMessageSystem.loadMessages();
                            }
                        }, 100);
                    }
                }
                
                // LISTENER PARA RECARGA FORZADA
                if (e.key === 'forceReload' && e.newValue !== lastForceReload) {
                    lastForceReload = e.newValue;
                    console.log('🚨 RECARGA FORZADA DETECTADA - Recargando página en 2 segundos...');
                    setTimeout(() => {
                        console.log('🔄 RECARGANDO PÁGINA PARA APLICAR CONTEXTO...');
                        location.reload();
                    }, 2000);
                }
            });
            
            // Listener para eventos personalizados en la misma ventana
            window.addEventListener('contextChanged', function(e) {
                console.log('🎭 EVENTO DE CAMBIO DE CONTEXTO:', e.detail);
                setTimeout(() => {
                    if (window.contextualMessageSystem && window.contextualMessageSystem.loadMessages) {
                        console.log('🔄 Recargando sistema de mensajes...');
                        window.contextualMessageSystem.loadMessages();
                    }
                }, 100);
            });
        console.log('💬 Usa testChatSync() para probar la sincronización del chat entre dispositivos');
        console.log('🧹 Usa cleanKaiserDuplicates() para limpiar duplicados del mensaje de Kaiser');
        console.log('🧪 Usa probarSistemaAtributos() para probar el sistema de atributos');
        console.log('🧹 Usa probarLimpiezaChat() para probar la limpieza de chat');
        console.log('🌙 v1.5: Chat sincronizado + Admin ve mensajes del jugador + Bandeja unificada');
    </script>

    <!-- Sistema de mensajes contextuales -->
    <script src="contextual-messages.js"></script>
    <script src="contextual-messages-p2.js"></script>
    <script src="contextual-messages-p3.js"></script>
    <script src="contextual-system-integration.js"></script>
    
    <!-- SISTEMA DE FILTROS DE MENSAJES v1.59 -->
    <script>
        // Inicializar sistema de filtros en index-user.html
        if (!window.MESSAGE_FILTERS) {
            window.MESSAGE_FILTERS = {
                enabledCategories: {
                    'fan': true,
                    'picante': true,
                    'humillante': true,
                    'relleno': true,
                    'queja': true,
                    'divertido': true,
                    'insulto': true
                },
                
                setFilter: function(category, enabled) {
                    this.enabledCategories[category] = enabled;
                    localStorage.setItem('messageFilters', JSON.stringify(this.enabledCategories));
                    console.log(`🎛️ [FILTROS] ${category}: ${enabled ? 'ACTIVADO' : 'DESACTIVADO'}`);
                    
                    // Actualizar mensajes contextuales cuando cambien los filtros
                    if (window.contextualSystem && typeof window.contextualSystem.refreshMessages === 'function') {
                        window.contextualSystem.refreshMessages();
                    }
                },
                
                getEnabledCategories: function() {
                    return this.enabledCategories;
                },
                
                loadFromStorage: function() {
                    const saved = localStorage.getItem('messageFilters');
                    if (saved) {
                        try {
                            this.enabledCategories = JSON.parse(saved);
                            console.log('🎛️ [FILTROS] Cargados desde localStorage:', this.enabledCategories);
                        } catch (e) {
                            console.error('❌ [FILTROS] Error loading message filters:', e);
                        }
                    }
                },
                
                // Función para aplicar filtros a mensajes
                applyFilters: function(messages) {
                    return messages.filter(msg => {
                        if (typeof msg === 'string') {
                            // Retrocompatibilidad para mensajes sin categorizar
                            return true;
                        }
                        const isEnabled = this.enabledCategories[msg.category] === true;
                        if (!isEnabled) {
                            console.log(`🚫 [FILTROS] Mensaje filtrado (${msg.category}): ${msg.text ? msg.text.substring(0, 30) : 'sin texto'}...`);
                        }
                        return isEnabled;
                    });
                }
            };
            
            // Cargar filtros desde localStorage al inicializar
            window.MESSAGE_FILTERS.loadFromStorage();
            console.log('✅ [FILTROS] Sistema de filtros inicializado en index-user.html');
            
            // Función de test para probar filtros desde la consola
            window.testFilters = function() {
                console.log('🧪 [FILTROS] Probando sistema de filtros...');
                console.log('🎛️ [FILTROS] Estado actual:', window.MESSAGE_FILTERS.enabledCategories);
                
                // Desactivar picante para probar
                console.log('🚫 [FILTROS] Desactivando filtro "picante"...');
                window.MESSAGE_FILTERS.setFilter('picante', false);
                
                // Obtener mensajes y ver si se filtran
                const messages = window.getCurrentContextualMessages();
                console.log(`📨 [FILTROS] Mensajes después del filtro: ${messages.length}`);
                
                // Reactivar picante
                setTimeout(() => {
                    console.log('✅ [FILTROS] Reactivando filtro "picante"...');
                    window.MESSAGE_FILTERS.setFilter('picante', true);
                    
                    const messagesAfter = window.getCurrentContextualMessages();
                    console.log(`📨 [FILTROS] Mensajes después de reactivar: ${messagesAfter.length}`);
                }, 2000);
            };
        }
    </script>
    
    <!-- INICIALIZACIÓN INMEDIATA v0.97 -->
    <script>
        // FORZAR inicialización inmediata del sistema contextual
        console.log('🚀 FORZANDO inicialización inmediata v0.97...');
        
        // Configurar contexto INMEDIATAMENTE
        if (!localStorage.getItem('currentTest')) localStorage.setItem('currentTest', 'prueba0');
        if (!localStorage.getItem('timeOfDay')) localStorage.setItem('timeOfDay', 'dia');
        if (!localStorage.getItem('rating')) localStorage.setItem('rating', '7.0');
        
        // CREAR LAS FUNCIONES GLOBALES USANDO LAS FUNCIONES EXPORTADAS CON FILTROS
        window.getCurrentContextualMessages = function() {
            try {
                // Usar PRIORITARIAMENTE la función de contextual-system-integration.js que ya integra filtros
                if (typeof window.contextualIntegration_getCurrentContextualMessages === 'function') {
                    const messages = window.contextualIntegration_getCurrentContextualMessages();
                    console.log(`✅ Obtenidos ${messages.length} mensajes contextuales con filtros integrados`);
                    return messages;
                }
                
                // Usar la función exportada del archivo contextual-messages.js con filtros
                if (typeof window.getContextualMessages === 'function') {
                    const messages = window.getContextualMessages();
                    console.log(`✅ Obtenidos ${messages.length} mensajes contextuales con filtros`);
                    return messages;
                } else {
                    console.warn('⚠️ window.getContextualMessages no está disponible');
                    
                    // Fallback directo a datos SIN FILTROS (no recomendado)
                    if (window.CONTEXTUAL_MESSAGES) {
                        const prueba = localStorage.getItem('currentTest') || 'prueba0';
                        const momento = localStorage.getItem('timeOfDay') || 'dia';
                        const rating = parseFloat(localStorage.getItem('rating') || '7.0');
                        const context = `${momento}_${rating > 6 ? 'alto' : 'bajo'}`;
                        
                        if (window.CONTEXTUAL_MESSAGES[prueba] && window.CONTEXTUAL_MESSAGES[prueba][context]) {
                            const rawMessages = window.CONTEXTUAL_MESSAGES[prueba][context];
                            // Aplicar filtros manualmente si es posible
                            if (typeof window.applyMessageFilters === 'function') {
                                const filteredMessages = window.applyMessageFilters(rawMessages);
                                const textMessages = filteredMessages.map(msg => typeof msg === 'object' ? msg.text : msg);
                                console.log(`⚠️ Mensajes filtrados manualmente: ${rawMessages.length} → ${textMessages.length}`);
                                return textMessages;
                            }
                            // Extraer solo texto sin filtros como último recurso
                            const textMessages = rawMessages.map(msg => typeof msg === 'object' ? msg.text : msg);
                            console.warn(`⚠️ Mensajes sin filtrar: ${textMessages.length}`);
                            return textMessages;
                        }
                    }
                    
                    // Último fallback
                    return [
                        "¡Vamos XIII, no decepciones a tus fans!",
                        "¡Estoy apostando todo por ti, no me falles!",
                        "¡Demuestra que mereces estar aquí! ¡+50 PM!"
                    ];
                }
            } catch (error) {
                console.error('❌ Error en getCurrentContextualMessages:', error);
                return [];
            }
        };
        
        window.getContextualUsernames = function() {
            try {
                // Usar la función exportada del archivo contextual-messages.js
                if (typeof window.getContextualUsers === 'function') {
                    const users = window.getContextualUsers();
                    console.log(`✅ Obtenidos ${users.length} usuarios contextuales`);
                    return users;
                } else {
                    console.warn('⚠️ window.getContextualUsers no está disponible');
                    
                    // Fallback manual
                    const momento = localStorage.getItem('timeOfDay') || 'dia';
                    const rating = parseFloat(localStorage.getItem('rating') || '7.0');
                    const isRatingHigh = rating > 6;
                    
                    if (momento === 'noche') {
                        if (isRatingHigh) {
                            return [
                                "NightWatcher_VIP", "MidnightFan", "DarkDesire_Premium", "ShadowLover69",
                                "NocturnaObsessed", "DreamCatcher_XIII", "NightQueen_Fan", "MoonlightStalker"
                            ];
                        } else {
                            return [
                                "NightCritic_Anon", "MidnightTroll", "DarkHater_666", "ShadowBooing",
                                "NocturnaDisgusted", "NightmareFuel", "DarkSide_Critic", "MidnightDisappoint"
                            ];
                        }
                    } else {
                        if (isRatingHigh) {
                            return [
                                "Neo_Kyoto_Fan42", "SamuraiStalker", "EdgerunnerGirl", "MercenaryCrazy", 
                                "BloodMoney99", "ChromeHeart", "WiredNinja", "NeonShadow",
                                "CyberSlice", "DeathMatch_Lover", "KatanaQueen", "StreetHunter22"
                            ];
                        } else {
                            return [
                                "Disappointed_Viewer", "FailedInvestment", "BoringShow_Critic", "WastedCredits",
                                "AmateurHour", "LowExpectations", "UnimpressedFan", "MediocreViewer"
                            ];
                        }
                    }
                }
            } catch (error) {
                console.error('❌ Error en getContextualUsernames:', error);
                return ["DefaultUser"];
            }
        };
        
        // Verificación simple y directa
        setTimeout(() => {
            console.log('🔍 Verificando sistema contextual...');
            
            // Verificar disponibilidad de variables globales
            if (window.CONTEXTUAL_MESSAGES) {
                console.log('📦 CONTEXTUAL_MESSAGES detectado:', Object.keys(window.CONTEXTUAL_MESSAGES));
                if (window.CONTEXTUAL_MESSAGES.prueba0) {
                    console.log('📦 PRUEBA0 disponible:', Object.keys(window.CONTEXTUAL_MESSAGES.prueba0));
                }
            } else {
                console.warn('⚠️ CONTEXTUAL_MESSAGES no disponible aún');
            }
            
            // Probar las funciones
            const msgs = window.getCurrentContextualMessages();
            const users = window.getContextualUsernames();
            
            console.log(`✅ Sistema listo: ${msgs.length} mensajes, ${users.length} usuarios`);
            if (msgs.length > 0) {
                console.log('📨 Primeros mensajes:', msgs.slice(0, 3));
            }
            
            // Reiniciar mensajes automáticos con el nuevo sistema
            if (window.updateAutoMessages) {
                window.updateAutoMessages();
                console.log('🔄 Mensajes automáticos iniciados');
            }
        }, 1000);
    </script>
    
    <!-- Verificación y debug del sistema contextual -->
    <script>
        // FORZAR inicialización del sistema contextual v1.58 - FORZAR DESPUÉS DE FIREBASE
        setTimeout(() => {
            console.log('🔍 INICIALIZANDO sistema contextual v1.59 - MENSAJES CONFIGURADOS...');
            
            // SOBRESCRIBIR valores DESPUÉS de que Firebase termine de cargar
            console.log('🔄 Configurando valores por defecto (respetando Firebase)...');
            console.log('📍 localStorage antes:', {
                prueba: localStorage.getItem('currentTest'),
                momento: localStorage.getItem('timeOfDay'),
                rating: localStorage.getItem('rating')
            });
            
            // Configurar valores solo si no existen (respetando Firebase)
            if (!localStorage.getItem('currentTest')) localStorage.setItem('currentTest', 'prueba1');
            // NO FORZAR timeOfDay - respetamos el valor de Firebase
            if (!localStorage.getItem('rating')) localStorage.setItem('rating', '8.0');
            
            console.log('📍 localStorage después de configurar:', {
                prueba: localStorage.getItem('currentTest'),
                momento: localStorage.getItem('timeOfDay'),
                rating: localStorage.getItem('rating')
            });
            
            console.log('📊 Contexto actual:', {
                prueba: localStorage.getItem('currentTest'),
                momento: localStorage.getItem('timeOfDay'),
                rating: localStorage.getItem('rating')
            });
            
            // FORZAR actualización del sistema con valores garantizados
            if (window.updateContextualSystem) {
                window.updateContextualSystem();
                console.log('🔄 Sistema contextual forzado a actualizar');
            }
            
            // Verificación simple para confirmar que el sistema funciona
            setTimeout(() => {
                console.log('📊 Verificación final del contexto:');
                console.log('   Prueba:', localStorage.getItem('currentTest'));
                console.log('   Momento:', localStorage.getItem('timeOfDay'));
                console.log('   Rating:', localStorage.getItem('rating'));
                
                const messages = window.getCurrentContextualMessages();
                console.log(`✅ Sistema operativo: ${messages.length} mensajes disponibles`);
                
                if (messages.length > 3) {
                    console.log('📨 Mensajes contextuales funcionando:', messages.slice(0, 5));
                } else {
                    console.log('📨 Usando fallback básico');
                }
            }, 2000);
            
        }, 3000); // Esperar MÁS para que Firebase termine completamente
    </script>

</body>
</html> 