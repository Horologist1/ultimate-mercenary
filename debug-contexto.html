<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Contexto - Ultimate Mercenary</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #0f0; }
        .error { color: #f44; }
        .warning { color: #fa0; }
        .success { color: #0f0; }
        button { background: #222; color: #0f0; border: 1px solid #0f0; padding: 10px; margin: 5px; cursor: pointer; }
        .mensaje { margin: 5px 0; padding: 5px; background: #111; }
        .mensaje.sensual { background: #442; border-left: 3px solid #f44; }
    </style>
</head>
<body>
    <h1>üîç DEBUG CONTEXTO - ULTIMATE MERCENARY</h1>
    
    <div class="test">
        <h3>Configurar Contexto:</h3>
        <button onclick="testContexto('prueba1', 'dia', '7.5')">Prueba 1 - D√≠a - Alto</button>
        <button onclick="testContexto('prueba0', 'noche', '7.5')">Prueba 0 - Noche - Alto</button>
        <button onclick="testContexto('prueba1', 'noche', '7.5')">Prueba 1 - Noche - Alto</button>
    </div>
    
    <div class="test">
        <h3>Estado del Sistema:</h3>
        <div id="sistema-estado"></div>
    </div>
    
    <div class="test">
        <h3>Mensajes Obtenidos:</h3>
        <div id="mensajes-obtenidos"></div>
    </div>
    
    <div class="test">
        <h3>An√°lisis de Contenido Sensual:</h3>
        <div id="analisis-sensual"></div>
    </div>

    <!-- Cargar sistema -->
    <script src="contextual-messages.js"></script>
    <script src="contextual-system-integration.js"></script>
    
    <script>
        // Configurar filtros
        window.MESSAGE_FILTERS = {
            enabledCategories: {
                'fan': true,
                'picante': true,
                'humillante': true,
                'relleno': true,
                'queja': true,
                'divertido': true,
                'insulto': true
            }
        };

        function testContexto(prueba, momento, rating) {
            console.log(`\nüß™ TESTEANDO: ${prueba} - ${momento} - ${rating}`);
            
            // Configurar contexto
            localStorage.setItem('currentTest', prueba);
            localStorage.setItem('timeOfDay', momento);
            localStorage.setItem('rating', rating);
            
            // Actualizar sistema
            if (window.updateContextualSystem) {
                window.updateContextualSystem();
            }
            
            setTimeout(() => {
                analizarSistema();
            }, 500);
        }

        function analizarSistema() {
            const prueba = localStorage.getItem('currentTest');
            const momento = localStorage.getItem('timeOfDay');
            const rating = localStorage.getItem('rating');
            const ratingLevel = parseFloat(rating) > 6 ? 'alto' : 'bajo';
            const contextKey = `${momento}_${ratingLevel}`;
            
            // Estado del sistema
            let estadoHTML = `
                <div class="success">üìä CONTEXTO ACTUAL:</div>
                <div>‚Ä¢ Prueba: ${prueba}</div>
                <div>‚Ä¢ Momento: ${momento}</div>
                <div>‚Ä¢ Rating: ${rating} (${ratingLevel})</div>
                <div>‚Ä¢ Clave: ${contextKey}</div>
                <br>
                <div class="success">üîß FUNCIONES:</div>
                <div>‚Ä¢ getContextualMessages: ${typeof window.getContextualMessages === 'function' ? '‚úÖ' : '‚ùå'}</div>
                <div>‚Ä¢ getCurrentContextualMessages: ${typeof window.getCurrentContextualMessages === 'function' ? '‚úÖ' : '‚ùå'}</div>
                <div>‚Ä¢ CONTEXTUAL_MESSAGES: ${window.CONTEXTUAL_MESSAGES ? '‚úÖ' : '‚ùå'}</div>
            `;
            document.getElementById('sistema-estado').innerHTML = estadoHTML;
            
            // Obtener mensajes
            let mensajes = [];
            let metodo = '';
            
            try {
                if (typeof window.getContextualMessages === 'function') {
                    mensajes = window.getContextualMessages();
                    metodo = 'getContextualMessages()';
                } else if (typeof window.getCurrentContextualMessages === 'function') {
                    mensajes = window.getCurrentContextualMessages();
                    metodo = 'getCurrentContextualMessages()';
                }
                
                // Mostrar mensajes
                let mensajesHTML = `
                    <div class="success">üì® MENSAJES OBTENIDOS (${mensajes.length}) - M√©todo: ${metodo}</div>
                `;
                
                mensajes.slice(0, 20).forEach((msg, i) => {
                    mensajesHTML += `<div class="mensaje">[${i+1}] ${msg}</div>`;
                });
                
                if (mensajes.length > 20) {
                    mensajesHTML += `<div>... y ${mensajes.length - 20} m√°s</div>`;
                }
                
                document.getElementById('mensajes-obtenidos').innerHTML = mensajesHTML;
                
                // An√°lisis de contenido sensual
                analizarContenidoSensual(mensajes);
                
            } catch (error) {
                document.getElementById('mensajes-obtenidos').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        function analizarContenidoSensual(mensajes) {
            const palabrasSensuales = ['sensual', 'er√≥tic', 'sexual', '√≠ntim', 'seduc', 'atractiv', 'fantas√≠a', 'seductora', 'danza', 'vulnerable'];
            let sensualCount = 0;
            let mensajesSensuales = [];
            
            mensajes.forEach((msg, index) => {
                palabrasSensuales.forEach(palabra => {
                    if (msg.toLowerCase().includes(palabra)) {
                        sensualCount++;
                        mensajesSensuales.push({
                            index: index + 1,
                            texto: msg,
                            palabra: palabra
                        });
                    }
                });
            });
            
            let analisisHTML = '';
            
            if (sensualCount > 0) {
                analisisHTML += `<div class="error">üö® CONTENIDO SENSUAL DETECTADO: ${sensualCount} mensajes</div>`;
                
                // Mostrar ejemplos
                const ejemplos = [...new Set(mensajesSensuales.map(m => m.texto))].slice(0, 10);
                ejemplos.forEach(texto => {
                    // Resaltar palabras sensuales
                    let textoResaltado = texto;
                    palabrasSensuales.forEach(palabra => {
                        const regex = new RegExp(`(${palabra})`, 'gi');
                        textoResaltado = textoResaltado.replace(regex, '<span style="background:#f44;color:#fff;padding:2px;">$1</span>');
                    });
                    analisisHTML += `<div class="mensaje sensual">${textoResaltado}</div>`;
                });
                
                // Diagn√≥stico espec√≠fico
                analisisHTML += `<br><div class="error">üîç DIAGN√ìSTICO:</div>`;
                analisisHTML += `<div>‚Ä¢ Contexto solicitado: ${localStorage.getItem('currentTest')} - ${localStorage.getItem('timeOfDay')} - ${localStorage.getItem('rating')}</div>`;
                analisisHTML += `<div>‚Ä¢ ¬øDeber√≠a haber contenido sensual aqu√≠? ${localStorage.getItem('timeOfDay') === 'noche' ? 'S√ç' : 'NO'}</div>`;
                
                if (localStorage.getItem('timeOfDay') === 'dia') {
                    analisisHTML += `<div class="error">‚ö†Ô∏è PROBLEMA: Contenido sensual en contexto D√çA donde NO deber√≠a haberlo</div>`;
                }
                
            } else {
                analisisHTML += `<div class="success">‚úÖ No se detect√≥ contenido sensual</div>`;
                analisisHTML += `<div>‚Ä¢ Contexto: ${localStorage.getItem('currentTest')} - ${localStorage.getItem('timeOfDay')} - ${localStorage.getItem('rating')}</div>`;
                analisisHTML += `<div>‚Ä¢ Estado: CORRECTO</div>`;
            }
            
            document.getElementById('analisis-sensual').innerHTML = analisisHTML;
        }

        // Inicializar con contexto problem√°tico
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                testContexto('prueba1', 'dia', '7.5');
            }, 1000);
        });
        
        // Capturar logs de consola
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
        };
    </script>
</body>
</html> 